{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"source/images/Linux-disk-base/GPT.png","path":"images/Linux-disk-base/GPT.png","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/MBR.png","path":"images/Linux-disk-base/MBR.png","modified":0,"renderable":0},{"_id":"source/images/local-llm-deploy/open-webui.png","path":"images/local-llm-deploy/open-webui.png","modified":0,"renderable":0},{"_id":"source/images/local-llm-deploy/qwen2.png","path":"images/local-llm-deploy/qwen2.png","modified":0,"renderable":0},{"_id":"source/images/local-llm-deploy/select-model.png","path":"images/local-llm-deploy/select-model.png","modified":0,"renderable":0},{"_id":"source/images/deploy-hexo/config.png","path":"images/deploy-hexo/config.png","modified":0,"renderable":0},{"_id":"source/images/deploy-hexo/deploy-config.png","path":"images/deploy-hexo/deploy-config.png","modified":0,"renderable":0},{"_id":"source/images/deploy-hexo/deploy-git.png","path":"images/deploy-hexo/deploy-git.png","modified":0,"renderable":0},{"_id":"source/images/deploy-hexo/page.png","path":"images/deploy-hexo/page.png","modified":0,"renderable":0},{"_id":"source/images/wsl-base/installed.png","path":"images/wsl-base/installed.png","modified":0,"renderable":0},{"_id":"source/images/wsl-base/wsl-version.png","path":"images/wsl-base/wsl-version.png","modified":0,"renderable":0},{"_id":"source/images/wsl-linux-init/available_list.png","path":"images/wsl-linux-init/available_list.png","modified":0,"renderable":0},{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","path":"css/gitalk.css","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight-dark.styl","path":"css/highlight-dark.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight.styl","path":"css/highlight.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","path":"xml/local-search.xml","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","path":"js/boot.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","path":"js/events.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","path":"js/color-schema.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","path":"js/img-lazyload.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","path":"js/leancloud.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","path":"js/plugins.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","path":"img/avatar.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","path":"img/default.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/fluid.png","path":"img/fluid.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","path":"img/police_beian.png","modified":0,"renderable":1},{"_id":"source/images/Linux-disk-base/078092image.png:Zone.Identifier","path":"images/Linux-disk-base/078092image.png:Zone.Identifier","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/078092image.png","path":"images/Linux-disk-base/078092image.png","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/098712image.png:Zone.Identifier","path":"images/Linux-disk-base/098712image.png:Zone.Identifier","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/098712image.png","path":"images/Linux-disk-base/098712image.png","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/052384image.png:Zone.Identifier","path":"images/Linux-disk-base/052384image.png:Zone.Identifier","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/052384image.png","path":"images/Linux-disk-base/052384image.png","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/016511image.png","path":"images/Linux-disk-base/016511image.png","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/016511image.png:Zone.Identifier","path":"images/Linux-disk-base/016511image.png:Zone.Identifier","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/20221031165313.jpg","path":"images/Linux-disk-base/20221031165313.jpg","modified":0,"renderable":0},{"_id":"source/images/Linux-disk-base/20221029005856.png","path":"images/Linux-disk-base/20221029005856.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/_posts/Ansible-Inventory-Intro.md","hash":"5d3f4d741b266ad96c85d4b9fb0553c33a1a292f","modified":1723078528795},{"_id":"source/_posts/Linux-disk-base.md","hash":"d50bcc8d9296754fed640388c7e90bb352392ef1","modified":1723112517043},{"_id":"source/_posts/WSL-Linux-init-proxy.md","hash":"ae8f38b3f99104c3a7799ac07b150fdb776f5b8e","modified":1723078528795},{"_id":"source/_posts/ansible-ad-hoc.md","hash":"106ab5a2ba5ac4a23b9d7ffb32ac3c44c6ef82d1","modified":1723078528795},{"_id":"source/_posts/deploy-hexo.md","hash":"15f8be24edb3e77e896297aab4c2deeec557d425","modified":1723078528795},{"_id":"source/_posts/git-intro.md","hash":"fc18991299017343cb2857e5b3bad5537c1e7382","modified":1723078528795},{"_id":"source/_posts/k8s-K8s-Install.md","hash":"2fa83c1b9714222bb104f37a15769559557a9b1e","modified":1723078528795},{"_id":"source/_posts/k8s-Prepare-Environment.md","hash":"6869d150242f11484bce44c473999db24e04da57","modified":1723078528795},{"_id":"source/_posts/local-llm-deploy.md","hash":"f562567fbcd1a596cd76745236448a7865666d22","modified":1723078528795},{"_id":"source/_posts/multipass.md","hash":"af331aa88f3ca7e47a120ffa9678f6dc29403fa3","modified":1723078528795},{"_id":"source/_posts/shell-action-2.md","hash":"1061a6b81963d076e8d113c86252f217752ee1fd","modified":1723690486753},{"_id":"source/_posts/shell-action.md","hash":"12e19d55d3c07a6f7ea1555e0dd8c074e7a968a9","modified":1723478272667},{"_id":"source/_posts/tmux.md","hash":"6647667e619e63906de7abc8728ecd5a685eec94","modified":1723078528795},{"_id":"source/_posts/wsl-base.md","hash":"fb3c59cf4dce0d51882d385a4de796c8a88613d9","modified":1723078528795},{"_id":"source/about/index.md","hash":"f4c5043e418ceb1c2043b7e5c10322891c877d88","modified":1723078528795},{"_id":"source/images/Linux-disk-base/MBR.png","hash":"a2c9f79c3fb1798e7b1e93505df873ff8187fc4d","modified":1723078528795},{"_id":"source/images/deploy-hexo/deploy-config.png","hash":"1e70b402d1544d7ea66505b6567ec54f5017d4b3","modified":1723078528795},{"_id":"source/images/deploy-hexo/deploy-git.png","hash":"999f8a8eaf9ecfebf9a37c3fb2006343cd71fb2d","modified":1723078528795},{"_id":"source/images/deploy-hexo/page.png","hash":"0fe763992ed1c972fb70a740caee471c0ba2300f","modified":1723078528795},{"_id":"source/images/wsl-base/installed.png","hash":"ff2b7708d9be1234f7a1fa8034006b4d4903b4a6","modified":1723078528806},{"_id":"source/images/wsl-base/wsl-version.png","hash":"1a296250b17783b1b3ac0b32e4474a3c7c60685e","modified":1723078528806},{"_id":"source/images/local-llm-deploy/open-webui.png","hash":"1725010cd835fc639cf0769bc08bbe00bacb628a","modified":1723078528795},{"_id":"source/images/local-llm-deploy/qwen2.png","hash":"c36a3cd1620c755d1082c161c37953c1888009ef","modified":1723078528795},{"_id":"source/images/local-llm-deploy/select-model.png","hash":"f2c09ddd3f9d4846318cd7b2a781837501c40629","modified":1723078528806},{"_id":"source/images/deploy-hexo/config.png","hash":"da9d1ca1c2caecb46e565d8877a1ffcfe67a8333","modified":1723078528795},{"_id":"source/images/wsl-linux-init/available_list.png","hash":"a5385bcf4da7604b5fbdb790a595d86f2f4e080a","modified":1723078528806},{"_id":"source/images/Linux-disk-base/GPT.png","hash":"a8e91973ee389da4999e518656edde64d9bf4f20","modified":1723078528795},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tag.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/LICENSE","hash":"26f9356fd6e84b5a88df6d9014378f41b65ba209","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/README.md","hash":"ff9b0e1fb9dba665af2f1e4a577f8cb9e840464b","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/_config.yml","hash":"759d78d97cfe364a4bcf0b5cd2d3505967674276","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/package.json","hash":"c640b57695b7b6002399711f1a7708b0f6c05b84","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/de.yml","hash":"0e7d455d9e004ff15d8924b7a0c35cea25ee5b1d","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/en.yml","hash":"cb11b39f44ea069652c9647179606b6cecc98d50","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/eo.yml","hash":"a556251cc50a5680578c03f1efbf252b1f4ab860","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/ru.yml","hash":"7dc78f22696649a4c68dc65a9b52d9a992fa82a0","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/ja.yml","hash":"3dd6d20f8d26585a7c154a8e59fe8d5d902f4c6a","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/es.yml","hash":"7112594259c88c04714be152af7fd377687dad40","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/zh-CN.yml","hash":"2253e1bc61694b3bdc5e434ea2660d13d941b50e","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/zh-HK.yml","hash":"80ed400a7adaa92ea54fc7f5d534c9af795bed00","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/languages/zh-TW.yml","hash":"596d031dff3826ae8e4ffc8931fff28977b73247","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/404.ejs","hash":"b84d575c7b7f778b4cb64e89ad3d0aed4a896820","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/categories.ejs","hash":"13859726c27b6c79b5876ec174176d0f9c1ee164","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/index.ejs","hash":"33c3317cdcee062789de2336dd8d0cc7f86d3650","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/category.ejs","hash":"f099161b738a16a32253f42085b5444f902018ed","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/layout.ejs","hash":"7e0023474128fbe4d68c467704c41f1712432415","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/links.ejs","hash":"1cac32ec4579aaf7b9fa39d317497331d4c5e1dd","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/about.ejs","hash":"163bee643e6a38912d3ae70923c83c48d57222e7","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/archive.ejs","hash":"7c1f44005849791feae4abaa10fae4cb983d3277","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/page.ejs","hash":"ed5007a3feb8f14d3d2843271bfb298eb0c56219","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/tag.ejs","hash":"9d686364c4d16a1a9219471623af452035c5b966","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/post.ejs","hash":"9bf0d357a607a282f3b9cb04525a4df0cc2a8b76","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/tags.ejs","hash":"1d06af34b6cf1d8a20d2eb565e309326ceba309f","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/category-chains.ejs","hash":"18309584aab83bc4deb20723ebad832149dd2e24","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments.ejs","hash":"d707c47b2638c94e489bc43d4cfd098b7c58447f","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/css.ejs","hash":"85f6e051550907681ab4ed2e268ac8f6e9ebf931","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer.ejs","hash":"10ccfb8eef4e16182183c9a3e175c90d5b6397d3","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/head.ejs","hash":"7b7b1d098726e86687a15fe3d520d178577ffcae","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header.ejs","hash":"0d5e397d30051e5fbabe7b47cfd1f1e6a5820af1","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/markdown-plugins.ejs","hash":"fc4bdf7de0cf1a66d0e5e4fba1b31d6f7ed49468","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/paginator.ejs","hash":"0f38a2c238169edcb63fc46c23bfc529ff3859b7","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/scripts.ejs","hash":"da5810785105e5075861593c7ac22c7aa9665a72","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/search.ejs","hash":"70e1c929e084ca8a2648cedabf29b372511ea2b8","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/index.js","hash":"79de5a379b28cad759a49048351c7f6b8915bd7d","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/archive-list.ejs","hash":"7520fbf91f762207c2ab06b2c293235cd5b23905","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/default-injects.js","hash":"b2013ae8e189cd07ebc8a2ff48a78e153345210f","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/locals.js","hash":"58d0fec976f6b1d35e7ea03edc45414088acf05c","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/filters/post-filter.js","hash":"82bb06686158ebe160a631c79f156cd4fde35656","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/index-generator.js","hash":"9159fc22fa84a7b605dd15fe4104f01fe9c71147","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/local-search.js","hash":"9ac5ddad06e9b0e6015ce531430018182a4bc0fa","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/generators/pages.js","hash":"d3e75f53c59674d171309e50702954671f31f1a4","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/date.js","hash":"9bda6382f61b40a20c24af466fe10c8366ebb74c","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/engine.js","hash":"d3a231d106795ce99cb0bc77eb65f9ae44515933","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/export-config.js","hash":"8e67b522c47aa250860e3fe2c733f1f958a506c0","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/import.js","hash":"ca53e8dbf7d44cfd372cfa79ac60f35a7d5b0076","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/injects.js","hash":"1ad2ae6b11bd8806ee7dd6eb7140d8b54a95d613","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/category-list.ejs","hash":"f8d2f1907450e61968e6d54443e9be8138196a77","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/page.js","hash":"4607607445233b3029ef20ed5e91de0da0a7f9c5","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/scope.js","hash":"d41d9d658fcb54964b388598e996747aadb85b0f","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/url.js","hash":"2a6a8288176d0e0f6ec008056bf2745a86e8943e","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/utils.js","hash":"966689d7c5e4320008285395fbaa2751f6209be5","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/helpers/wordcount.js","hash":"4d48c424e47ff9a17a563167ea5f480890267adf","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/button.js","hash":"3eb43a8cdea0a64576ad6b31b4df6c2bf5698d4c","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/checkbox.js","hash":"0857aa86db2a711ae5c77218a9e3fa686d0e87b1","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/group-image.js","hash":"4aeebb797026f1df25646a5d69f7fde79b1bcd26","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/fold.js","hash":"73e4fd12ce3e47981479391ed354b7d9d3279f70","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/label.js","hash":"f05a6d32cca79535b22907dc03edb9d3fa2d8176","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/mermaid.js","hash":"75160561e1ef3603b6d2ad2938464ab1cb77fd38","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/tags/note.js","hash":"e3b456a079e5dc0032473b516c865b20f83d2c26","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/compare-versions.js","hash":"dbbc928c914fc2bd242cd66aa0c45971aec13a5d","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/crypto.js","hash":"ae4ad8a188ef5b3fa6818b01629fc962b3de8551","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/object.js","hash":"33b57e4decdc5e75c518859f168c8ba80b2c665b","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/resolve.js","hash":"8c4a8b62aa8608f12f1e9046231dff04859dc3e9","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/scripts/utils/url-join.js","hash":"718aab5e7b2059a06b093ca738de420d9afa44ba","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/gitalk.css","hash":"a57b3cc8e04a0a4a27aefa07facf5b5e7bca0e76","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight-dark.styl","hash":"45695ef75c31a4aa57324dd408b7e2327a337018","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/highlight.styl","hash":"a9efc52a646a9e585439c768557e3e3c9e3326dc","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/main.styl","hash":"855ae5fe229c51afa57f7645f6997a27a705d7e4","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/xml/local-search.xml","hash":"8c96ba6a064705602ce28d096fd7dd9069630a55","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/boot.js","hash":"38bd26c6b7acdafda86dda3560e6a3ca488d3c76","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/events.js","hash":"5891534506b959a2f559f29e122baa3eb9159d93","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/color-schema.js","hash":"c5939d14065d38c86e16d1642e154dde5a23e830","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/img-lazyload.js","hash":"cbdeca434ec4da51f488c821d51b4d23c73294af","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/leancloud.js","hash":"eff77c7a5c399fcaefda48884980571e15243fc9","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/local-search.js","hash":"b9945f76f8682f3ec32edfb285b26eb559f7b7e8","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/plugins.js","hash":"c34916291e392a774ff3e85c55badb83e8661297","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/js/utils.js","hash":"b82e7c289a66dfd36064470fd41c0e96fc598b43","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/img/avatar.png","hash":"fe739a158cc128f70f780eb5fa96f388b81d478f","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/img/fluid.png","hash":"64b215db2cb3af98fe639e94537cb5209f959c78","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/img/loading.gif","hash":"2d2fc0f947940f98c21afafef39ecf226a2e8d55","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/img/police_beian.png","hash":"90efded6baa2dde599a9d6b1387973e8e64923ea","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/changyan.ejs","hash":"c9b2d68ed3d375f1953e7007307d2a3f75ed6249","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/cusdis.ejs","hash":"5f9dc012be27040bbe874d0c093c0d53958cc987","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/discuss.ejs","hash":"98d065b58ce06b7d18bff3c974e96fa0f34ae03a","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/disqus.ejs","hash":"aab4a4d24c55231a37db308ae94414319cecdd9b","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/giscus.ejs","hash":"95f8b866b158eff9352c381c243b332a155a5110","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/livere.ejs","hash":"2264758fed57542a7389c7aa9f00f1aefa17eb87","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/gitalk.ejs","hash":"843bc141a4545eb20d1c92fb63c85d459b4271ec","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/remark42.ejs","hash":"d4e9532feeb02aed61bd15eda536b5b631454dac","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/twikoo.ejs","hash":"d84bcb5ccd78470a60c067fc914ac0ac67ac8777","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/utterances.ejs","hash":"c7ccf7f28308334a6da6f5425b141a24b5eca0e2","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/waline.ejs","hash":"12727da7cf3ac83443270f550be4d1c06135b52b","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/comments/valine.ejs","hash":"19ba937553dddd317f827d682661a1066a7b1f30","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer/beian.ejs","hash":"4fb9b5dd3f3e41a586d6af44e5069afe7c81fff2","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header/banner.ejs","hash":"e07757b59e7b89eea213d0e595cb5932f812fd32","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/footer/statistics.ejs","hash":"454d8dd4c39f9494ebeb03ca0746f5bc122af76a","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/header/navigation.ejs","hash":"37d750428772d7c71ba36ce0c2540780d90fadea","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/anchorjs.ejs","hash":"40181442d3a2b8734783a0ad7caf2d2522e3f2ab","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/analytics.ejs","hash":"4f68c80bd1395e2f6d11e373116e54de11cb62e8","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/code-widget.ejs","hash":"3a505cba37942badf62a56bbb8b605b72af330aa","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/encrypt.ejs","hash":"0fff24cf5bf99fbe5c56c292e2eac4a89bf29db4","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/fancybox.ejs","hash":"9d1ea2a46b8c8ad8c168594d578f40764818ef13","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/highlight.ejs","hash":"7529dd215b09d3557804333942377b9e20fa554e","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/math.ejs","hash":"dcbf9a381ee76f2f1f75fcbc22c50a502ec85023","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/mermaid.ejs","hash":"03ac02762f801970d1c4e73d6ec8d4c503780e50","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/moment.ejs","hash":"4ff3fb1b60ccc95a0af3bbdbd0757fedefc088b5","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/nprogress.ejs","hash":"4c2d39ce816b8a6dcd6b53113c8695f8bd650a23","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/plugins/typed.ejs","hash":"f345374885cd6a334f09a11f59c443b5d577c06c","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/category-bar.ejs","hash":"8772bce97ed297e7a88523f4e939ed6436c22f87","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/copyright.ejs","hash":"529f3069742b3d338c769ba2d836e7f3c342a09d","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/meta-bottom.ejs","hash":"375974ec017696e294dc12469fb0ae257800dc2d","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/meta-top.ejs","hash":"ce6e9f578f4faa45840abddf8f46af3f4b69c177","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/sidebar-right.ejs","hash":"d5fcc9b60e02f869a29a8c17a16a6028ecc1e6d8","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/sidebar-left.ejs","hash":"9992c99b3eb728ad195970e1b84d665f2c8691c4","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/layout/_partials/post/toc.ejs","hash":"635a89060fbf72eeda066fc4bd0a97462f069417","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/compatible-configs.js","hash":"ef474d1fa5bbafc52619ced0f9dc7eaf2affb363","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/footnote.js","hash":"c19ac8050b82c3676b0332a56099ccfcc36d9d52","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/hello.js","hash":"bd8376e1cf7892dc2daa58f2f443574be559fdbf","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/highlight.js","hash":"a5fe1deccb73b5f578797dbb11038efc15f63ce8","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/injects.js","hash":"5ae4b07204683e54b5a1b74e931702bbce2ac23e","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/merge-configs.js","hash":"7c944c43b2ece5dd84859bd9d1fe955d13427387","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/scripts/events/lib/lazyload.js","hash":"9ba0d4bc224e22af8a5a48d6ff13e5a0fcfee2a4","modified":1723078529201},{"_id":"node_modules/hexo-theme-fluid/source/css/_variables/base.styl","hash":"4ed5f0ae105ef4c7dd92eaf652ceda176c38e502","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_functions/base.styl","hash":"2e46f3f4e2c9fe34c1ff1c598738fc7349ae8188","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/pages.styl","hash":"b8e887bc7fb3b765a1f8ec9448eff8603a41984f","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_mixins/base.styl","hash":"542e306ee9494e8a78e44d6d7d409605d94caeb3","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_about/about.styl","hash":"97fe42516ea531fdad771489b68aa8b2a7f6ae46","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_archive/archive.styl","hash":"c475e6681546d30350eaed11f23081ecae80c375","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/base.styl","hash":"643284c567665f96915f0b64e59934dda315f74d","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/color-schema.styl","hash":"85492ef64d7e5f70f0f7e46d570bbc911e686d7e","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/inline.styl","hash":"411a3fa3f924a87e00ff04d18b5c83283b049a4d","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/keyframes.styl","hash":"94065ea50f5bef7566d184f2422f6ac20866ba22","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/print.styl","hash":"166afbc596ea4b552bad7290ec372d25ec34db7b","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-bar.styl","hash":"cc6df43fef6bb3efecbfdd8b9e467424a1dea581","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-chain.styl","hash":"0cdf7ef50dfd0669d3b257821384ff31cd81b7c9","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_category/category-list.styl","hash":"7edfe1b571ecca7d08f5f4dbcf76f4ffdcfbf0b5","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_index/index.styl","hash":"25fb6fa4c783b847c632584c49a7e1593cdb2f5d","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_links/links.styl","hash":"5c7f2044e3f1da05a3229537c06bd879836f8d6e","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_tag/tags.styl","hash":"65bfc01c76abc927fa1a23bf2422892b0d566c3f","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/comment.styl","hash":"780f3788e7357bcd3f3262d781cb91bb53976a93","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/highlight.styl","hash":"4df764d298fe556e501db4afc2b05686fe6ebcfb","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/markdown.styl","hash":"1e3d3a82721e7c10bcfcecec6d81cf2979039452","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/post-page.styl","hash":"cd432a6411ccac7df47e6a300fb1a872cfc763e7","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_post/post-tag.styl","hash":"c96d36aa8fe20f0c3c1a29ee2473cd8064b10f73","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/anchorjs.styl","hash":"e0cebda4a6f499aff75e71417d88caa7ceb13b94","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/banner.styl","hash":"7a0bd629bc234fc75e3cc8e3715ffada92f09e73","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/board.styl","hash":"4397037fc3f0033dbe546c33cd9dbdabd8cb1632","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/code-widget.styl","hash":"b66ab013f0f37d724a149b85b3c7432afcf460ad","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/copyright.styl","hash":"26f71a9cd60d96bb0cb5bbdf58150b8e524d9707","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footer.styl","hash":"2caaca71dd1ff63d583099ed817677dd267b457e","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/footnote.styl","hash":"ae9289cc89649af2042907f8a003303b987f3404","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/header.styl","hash":"c4459248c66ea1326feed021179b847ae91d465f","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/modal.styl","hash":"adf6c1e5c8e1fb41c77ce6e2258001df61245aa2","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/noscript.styl","hash":"0cf2f2bb44f456150d428016675d5876a9d2e2aa","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/pagination.styl","hash":"8bb1b68e5f3552cb48c2ffa31edbc53646a8fb4c","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/qrcode.styl","hash":"78704a94c0436097abfb0e0a57abeb3429c749b7","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/scroll-btn.styl","hash":"f0e429a27fa8a7658fcbddbb4d4dbe4afa12499a","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/search.styl","hash":"10f7e91a91e681fb9fe46f9df7707b9ef78707c8","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/toc.styl","hash":"9e7452aa2372153f25d7a4675c9d36d281a65d24","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/css/_pages/_base/_widget/ngrogress.styl","hash":"5d225357b4a58d46118e6616377168336ed44cb2","modified":1723078529211},{"_id":"node_modules/hexo-theme-fluid/source/img/default.png","hash":"167a12978d80371cf578c8a2e45c24a2eb25b6fb","modified":1723078529211},{"_id":"source/_posts/docker-local-registry.md","hash":"45b3f4acbe9c28def94ba94fc13d94eecee5b1a4","modified":1723443501129},{"_id":"source/images/Linux-disk-base/016511image.png","hash":"ee9215305bbdab8238b69471aba2e4a7435d5165","modified":1666975157176},{"_id":"source/images/Linux-disk-base/078092image.png","hash":"2c52ca26945edd5964dd0339063338af68fcc3d3","modified":1666946275753},{"_id":"source/images/Linux-disk-base/098712image.png","hash":"923cbab4d3e9bad2bafbb5448f74cb5b7cc55b49","modified":1666946266672},{"_id":"source/images/Linux-disk-base/052384image.png:Zone.Identifier","hash":"9a16d4077b0836f06475592e5910589d32da6081","modified":1666946285054},{"_id":"source/images/Linux-disk-base/016511image.png:Zone.Identifier","hash":"3dc93e46e584e484662dd42bb1b1204b65a00f14","modified":1666975157176},{"_id":"source/images/Linux-disk-base/078092image.png:Zone.Identifier","hash":"c6094c0cf12dd005148dab6cffd862f8af7d0054","modified":1666946275753},{"_id":"source/images/Linux-disk-base/098712image.png:Zone.Identifier","hash":"c231e9f887e0d0f6ef8e3039c5bee672b4e2ef6f","modified":1666946266672},{"_id":"source/images/Linux-disk-base/052384image.png","hash":"2bdd5076edb08d869e2d45e76b89d45acb55d24c","modified":1666946285054},{"_id":"source/images/Linux-disk-base/20221029005856.png","hash":"184199761a01a58be0c1f6602e1b754236923872","modified":1666856249725},{"_id":"source/images/Linux-disk-base/20221031165313.jpg","hash":"e6f97646d6fba2a21c0a3552f5ad5c2102d148b6","modified":1667206406619},{"_id":"public/local-search.xml","hash":"847ef7e2756a4ac2e692ae2978648c64bf8b9b2f","modified":1729492699018},{"_id":"public/about/index.html","hash":"47ba2e81f279ec2bb22d56556d6a4c3f6b3a8fd6","modified":1724922797837},{"_id":"public/archives/index.html","hash":"70be31c11b1087d8d7096ce4eff2be1e404b9aa8","modified":1729492699018},{"_id":"public/archives/page/2/index.html","hash":"64a4f8179afcc2b78b3e8b5aac375bf1c296773f","modified":1729156777257},{"_id":"public/archives/2024/index.html","hash":"74ad674a030838b08f29fe61e25324773c2cb1c1","modified":1729492699018},{"_id":"public/archives/2024/page/2/index.html","hash":"02fd76db3da6bee309e05a2c52922a23e3fcd57b","modified":1729156777257},{"_id":"public/archives/2024/07/index.html","hash":"b597ded1149bd0d7d931bcdeba6285dec2e6c284","modified":1729156777257},{"_id":"public/archives/2024/08/index.html","hash":"e54f9b2da82059444fabd3e378df43069c6ed436","modified":1729156777257},{"_id":"public/tags/ansible/index.html","hash":"8fad93fac66d6093ff0e456073e35149d023d85e","modified":1727420578270},{"_id":"public/tags/linux/index.html","hash":"4b5fa8d4ade79341712b6785963fff83625f0198","modified":1729072522788},{"_id":"public/tags/tools/index.html","hash":"2e0dda12a82cec2e1337211b6211405eca854062","modified":1729492699018},{"_id":"public/tags/k8s/index.html","hash":"7eca8112714312721d0fd03d944825a9f866b1c9","modified":1724922797837},{"_id":"public/tags/docker/index.html","hash":"b47faa06ac3798fca7ef1fd75e6d9c8a0ea1b820","modified":1723768959713},{"_id":"public/404.html","hash":"2ed7dd8f84d6552ae41657f8c6341fa4a2968063","modified":1723768959713},{"_id":"public/tags/index.html","hash":"1a19df6857d90eb33b2983cd6a5ef0d549d2ac25","modified":1727420578270},{"_id":"public/categories/index.html","hash":"a304cce08c594fc169621c43b44697c68048d4d3","modified":1723768959713},{"_id":"public/links/index.html","hash":"d2c49aba6a8358503029cbbe7fc0a242bd369f34","modified":1723768959713},{"_id":"public/2024/08/11/docker-local-registry/index.html","hash":"e1f51d5598d28fa1c1a4bd4b1862c5fe15ab4b75","modified":1729072522788},{"_id":"public/2024/08/07/shell-action-2/index.html","hash":"9d9d4b436fc960a32dac0dc39b761fc9dcf857c3","modified":1723768959713},{"_id":"public/2024/08/06/shell-action/index.html","hash":"4b5c2dcdd5455865d9ef7f3d7b7ae814ddfb25f1","modified":1723768959713},{"_id":"public/2024/08/04/WSL-Linux-init-proxy/index.html","hash":"3a4b3d67d6673fd33c9d3d49a7dcc680b54a964d","modified":1723768959713},{"_id":"public/2024/08/05/deploy-hexo/index.html","hash":"90603bee2117261f77cf15dd71a77132deb1b763","modified":1723768959713},{"_id":"public/2024/08/04/local-llm-deploy/index.html","hash":"7ce4d3a2d46c5685f3dc23cd0376a480032a5ca7","modified":1723768959713},{"_id":"public/2024/08/04/wsl-base/index.html","hash":"fb16087e85da5553bff4286991988e7bfe374cba","modified":1723768959713},{"_id":"public/2024/07/17/Linux-disk-base/index.html","hash":"515e166c978f6e2febc8f0da4ef82be69e04d576","modified":1723768959713},{"_id":"public/2024/07/12/ansible-ad-hoc/index.html","hash":"a11236e082f3fcf33fd20a7eda6b11488ebe65f5","modified":1723768959713},{"_id":"public/2024/07/12/Ansible-Inventory-Intro/index.html","hash":"ac223b9484bced3e6022ee170a430693446a56bf","modified":1723768959713},{"_id":"public/2024/07/11/tmux/index.html","hash":"3a449119d4b457efcd4a3a88e0957d0edb5160d7","modified":1723768959713},{"_id":"public/2024/07/08/git-intro/index.html","hash":"b1ca19258caab5a5070d01d4d4d3d21e7d28cd09","modified":1723768959713},{"_id":"public/2024/07/08/k8s-K8s-Install/index.html","hash":"8db87941eedc84963999a3607893f765061126ca","modified":1723768959713},{"_id":"public/2024/07/08/k8s-Prepare-Environment/index.html","hash":"7ccd748a2ad91ed133618f1af556c79b5bdec314","modified":1723768959713},{"_id":"public/2024/07/08/multipass/index.html","hash":"dece84296ee10fe655396928746f69733c914072","modified":1723768959713},{"_id":"public/index.html","hash":"da8ea6d71796a616fd051dff5b45b9435813d151","modified":1729492699018},{"_id":"public/page/2/index.html","hash":"36da04a9307de9010ebfb07b1d3e5eb628ba57c5","modified":1729156777257},{"_id":"source/_posts/shell-action-3.md","hash":"075491733bf175249163165fa471b8ba80f2429a","modified":1724291460987},{"_id":"source/_posts/curl-action.md","hash":"ac59bc9edc8bd348112ef27273042e7e143fd630","modified":1729072470211},{"_id":"public/2024/08/15/shell-action-3/index.html","hash":"8420dda6b7bf48e3712b653dbcb2e962fd4d65ce","modified":1729072522788},{"_id":"public/2024/08/14/curl-action/index.html","hash":"ac8c10013b8b9a92e4ec0ce4f68a8c7189afb08f","modified":1729072522788},{"_id":"source/_posts/k8s-base-operation-config.md","hash":"454a27a24c24f49a2fecc86980e3a17681187e2d","modified":1725610240890},{"_id":"source/_posts/ansible-set-sshpass.md","hash":"35d636166ca3d2a64231d2af9f3fb82cbdacf4fc","modified":1724922712428},{"_id":"public/archives/2024/08/page/2/index.html","hash":"f2df52e9a655205481a3841d783ac5e1ffabcbb2","modified":1729156777257},{"_id":"public/2024/08/29/ansible-set-sshpass/index.html","hash":"f1815310fc68a272f66d7273f46dc5d3b3fbbc18","modified":1727420578270},{"_id":"public/2024/08/27/k8s-base-operation-config/index.html","hash":"74c08b33169cd38d910fdb8efcccfe86222165a9","modified":1727420578270},{"_id":"source/_posts/ansible-action.md","hash":"e575d8a272a2dc74d2abb48c013991615671d06a","modified":1727420564163},{"_id":"public/archives/2024/09/index.html","hash":"f362f112aad003f6fe515fd9922514218b484d13","modified":1729156777257},{"_id":"public/2024/09/27/ansible-action/index.html","hash":"fe7b0b7e2bf0a29e49e7be4bb767b2186f161066","modified":1729072522788},{"_id":"source/_posts/svn-gitlab-backup.md","hash":"5a1418bf1f2d313538014c617579cdf0777b62d0","modified":1729071977927},{"_id":"public/archives/page/3/index.html","hash":"c0bc7e91e1c7b223bc6d3019e16a6cafa554937e","modified":1729156777257},{"_id":"public/archives/2024/page/3/index.html","hash":"3586a7a57aa6fa364a970c8b493f3bc2a26ba9bc","modified":1729156777257},{"_id":"public/archives/2024/10/index.html","hash":"a0e907083bd704058a86557155f1d225f361e50f","modified":1729492699018},{"_id":"public/page/3/index.html","hash":"e665bce748aa7253dd10f9b1716fb8be1bc74c92","modified":1729156777257},{"_id":"public/2024/10/15/svn-gitlab-backup/index.html","hash":"924cedfc3de2ca1f93a4730dabad10b19fd3968f","modified":1729492699018},{"_id":"source/_posts/wsl-migrate.md","hash":"f6070479b58c52e9ac2d717dc3c19cd436268c57","modified":1729157041655},{"_id":"public/2024/10/17/wsl-migrate/index.html","hash":"773792076f440a3e212d0ea4556f48dacbdbfd46","modified":1729492699018}],"Category":[],"Data":[],"Page":[{"title":"about","layout":"about","date":"2024-07-08T02:21:57.000Z","_content":"\n","source":"about/index.md","raw":"---\ntitle: about\nlayout: about\ndate: 2024-07-08 10:21:57\n---\n\n","updated":"2024-08-08T00:55:28.795Z","path":"about/index.html","comments":1,"_id":"clzkkh3yc0000uhuqg9m56bee","content":"","excerpt":"","more":""}],"Post":[{"title":"Ansible Inventory Intro","date":"2024-07-12T05:35:03.000Z","_content":"# ansible inventory 文件基本介绍\n\n> 默认配置路径\n>\n> `/etc/ansible/hosts`\n\n## 定义主机和组\n\nansible 支持将同一个主机同时归并到多个不同的组中\n\n```ini\n# 可以直接写IP地址\n192.168.3.27\n# 支持hostname\nntp.example.com\n# 支持:+port\n192.168.3.27:22\nntp.example.com:222\n# []表示一个分组\n[ntpserver]\nntp1.example.com\nntp2.example.com\n# 表示3-4之间的所有数字,包含3,4\nntp[3:4].example.com\n# 表示a-c之间所有数字,包含a,c\nntp[a:c].example.com\n```\n\n## 定义主机变量\n\n```ini\n[webservers]\nweb1.example.com http_port=808\nmaxRequestsPerChild=801 \n# 自定义http_port的端口号为808，配置maxRequestsPerChild为801\n```\n\n> Ansible其实支持多种方式修改或自定义变量，Inventory是其中的一种修改方式\n\n## 定义组变量\n\n```ini\n[groupservers]\nweb1.example.com\nweb2.example.com\n[groupservers:vars]\nntp_server=ntp.example.com  \n# 定义groupservers组中所有主机ntp_server值为ntp.magedu.com\nnfs_server=nfs.example.com \n# 定义groupservers组中所有主机nfs_server值为nfs.magedu.com\n```\n\n## 定义组嵌套及组变量\n\n```ini\n[apache]\nhttpd1.example.com\nhttpd2.example.com\n[nginx]\nngx1.example.com\nngx2.example.com\n[webservers:children]\napache\nnginx\n[webservers:vars]\nntp_server=ntp.example.com\n```\n\n## 多重变量定义\n\n变量除了在inventory中定义,还可以在其他格式的配置文件中定义，如：yml、json\n\n通常在以下四个位置检索\n\n- inventory配置文件\n- playbook中vars定义的区域\n- roles中vars目录下的文件\n- roles同级目录group_vars和hosts_vars目录下的文件\n\n## 其他参数列表\n\n```ini\nansible_ssh_host=\nansible_ssh_user=root\nansible_ssh_pass=xxx\nansible_ssh_port=22\n# 指定特有私钥文件\nansible_ssh_private_key_file=\n```\n\n> 更多参数查询官网","source":"_posts/Ansible-Inventory-Intro.md","raw":"---\ntitle: Ansible Inventory Intro\ndate: 2024-07-12 13:35:03\ntags: ansible\n---\n# ansible inventory 文件基本介绍\n\n> 默认配置路径\n>\n> `/etc/ansible/hosts`\n\n## 定义主机和组\n\nansible 支持将同一个主机同时归并到多个不同的组中\n\n```ini\n# 可以直接写IP地址\n192.168.3.27\n# 支持hostname\nntp.example.com\n# 支持:+port\n192.168.3.27:22\nntp.example.com:222\n# []表示一个分组\n[ntpserver]\nntp1.example.com\nntp2.example.com\n# 表示3-4之间的所有数字,包含3,4\nntp[3:4].example.com\n# 表示a-c之间所有数字,包含a,c\nntp[a:c].example.com\n```\n\n## 定义主机变量\n\n```ini\n[webservers]\nweb1.example.com http_port=808\nmaxRequestsPerChild=801 \n# 自定义http_port的端口号为808，配置maxRequestsPerChild为801\n```\n\n> Ansible其实支持多种方式修改或自定义变量，Inventory是其中的一种修改方式\n\n## 定义组变量\n\n```ini\n[groupservers]\nweb1.example.com\nweb2.example.com\n[groupservers:vars]\nntp_server=ntp.example.com  \n# 定义groupservers组中所有主机ntp_server值为ntp.magedu.com\nnfs_server=nfs.example.com \n# 定义groupservers组中所有主机nfs_server值为nfs.magedu.com\n```\n\n## 定义组嵌套及组变量\n\n```ini\n[apache]\nhttpd1.example.com\nhttpd2.example.com\n[nginx]\nngx1.example.com\nngx2.example.com\n[webservers:children]\napache\nnginx\n[webservers:vars]\nntp_server=ntp.example.com\n```\n\n## 多重变量定义\n\n变量除了在inventory中定义,还可以在其他格式的配置文件中定义，如：yml、json\n\n通常在以下四个位置检索\n\n- inventory配置文件\n- playbook中vars定义的区域\n- roles中vars目录下的文件\n- roles同级目录group_vars和hosts_vars目录下的文件\n\n## 其他参数列表\n\n```ini\nansible_ssh_host=\nansible_ssh_user=root\nansible_ssh_pass=xxx\nansible_ssh_port=22\n# 指定特有私钥文件\nansible_ssh_private_key_file=\n```\n\n> 更多参数查询官网","slug":"Ansible-Inventory-Intro","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yf0001uhuq1bz6an0s","content":"<h1 id=\"ansible-inventory-文件基本介绍\"><a href=\"#ansible-inventory-文件基本介绍\" class=\"headerlink\" title=\"ansible inventory 文件基本介绍\"></a>ansible inventory 文件基本介绍</h1><blockquote>\n<p>默认配置路径</p>\n<p><code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h2 id=\"定义主机和组\"><a href=\"#定义主机和组\" class=\"headerlink\" title=\"定义主机和组\"></a>定义主机和组</h2><p>ansible 支持将同一个主机同时归并到多个不同的组中</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># 可以直接写IP地址</span><br>192.168.3.27<br><span class=\"hljs-comment\"># 支持hostname</span><br>ntp.example.com<br><span class=\"hljs-comment\"># 支持:+port</span><br>192.168.3.27:22<br>ntp.example.com:222<br><span class=\"hljs-comment\"># []表示一个分组</span><br><span class=\"hljs-section\">[ntpserver]</span><br>ntp1.example.com<br>ntp2.example.com<br><span class=\"hljs-comment\"># 表示3-4之间的所有数字,包含3,4</span><br>ntp<span class=\"hljs-section\">[3:4]</span>.example.com<br><span class=\"hljs-comment\"># 表示a-c之间所有数字,包含a,c</span><br>ntp<span class=\"hljs-section\">[a:c]</span>.example.com<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"定义主机变量\"><a href=\"#定义主机变量\" class=\"headerlink\" title=\"定义主机变量\"></a>定义主机变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[webservers]</span><br>web1.example.com <span class=\"hljs-attr\">http_port</span>=<span class=\"hljs-number\">808</span><br><span class=\"hljs-attr\">maxRequestsPerChild</span>=<span class=\"hljs-number\">801</span> <br><span class=\"hljs-comment\"># 自定义http_port的端口号为808，配置maxRequestsPerChild为801</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Ansible其实支持多种方式修改或自定义变量，Inventory是其中的一种修改方式</p>\n</blockquote>\n<h2 id=\"定义组变量\"><a href=\"#定义组变量\" class=\"headerlink\" title=\"定义组变量\"></a>定义组变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[groupservers]</span><br>web1.example.com<br>web2.example.com<br><span class=\"hljs-section\">[groupservers:vars]</span><br><span class=\"hljs-attr\">ntp_server</span>=ntp.example.com  <br><span class=\"hljs-comment\"># 定义groupservers组中所有主机ntp_server值为ntp.magedu.com</span><br><span class=\"hljs-attr\">nfs_server</span>=nfs.example.com <br><span class=\"hljs-comment\"># 定义groupservers组中所有主机nfs_server值为nfs.magedu.com</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"定义组嵌套及组变量\"><a href=\"#定义组嵌套及组变量\" class=\"headerlink\" title=\"定义组嵌套及组变量\"></a>定义组嵌套及组变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[apache]</span><br>httpd1.example.com<br>httpd2.example.com<br><span class=\"hljs-section\">[nginx]</span><br>ngx1.example.com<br>ngx2.example.com<br><span class=\"hljs-section\">[webservers:children]</span><br>apache<br>nginx<br><span class=\"hljs-section\">[webservers:vars]</span><br><span class=\"hljs-attr\">ntp_server</span>=ntp.example.com<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"多重变量定义\"><a href=\"#多重变量定义\" class=\"headerlink\" title=\"多重变量定义\"></a>多重变量定义</h2><p>变量除了在inventory中定义,还可以在其他格式的配置文件中定义，如：yml、json</p>\n<p>通常在以下四个位置检索</p>\n<ul>\n<li>inventory配置文件</li>\n<li>playbook中vars定义的区域</li>\n<li>roles中vars目录下的文件</li>\n<li>roles同级目录group_vars和hosts_vars目录下的文件</li>\n</ul>\n<h2 id=\"其他参数列表\"><a href=\"#其他参数列表\" class=\"headerlink\" title=\"其他参数列表\"></a>其他参数列表</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">ansible_ssh_host</span>=<br><span class=\"hljs-attr\">ansible_ssh_user</span>=root<br><span class=\"hljs-attr\">ansible_ssh_pass</span>=xxx<br><span class=\"hljs-attr\">ansible_ssh_port</span>=<span class=\"hljs-number\">22</span><br><span class=\"hljs-comment\"># 指定特有私钥文件</span><br>ansible_ssh_private_key_file=<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>更多参数查询官网</p>\n</blockquote>\n","excerpt":"","more":"<h1 id=\"ansible-inventory-文件基本介绍\"><a href=\"#ansible-inventory-文件基本介绍\" class=\"headerlink\" title=\"ansible inventory 文件基本介绍\"></a>ansible inventory 文件基本介绍</h1><blockquote>\n<p>默认配置路径</p>\n<p><code>/etc/ansible/hosts</code></p>\n</blockquote>\n<h2 id=\"定义主机和组\"><a href=\"#定义主机和组\" class=\"headerlink\" title=\"定义主机和组\"></a>定义主机和组</h2><p>ansible 支持将同一个主机同时归并到多个不同的组中</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># 可以直接写IP地址</span><br>192.168.3.27<br><span class=\"hljs-comment\"># 支持hostname</span><br>ntp.example.com<br><span class=\"hljs-comment\"># 支持:+port</span><br>192.168.3.27:22<br>ntp.example.com:222<br><span class=\"hljs-comment\"># []表示一个分组</span><br><span class=\"hljs-section\">[ntpserver]</span><br>ntp1.example.com<br>ntp2.example.com<br><span class=\"hljs-comment\"># 表示3-4之间的所有数字,包含3,4</span><br>ntp<span class=\"hljs-section\">[3:4]</span>.example.com<br><span class=\"hljs-comment\"># 表示a-c之间所有数字,包含a,c</span><br>ntp<span class=\"hljs-section\">[a:c]</span>.example.com<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"定义主机变量\"><a href=\"#定义主机变量\" class=\"headerlink\" title=\"定义主机变量\"></a>定义主机变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[webservers]</span><br>web1.example.com <span class=\"hljs-attr\">http_port</span>=<span class=\"hljs-number\">808</span><br><span class=\"hljs-attr\">maxRequestsPerChild</span>=<span class=\"hljs-number\">801</span> <br><span class=\"hljs-comment\"># 自定义http_port的端口号为808，配置maxRequestsPerChild为801</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Ansible其实支持多种方式修改或自定义变量，Inventory是其中的一种修改方式</p>\n</blockquote>\n<h2 id=\"定义组变量\"><a href=\"#定义组变量\" class=\"headerlink\" title=\"定义组变量\"></a>定义组变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[groupservers]</span><br>web1.example.com<br>web2.example.com<br><span class=\"hljs-section\">[groupservers:vars]</span><br><span class=\"hljs-attr\">ntp_server</span>=ntp.example.com  <br><span class=\"hljs-comment\"># 定义groupservers组中所有主机ntp_server值为ntp.magedu.com</span><br><span class=\"hljs-attr\">nfs_server</span>=nfs.example.com <br><span class=\"hljs-comment\"># 定义groupservers组中所有主机nfs_server值为nfs.magedu.com</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"定义组嵌套及组变量\"><a href=\"#定义组嵌套及组变量\" class=\"headerlink\" title=\"定义组嵌套及组变量\"></a>定义组嵌套及组变量</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[apache]</span><br>httpd1.example.com<br>httpd2.example.com<br><span class=\"hljs-section\">[nginx]</span><br>ngx1.example.com<br>ngx2.example.com<br><span class=\"hljs-section\">[webservers:children]</span><br>apache<br>nginx<br><span class=\"hljs-section\">[webservers:vars]</span><br><span class=\"hljs-attr\">ntp_server</span>=ntp.example.com<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"多重变量定义\"><a href=\"#多重变量定义\" class=\"headerlink\" title=\"多重变量定义\"></a>多重变量定义</h2><p>变量除了在inventory中定义,还可以在其他格式的配置文件中定义，如：yml、json</p>\n<p>通常在以下四个位置检索</p>\n<ul>\n<li>inventory配置文件</li>\n<li>playbook中vars定义的区域</li>\n<li>roles中vars目录下的文件</li>\n<li>roles同级目录group_vars和hosts_vars目录下的文件</li>\n</ul>\n<h2 id=\"其他参数列表\"><a href=\"#其他参数列表\" class=\"headerlink\" title=\"其他参数列表\"></a>其他参数列表</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">ansible_ssh_host</span>=<br><span class=\"hljs-attr\">ansible_ssh_user</span>=root<br><span class=\"hljs-attr\">ansible_ssh_pass</span>=xxx<br><span class=\"hljs-attr\">ansible_ssh_port</span>=<span class=\"hljs-number\">22</span><br><span class=\"hljs-comment\"># 指定特有私钥文件</span><br>ansible_ssh_private_key_file=<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>更多参数查询官网</p>\n</blockquote>\n"},{"title":"Linux 磁盘基础","date":"2024-07-17T02:53:47.000Z","_content":"\n# Linux 磁盘基础\n\n先从如何使用开始\n\n- 如何查磁盘占用大小及基本信息\n\n  将会用到的命令：\n\n  - df\n  - lsblk\n  - du\n  - blkid\n\n- 如何进行磁盘分区、制作逻辑卷、格式化、挂载\n\n  将会用到的命令：\n\n  - fdisk\n  - gdisk\n  - parted\n  - pvcreate\n  - vgcreate\n  - lvcreate\n  - mkfs\n  - mount\n\n然后简单了解磁盘分区的原理\n\n- MBR\n- GPT\n\n最后是操作磁盘时可能遇到的各种问题。例如机器添加磁盘后系统层面没有显示、已分区没做逻辑卷的磁盘扩容、曾经使用过的磁盘换到新机器使用报错、已删除文件`df -h`仍然显示占用、挂载类似nfs等网络盘时操作卡顿、实际占用与显示不符等等...\n\n\n\n## 磁盘信息查看\n\n### 1. 查看磁盘使用量 -- display file system\n\n   ```bash\ndf -h # 二进制计算方式，以人类友好形式显示，如1024M=1G\ndf -l # 只列出本地文件系统，即排除nfs或其他类似的如nas盘存储挂载\ndf -T # 显示挂载类型\ndf -H # 十进制计算方式，以人类友好形式显示，如1000M=1G\ndf -t xfs # 指定显示xfs类型的挂载\ndf -i\n   ```\n\n\n\n### 2. 查看磁盘分区挂载信息 -- list block\n\n   ```bash\nlsblk\nlsblk -l \n   ```\n\n   使用`lsblk`输出如下:\n\n   ```\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsda       8:0    0   15G  0 disk\n├─sda1    8:1    0   14G  0 part /\n├─sda14   8:14   0    4M  0 part\n├─sda15   8:15   0  106M  0 part /boot/efi\n└─sda16 259:0    0  913M  0 part /boot\nsr0      11:0    1   54K  0 rom\n   ```\n\n   \n\n\n### 3. 查看具体文件或目录大小 -- disk usage\n\n   ```bash\ndu -sh # 计算总大小\ndu -ahd 0 # 与上述相同\ndu -sh * # 计算当前目录下所有文件具体大小，最后计算出总值，并以人类友好形式输出\ndu -ahd 1 # 与上述相同\n# -d 在有某些版本不可用，需要换成--max-depth 1\ndu -ahd 1 --time # 显示文件或目录修改时间\ndu -ahd 1 --time | sort -h ## 以人类友好形式进行排序输出\ndu -ahd 1 ./ -x ./ # 跳过不同文件系统的目录，经常可以用来规避nfs这类网络挂载\n   ```\n\n\n\n### 4. 其他命令\n\n   ```bash\nblkid ## block id, 可以用来查看uuid及文件系统类型\n## 以下命令可以用来查看分区情况\nfdisk -l \ngdisk -l\nparted /dev/vda print\n   ```\n\n\n\n   ## 磁盘分区、格式化、挂载\n\n> 磁盘有价，数据无价，对磁盘进行分区、扩容操作时请务必做好数据备份！！！\n\n### 1. 分区\n\n一般分区有两种常用形式，`GPT`和`MBR`\n\nMBR格式最多只能有四个主分区，若想继续分区就需要建立逻辑分区。\n\nGPT格式没有分区限制，建议使用GPT分区\n\n1. **fdisk**\n\nfdisk使用方法如下，进入交互式命令行后，用`p`查看磁盘信息，`n`新建分区，下面的操作无特殊指定回车即可。\n\n如有指定，一般起始扇区默认即可，结束扇区可用`+10G`类似写法指定，`+`号是在现有基础上增加空间。\n\n有时候缩容操作（一般不考虑缩容）不会指定+号，直接指定大小而不是在原基础上增加。\n\n```bash\nroot@docker:~# fdisk /dev/sda\n\nWelcome to fdisk (util-linux 2.39.3).\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n\nPartition number (2-13,17-128, default 2):\nFirst sector (33556480-52428766, default 33556480):\nLast sector, +/-sectors or +/-size{K,M,G,T,P} (33556480-52428766, default 52426751):\n\nCreated a new partition 2 of type 'Linux filesystem' and of size 9 GiB.\n\nCommand (m for help): p\nDisk /dev/sda: 25 GiB, 26843545600 bytes, 52428800 sectors\nDisk model: VBOX HARDDISK\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: A102F557-254C-4E8A-BB7B-5CE2CBC42B40\n\nDevice        Start      End  Sectors  Size Type\n/dev/sda1   2099200 33556479 31457280   15G Linux filesystem\n/dev/sda2  33556480 52426751 18870272    9G Linux filesystem\n/dev/sda14     2048    10239     8192    4M BIOS boot\n/dev/sda15    10240   227327   217088  106M EFI System\n/dev/sda16   227328  2097152  1869825  913M Linux extended boot\n\nPartition table entries are not in disk order.\n\nCommand (m for help): w\nThe partition table has been altered.\nSyncing disks.\n```\n\n\n\n2. **gdisk**\n\ngdisk的操作类似于fdisk，多了一步需要输入Hex code，可回车默认。\n\n如果保存退出后`lsblk`查看不到分区，可使用`partprobe`刷新分区表\n\n```bash\nroot@docker:~# gdisk /dev/sda\nGPT fdisk (gdisk) version 1.0.10\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\n\nCommand (? for help): p\nDisk /dev/sda: 52428800 sectors, 25.0 GiB\nModel: VBOX HARDDISK\nSector size (logical/physical): 512/512 bytes\nDisk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40\nPartition table holds up to 128 entries\nMain partition table begins at sector 2 and ends at sector 33\nFirst usable sector is 34, last usable sector is 52428766\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 18876348 sectors (9.0 GiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1         2099200        33556479   15.0 GiB    8300\n  14            2048           10239   4.0 MiB     EF02\n  15           10240          227327   106.0 MiB   EF00\n  16          227328         2097152   913.0 MiB   EA00\n\nCommand (? for help): n\nPartition number (2-128, default 2):\nFirst sector (34-52428766, default = 33556480) or {+-}size{KMGTP}:\nLast sector (33556480-52428766, default = 52426751) or {+-}size{KMGTP}: +8G\nCurrent type is 8300 (Linux filesystem)\nHex code or GUID (L to show codes, Enter = 8300): 8e00\nChanged type of partition to 'Linux LVM'\n\nCommand (? for help): p\nDisk /dev/sda: 52428800 sectors, 25.0 GiB\nModel: VBOX HARDDISK\nSector size (logical/physical): 512/512 bytes\nDisk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40\nPartition table holds up to 128 entries\nMain partition table begins at sector 2 and ends at sector 33\nFirst usable sector is 34, last usable sector is 52428766\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2099132 sectors (1025.0 MiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1         2099200        33556479   15.0 GiB    8300\n   2        33556480        50333695   8.0 GiB     8E00  Linux LVM\n  14            2048           10239   4.0 MiB     EF02\n  15           10240          227327   106.0 MiB   EF00\n  16          227328         2097152   913.0 MiB   EA00\n\nCommand (? for help): w\n\nFinal checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING\nPARTITIONS!!\n\nDo you want to proceed? (Y/N): y\nOK; writing new GUID partition table (GPT) to /dev/sda.\nWarning: The kernel is still using the old partition table.\nThe new table will be used at the next reboot or after you\nrun partprobe(8) or kpartx(8)\nThe operation has completed successfully.\n\nroot@docker:~# lsblk\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nloop0     7:0    0    4K  1 loop /snap/bare/5\nloop1     7:1    0 74.2M  1 loop /snap/core22/1380\nloop2     7:2    0    1M  1 loop /snap/multipass-sshfs/145\nloop3     7:3    0 38.8M  1 loop /snap/snapd/21759\nsda       8:0    0   25G  0 disk\n├─sda1    8:1    0   15G  0 part /\n├─sda14   8:14   0    4M  0 part\n├─sda15   8:15   0  106M  0 part /boot/efi\n└─sda16 259:0    0  913M  0 part /boot\nsr0      11:0    1   54K  0 rom\nroot@docker:~# partprobe -s\n```\n\n\n\n3. **parted**\n\n> 需谨慎使用，该命令操作会直接生效，不像gdisk、fdisk先将数据写入内存\n\n`parted` 命令也可以直接运行进入类似`fdisk`的交互式界面，但本人更习惯直接命令行操作\n\n分区三步法：\n   1. 设置分区形式 - mklabel\n   2. 设置分区大小 - mkpart\n      - mkpart的开始分区从第2048个扇区开始，也就是1024kb,给头部信息留足空间\n   3. 按需格式化磁盘或做成pv卷扩容\n\n```bash\n## 指定分区形式以及分区名和大小\nparted /dev/sda mklabel gpt mkpart primary 1024kb 100%\n## 更倾向于用扇区来指定大小，假设上一个分区的结束扇区为227328，则新分区可以+1从227329扇区开始。\n## 此处会自动调整结束扇区，因为磁盘尾还需要存放GPT备份表\nparted /dev/sda mklabel gpt mkpart primary 227329s 100%\n```\n\n### 2. 格式化\n\n一个磁盘分区完后还不能直接挂载使用，还需要进行文件系统格式化，格式化完成后才能挂载使用。\n\n一般常见的为xfs、ext4格式，建议使用xfs格式，对应的命令为\n\n```bash\nmkfs.xfs /dev/sda1\nmkfs.ext4 /dev/sda1\n\n## 格式化完成后可以用blkid查看信息\nblkid /dev/sda1 \n```\n\n### 3. 挂载\n\n挂载可以是临时挂载，也可以开机自动挂载\n\n- 临时挂载\n\n  关机重启挂载消失\n\n  ```bash\n  mount -t xfs /dev/sda2 /tmp\n  ```\n\n- 开机自动挂载\n\n  将挂载写入`/etc/fstab`文件即可实现开机自挂载\n\n  ```bash\n  echo \"/dev/sda2   /tmp        xfs   defaults     0 0\" >> /etc/fstab\n  ```\n\n### 4. 制作逻辑卷\n\nLVM允许系统将多个物理硬盘或分区组合成一个逻辑卷组，‌从而形成一个大的存储池。利用逻辑卷的特性可以实现跨盘扩容，因此在制作逻辑卷的时候最好使用性能相近的磁盘，否则将会影响逻辑卷整体性能。\n\n```bash\n## 先将某块磁盘或分区创建为PV\npvcreate /dev/sda\n## 将sda创建一个名为vg1的卷组\nvgcreate vg1 /dev/sda\n## 在vg1卷组创建一个名为lv1的逻辑卷，将所有vg1空间都使用\nlvcreate -l +100%free -n lv1 vg1\n## 在vg1卷组创建一个名为lv1,大小为40G的逻辑卷\nlvcreate -L 40G -n lv1 vg1\n## 制作文件系统\nmkfs.xfs /dev/vg1/lv1\n## 挂载，同样可以写入fstab\nmount /dev/vg1/lv1 /root/tmp/\n```\n\n### 5. 磁盘扩容\n\n通常磁盘需要做逻辑卷或者处于最后一个分区的时候进行扩容是最方便的。\n\n扩容前一定必须做好备份！！！\n\n1. 逻辑卷扩容\n\n```bash\n## 首先加入pv\npvcreate /dev/sda\n## 然后扩展vg\nvgextend vg1 /dev/sda\n## 扩充lv\n## +号必须有，不然就变成了调整lv大小，造成数据丢失\nlvextend -l +100%free /dev/vg1/lv1\nlvextend -L +20G /dev/vg1/lv1\n## 同步文件系统\n## xfs \nxfs_growfs /dev/vg1/lv1\n## ext4\nresize2fs /dev/vg1/lv1\n```\n\n2. 没分区的整块盘\n\n```bash\n## 可以直接同步文件系统\nxfs_growfs /dev/sda\nresize2fs /dev/sda\n```\n\n\n\n## 磁盘分区类型及原理\n\n#### MBR（Master Boot Record）分区格式\n\n早期磁盘第一个扇区（`521bytes`）里面包含重要的信息`MBR（Master Boot Record）`，其中`446 bytes`，安装开机管理程序的地方；剩下的`64bytes`记录硬盘分区的数据，即分区表，如图\n\n![mbr](../images/Linux-disk-base/MBR.png)\n\n由于分区表所在区块仅有64bytes容量，因此最多仅能有四组记录区，每组记录区记录了该区段的起始与结束的磁柱号码。\n\n也就是MBR只支持四个主分区，且最大只支持2TB的硬盘。\n\n若想多个分区，需要使用扩展分区，扩展分区从5开始计数。\n\n#### GPT（GUID Partition Table）分区格式\n\nGPT将磁盘划分为一块块的`逻辑区块地址（Logical Block Address，简称LBA）` 来处理，每个LBA预设计为512bytes，即一个扇区的大小；同时改进MBR之用一块扇区来标识分区表的弊端，GPT使用了前后各34个LBA来标识分区表信息（最后的34各区可以理解为备份，达到高可用），如图\n\n![gpt](../images/Linux-disk-base/GPT.png)\n\n LBA的标识是从0开始的，LBA0-34共35块，这里分别阐述下其含义:\n\n- `LBA0` :包含两部分，一部分是类似MBR的446bytes,存储开机管理程序，第二部分则是存储一个特殊的标记，标识该磁盘为GPT格式，而看不懂GPT分区的程序则无法操作该磁盘，起到保护作用，放心，目前基本的管理程序都能识别GPT格式，所以该LBA块实际上与分区信息并无直接关联，这就是为啥不算入34LBA的原因\n- `LBA1` :GPT的表头，记录分区本身的位置与大小，同时记录分区在备份中最后34个LBA中的位置，方便恢复\n- `LBA2-34`:共32块LBA，每块LBA记录4笔分区表，共支持4\\*32=128笔分区；而每个LBA默认为512bytes，则每笔记录用到512/4=128bytes,每笔记录拿出64bytes来记录开始、结束的扇区号码，因此对一个单一分区槽而言，支持的最大容量为2^64∗512bytes=2^63∗1Kbytes=2^33TB=8ZB\n\n> 1024TB=1PB \\\n> 1024PB=1EB \\\n> 1024EB=1ZB\n\n\n\n# 其他事项\n\n## 1. 已添加磁盘无法识别\n\n有时候机房加了磁盘可能不会在系统层面立即显示出来，需要重启服务器，也可以重新扫描下scsi总线\n\n```bash\nfor i in /sys/class/scsi_host/*/scan; do echo $i;echo \"- - -\" > $i; done\n```\n\n\n\n## 2. 已分区没做lvm的磁盘扩容\n\n有时候我们会遇到项目组在原磁盘上加空间，而想要扩容的那个分区是没有做逻辑卷的，以至于加的空间会浪费，下面有两种方案，其一是`fdisk`的一种特殊用法，其二是提供一个工具`growpart`，可以对没有做过逻辑卷的分区进行扩容。\n\n两种方案都需要该分区必需是整个磁盘的最后一个分区\n\n- 其一，使用`fdisk`扩容。因为fdisk在进行操作的时候分区数据不会直接写入磁盘，而是先会保存在内存中，所以可以利用这点来进行扩容\n\n  ```bash\n  fdisk /dev/sda\n  ## 进入后用p查看分区\n  ## 按d 删除最后一个分区\n  ## 然后再n，创建新分区。\n  ## 新分区的大小必须比原来的分区大，不能缩小，否则会造成数据丢失\n  ## 最后w保存，然后xfs_growf或resize2fs同步对应文件系统即可\n  ```\n  \n- 其二，可使用`growpart`来进行扩容\n\n   ```bash\n   # 联网条件下\n   yum install cloud-utils-growpart\n   # 没联网就传包吧\n   rpm -ivhU cloud-utils-growpart.rpm\n   # 如服务器有一块盘vda，仅有一个分区vda1，且没做过逻辑卷\n   # 先用growpart将空间加到vda1上\n   ## 表示对/dev/sda的分区1进行扩容\n   growpart /dev/vda 1\n   ## 如果报错 unexpected output in sfdisk --version\n   ## LANG=en_US.UTF-8 就可以了,不行可以重启下物理机试一下.(编码问题)\n   # 然后同步文件系统即可\n   xfs_growfs /\n   resize2fs /dev/vda1\n   ```\n\n**案例**\n\n>由于没有找到现成的做了分区而没做lvm的项目，但是步骤是一样的。\n\n![gdisk_caution](../images/Linux-disk-base/20221031165313.jpg)\n\n\n## 3. 旧磁盘换到新机器无法使用\n\n面对这个情况其实如果在确定磁盘里面的数据进行了备份，或者不需要的时候可以直接进行强制格式化。\n\n也可以`dd`去备份一下磁盘头和磁盘尾信息，或者整个磁盘。\n\n如下有一个磁盘sda，通过parted查看磁盘信息，这里建议把unit切换成s单位来看会更精确更清楚些。\n\n```shell\nroot@docker:~# parted /dev/sda u s p\nModel: ATA VBOX HARDDISK (scsi)\nDisk /dev/sda: 31457280s\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start     End        Size       File system  Name  Flags\n14      2048s     10239s     8192s                         bios_grub\n15      10240s    227327s    217088s    fat32              boot, esp\n16      227328s   2097152s   1869825s   ext4               bls_boot\n 1      2099200s  31457246s  29358047s  ext4\n```\n\n在这个输出中可以看到磁盘总大小31457280个扇区，磁盘实际分配到第31457246个扇区结束，`31457280-31457246=34`，也就是刚好留下了GPT格式备份的34个LBA。\n\n```bash\n## dd默认1count为512B，与扇区size对应\n## 备份前34个扇区\ndd if=/dev/sda of=~/sda.img.bak count=34\n## 跳过前面31457246个扇区进行备份\ndd if=/dev/sda of=~/sda.img.bak skip=31457246\n```\n\n如下输出可见备份了最后34个扇区\n\n\n```shell\nroot@docker:~# dd if=/dev/sda of=~/sda.end.bak skip=31457246\n34+0 records in\n34+0 records out\n17408 bytes (17 kB, 17 KiB) copied, 0.000214267 s, 81.2 MB/s\n```\n\n备份好后可以直接用`dd`命令把磁头磁尾清空即可\n\n```bash\ndd if=/dev/zero of=/dev/sda count=34\ndd if=/dev/zero of=/dev/sda skip=31457246\n```\n\n\n\n## 4. 已删除文件占用空间\n\n这种情况一般是有进程在占用被删除的文件，从而导致空间未释放\n\n```bash\n## 可使用lsof来排查，找到对应的pid\nlsof | grep deleted\n## 非业务时间段可以通过 kill对应进程来释放\n## 但业务时间段肯定不能这样操作\n## 所以有了第二种方法\nls -l /proc/$pid/fd/* | grep $filename\necho > /proc/$pid/fd/$fdnum\n```\n\n## 5. 实际占用与显示不符\n\n一可能是前面说的已删除文件后`df`没有变化\n\n二可能是覆盖挂载\n\n三可能是计算的时候没有排除网络挂载\n\n前面已经介绍过第一种处理办法，下面介绍后面两种\n\n对于覆盖挂载可以在非业务时间将异常挂载的目录先卸载下来，然后去看看卸载后的该目录下面是否有文件，如有文件占用空间则属于覆盖挂载。\n\n对于网络挂载，可以在使用`du`命令的时候使用`-x`选项来进行排除（前面有介绍过），便可计算出当前本地的准确值。\n\n## 6. 由MBR (MSDOS) 格式转GPT\n**场景**\n\nMBR分区只支持四个主分区，因此，当有人在第四个分区不用逻辑分区而继续用主分区的话将无法再进行分区，且最大只能操作2T空间的磁盘，所以在面对这种四个主分区都用满或磁盘空间超过2T的情况下，需要将磁盘格式转成GPT后才能进一步进行分区和扩容。\n\n**前提条件**\n\n磁盘头信息需要留足空间转换成GPT分区，start最小需要从第63个扇区开始。\n\n可以自己模拟下，用parted工具进行分区，第一个分区头从0开始，命令如下。\n\n```bash\nparted /dev/vdx mklabel msdos/gpt mkpart primary 0 100%\n```\n\n如果使用的label是mbr则会默认从63s开始，如果是gpt，则会从34s开始。\n\n![mbr_default](../images/Linux-disk-base/078092image.png)\n\n![gpt_default](../images/Linux-disk-base/098712image.png)\n\n如果用的是gdisk和fdisk分区，默认是从2048s开始，所以完全够从mbr转换成gpt格式。\n\n但是需要注意磁盘末尾是否还有空间，因为MBR末尾并不记录信息，所以当磁盘100%时也就是空间完全没有了，此时进行gpt转换可能造成尾部数据丢失。\n\n![fdisk_default](../images/Linux-disk-base/052384image.png)\n\n- 先备份分区表信息\n\n```bash\n# 备份分区表信息\n# 最好选择另外的盘进行备份\ndd if=/dev/vda of=/xxxx/xxx.mbr.bak  bs=1024 count=2000\n# 恢复分区表信息\ndd if=/home/xxx.mbr.bak  of=/dev/vda bs=1024 count=2000\n```\n\n- 使用gdisk将分区格式转换为gpt\n\n![gdisk_default](../images/Linux-disk-base/016511image.png)\n\n\n## 7. 新磁盘残留GPT分区信息导致无法分区扩容\n\n> 类似第三点\n\n当项目组拿来新磁盘，要求分区扩容时，碰到如下提示gpt备份区信息与主分区信息不一致的提示时，考虑是该磁盘是曾经做过分区的盘。\n\n![gdisk_caution](../images/Linux-disk-base/20221029005856.png)\n\n先与项目组确认是否是新盘无数据，当确认是新盘无数据后，可用`dd`命令去清空头尾记录的分区信息，一般取首尾1M左右即可，清空完后就可以按正常流程进行分区。\n\n```bash\n# 如项目组有893G磁盘\n# 清空头部信息\ndd if=/dev/zero of=/dev/sdb bs=512 count=4000\n# 清空尾部信息\ndd if=/dev/zero of=/dev/sdb bs=1M seek=890000\n# seek参数为跳过sdb的第890000个block，即将if的内容从第890000个block后开始写入\n```","source":"_posts/Linux-disk-base.md","raw":"---\ntitle: Linux 磁盘基础\ndate: 2024-07-17 10:53:47\ntags: linux\n---\n\n# Linux 磁盘基础\n\n先从如何使用开始\n\n- 如何查磁盘占用大小及基本信息\n\n  将会用到的命令：\n\n  - df\n  - lsblk\n  - du\n  - blkid\n\n- 如何进行磁盘分区、制作逻辑卷、格式化、挂载\n\n  将会用到的命令：\n\n  - fdisk\n  - gdisk\n  - parted\n  - pvcreate\n  - vgcreate\n  - lvcreate\n  - mkfs\n  - mount\n\n然后简单了解磁盘分区的原理\n\n- MBR\n- GPT\n\n最后是操作磁盘时可能遇到的各种问题。例如机器添加磁盘后系统层面没有显示、已分区没做逻辑卷的磁盘扩容、曾经使用过的磁盘换到新机器使用报错、已删除文件`df -h`仍然显示占用、挂载类似nfs等网络盘时操作卡顿、实际占用与显示不符等等...\n\n\n\n## 磁盘信息查看\n\n### 1. 查看磁盘使用量 -- display file system\n\n   ```bash\ndf -h # 二进制计算方式，以人类友好形式显示，如1024M=1G\ndf -l # 只列出本地文件系统，即排除nfs或其他类似的如nas盘存储挂载\ndf -T # 显示挂载类型\ndf -H # 十进制计算方式，以人类友好形式显示，如1000M=1G\ndf -t xfs # 指定显示xfs类型的挂载\ndf -i\n   ```\n\n\n\n### 2. 查看磁盘分区挂载信息 -- list block\n\n   ```bash\nlsblk\nlsblk -l \n   ```\n\n   使用`lsblk`输出如下:\n\n   ```\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsda       8:0    0   15G  0 disk\n├─sda1    8:1    0   14G  0 part /\n├─sda14   8:14   0    4M  0 part\n├─sda15   8:15   0  106M  0 part /boot/efi\n└─sda16 259:0    0  913M  0 part /boot\nsr0      11:0    1   54K  0 rom\n   ```\n\n   \n\n\n### 3. 查看具体文件或目录大小 -- disk usage\n\n   ```bash\ndu -sh # 计算总大小\ndu -ahd 0 # 与上述相同\ndu -sh * # 计算当前目录下所有文件具体大小，最后计算出总值，并以人类友好形式输出\ndu -ahd 1 # 与上述相同\n# -d 在有某些版本不可用，需要换成--max-depth 1\ndu -ahd 1 --time # 显示文件或目录修改时间\ndu -ahd 1 --time | sort -h ## 以人类友好形式进行排序输出\ndu -ahd 1 ./ -x ./ # 跳过不同文件系统的目录，经常可以用来规避nfs这类网络挂载\n   ```\n\n\n\n### 4. 其他命令\n\n   ```bash\nblkid ## block id, 可以用来查看uuid及文件系统类型\n## 以下命令可以用来查看分区情况\nfdisk -l \ngdisk -l\nparted /dev/vda print\n   ```\n\n\n\n   ## 磁盘分区、格式化、挂载\n\n> 磁盘有价，数据无价，对磁盘进行分区、扩容操作时请务必做好数据备份！！！\n\n### 1. 分区\n\n一般分区有两种常用形式，`GPT`和`MBR`\n\nMBR格式最多只能有四个主分区，若想继续分区就需要建立逻辑分区。\n\nGPT格式没有分区限制，建议使用GPT分区\n\n1. **fdisk**\n\nfdisk使用方法如下，进入交互式命令行后，用`p`查看磁盘信息，`n`新建分区，下面的操作无特殊指定回车即可。\n\n如有指定，一般起始扇区默认即可，结束扇区可用`+10G`类似写法指定，`+`号是在现有基础上增加空间。\n\n有时候缩容操作（一般不考虑缩容）不会指定+号，直接指定大小而不是在原基础上增加。\n\n```bash\nroot@docker:~# fdisk /dev/sda\n\nWelcome to fdisk (util-linux 2.39.3).\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n\nPartition number (2-13,17-128, default 2):\nFirst sector (33556480-52428766, default 33556480):\nLast sector, +/-sectors or +/-size{K,M,G,T,P} (33556480-52428766, default 52426751):\n\nCreated a new partition 2 of type 'Linux filesystem' and of size 9 GiB.\n\nCommand (m for help): p\nDisk /dev/sda: 25 GiB, 26843545600 bytes, 52428800 sectors\nDisk model: VBOX HARDDISK\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: A102F557-254C-4E8A-BB7B-5CE2CBC42B40\n\nDevice        Start      End  Sectors  Size Type\n/dev/sda1   2099200 33556479 31457280   15G Linux filesystem\n/dev/sda2  33556480 52426751 18870272    9G Linux filesystem\n/dev/sda14     2048    10239     8192    4M BIOS boot\n/dev/sda15    10240   227327   217088  106M EFI System\n/dev/sda16   227328  2097152  1869825  913M Linux extended boot\n\nPartition table entries are not in disk order.\n\nCommand (m for help): w\nThe partition table has been altered.\nSyncing disks.\n```\n\n\n\n2. **gdisk**\n\ngdisk的操作类似于fdisk，多了一步需要输入Hex code，可回车默认。\n\n如果保存退出后`lsblk`查看不到分区，可使用`partprobe`刷新分区表\n\n```bash\nroot@docker:~# gdisk /dev/sda\nGPT fdisk (gdisk) version 1.0.10\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\n\nCommand (? for help): p\nDisk /dev/sda: 52428800 sectors, 25.0 GiB\nModel: VBOX HARDDISK\nSector size (logical/physical): 512/512 bytes\nDisk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40\nPartition table holds up to 128 entries\nMain partition table begins at sector 2 and ends at sector 33\nFirst usable sector is 34, last usable sector is 52428766\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 18876348 sectors (9.0 GiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1         2099200        33556479   15.0 GiB    8300\n  14            2048           10239   4.0 MiB     EF02\n  15           10240          227327   106.0 MiB   EF00\n  16          227328         2097152   913.0 MiB   EA00\n\nCommand (? for help): n\nPartition number (2-128, default 2):\nFirst sector (34-52428766, default = 33556480) or {+-}size{KMGTP}:\nLast sector (33556480-52428766, default = 52426751) or {+-}size{KMGTP}: +8G\nCurrent type is 8300 (Linux filesystem)\nHex code or GUID (L to show codes, Enter = 8300): 8e00\nChanged type of partition to 'Linux LVM'\n\nCommand (? for help): p\nDisk /dev/sda: 52428800 sectors, 25.0 GiB\nModel: VBOX HARDDISK\nSector size (logical/physical): 512/512 bytes\nDisk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40\nPartition table holds up to 128 entries\nMain partition table begins at sector 2 and ends at sector 33\nFirst usable sector is 34, last usable sector is 52428766\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2099132 sectors (1025.0 MiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1         2099200        33556479   15.0 GiB    8300\n   2        33556480        50333695   8.0 GiB     8E00  Linux LVM\n  14            2048           10239   4.0 MiB     EF02\n  15           10240          227327   106.0 MiB   EF00\n  16          227328         2097152   913.0 MiB   EA00\n\nCommand (? for help): w\n\nFinal checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING\nPARTITIONS!!\n\nDo you want to proceed? (Y/N): y\nOK; writing new GUID partition table (GPT) to /dev/sda.\nWarning: The kernel is still using the old partition table.\nThe new table will be used at the next reboot or after you\nrun partprobe(8) or kpartx(8)\nThe operation has completed successfully.\n\nroot@docker:~# lsblk\nNAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nloop0     7:0    0    4K  1 loop /snap/bare/5\nloop1     7:1    0 74.2M  1 loop /snap/core22/1380\nloop2     7:2    0    1M  1 loop /snap/multipass-sshfs/145\nloop3     7:3    0 38.8M  1 loop /snap/snapd/21759\nsda       8:0    0   25G  0 disk\n├─sda1    8:1    0   15G  0 part /\n├─sda14   8:14   0    4M  0 part\n├─sda15   8:15   0  106M  0 part /boot/efi\n└─sda16 259:0    0  913M  0 part /boot\nsr0      11:0    1   54K  0 rom\nroot@docker:~# partprobe -s\n```\n\n\n\n3. **parted**\n\n> 需谨慎使用，该命令操作会直接生效，不像gdisk、fdisk先将数据写入内存\n\n`parted` 命令也可以直接运行进入类似`fdisk`的交互式界面，但本人更习惯直接命令行操作\n\n分区三步法：\n   1. 设置分区形式 - mklabel\n   2. 设置分区大小 - mkpart\n      - mkpart的开始分区从第2048个扇区开始，也就是1024kb,给头部信息留足空间\n   3. 按需格式化磁盘或做成pv卷扩容\n\n```bash\n## 指定分区形式以及分区名和大小\nparted /dev/sda mklabel gpt mkpart primary 1024kb 100%\n## 更倾向于用扇区来指定大小，假设上一个分区的结束扇区为227328，则新分区可以+1从227329扇区开始。\n## 此处会自动调整结束扇区，因为磁盘尾还需要存放GPT备份表\nparted /dev/sda mklabel gpt mkpart primary 227329s 100%\n```\n\n### 2. 格式化\n\n一个磁盘分区完后还不能直接挂载使用，还需要进行文件系统格式化，格式化完成后才能挂载使用。\n\n一般常见的为xfs、ext4格式，建议使用xfs格式，对应的命令为\n\n```bash\nmkfs.xfs /dev/sda1\nmkfs.ext4 /dev/sda1\n\n## 格式化完成后可以用blkid查看信息\nblkid /dev/sda1 \n```\n\n### 3. 挂载\n\n挂载可以是临时挂载，也可以开机自动挂载\n\n- 临时挂载\n\n  关机重启挂载消失\n\n  ```bash\n  mount -t xfs /dev/sda2 /tmp\n  ```\n\n- 开机自动挂载\n\n  将挂载写入`/etc/fstab`文件即可实现开机自挂载\n\n  ```bash\n  echo \"/dev/sda2   /tmp        xfs   defaults     0 0\" >> /etc/fstab\n  ```\n\n### 4. 制作逻辑卷\n\nLVM允许系统将多个物理硬盘或分区组合成一个逻辑卷组，‌从而形成一个大的存储池。利用逻辑卷的特性可以实现跨盘扩容，因此在制作逻辑卷的时候最好使用性能相近的磁盘，否则将会影响逻辑卷整体性能。\n\n```bash\n## 先将某块磁盘或分区创建为PV\npvcreate /dev/sda\n## 将sda创建一个名为vg1的卷组\nvgcreate vg1 /dev/sda\n## 在vg1卷组创建一个名为lv1的逻辑卷，将所有vg1空间都使用\nlvcreate -l +100%free -n lv1 vg1\n## 在vg1卷组创建一个名为lv1,大小为40G的逻辑卷\nlvcreate -L 40G -n lv1 vg1\n## 制作文件系统\nmkfs.xfs /dev/vg1/lv1\n## 挂载，同样可以写入fstab\nmount /dev/vg1/lv1 /root/tmp/\n```\n\n### 5. 磁盘扩容\n\n通常磁盘需要做逻辑卷或者处于最后一个分区的时候进行扩容是最方便的。\n\n扩容前一定必须做好备份！！！\n\n1. 逻辑卷扩容\n\n```bash\n## 首先加入pv\npvcreate /dev/sda\n## 然后扩展vg\nvgextend vg1 /dev/sda\n## 扩充lv\n## +号必须有，不然就变成了调整lv大小，造成数据丢失\nlvextend -l +100%free /dev/vg1/lv1\nlvextend -L +20G /dev/vg1/lv1\n## 同步文件系统\n## xfs \nxfs_growfs /dev/vg1/lv1\n## ext4\nresize2fs /dev/vg1/lv1\n```\n\n2. 没分区的整块盘\n\n```bash\n## 可以直接同步文件系统\nxfs_growfs /dev/sda\nresize2fs /dev/sda\n```\n\n\n\n## 磁盘分区类型及原理\n\n#### MBR（Master Boot Record）分区格式\n\n早期磁盘第一个扇区（`521bytes`）里面包含重要的信息`MBR（Master Boot Record）`，其中`446 bytes`，安装开机管理程序的地方；剩下的`64bytes`记录硬盘分区的数据，即分区表，如图\n\n![mbr](../images/Linux-disk-base/MBR.png)\n\n由于分区表所在区块仅有64bytes容量，因此最多仅能有四组记录区，每组记录区记录了该区段的起始与结束的磁柱号码。\n\n也就是MBR只支持四个主分区，且最大只支持2TB的硬盘。\n\n若想多个分区，需要使用扩展分区，扩展分区从5开始计数。\n\n#### GPT（GUID Partition Table）分区格式\n\nGPT将磁盘划分为一块块的`逻辑区块地址（Logical Block Address，简称LBA）` 来处理，每个LBA预设计为512bytes，即一个扇区的大小；同时改进MBR之用一块扇区来标识分区表的弊端，GPT使用了前后各34个LBA来标识分区表信息（最后的34各区可以理解为备份，达到高可用），如图\n\n![gpt](../images/Linux-disk-base/GPT.png)\n\n LBA的标识是从0开始的，LBA0-34共35块，这里分别阐述下其含义:\n\n- `LBA0` :包含两部分，一部分是类似MBR的446bytes,存储开机管理程序，第二部分则是存储一个特殊的标记，标识该磁盘为GPT格式，而看不懂GPT分区的程序则无法操作该磁盘，起到保护作用，放心，目前基本的管理程序都能识别GPT格式，所以该LBA块实际上与分区信息并无直接关联，这就是为啥不算入34LBA的原因\n- `LBA1` :GPT的表头，记录分区本身的位置与大小，同时记录分区在备份中最后34个LBA中的位置，方便恢复\n- `LBA2-34`:共32块LBA，每块LBA记录4笔分区表，共支持4\\*32=128笔分区；而每个LBA默认为512bytes，则每笔记录用到512/4=128bytes,每笔记录拿出64bytes来记录开始、结束的扇区号码，因此对一个单一分区槽而言，支持的最大容量为2^64∗512bytes=2^63∗1Kbytes=2^33TB=8ZB\n\n> 1024TB=1PB \\\n> 1024PB=1EB \\\n> 1024EB=1ZB\n\n\n\n# 其他事项\n\n## 1. 已添加磁盘无法识别\n\n有时候机房加了磁盘可能不会在系统层面立即显示出来，需要重启服务器，也可以重新扫描下scsi总线\n\n```bash\nfor i in /sys/class/scsi_host/*/scan; do echo $i;echo \"- - -\" > $i; done\n```\n\n\n\n## 2. 已分区没做lvm的磁盘扩容\n\n有时候我们会遇到项目组在原磁盘上加空间，而想要扩容的那个分区是没有做逻辑卷的，以至于加的空间会浪费，下面有两种方案，其一是`fdisk`的一种特殊用法，其二是提供一个工具`growpart`，可以对没有做过逻辑卷的分区进行扩容。\n\n两种方案都需要该分区必需是整个磁盘的最后一个分区\n\n- 其一，使用`fdisk`扩容。因为fdisk在进行操作的时候分区数据不会直接写入磁盘，而是先会保存在内存中，所以可以利用这点来进行扩容\n\n  ```bash\n  fdisk /dev/sda\n  ## 进入后用p查看分区\n  ## 按d 删除最后一个分区\n  ## 然后再n，创建新分区。\n  ## 新分区的大小必须比原来的分区大，不能缩小，否则会造成数据丢失\n  ## 最后w保存，然后xfs_growf或resize2fs同步对应文件系统即可\n  ```\n  \n- 其二，可使用`growpart`来进行扩容\n\n   ```bash\n   # 联网条件下\n   yum install cloud-utils-growpart\n   # 没联网就传包吧\n   rpm -ivhU cloud-utils-growpart.rpm\n   # 如服务器有一块盘vda，仅有一个分区vda1，且没做过逻辑卷\n   # 先用growpart将空间加到vda1上\n   ## 表示对/dev/sda的分区1进行扩容\n   growpart /dev/vda 1\n   ## 如果报错 unexpected output in sfdisk --version\n   ## LANG=en_US.UTF-8 就可以了,不行可以重启下物理机试一下.(编码问题)\n   # 然后同步文件系统即可\n   xfs_growfs /\n   resize2fs /dev/vda1\n   ```\n\n**案例**\n\n>由于没有找到现成的做了分区而没做lvm的项目，但是步骤是一样的。\n\n![gdisk_caution](../images/Linux-disk-base/20221031165313.jpg)\n\n\n## 3. 旧磁盘换到新机器无法使用\n\n面对这个情况其实如果在确定磁盘里面的数据进行了备份，或者不需要的时候可以直接进行强制格式化。\n\n也可以`dd`去备份一下磁盘头和磁盘尾信息，或者整个磁盘。\n\n如下有一个磁盘sda，通过parted查看磁盘信息，这里建议把unit切换成s单位来看会更精确更清楚些。\n\n```shell\nroot@docker:~# parted /dev/sda u s p\nModel: ATA VBOX HARDDISK (scsi)\nDisk /dev/sda: 31457280s\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start     End        Size       File system  Name  Flags\n14      2048s     10239s     8192s                         bios_grub\n15      10240s    227327s    217088s    fat32              boot, esp\n16      227328s   2097152s   1869825s   ext4               bls_boot\n 1      2099200s  31457246s  29358047s  ext4\n```\n\n在这个输出中可以看到磁盘总大小31457280个扇区，磁盘实际分配到第31457246个扇区结束，`31457280-31457246=34`，也就是刚好留下了GPT格式备份的34个LBA。\n\n```bash\n## dd默认1count为512B，与扇区size对应\n## 备份前34个扇区\ndd if=/dev/sda of=~/sda.img.bak count=34\n## 跳过前面31457246个扇区进行备份\ndd if=/dev/sda of=~/sda.img.bak skip=31457246\n```\n\n如下输出可见备份了最后34个扇区\n\n\n```shell\nroot@docker:~# dd if=/dev/sda of=~/sda.end.bak skip=31457246\n34+0 records in\n34+0 records out\n17408 bytes (17 kB, 17 KiB) copied, 0.000214267 s, 81.2 MB/s\n```\n\n备份好后可以直接用`dd`命令把磁头磁尾清空即可\n\n```bash\ndd if=/dev/zero of=/dev/sda count=34\ndd if=/dev/zero of=/dev/sda skip=31457246\n```\n\n\n\n## 4. 已删除文件占用空间\n\n这种情况一般是有进程在占用被删除的文件，从而导致空间未释放\n\n```bash\n## 可使用lsof来排查，找到对应的pid\nlsof | grep deleted\n## 非业务时间段可以通过 kill对应进程来释放\n## 但业务时间段肯定不能这样操作\n## 所以有了第二种方法\nls -l /proc/$pid/fd/* | grep $filename\necho > /proc/$pid/fd/$fdnum\n```\n\n## 5. 实际占用与显示不符\n\n一可能是前面说的已删除文件后`df`没有变化\n\n二可能是覆盖挂载\n\n三可能是计算的时候没有排除网络挂载\n\n前面已经介绍过第一种处理办法，下面介绍后面两种\n\n对于覆盖挂载可以在非业务时间将异常挂载的目录先卸载下来，然后去看看卸载后的该目录下面是否有文件，如有文件占用空间则属于覆盖挂载。\n\n对于网络挂载，可以在使用`du`命令的时候使用`-x`选项来进行排除（前面有介绍过），便可计算出当前本地的准确值。\n\n## 6. 由MBR (MSDOS) 格式转GPT\n**场景**\n\nMBR分区只支持四个主分区，因此，当有人在第四个分区不用逻辑分区而继续用主分区的话将无法再进行分区，且最大只能操作2T空间的磁盘，所以在面对这种四个主分区都用满或磁盘空间超过2T的情况下，需要将磁盘格式转成GPT后才能进一步进行分区和扩容。\n\n**前提条件**\n\n磁盘头信息需要留足空间转换成GPT分区，start最小需要从第63个扇区开始。\n\n可以自己模拟下，用parted工具进行分区，第一个分区头从0开始，命令如下。\n\n```bash\nparted /dev/vdx mklabel msdos/gpt mkpart primary 0 100%\n```\n\n如果使用的label是mbr则会默认从63s开始，如果是gpt，则会从34s开始。\n\n![mbr_default](../images/Linux-disk-base/078092image.png)\n\n![gpt_default](../images/Linux-disk-base/098712image.png)\n\n如果用的是gdisk和fdisk分区，默认是从2048s开始，所以完全够从mbr转换成gpt格式。\n\n但是需要注意磁盘末尾是否还有空间，因为MBR末尾并不记录信息，所以当磁盘100%时也就是空间完全没有了，此时进行gpt转换可能造成尾部数据丢失。\n\n![fdisk_default](../images/Linux-disk-base/052384image.png)\n\n- 先备份分区表信息\n\n```bash\n# 备份分区表信息\n# 最好选择另外的盘进行备份\ndd if=/dev/vda of=/xxxx/xxx.mbr.bak  bs=1024 count=2000\n# 恢复分区表信息\ndd if=/home/xxx.mbr.bak  of=/dev/vda bs=1024 count=2000\n```\n\n- 使用gdisk将分区格式转换为gpt\n\n![gdisk_default](../images/Linux-disk-base/016511image.png)\n\n\n## 7. 新磁盘残留GPT分区信息导致无法分区扩容\n\n> 类似第三点\n\n当项目组拿来新磁盘，要求分区扩容时，碰到如下提示gpt备份区信息与主分区信息不一致的提示时，考虑是该磁盘是曾经做过分区的盘。\n\n![gdisk_caution](../images/Linux-disk-base/20221029005856.png)\n\n先与项目组确认是否是新盘无数据，当确认是新盘无数据后，可用`dd`命令去清空头尾记录的分区信息，一般取首尾1M左右即可，清空完后就可以按正常流程进行分区。\n\n```bash\n# 如项目组有893G磁盘\n# 清空头部信息\ndd if=/dev/zero of=/dev/sdb bs=512 count=4000\n# 清空尾部信息\ndd if=/dev/zero of=/dev/sdb bs=1M seek=890000\n# seek参数为跳过sdb的第890000个block，即将if的内容从第890000个block后开始写入\n```","slug":"Linux-disk-base","published":1,"updated":"2024-08-08T10:21:57.043Z","_id":"clzkkh3yi0002uhuqdzi3hgca","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"Linux-磁盘基础\"><a href=\"#Linux-磁盘基础\" class=\"headerlink\" title=\"Linux 磁盘基础\"></a>Linux 磁盘基础</h1><p>先从如何使用开始</p>\n<ul>\n<li><p>如何查磁盘占用大小及基本信息</p>\n<p>将会用到的命令：</p>\n<ul>\n<li>df</li>\n<li>lsblk</li>\n<li>du</li>\n<li>blkid</li>\n</ul>\n</li>\n<li><p>如何进行磁盘分区、制作逻辑卷、格式化、挂载</p>\n<p>将会用到的命令：</p>\n<ul>\n<li>fdisk</li>\n<li>gdisk</li>\n<li>parted</li>\n<li>pvcreate</li>\n<li>vgcreate</li>\n<li>lvcreate</li>\n<li>mkfs</li>\n<li>mount</li>\n</ul>\n</li>\n</ul>\n<p>然后简单了解磁盘分区的原理</p>\n<ul>\n<li>MBR</li>\n<li>GPT</li>\n</ul>\n<p>最后是操作磁盘时可能遇到的各种问题。例如机器添加磁盘后系统层面没有显示、已分区没做逻辑卷的磁盘扩容、曾经使用过的磁盘换到新机器使用报错、已删除文件<code>df -h</code>仍然显示占用、挂载类似nfs等网络盘时操作卡顿、实际占用与显示不符等等…</p>\n<h2 id=\"磁盘信息查看\"><a href=\"#磁盘信息查看\" class=\"headerlink\" title=\"磁盘信息查看\"></a>磁盘信息查看</h2><h3 id=\"1-查看磁盘使用量-–-display-file-system\"><a href=\"#1-查看磁盘使用量-–-display-file-system\" class=\"headerlink\" title=\"1. 查看磁盘使用量 – display file system\"></a>1. 查看磁盘使用量 – display file system</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">df</span> -h <span class=\"hljs-comment\"># 二进制计算方式，以人类友好形式显示，如1024M=1G</span><br><span class=\"hljs-built_in\">df</span> -l <span class=\"hljs-comment\"># 只列出本地文件系统，即排除nfs或其他类似的如nas盘存储挂载</span><br><span class=\"hljs-built_in\">df</span> -T <span class=\"hljs-comment\"># 显示挂载类型</span><br><span class=\"hljs-built_in\">df</span> -H <span class=\"hljs-comment\"># 十进制计算方式，以人类友好形式显示，如1000M=1G</span><br><span class=\"hljs-built_in\">df</span> -t xfs <span class=\"hljs-comment\"># 指定显示xfs类型的挂载</span><br><span class=\"hljs-built_in\">df</span> -i<br></code></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"2-查看磁盘分区挂载信息-–-list-block\"><a href=\"#2-查看磁盘分区挂载信息-–-list-block\" class=\"headerlink\" title=\"2. 查看磁盘分区挂载信息 – list block\"></a>2. 查看磁盘分区挂载信息 – list block</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">lsblk<br>lsblk -l <br></code></pre></td></tr></table></figure>\n\n<p>   使用<code>lsblk</code>输出如下:</p>\n   <figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs tap\">NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS<br>sda       8:0   <span class=\"hljs-number\"> 0 </span>  15G <span class=\"hljs-number\"> 0 </span>disk<br>├─sda1    8:1   <span class=\"hljs-number\"> 0 </span>  14G <span class=\"hljs-number\"> 0 </span>part /<br>├─sda14   8:14  <span class=\"hljs-number\"> 0 </span>   4M <span class=\"hljs-number\"> 0 </span>part<br>├─sda15   8:15  <span class=\"hljs-number\"> 0 </span> 106M <span class=\"hljs-number\"> 0 </span>part /boot/efi<br>└─sda16 259:0   <span class=\"hljs-number\"> 0 </span> 913M <span class=\"hljs-number\"> 0 </span>part /boot<br>sr0      11:0   <span class=\"hljs-number\"> 1 </span>  54K <span class=\"hljs-number\"> 0 </span>rom<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-查看具体文件或目录大小-–-disk-usage\"><a href=\"#3-查看具体文件或目录大小-–-disk-usage\" class=\"headerlink\" title=\"3. 查看具体文件或目录大小 – disk usage\"></a>3. 查看具体文件或目录大小 – disk usage</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">du</span> -sh <span class=\"hljs-comment\"># 计算总大小</span><br><span class=\"hljs-built_in\">du</span> -ahd 0 <span class=\"hljs-comment\"># 与上述相同</span><br><span class=\"hljs-built_in\">du</span> -sh * <span class=\"hljs-comment\"># 计算当前目录下所有文件具体大小，最后计算出总值，并以人类友好形式输出</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 <span class=\"hljs-comment\"># 与上述相同</span><br><span class=\"hljs-comment\"># -d 在有某些版本不可用，需要换成--max-depth 1</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 --time <span class=\"hljs-comment\"># 显示文件或目录修改时间</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 --time | <span class=\"hljs-built_in\">sort</span> -h <span class=\"hljs-comment\">## 以人类友好形式进行排序输出</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 ./ -x ./ <span class=\"hljs-comment\"># 跳过不同文件系统的目录，经常可以用来规避nfs这类网络挂载</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"4-其他命令\"><a href=\"#4-其他命令\" class=\"headerlink\" title=\"4. 其他命令\"></a>4. 其他命令</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">blkid <span class=\"hljs-comment\">## block id, 可以用来查看uuid及文件系统类型</span><br><span class=\"hljs-comment\">## 以下命令可以用来查看分区情况</span><br>fdisk -l <br>gdisk -l<br>parted /dev/vda <span class=\"hljs-built_in\">print</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"磁盘分区、格式化、挂载\"><a href=\"#磁盘分区、格式化、挂载\" class=\"headerlink\" title=\"磁盘分区、格式化、挂载\"></a>磁盘分区、格式化、挂载</h2><blockquote>\n<p>磁盘有价，数据无价，对磁盘进行分区、扩容操作时请务必做好数据备份！！！</p>\n</blockquote>\n<h3 id=\"1-分区\"><a href=\"#1-分区\" class=\"headerlink\" title=\"1. 分区\"></a>1. 分区</h3><p>一般分区有两种常用形式，<code>GPT</code>和<code>MBR</code></p>\n<p>MBR格式最多只能有四个主分区，若想继续分区就需要建立逻辑分区。</p>\n<p>GPT格式没有分区限制，建议使用GPT分区</p>\n<ol>\n<li><strong>fdisk</strong></li>\n</ol>\n<p>fdisk使用方法如下，进入交互式命令行后，用<code>p</code>查看磁盘信息，<code>n</code>新建分区，下面的操作无特殊指定回车即可。</p>\n<p>如有指定，一般起始扇区默认即可，结束扇区可用<code>+10G</code>类似写法指定，<code>+</code>号是在现有基础上增加空间。</p>\n<p>有时候缩容操作（一般不考虑缩容）不会指定+号，直接指定大小而不是在原基础上增加。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">root@docker:~# fdisk /dev/sda<br><br>Welcome to fdisk (util-linux 2.39.3).<br>Changes will remain <span class=\"hljs-keyword\">in</span> memory only, <span class=\"hljs-keyword\">until</span> you decide to write them.<br>Be careful before using the write <span class=\"hljs-built_in\">command</span>.<br><br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): n<br>Partition number (2-13,17-128, default 2):<br>First sector (33556480-52428766, default 33556480):<br>Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (33556480-52428766, default 52426751):<br><br>Created a new partition 2 of <span class=\"hljs-built_in\">type</span> <span class=\"hljs-string\">&#x27;Linux filesystem&#x27;</span> and of size 9 GiB.<br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 25 GiB, 26843545600 bytes, 52428800 sectors<br>Disk model: VBOX HARDDISK<br>Units: sectors of 1 * 512 = 512 bytes<br>Sector size (logical/physical): 512 bytes / 512 bytes<br>I/O size (minimum/optimal): 512 bytes / 512 bytes<br>Disklabel <span class=\"hljs-built_in\">type</span>: gpt<br>Disk identifier: A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br><br>Device        Start      End  Sectors  Size Type<br>/dev/sda1   2099200 33556479 31457280   15G Linux filesystem<br>/dev/sda2  33556480 52426751 18870272    9G Linux filesystem<br>/dev/sda14     2048    10239     8192    4M BIOS boot<br>/dev/sda15    10240   227327   217088  106M EFI System<br>/dev/sda16   227328  2097152  1869825  913M Linux extended boot<br><br>Partition table entries are not <span class=\"hljs-keyword\">in</span> disk order.<br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): w<br>The partition table has been altered.<br>Syncing disks.<br></code></pre></td></tr></table></figure>\n\n\n\n<ol start=\"2\">\n<li><strong>gdisk</strong></li>\n</ol>\n<p>gdisk的操作类似于fdisk，多了一步需要输入Hex code，可回车默认。</p>\n<p>如果保存退出后<code>lsblk</code>查看不到分区，可使用<code>partprobe</code>刷新分区表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">root@docker:~# gdisk /dev/sda<br>GPT fdisk (gdisk) version 1.0.10<br><br>Partition table scan:<br>  MBR: protective<br>  BSD: not present<br>  APM: not present<br>  GPT: present<br><br>Found valid GPT with protective MBR; using GPT.<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 52428800 sectors, 25.0 GiB<br>Model: VBOX HARDDISK<br>Sector size (logical/physical): 512/512 bytes<br>Disk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br>Partition table holds up to 128 entries<br>Main partition table begins at sector 2 and ends at sector 33<br>First usable sector is 34, last usable sector is 52428766<br>Partitions will be aligned on 2048-sector boundaries<br>Total free space is 18876348 sectors (9.0 GiB)<br><br>Number  Start (sector)    End (sector)  Size       Code  Name<br>   1         2099200        33556479   15.0 GiB    8300<br>  14            2048           10239   4.0 MiB     EF02<br>  15           10240          227327   106.0 MiB   EF00<br>  16          227328         2097152   913.0 MiB   EA00<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): n<br>Partition number (2-128, default 2):<br>First sector (34-52428766, default = 33556480) or &#123;+-&#125;size&#123;KMGTP&#125;:<br>Last sector (33556480-52428766, default = 52426751) or &#123;+-&#125;size&#123;KMGTP&#125;: +8G<br>Current <span class=\"hljs-built_in\">type</span> is 8300 (Linux filesystem)<br>Hex code or GUID (L to show codes, Enter = 8300): 8e00<br>Changed <span class=\"hljs-built_in\">type</span> of partition to <span class=\"hljs-string\">&#x27;Linux LVM&#x27;</span><br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 52428800 sectors, 25.0 GiB<br>Model: VBOX HARDDISK<br>Sector size (logical/physical): 512/512 bytes<br>Disk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br>Partition table holds up to 128 entries<br>Main partition table begins at sector 2 and ends at sector 33<br>First usable sector is 34, last usable sector is 52428766<br>Partitions will be aligned on 2048-sector boundaries<br>Total free space is 2099132 sectors (1025.0 MiB)<br><br>Number  Start (sector)    End (sector)  Size       Code  Name<br>   1         2099200        33556479   15.0 GiB    8300<br>   2        33556480        50333695   8.0 GiB     8E00  Linux LVM<br>  14            2048           10239   4.0 MiB     EF02<br>  15           10240          227327   106.0 MiB   EF00<br>  16          227328         2097152   913.0 MiB   EA00<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): w<br><br>Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING<br>PARTITIONS!!<br><br>Do you want to proceed? (Y/N): y<br>OK; writing new GUID partition table (GPT) to /dev/sda.<br>Warning: The kernel is still using the old partition table.<br>The new table will be used at the next reboot or after you<br>run partprobe(8) or kpartx(8)<br>The operation has completed successfully.<br><br>root@docker:~# lsblk<br>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS<br>loop0     7:0    0    4K  1 loop /snap/bare/5<br>loop1     7:1    0 74.2M  1 loop /snap/core22/1380<br>loop2     7:2    0    1M  1 loop /snap/multipass-sshfs/145<br>loop3     7:3    0 38.8M  1 loop /snap/snapd/21759<br>sda       8:0    0   25G  0 disk<br>├─sda1    8:1    0   15G  0 part /<br>├─sda14   8:14   0    4M  0 part<br>├─sda15   8:15   0  106M  0 part /boot/efi<br>└─sda16 259:0    0  913M  0 part /boot<br>sr0      11:0    1   54K  0 rom<br>root@docker:~# partprobe -s<br></code></pre></td></tr></table></figure>\n\n\n\n<ol start=\"3\">\n<li><strong>parted</strong></li>\n</ol>\n<blockquote>\n<p>需谨慎使用，该命令操作会直接生效，不像gdisk、fdisk先将数据写入内存</p>\n</blockquote>\n<p><code>parted</code> 命令也可以直接运行进入类似<code>fdisk</code>的交互式界面，但本人更习惯直接命令行操作</p>\n<p>分区三步法：</p>\n<ol>\n<li>设置分区形式 - mklabel</li>\n<li>设置分区大小 - mkpart<ul>\n<li>mkpart的开始分区从第2048个扇区开始，也就是1024kb,给头部信息留足空间</li>\n</ul>\n</li>\n<li>按需格式化磁盘或做成pv卷扩容</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 指定分区形式以及分区名和大小</span><br>parted /dev/sda mklabel gpt mkpart primary 1024kb 100%<br><span class=\"hljs-comment\">## 更倾向于用扇区来指定大小，假设上一个分区的结束扇区为227328，则新分区可以+1从227329扇区开始。</span><br><span class=\"hljs-comment\">## 此处会自动调整结束扇区，因为磁盘尾还需要存放GPT备份表</span><br>parted /dev/sda mklabel gpt mkpart primary 227329s 100%<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-格式化\"><a href=\"#2-格式化\" class=\"headerlink\" title=\"2. 格式化\"></a>2. 格式化</h3><p>一个磁盘分区完后还不能直接挂载使用，还需要进行文件系统格式化，格式化完成后才能挂载使用。</p>\n<p>一般常见的为xfs、ext4格式，建议使用xfs格式，对应的命令为</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mkfs.xfs /dev/sda1<br>mkfs.ext4 /dev/sda1<br><br><span class=\"hljs-comment\">## 格式化完成后可以用blkid查看信息</span><br>blkid /dev/sda1 <br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-挂载\"><a href=\"#3-挂载\" class=\"headerlink\" title=\"3. 挂载\"></a>3. 挂载</h3><p>挂载可以是临时挂载，也可以开机自动挂载</p>\n<ul>\n<li><p>临时挂载</p>\n<p>关机重启挂载消失</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mount -t xfs /dev/sda2 /tmp<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>开机自动挂载</p>\n<p>将挂载写入<code>/etc/fstab</code>文件即可实现开机自挂载</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;/dev/sda2   /tmp        xfs   defaults     0 0&quot;</span> &gt;&gt; /etc/fstab<br></code></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-制作逻辑卷\"><a href=\"#4-制作逻辑卷\" class=\"headerlink\" title=\"4. 制作逻辑卷\"></a>4. 制作逻辑卷</h3><p>LVM允许系统将多个物理硬盘或分区组合成一个逻辑卷组，‌从而形成一个大的存储池。利用逻辑卷的特性可以实现跨盘扩容，因此在制作逻辑卷的时候最好使用性能相近的磁盘，否则将会影响逻辑卷整体性能。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 先将某块磁盘或分区创建为PV</span><br>pvcreate /dev/sda<br><span class=\"hljs-comment\">## 将sda创建一个名为vg1的卷组</span><br>vgcreate vg1 /dev/sda<br><span class=\"hljs-comment\">## 在vg1卷组创建一个名为lv1的逻辑卷，将所有vg1空间都使用</span><br>lvcreate -l +100%free -n lv1 vg1<br><span class=\"hljs-comment\">## 在vg1卷组创建一个名为lv1,大小为40G的逻辑卷</span><br>lvcreate -L 40G -n lv1 vg1<br><span class=\"hljs-comment\">## 制作文件系统</span><br>mkfs.xfs /dev/vg1/lv1<br><span class=\"hljs-comment\">## 挂载，同样可以写入fstab</span><br>mount /dev/vg1/lv1 /root/tmp/<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-磁盘扩容\"><a href=\"#5-磁盘扩容\" class=\"headerlink\" title=\"5. 磁盘扩容\"></a>5. 磁盘扩容</h3><p>通常磁盘需要做逻辑卷或者处于最后一个分区的时候进行扩容是最方便的。</p>\n<p>扩容前一定必须做好备份！！！</p>\n<ol>\n<li>逻辑卷扩容</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 首先加入pv</span><br>pvcreate /dev/sda<br><span class=\"hljs-comment\">## 然后扩展vg</span><br>vgextend vg1 /dev/sda<br><span class=\"hljs-comment\">## 扩充lv</span><br><span class=\"hljs-comment\">## +号必须有，不然就变成了调整lv大小，造成数据丢失</span><br>lvextend -l +100%free /dev/vg1/lv1<br>lvextend -L +20G /dev/vg1/lv1<br><span class=\"hljs-comment\">## 同步文件系统</span><br><span class=\"hljs-comment\">## xfs </span><br>xfs_growfs /dev/vg1/lv1<br><span class=\"hljs-comment\">## ext4</span><br>resize2fs /dev/vg1/lv1<br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>没分区的整块盘</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可以直接同步文件系统</span><br>xfs_growfs /dev/sda<br>resize2fs /dev/sda<br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"磁盘分区类型及原理\"><a href=\"#磁盘分区类型及原理\" class=\"headerlink\" title=\"磁盘分区类型及原理\"></a>磁盘分区类型及原理</h2><h4 id=\"MBR（Master-Boot-Record）分区格式\"><a href=\"#MBR（Master-Boot-Record）分区格式\" class=\"headerlink\" title=\"MBR（Master Boot Record）分区格式\"></a>MBR（Master Boot Record）分区格式</h4><p>早期磁盘第一个扇区（<code>521bytes</code>）里面包含重要的信息<code>MBR（Master Boot Record）</code>，其中<code>446 bytes</code>，安装开机管理程序的地方；剩下的<code>64bytes</code>记录硬盘分区的数据，即分区表，如图</p>\n<p><img src=\"/../images/Linux-disk-base/MBR.png\" alt=\"mbr\"></p>\n<p>由于分区表所在区块仅有64bytes容量，因此最多仅能有四组记录区，每组记录区记录了该区段的起始与结束的磁柱号码。</p>\n<p>也就是MBR只支持四个主分区，且最大只支持2TB的硬盘。</p>\n<p>若想多个分区，需要使用扩展分区，扩展分区从5开始计数。</p>\n<h4 id=\"GPT（GUID-Partition-Table）分区格式\"><a href=\"#GPT（GUID-Partition-Table）分区格式\" class=\"headerlink\" title=\"GPT（GUID Partition Table）分区格式\"></a>GPT（GUID Partition Table）分区格式</h4><p>GPT将磁盘划分为一块块的<code>逻辑区块地址（Logical Block Address，简称LBA）</code> 来处理，每个LBA预设计为512bytes，即一个扇区的大小；同时改进MBR之用一块扇区来标识分区表的弊端，GPT使用了前后各34个LBA来标识分区表信息（最后的34各区可以理解为备份，达到高可用），如图</p>\n<p><img src=\"/../images/Linux-disk-base/GPT.png\" alt=\"gpt\"></p>\n<p> LBA的标识是从0开始的，LBA0-34共35块，这里分别阐述下其含义:</p>\n<ul>\n<li><code>LBA0</code> :包含两部分，一部分是类似MBR的446bytes,存储开机管理程序，第二部分则是存储一个特殊的标记，标识该磁盘为GPT格式，而看不懂GPT分区的程序则无法操作该磁盘，起到保护作用，放心，目前基本的管理程序都能识别GPT格式，所以该LBA块实际上与分区信息并无直接关联，这就是为啥不算入34LBA的原因</li>\n<li><code>LBA1</code> :GPT的表头，记录分区本身的位置与大小，同时记录分区在备份中最后34个LBA中的位置，方便恢复</li>\n<li><code>LBA2-34</code>:共32块LBA，每块LBA记录4笔分区表，共支持4*32&#x3D;128笔分区；而每个LBA默认为512bytes，则每笔记录用到512&#x2F;4&#x3D;128bytes,每笔记录拿出64bytes来记录开始、结束的扇区号码，因此对一个单一分区槽而言，支持的最大容量为2^64∗512bytes&#x3D;2^63∗1Kbytes&#x3D;2^33TB&#x3D;8ZB</li>\n</ul>\n<blockquote>\n<p>1024TB&#x3D;1PB <br>1024PB&#x3D;1EB <br>1024EB&#x3D;1ZB</p>\n</blockquote>\n<h1 id=\"其他事项\"><a href=\"#其他事项\" class=\"headerlink\" title=\"其他事项\"></a>其他事项</h1><h2 id=\"1-已添加磁盘无法识别\"><a href=\"#1-已添加磁盘无法识别\" class=\"headerlink\" title=\"1. 已添加磁盘无法识别\"></a>1. 已添加磁盘无法识别</h2><p>有时候机房加了磁盘可能不会在系统层面立即显示出来，需要重启服务器，也可以重新扫描下scsi总线</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> /sys/class/scsi_host/*/scan; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$i</span>;<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;- - -&quot;</span> &gt; <span class=\"hljs-variable\">$i</span>; <span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-已分区没做lvm的磁盘扩容\"><a href=\"#2-已分区没做lvm的磁盘扩容\" class=\"headerlink\" title=\"2. 已分区没做lvm的磁盘扩容\"></a>2. 已分区没做lvm的磁盘扩容</h2><p>有时候我们会遇到项目组在原磁盘上加空间，而想要扩容的那个分区是没有做逻辑卷的，以至于加的空间会浪费，下面有两种方案，其一是<code>fdisk</code>的一种特殊用法，其二是提供一个工具<code>growpart</code>，可以对没有做过逻辑卷的分区进行扩容。</p>\n<p>两种方案都需要该分区必需是整个磁盘的最后一个分区</p>\n<ul>\n<li><p>其一，使用<code>fdisk</code>扩容。因为fdisk在进行操作的时候分区数据不会直接写入磁盘，而是先会保存在内存中，所以可以利用这点来进行扩容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">fdisk /dev/sda<br><span class=\"hljs-comment\">## 进入后用p查看分区</span><br><span class=\"hljs-comment\">## 按d 删除最后一个分区</span><br><span class=\"hljs-comment\">## 然后再n，创建新分区。</span><br><span class=\"hljs-comment\">## 新分区的大小必须比原来的分区大，不能缩小，否则会造成数据丢失</span><br><span class=\"hljs-comment\">## 最后w保存，然后xfs_growf或resize2fs同步对应文件系统即可</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>其二，可使用<code>growpart</code>来进行扩容</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 联网条件下</span><br>yum install cloud-utils-growpart<br><span class=\"hljs-comment\"># 没联网就传包吧</span><br>rpm -ivhU cloud-utils-growpart.rpm<br><span class=\"hljs-comment\"># 如服务器有一块盘vda，仅有一个分区vda1，且没做过逻辑卷</span><br><span class=\"hljs-comment\"># 先用growpart将空间加到vda1上</span><br><span class=\"hljs-comment\">## 表示对/dev/sda的分区1进行扩容</span><br>growpart /dev/vda 1<br><span class=\"hljs-comment\">## 如果报错 unexpected output in sfdisk --version</span><br><span class=\"hljs-comment\">## LANG=en_US.UTF-8 就可以了,不行可以重启下物理机试一下.(编码问题)</span><br><span class=\"hljs-comment\"># 然后同步文件系统即可</span><br>xfs_growfs /<br>resize2fs /dev/vda1<br></code></pre></td></tr></table></figure></li>\n</ul>\n<p><strong>案例</strong></p>\n<blockquote>\n<p>由于没有找到现成的做了分区而没做lvm的项目，但是步骤是一样的。</p>\n</blockquote>\n<p><img src=\"/../images/Linux-disk-base/20221031165313.jpg\" alt=\"gdisk_caution\"></p>\n<h2 id=\"3-旧磁盘换到新机器无法使用\"><a href=\"#3-旧磁盘换到新机器无法使用\" class=\"headerlink\" title=\"3. 旧磁盘换到新机器无法使用\"></a>3. 旧磁盘换到新机器无法使用</h2><p>面对这个情况其实如果在确定磁盘里面的数据进行了备份，或者不需要的时候可以直接进行强制格式化。</p>\n<p>也可以<code>dd</code>去备份一下磁盘头和磁盘尾信息，或者整个磁盘。</p>\n<p>如下有一个磁盘sda，通过parted查看磁盘信息，这里建议把unit切换成s单位来看会更精确更清楚些。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">root@docker:~# parted /dev/sda u s p<br>Model: ATA VBOX HARDDISK (scsi)<br>Disk /dev/sda: 31457280s<br>Sector size (logical/physical): 512B/512B<br>Partition Table: gpt<br>Disk Flags:<br><br>Number  Start     End        Size       File system  Name  Flags<br>14      2048s     10239s     8192s                         bios_grub<br>15      10240s    227327s    217088s    fat32              boot, esp<br>16      227328s   2097152s   1869825s   ext4               bls_boot<br> 1      2099200s  31457246s  29358047s  ext4<br></code></pre></td></tr></table></figure>\n\n<p>在这个输出中可以看到磁盘总大小31457280个扇区，磁盘实际分配到第31457246个扇区结束，<code>31457280-31457246=34</code>，也就是刚好留下了GPT格式备份的34个LBA。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## dd默认1count为512B，与扇区size对应</span><br><span class=\"hljs-comment\">## 备份前34个扇区</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/sda of=~/sda.img.bak count=34<br><span class=\"hljs-comment\">## 跳过前面31457246个扇区进行备份</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/sda of=~/sda.img.bak skip=31457246<br></code></pre></td></tr></table></figure>\n\n<p>如下输出可见备份了最后34个扇区</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">root@docker:~# dd if=/dev/sda of=~/sda.end.bak skip=31457246<br>34+0 records in<br>34+0 records out<br>17408 bytes (17 kB, 17 KiB) copied, 0.000214267 s, 81.2 MB/s<br></code></pre></td></tr></table></figure>\n\n<p>备份好后可以直接用<code>dd</code>命令把磁头磁尾清空即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sda count=34<br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sda skip=31457246<br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"4-已删除文件占用空间\"><a href=\"#4-已删除文件占用空间\" class=\"headerlink\" title=\"4. 已删除文件占用空间\"></a>4. 已删除文件占用空间</h2><p>这种情况一般是有进程在占用被删除的文件，从而导致空间未释放</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可使用lsof来排查，找到对应的pid</span><br>lsof | grep deleted<br><span class=\"hljs-comment\">## 非业务时间段可以通过 kill对应进程来释放</span><br><span class=\"hljs-comment\">## 但业务时间段肯定不能这样操作</span><br><span class=\"hljs-comment\">## 所以有了第二种方法</span><br><span class=\"hljs-built_in\">ls</span> -l /proc/<span class=\"hljs-variable\">$pid</span>/fd/* | grep <span class=\"hljs-variable\">$filename</span><br><span class=\"hljs-built_in\">echo</span> &gt; /proc/<span class=\"hljs-variable\">$pid</span>/fd/<span class=\"hljs-variable\">$fdnum</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"5-实际占用与显示不符\"><a href=\"#5-实际占用与显示不符\" class=\"headerlink\" title=\"5. 实际占用与显示不符\"></a>5. 实际占用与显示不符</h2><p>一可能是前面说的已删除文件后<code>df</code>没有变化</p>\n<p>二可能是覆盖挂载</p>\n<p>三可能是计算的时候没有排除网络挂载</p>\n<p>前面已经介绍过第一种处理办法，下面介绍后面两种</p>\n<p>对于覆盖挂载可以在非业务时间将异常挂载的目录先卸载下来，然后去看看卸载后的该目录下面是否有文件，如有文件占用空间则属于覆盖挂载。</p>\n<p>对于网络挂载，可以在使用<code>du</code>命令的时候使用<code>-x</code>选项来进行排除（前面有介绍过），便可计算出当前本地的准确值。</p>\n<h2 id=\"6-由MBR-MSDOS-格式转GPT\"><a href=\"#6-由MBR-MSDOS-格式转GPT\" class=\"headerlink\" title=\"6. 由MBR (MSDOS) 格式转GPT\"></a>6. 由MBR (MSDOS) 格式转GPT</h2><p><strong>场景</strong></p>\n<p>MBR分区只支持四个主分区，因此，当有人在第四个分区不用逻辑分区而继续用主分区的话将无法再进行分区，且最大只能操作2T空间的磁盘，所以在面对这种四个主分区都用满或磁盘空间超过2T的情况下，需要将磁盘格式转成GPT后才能进一步进行分区和扩容。</p>\n<p><strong>前提条件</strong></p>\n<p>磁盘头信息需要留足空间转换成GPT分区，start最小需要从第63个扇区开始。</p>\n<p>可以自己模拟下，用parted工具进行分区，第一个分区头从0开始，命令如下。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">parted /dev/vdx mklabel msdos/gpt mkpart primary 0 100%<br></code></pre></td></tr></table></figure>\n\n<p>如果使用的label是mbr则会默认从63s开始，如果是gpt，则会从34s开始。</p>\n<p><img src=\"/../images/Linux-disk-base/078092image.png\" alt=\"mbr_default\"></p>\n<p><img src=\"/../images/Linux-disk-base/098712image.png\" alt=\"gpt_default\"></p>\n<p>如果用的是gdisk和fdisk分区，默认是从2048s开始，所以完全够从mbr转换成gpt格式。</p>\n<p>但是需要注意磁盘末尾是否还有空间，因为MBR末尾并不记录信息，所以当磁盘100%时也就是空间完全没有了，此时进行gpt转换可能造成尾部数据丢失。</p>\n<p><img src=\"/../images/Linux-disk-base/052384image.png\" alt=\"fdisk_default\"></p>\n<ul>\n<li>先备份分区表信息</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 备份分区表信息</span><br><span class=\"hljs-comment\"># 最好选择另外的盘进行备份</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/vda of=/xxxx/xxx.mbr.bak  bs=1024 count=2000<br><span class=\"hljs-comment\"># 恢复分区表信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/home/xxx.mbr.bak  of=/dev/vda bs=1024 count=2000<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li>使用gdisk将分区格式转换为gpt</li>\n</ul>\n<p><img src=\"/../images/Linux-disk-base/016511image.png\" alt=\"gdisk_default\"></p>\n<h2 id=\"7-新磁盘残留GPT分区信息导致无法分区扩容\"><a href=\"#7-新磁盘残留GPT分区信息导致无法分区扩容\" class=\"headerlink\" title=\"7. 新磁盘残留GPT分区信息导致无法分区扩容\"></a>7. 新磁盘残留GPT分区信息导致无法分区扩容</h2><blockquote>\n<p>类似第三点</p>\n</blockquote>\n<p>当项目组拿来新磁盘，要求分区扩容时，碰到如下提示gpt备份区信息与主分区信息不一致的提示时，考虑是该磁盘是曾经做过分区的盘。</p>\n<p><img src=\"/../images/Linux-disk-base/20221029005856.png\" alt=\"gdisk_caution\"></p>\n<p>先与项目组确认是否是新盘无数据，当确认是新盘无数据后，可用<code>dd</code>命令去清空头尾记录的分区信息，一般取首尾1M左右即可，清空完后就可以按正常流程进行分区。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 如项目组有893G磁盘</span><br><span class=\"hljs-comment\"># 清空头部信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sdb bs=512 count=4000<br><span class=\"hljs-comment\"># 清空尾部信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sdb bs=1M seek=890000<br><span class=\"hljs-comment\"># seek参数为跳过sdb的第890000个block，即将if的内容从第890000个block后开始写入</span><br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"Linux-磁盘基础\"><a href=\"#Linux-磁盘基础\" class=\"headerlink\" title=\"Linux 磁盘基础\"></a>Linux 磁盘基础</h1><p>先从如何使用开始</p>\n<ul>\n<li><p>如何查磁盘占用大小及基本信息</p>\n<p>将会用到的命令：</p>\n<ul>\n<li>df</li>\n<li>lsblk</li>\n<li>du</li>\n<li>blkid</li>\n</ul>\n</li>\n<li><p>如何进行磁盘分区、制作逻辑卷、格式化、挂载</p>\n<p>将会用到的命令：</p>\n<ul>\n<li>fdisk</li>\n<li>gdisk</li>\n<li>parted</li>\n<li>pvcreate</li>\n<li>vgcreate</li>\n<li>lvcreate</li>\n<li>mkfs</li>\n<li>mount</li>\n</ul>\n</li>\n</ul>\n<p>然后简单了解磁盘分区的原理</p>\n<ul>\n<li>MBR</li>\n<li>GPT</li>\n</ul>\n<p>最后是操作磁盘时可能遇到的各种问题。例如机器添加磁盘后系统层面没有显示、已分区没做逻辑卷的磁盘扩容、曾经使用过的磁盘换到新机器使用报错、已删除文件<code>df -h</code>仍然显示占用、挂载类似nfs等网络盘时操作卡顿、实际占用与显示不符等等…</p>\n<h2 id=\"磁盘信息查看\"><a href=\"#磁盘信息查看\" class=\"headerlink\" title=\"磁盘信息查看\"></a>磁盘信息查看</h2><h3 id=\"1-查看磁盘使用量-–-display-file-system\"><a href=\"#1-查看磁盘使用量-–-display-file-system\" class=\"headerlink\" title=\"1. 查看磁盘使用量 – display file system\"></a>1. 查看磁盘使用量 – display file system</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">df</span> -h <span class=\"hljs-comment\"># 二进制计算方式，以人类友好形式显示，如1024M=1G</span><br><span class=\"hljs-built_in\">df</span> -l <span class=\"hljs-comment\"># 只列出本地文件系统，即排除nfs或其他类似的如nas盘存储挂载</span><br><span class=\"hljs-built_in\">df</span> -T <span class=\"hljs-comment\"># 显示挂载类型</span><br><span class=\"hljs-built_in\">df</span> -H <span class=\"hljs-comment\"># 十进制计算方式，以人类友好形式显示，如1000M=1G</span><br><span class=\"hljs-built_in\">df</span> -t xfs <span class=\"hljs-comment\"># 指定显示xfs类型的挂载</span><br><span class=\"hljs-built_in\">df</span> -i<br></code></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"2-查看磁盘分区挂载信息-–-list-block\"><a href=\"#2-查看磁盘分区挂载信息-–-list-block\" class=\"headerlink\" title=\"2. 查看磁盘分区挂载信息 – list block\"></a>2. 查看磁盘分区挂载信息 – list block</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">lsblk<br>lsblk -l <br></code></pre></td></tr></table></figure>\n\n<p>   使用<code>lsblk</code>输出如下:</p>\n   <figure class=\"highlight tap\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs tap\">NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS<br>sda       8:0   <span class=\"hljs-number\"> 0 </span>  15G <span class=\"hljs-number\"> 0 </span>disk<br>├─sda1    8:1   <span class=\"hljs-number\"> 0 </span>  14G <span class=\"hljs-number\"> 0 </span>part /<br>├─sda14   8:14  <span class=\"hljs-number\"> 0 </span>   4M <span class=\"hljs-number\"> 0 </span>part<br>├─sda15   8:15  <span class=\"hljs-number\"> 0 </span> 106M <span class=\"hljs-number\"> 0 </span>part /boot/efi<br>└─sda16 259:0   <span class=\"hljs-number\"> 0 </span> 913M <span class=\"hljs-number\"> 0 </span>part /boot<br>sr0      11:0   <span class=\"hljs-number\"> 1 </span>  54K <span class=\"hljs-number\"> 0 </span>rom<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-查看具体文件或目录大小-–-disk-usage\"><a href=\"#3-查看具体文件或目录大小-–-disk-usage\" class=\"headerlink\" title=\"3. 查看具体文件或目录大小 – disk usage\"></a>3. 查看具体文件或目录大小 – disk usage</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">du</span> -sh <span class=\"hljs-comment\"># 计算总大小</span><br><span class=\"hljs-built_in\">du</span> -ahd 0 <span class=\"hljs-comment\"># 与上述相同</span><br><span class=\"hljs-built_in\">du</span> -sh * <span class=\"hljs-comment\"># 计算当前目录下所有文件具体大小，最后计算出总值，并以人类友好形式输出</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 <span class=\"hljs-comment\"># 与上述相同</span><br><span class=\"hljs-comment\"># -d 在有某些版本不可用，需要换成--max-depth 1</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 --time <span class=\"hljs-comment\"># 显示文件或目录修改时间</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 --time | <span class=\"hljs-built_in\">sort</span> -h <span class=\"hljs-comment\">## 以人类友好形式进行排序输出</span><br><span class=\"hljs-built_in\">du</span> -ahd 1 ./ -x ./ <span class=\"hljs-comment\"># 跳过不同文件系统的目录，经常可以用来规避nfs这类网络挂载</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"4-其他命令\"><a href=\"#4-其他命令\" class=\"headerlink\" title=\"4. 其他命令\"></a>4. 其他命令</h3>   <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">blkid <span class=\"hljs-comment\">## block id, 可以用来查看uuid及文件系统类型</span><br><span class=\"hljs-comment\">## 以下命令可以用来查看分区情况</span><br>fdisk -l <br>gdisk -l<br>parted /dev/vda <span class=\"hljs-built_in\">print</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"磁盘分区、格式化、挂载\"><a href=\"#磁盘分区、格式化、挂载\" class=\"headerlink\" title=\"磁盘分区、格式化、挂载\"></a>磁盘分区、格式化、挂载</h2><blockquote>\n<p>磁盘有价，数据无价，对磁盘进行分区、扩容操作时请务必做好数据备份！！！</p>\n</blockquote>\n<h3 id=\"1-分区\"><a href=\"#1-分区\" class=\"headerlink\" title=\"1. 分区\"></a>1. 分区</h3><p>一般分区有两种常用形式，<code>GPT</code>和<code>MBR</code></p>\n<p>MBR格式最多只能有四个主分区，若想继续分区就需要建立逻辑分区。</p>\n<p>GPT格式没有分区限制，建议使用GPT分区</p>\n<ol>\n<li><strong>fdisk</strong></li>\n</ol>\n<p>fdisk使用方法如下，进入交互式命令行后，用<code>p</code>查看磁盘信息，<code>n</code>新建分区，下面的操作无特殊指定回车即可。</p>\n<p>如有指定，一般起始扇区默认即可，结束扇区可用<code>+10G</code>类似写法指定，<code>+</code>号是在现有基础上增加空间。</p>\n<p>有时候缩容操作（一般不考虑缩容）不会指定+号，直接指定大小而不是在原基础上增加。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">root@docker:~# fdisk /dev/sda<br><br>Welcome to fdisk (util-linux 2.39.3).<br>Changes will remain <span class=\"hljs-keyword\">in</span> memory only, <span class=\"hljs-keyword\">until</span> you decide to write them.<br>Be careful before using the write <span class=\"hljs-built_in\">command</span>.<br><br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): n<br>Partition number (2-13,17-128, default 2):<br>First sector (33556480-52428766, default 33556480):<br>Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (33556480-52428766, default 52426751):<br><br>Created a new partition 2 of <span class=\"hljs-built_in\">type</span> <span class=\"hljs-string\">&#x27;Linux filesystem&#x27;</span> and of size 9 GiB.<br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 25 GiB, 26843545600 bytes, 52428800 sectors<br>Disk model: VBOX HARDDISK<br>Units: sectors of 1 * 512 = 512 bytes<br>Sector size (logical/physical): 512 bytes / 512 bytes<br>I/O size (minimum/optimal): 512 bytes / 512 bytes<br>Disklabel <span class=\"hljs-built_in\">type</span>: gpt<br>Disk identifier: A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br><br>Device        Start      End  Sectors  Size Type<br>/dev/sda1   2099200 33556479 31457280   15G Linux filesystem<br>/dev/sda2  33556480 52426751 18870272    9G Linux filesystem<br>/dev/sda14     2048    10239     8192    4M BIOS boot<br>/dev/sda15    10240   227327   217088  106M EFI System<br>/dev/sda16   227328  2097152  1869825  913M Linux extended boot<br><br>Partition table entries are not <span class=\"hljs-keyword\">in</span> disk order.<br><br>Command (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): w<br>The partition table has been altered.<br>Syncing disks.<br></code></pre></td></tr></table></figure>\n\n\n\n<ol start=\"2\">\n<li><strong>gdisk</strong></li>\n</ol>\n<p>gdisk的操作类似于fdisk，多了一步需要输入Hex code，可回车默认。</p>\n<p>如果保存退出后<code>lsblk</code>查看不到分区，可使用<code>partprobe</code>刷新分区表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">root@docker:~# gdisk /dev/sda<br>GPT fdisk (gdisk) version 1.0.10<br><br>Partition table scan:<br>  MBR: protective<br>  BSD: not present<br>  APM: not present<br>  GPT: present<br><br>Found valid GPT with protective MBR; using GPT.<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 52428800 sectors, 25.0 GiB<br>Model: VBOX HARDDISK<br>Sector size (logical/physical): 512/512 bytes<br>Disk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br>Partition table holds up to 128 entries<br>Main partition table begins at sector 2 and ends at sector 33<br>First usable sector is 34, last usable sector is 52428766<br>Partitions will be aligned on 2048-sector boundaries<br>Total free space is 18876348 sectors (9.0 GiB)<br><br>Number  Start (sector)    End (sector)  Size       Code  Name<br>   1         2099200        33556479   15.0 GiB    8300<br>  14            2048           10239   4.0 MiB     EF02<br>  15           10240          227327   106.0 MiB   EF00<br>  16          227328         2097152   913.0 MiB   EA00<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): n<br>Partition number (2-128, default 2):<br>First sector (34-52428766, default = 33556480) or &#123;+-&#125;size&#123;KMGTP&#125;:<br>Last sector (33556480-52428766, default = 52426751) or &#123;+-&#125;size&#123;KMGTP&#125;: +8G<br>Current <span class=\"hljs-built_in\">type</span> is 8300 (Linux filesystem)<br>Hex code or GUID (L to show codes, Enter = 8300): 8e00<br>Changed <span class=\"hljs-built_in\">type</span> of partition to <span class=\"hljs-string\">&#x27;Linux LVM&#x27;</span><br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p<br>Disk /dev/sda: 52428800 sectors, 25.0 GiB<br>Model: VBOX HARDDISK<br>Sector size (logical/physical): 512/512 bytes<br>Disk identifier (GUID): A102F557-254C-4E8A-BB7B-5CE2CBC42B40<br>Partition table holds up to 128 entries<br>Main partition table begins at sector 2 and ends at sector 33<br>First usable sector is 34, last usable sector is 52428766<br>Partitions will be aligned on 2048-sector boundaries<br>Total free space is 2099132 sectors (1025.0 MiB)<br><br>Number  Start (sector)    End (sector)  Size       Code  Name<br>   1         2099200        33556479   15.0 GiB    8300<br>   2        33556480        50333695   8.0 GiB     8E00  Linux LVM<br>  14            2048           10239   4.0 MiB     EF02<br>  15           10240          227327   106.0 MiB   EF00<br>  16          227328         2097152   913.0 MiB   EA00<br><br>Command (? <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): w<br><br>Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING<br>PARTITIONS!!<br><br>Do you want to proceed? (Y/N): y<br>OK; writing new GUID partition table (GPT) to /dev/sda.<br>Warning: The kernel is still using the old partition table.<br>The new table will be used at the next reboot or after you<br>run partprobe(8) or kpartx(8)<br>The operation has completed successfully.<br><br>root@docker:~# lsblk<br>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS<br>loop0     7:0    0    4K  1 loop /snap/bare/5<br>loop1     7:1    0 74.2M  1 loop /snap/core22/1380<br>loop2     7:2    0    1M  1 loop /snap/multipass-sshfs/145<br>loop3     7:3    0 38.8M  1 loop /snap/snapd/21759<br>sda       8:0    0   25G  0 disk<br>├─sda1    8:1    0   15G  0 part /<br>├─sda14   8:14   0    4M  0 part<br>├─sda15   8:15   0  106M  0 part /boot/efi<br>└─sda16 259:0    0  913M  0 part /boot<br>sr0      11:0    1   54K  0 rom<br>root@docker:~# partprobe -s<br></code></pre></td></tr></table></figure>\n\n\n\n<ol start=\"3\">\n<li><strong>parted</strong></li>\n</ol>\n<blockquote>\n<p>需谨慎使用，该命令操作会直接生效，不像gdisk、fdisk先将数据写入内存</p>\n</blockquote>\n<p><code>parted</code> 命令也可以直接运行进入类似<code>fdisk</code>的交互式界面，但本人更习惯直接命令行操作</p>\n<p>分区三步法：</p>\n<ol>\n<li>设置分区形式 - mklabel</li>\n<li>设置分区大小 - mkpart<ul>\n<li>mkpart的开始分区从第2048个扇区开始，也就是1024kb,给头部信息留足空间</li>\n</ul>\n</li>\n<li>按需格式化磁盘或做成pv卷扩容</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 指定分区形式以及分区名和大小</span><br>parted /dev/sda mklabel gpt mkpart primary 1024kb 100%<br><span class=\"hljs-comment\">## 更倾向于用扇区来指定大小，假设上一个分区的结束扇区为227328，则新分区可以+1从227329扇区开始。</span><br><span class=\"hljs-comment\">## 此处会自动调整结束扇区，因为磁盘尾还需要存放GPT备份表</span><br>parted /dev/sda mklabel gpt mkpart primary 227329s 100%<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-格式化\"><a href=\"#2-格式化\" class=\"headerlink\" title=\"2. 格式化\"></a>2. 格式化</h3><p>一个磁盘分区完后还不能直接挂载使用，还需要进行文件系统格式化，格式化完成后才能挂载使用。</p>\n<p>一般常见的为xfs、ext4格式，建议使用xfs格式，对应的命令为</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mkfs.xfs /dev/sda1<br>mkfs.ext4 /dev/sda1<br><br><span class=\"hljs-comment\">## 格式化完成后可以用blkid查看信息</span><br>blkid /dev/sda1 <br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-挂载\"><a href=\"#3-挂载\" class=\"headerlink\" title=\"3. 挂载\"></a>3. 挂载</h3><p>挂载可以是临时挂载，也可以开机自动挂载</p>\n<ul>\n<li><p>临时挂载</p>\n<p>关机重启挂载消失</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">mount -t xfs /dev/sda2 /tmp<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>开机自动挂载</p>\n<p>将挂载写入<code>/etc/fstab</code>文件即可实现开机自挂载</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;/dev/sda2   /tmp        xfs   defaults     0 0&quot;</span> &gt;&gt; /etc/fstab<br></code></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"4-制作逻辑卷\"><a href=\"#4-制作逻辑卷\" class=\"headerlink\" title=\"4. 制作逻辑卷\"></a>4. 制作逻辑卷</h3><p>LVM允许系统将多个物理硬盘或分区组合成一个逻辑卷组，‌从而形成一个大的存储池。利用逻辑卷的特性可以实现跨盘扩容，因此在制作逻辑卷的时候最好使用性能相近的磁盘，否则将会影响逻辑卷整体性能。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 先将某块磁盘或分区创建为PV</span><br>pvcreate /dev/sda<br><span class=\"hljs-comment\">## 将sda创建一个名为vg1的卷组</span><br>vgcreate vg1 /dev/sda<br><span class=\"hljs-comment\">## 在vg1卷组创建一个名为lv1的逻辑卷，将所有vg1空间都使用</span><br>lvcreate -l +100%free -n lv1 vg1<br><span class=\"hljs-comment\">## 在vg1卷组创建一个名为lv1,大小为40G的逻辑卷</span><br>lvcreate -L 40G -n lv1 vg1<br><span class=\"hljs-comment\">## 制作文件系统</span><br>mkfs.xfs /dev/vg1/lv1<br><span class=\"hljs-comment\">## 挂载，同样可以写入fstab</span><br>mount /dev/vg1/lv1 /root/tmp/<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-磁盘扩容\"><a href=\"#5-磁盘扩容\" class=\"headerlink\" title=\"5. 磁盘扩容\"></a>5. 磁盘扩容</h3><p>通常磁盘需要做逻辑卷或者处于最后一个分区的时候进行扩容是最方便的。</p>\n<p>扩容前一定必须做好备份！！！</p>\n<ol>\n<li>逻辑卷扩容</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 首先加入pv</span><br>pvcreate /dev/sda<br><span class=\"hljs-comment\">## 然后扩展vg</span><br>vgextend vg1 /dev/sda<br><span class=\"hljs-comment\">## 扩充lv</span><br><span class=\"hljs-comment\">## +号必须有，不然就变成了调整lv大小，造成数据丢失</span><br>lvextend -l +100%free /dev/vg1/lv1<br>lvextend -L +20G /dev/vg1/lv1<br><span class=\"hljs-comment\">## 同步文件系统</span><br><span class=\"hljs-comment\">## xfs </span><br>xfs_growfs /dev/vg1/lv1<br><span class=\"hljs-comment\">## ext4</span><br>resize2fs /dev/vg1/lv1<br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>没分区的整块盘</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可以直接同步文件系统</span><br>xfs_growfs /dev/sda<br>resize2fs /dev/sda<br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"磁盘分区类型及原理\"><a href=\"#磁盘分区类型及原理\" class=\"headerlink\" title=\"磁盘分区类型及原理\"></a>磁盘分区类型及原理</h2><h4 id=\"MBR（Master-Boot-Record）分区格式\"><a href=\"#MBR（Master-Boot-Record）分区格式\" class=\"headerlink\" title=\"MBR（Master Boot Record）分区格式\"></a>MBR（Master Boot Record）分区格式</h4><p>早期磁盘第一个扇区（<code>521bytes</code>）里面包含重要的信息<code>MBR（Master Boot Record）</code>，其中<code>446 bytes</code>，安装开机管理程序的地方；剩下的<code>64bytes</code>记录硬盘分区的数据，即分区表，如图</p>\n<p><img src=\"/../images/Linux-disk-base/MBR.png\" alt=\"mbr\"></p>\n<p>由于分区表所在区块仅有64bytes容量，因此最多仅能有四组记录区，每组记录区记录了该区段的起始与结束的磁柱号码。</p>\n<p>也就是MBR只支持四个主分区，且最大只支持2TB的硬盘。</p>\n<p>若想多个分区，需要使用扩展分区，扩展分区从5开始计数。</p>\n<h4 id=\"GPT（GUID-Partition-Table）分区格式\"><a href=\"#GPT（GUID-Partition-Table）分区格式\" class=\"headerlink\" title=\"GPT（GUID Partition Table）分区格式\"></a>GPT（GUID Partition Table）分区格式</h4><p>GPT将磁盘划分为一块块的<code>逻辑区块地址（Logical Block Address，简称LBA）</code> 来处理，每个LBA预设计为512bytes，即一个扇区的大小；同时改进MBR之用一块扇区来标识分区表的弊端，GPT使用了前后各34个LBA来标识分区表信息（最后的34各区可以理解为备份，达到高可用），如图</p>\n<p><img src=\"/../images/Linux-disk-base/GPT.png\" alt=\"gpt\"></p>\n<p> LBA的标识是从0开始的，LBA0-34共35块，这里分别阐述下其含义:</p>\n<ul>\n<li><code>LBA0</code> :包含两部分，一部分是类似MBR的446bytes,存储开机管理程序，第二部分则是存储一个特殊的标记，标识该磁盘为GPT格式，而看不懂GPT分区的程序则无法操作该磁盘，起到保护作用，放心，目前基本的管理程序都能识别GPT格式，所以该LBA块实际上与分区信息并无直接关联，这就是为啥不算入34LBA的原因</li>\n<li><code>LBA1</code> :GPT的表头，记录分区本身的位置与大小，同时记录分区在备份中最后34个LBA中的位置，方便恢复</li>\n<li><code>LBA2-34</code>:共32块LBA，每块LBA记录4笔分区表，共支持4*32&#x3D;128笔分区；而每个LBA默认为512bytes，则每笔记录用到512&#x2F;4&#x3D;128bytes,每笔记录拿出64bytes来记录开始、结束的扇区号码，因此对一个单一分区槽而言，支持的最大容量为2^64∗512bytes&#x3D;2^63∗1Kbytes&#x3D;2^33TB&#x3D;8ZB</li>\n</ul>\n<blockquote>\n<p>1024TB&#x3D;1PB <br>1024PB&#x3D;1EB <br>1024EB&#x3D;1ZB</p>\n</blockquote>\n<h1 id=\"其他事项\"><a href=\"#其他事项\" class=\"headerlink\" title=\"其他事项\"></a>其他事项</h1><h2 id=\"1-已添加磁盘无法识别\"><a href=\"#1-已添加磁盘无法识别\" class=\"headerlink\" title=\"1. 已添加磁盘无法识别\"></a>1. 已添加磁盘无法识别</h2><p>有时候机房加了磁盘可能不会在系统层面立即显示出来，需要重启服务器，也可以重新扫描下scsi总线</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> /sys/class/scsi_host/*/scan; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$i</span>;<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;- - -&quot;</span> &gt; <span class=\"hljs-variable\">$i</span>; <span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-已分区没做lvm的磁盘扩容\"><a href=\"#2-已分区没做lvm的磁盘扩容\" class=\"headerlink\" title=\"2. 已分区没做lvm的磁盘扩容\"></a>2. 已分区没做lvm的磁盘扩容</h2><p>有时候我们会遇到项目组在原磁盘上加空间，而想要扩容的那个分区是没有做逻辑卷的，以至于加的空间会浪费，下面有两种方案，其一是<code>fdisk</code>的一种特殊用法，其二是提供一个工具<code>growpart</code>，可以对没有做过逻辑卷的分区进行扩容。</p>\n<p>两种方案都需要该分区必需是整个磁盘的最后一个分区</p>\n<ul>\n<li><p>其一，使用<code>fdisk</code>扩容。因为fdisk在进行操作的时候分区数据不会直接写入磁盘，而是先会保存在内存中，所以可以利用这点来进行扩容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">fdisk /dev/sda<br><span class=\"hljs-comment\">## 进入后用p查看分区</span><br><span class=\"hljs-comment\">## 按d 删除最后一个分区</span><br><span class=\"hljs-comment\">## 然后再n，创建新分区。</span><br><span class=\"hljs-comment\">## 新分区的大小必须比原来的分区大，不能缩小，否则会造成数据丢失</span><br><span class=\"hljs-comment\">## 最后w保存，然后xfs_growf或resize2fs同步对应文件系统即可</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>其二，可使用<code>growpart</code>来进行扩容</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 联网条件下</span><br>yum install cloud-utils-growpart<br><span class=\"hljs-comment\"># 没联网就传包吧</span><br>rpm -ivhU cloud-utils-growpart.rpm<br><span class=\"hljs-comment\"># 如服务器有一块盘vda，仅有一个分区vda1，且没做过逻辑卷</span><br><span class=\"hljs-comment\"># 先用growpart将空间加到vda1上</span><br><span class=\"hljs-comment\">## 表示对/dev/sda的分区1进行扩容</span><br>growpart /dev/vda 1<br><span class=\"hljs-comment\">## 如果报错 unexpected output in sfdisk --version</span><br><span class=\"hljs-comment\">## LANG=en_US.UTF-8 就可以了,不行可以重启下物理机试一下.(编码问题)</span><br><span class=\"hljs-comment\"># 然后同步文件系统即可</span><br>xfs_growfs /<br>resize2fs /dev/vda1<br></code></pre></td></tr></table></figure></li>\n</ul>\n<p><strong>案例</strong></p>\n<blockquote>\n<p>由于没有找到现成的做了分区而没做lvm的项目，但是步骤是一样的。</p>\n</blockquote>\n<p><img src=\"/../images/Linux-disk-base/20221031165313.jpg\" alt=\"gdisk_caution\"></p>\n<h2 id=\"3-旧磁盘换到新机器无法使用\"><a href=\"#3-旧磁盘换到新机器无法使用\" class=\"headerlink\" title=\"3. 旧磁盘换到新机器无法使用\"></a>3. 旧磁盘换到新机器无法使用</h2><p>面对这个情况其实如果在确定磁盘里面的数据进行了备份，或者不需要的时候可以直接进行强制格式化。</p>\n<p>也可以<code>dd</code>去备份一下磁盘头和磁盘尾信息，或者整个磁盘。</p>\n<p>如下有一个磁盘sda，通过parted查看磁盘信息，这里建议把unit切换成s单位来看会更精确更清楚些。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">root@docker:~# parted /dev/sda u s p<br>Model: ATA VBOX HARDDISK (scsi)<br>Disk /dev/sda: 31457280s<br>Sector size (logical/physical): 512B/512B<br>Partition Table: gpt<br>Disk Flags:<br><br>Number  Start     End        Size       File system  Name  Flags<br>14      2048s     10239s     8192s                         bios_grub<br>15      10240s    227327s    217088s    fat32              boot, esp<br>16      227328s   2097152s   1869825s   ext4               bls_boot<br> 1      2099200s  31457246s  29358047s  ext4<br></code></pre></td></tr></table></figure>\n\n<p>在这个输出中可以看到磁盘总大小31457280个扇区，磁盘实际分配到第31457246个扇区结束，<code>31457280-31457246=34</code>，也就是刚好留下了GPT格式备份的34个LBA。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## dd默认1count为512B，与扇区size对应</span><br><span class=\"hljs-comment\">## 备份前34个扇区</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/sda of=~/sda.img.bak count=34<br><span class=\"hljs-comment\">## 跳过前面31457246个扇区进行备份</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/sda of=~/sda.img.bak skip=31457246<br></code></pre></td></tr></table></figure>\n\n<p>如下输出可见备份了最后34个扇区</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">root@docker:~# dd if=/dev/sda of=~/sda.end.bak skip=31457246<br>34+0 records in<br>34+0 records out<br>17408 bytes (17 kB, 17 KiB) copied, 0.000214267 s, 81.2 MB/s<br></code></pre></td></tr></table></figure>\n\n<p>备份好后可以直接用<code>dd</code>命令把磁头磁尾清空即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sda count=34<br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sda skip=31457246<br></code></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"4-已删除文件占用空间\"><a href=\"#4-已删除文件占用空间\" class=\"headerlink\" title=\"4. 已删除文件占用空间\"></a>4. 已删除文件占用空间</h2><p>这种情况一般是有进程在占用被删除的文件，从而导致空间未释放</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可使用lsof来排查，找到对应的pid</span><br>lsof | grep deleted<br><span class=\"hljs-comment\">## 非业务时间段可以通过 kill对应进程来释放</span><br><span class=\"hljs-comment\">## 但业务时间段肯定不能这样操作</span><br><span class=\"hljs-comment\">## 所以有了第二种方法</span><br><span class=\"hljs-built_in\">ls</span> -l /proc/<span class=\"hljs-variable\">$pid</span>/fd/* | grep <span class=\"hljs-variable\">$filename</span><br><span class=\"hljs-built_in\">echo</span> &gt; /proc/<span class=\"hljs-variable\">$pid</span>/fd/<span class=\"hljs-variable\">$fdnum</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"5-实际占用与显示不符\"><a href=\"#5-实际占用与显示不符\" class=\"headerlink\" title=\"5. 实际占用与显示不符\"></a>5. 实际占用与显示不符</h2><p>一可能是前面说的已删除文件后<code>df</code>没有变化</p>\n<p>二可能是覆盖挂载</p>\n<p>三可能是计算的时候没有排除网络挂载</p>\n<p>前面已经介绍过第一种处理办法，下面介绍后面两种</p>\n<p>对于覆盖挂载可以在非业务时间将异常挂载的目录先卸载下来，然后去看看卸载后的该目录下面是否有文件，如有文件占用空间则属于覆盖挂载。</p>\n<p>对于网络挂载，可以在使用<code>du</code>命令的时候使用<code>-x</code>选项来进行排除（前面有介绍过），便可计算出当前本地的准确值。</p>\n<h2 id=\"6-由MBR-MSDOS-格式转GPT\"><a href=\"#6-由MBR-MSDOS-格式转GPT\" class=\"headerlink\" title=\"6. 由MBR (MSDOS) 格式转GPT\"></a>6. 由MBR (MSDOS) 格式转GPT</h2><p><strong>场景</strong></p>\n<p>MBR分区只支持四个主分区，因此，当有人在第四个分区不用逻辑分区而继续用主分区的话将无法再进行分区，且最大只能操作2T空间的磁盘，所以在面对这种四个主分区都用满或磁盘空间超过2T的情况下，需要将磁盘格式转成GPT后才能进一步进行分区和扩容。</p>\n<p><strong>前提条件</strong></p>\n<p>磁盘头信息需要留足空间转换成GPT分区，start最小需要从第63个扇区开始。</p>\n<p>可以自己模拟下，用parted工具进行分区，第一个分区头从0开始，命令如下。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">parted /dev/vdx mklabel msdos/gpt mkpart primary 0 100%<br></code></pre></td></tr></table></figure>\n\n<p>如果使用的label是mbr则会默认从63s开始，如果是gpt，则会从34s开始。</p>\n<p><img src=\"/../images/Linux-disk-base/078092image.png\" alt=\"mbr_default\"></p>\n<p><img src=\"/../images/Linux-disk-base/098712image.png\" alt=\"gpt_default\"></p>\n<p>如果用的是gdisk和fdisk分区，默认是从2048s开始，所以完全够从mbr转换成gpt格式。</p>\n<p>但是需要注意磁盘末尾是否还有空间，因为MBR末尾并不记录信息，所以当磁盘100%时也就是空间完全没有了，此时进行gpt转换可能造成尾部数据丢失。</p>\n<p><img src=\"/../images/Linux-disk-base/052384image.png\" alt=\"fdisk_default\"></p>\n<ul>\n<li>先备份分区表信息</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 备份分区表信息</span><br><span class=\"hljs-comment\"># 最好选择另外的盘进行备份</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/vda of=/xxxx/xxx.mbr.bak  bs=1024 count=2000<br><span class=\"hljs-comment\"># 恢复分区表信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/home/xxx.mbr.bak  of=/dev/vda bs=1024 count=2000<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li>使用gdisk将分区格式转换为gpt</li>\n</ul>\n<p><img src=\"/../images/Linux-disk-base/016511image.png\" alt=\"gdisk_default\"></p>\n<h2 id=\"7-新磁盘残留GPT分区信息导致无法分区扩容\"><a href=\"#7-新磁盘残留GPT分区信息导致无法分区扩容\" class=\"headerlink\" title=\"7. 新磁盘残留GPT分区信息导致无法分区扩容\"></a>7. 新磁盘残留GPT分区信息导致无法分区扩容</h2><blockquote>\n<p>类似第三点</p>\n</blockquote>\n<p>当项目组拿来新磁盘，要求分区扩容时，碰到如下提示gpt备份区信息与主分区信息不一致的提示时，考虑是该磁盘是曾经做过分区的盘。</p>\n<p><img src=\"/../images/Linux-disk-base/20221029005856.png\" alt=\"gdisk_caution\"></p>\n<p>先与项目组确认是否是新盘无数据，当确认是新盘无数据后，可用<code>dd</code>命令去清空头尾记录的分区信息，一般取首尾1M左右即可，清空完后就可以按正常流程进行分区。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 如项目组有893G磁盘</span><br><span class=\"hljs-comment\"># 清空头部信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sdb bs=512 count=4000<br><span class=\"hljs-comment\"># 清空尾部信息</span><br><span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">if</span>=/dev/zero of=/dev/sdb bs=1M seek=890000<br><span class=\"hljs-comment\"># seek参数为跳过sdb的第890000个block，即将if的内容从第890000个block后开始写入</span><br></code></pre></td></tr></table></figure>"},{"title":"WSL启动Linux并初始化及代理配置","date":"2024-08-04T11:45:05.000Z","_content":"\n## WSL 启动 Ubuntu\n\n由于22.04 jammy不支持高版本nodejs，所以我们下载24.04 noble版本的Ubuntu。\n\n```powershell\n## 查看可下载的发行版\nwsl -l -o\n\nwsl --install -d Ubuntu-24.04 \n```\n\n![list](../images/wsl-linux-init/available_list.png)\n\n等待下载完成就会自动进入。\n\n### 配置 apt阿里源\n\n```bash\ncp /etc/apt/sources.list /etc/apt/sources.list.bak\n\n## 查看版本codename\ncat /etc/os-release | grep UBUNTU_CODENAME\n## 如用其他版本，如22.04 jammy，将noble替换为jammy即可\ncat >> /etc/apt/sources.list <<EOF\ndeb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse\nEOF\n## 配置完后update\napt update\n\napt install nodejs npm\n```\n\n## WSL 本地导入CentOS\n\nWSL没有CentOS的发行版，因此需要自行导出一个。\n\ncentos的tar包从docker容器导出。\n\n```powershell\nwsl --import CentOS D:\\wsl\\centos\\ .\\centos.tar\nwsl -d CentOS\n\ncat >> /etc/wsl.conf <<EOF\n[boot]\nsystemd=true\nEOF\n```\n\n### 配置 yum阿里源\n\n```bash\nmv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nyum clean all && yum makecache\n\nyum install initscripts\nyum install net-tools\nyum install which\nyum install sudo\nyum install tmux\n```\n\n## 配置代理\n\n此处我将自己的WSL网络设置成了`mirrored`，因此在访问一些服务的时候可以通过127.0.0.1来访问。\n\n比如 ssh可以通过`ssh root@127.0.0.1`来远程连接，方便使用其他终端程序；Web服务可以通过http://127.0.0.1:80 访问。\n\n```bash\n## 设置网络为镜像网络，完成后关闭虚拟机，等待8秒后再启动\ncat >>/mnt/c/Users/xxx/.wslconfig <<EOF\n[experimental]\nnetworkingMode=mirrored\nEOF\n\n## 配置代理\n## 根据自己选择的工具填写端口号\ncat >> ~/.bashrc <<EOF\nalias proxy='export all_proxy=http://127.0.0.1:7890'\nalias unproxy='unset all_proxy'\nEOF\nsource ~/.bashrc\n## 运行即可启动代理\nproxy\n\n## 配置npm代理\nnpm config set proxy=http://127.0.0.1:7890\n## 默认registry地址，可换成其他国内源\nnpm config set registry=http://registry.npmjs.org\n\nnpm install -g hexo\n```\n\n## 配置 github加速\n\n在`/etc/hosts`下添加\n\n```\n199.96.58.157 github.global.ssl.fastly.net\n20.205.243.166 github.com\n```\n\n","source":"_posts/WSL-Linux-init-proxy.md","raw":"---\ntitle: WSL启动Linux并初始化及代理配置\ndate: 2024-08-04 19:45:05\ntags: tools\n---\n\n## WSL 启动 Ubuntu\n\n由于22.04 jammy不支持高版本nodejs，所以我们下载24.04 noble版本的Ubuntu。\n\n```powershell\n## 查看可下载的发行版\nwsl -l -o\n\nwsl --install -d Ubuntu-24.04 \n```\n\n![list](../images/wsl-linux-init/available_list.png)\n\n等待下载完成就会自动进入。\n\n### 配置 apt阿里源\n\n```bash\ncp /etc/apt/sources.list /etc/apt/sources.list.bak\n\n## 查看版本codename\ncat /etc/os-release | grep UBUNTU_CODENAME\n## 如用其他版本，如22.04 jammy，将noble替换为jammy即可\ncat >> /etc/apt/sources.list <<EOF\ndeb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse\nEOF\n## 配置完后update\napt update\n\napt install nodejs npm\n```\n\n## WSL 本地导入CentOS\n\nWSL没有CentOS的发行版，因此需要自行导出一个。\n\ncentos的tar包从docker容器导出。\n\n```powershell\nwsl --import CentOS D:\\wsl\\centos\\ .\\centos.tar\nwsl -d CentOS\n\ncat >> /etc/wsl.conf <<EOF\n[boot]\nsystemd=true\nEOF\n```\n\n### 配置 yum阿里源\n\n```bash\nmv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nyum clean all && yum makecache\n\nyum install initscripts\nyum install net-tools\nyum install which\nyum install sudo\nyum install tmux\n```\n\n## 配置代理\n\n此处我将自己的WSL网络设置成了`mirrored`，因此在访问一些服务的时候可以通过127.0.0.1来访问。\n\n比如 ssh可以通过`ssh root@127.0.0.1`来远程连接，方便使用其他终端程序；Web服务可以通过http://127.0.0.1:80 访问。\n\n```bash\n## 设置网络为镜像网络，完成后关闭虚拟机，等待8秒后再启动\ncat >>/mnt/c/Users/xxx/.wslconfig <<EOF\n[experimental]\nnetworkingMode=mirrored\nEOF\n\n## 配置代理\n## 根据自己选择的工具填写端口号\ncat >> ~/.bashrc <<EOF\nalias proxy='export all_proxy=http://127.0.0.1:7890'\nalias unproxy='unset all_proxy'\nEOF\nsource ~/.bashrc\n## 运行即可启动代理\nproxy\n\n## 配置npm代理\nnpm config set proxy=http://127.0.0.1:7890\n## 默认registry地址，可换成其他国内源\nnpm config set registry=http://registry.npmjs.org\n\nnpm install -g hexo\n```\n\n## 配置 github加速\n\n在`/etc/hosts`下添加\n\n```\n199.96.58.157 github.global.ssl.fastly.net\n20.205.243.166 github.com\n```\n\n","slug":"WSL-Linux-init-proxy","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yk0004uhuq1jzn2om4","content":"<h2 id=\"WSL-启动-Ubuntu\"><a href=\"#WSL-启动-Ubuntu\" class=\"headerlink\" title=\"WSL 启动 Ubuntu\"></a>WSL 启动 Ubuntu</h2><p>由于22.04 jammy不支持高版本nodejs，所以我们下载24.04 noble版本的Ubuntu。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 查看可下载的发行版</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-o</span><br><br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">-d</span> Ubuntu<span class=\"hljs-literal\">-24</span>.<span class=\"hljs-number\">04</span> <br></code></pre></td></tr></table></figure>\n\n<p><img src=\"/../images/wsl-linux-init/available_list.png\" alt=\"list\"></p>\n<p>等待下载完成就会自动进入。</p>\n<h3 id=\"配置-apt阿里源\"><a href=\"#配置-apt阿里源\" class=\"headerlink\" title=\"配置 apt阿里源\"></a>配置 apt阿里源</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak<br><br><span class=\"hljs-comment\">## 查看版本codename</span><br><span class=\"hljs-built_in\">cat</span> /etc/os-release | grep UBUNTU_CODENAME<br><span class=\"hljs-comment\">## 如用其他版本，如22.04 jammy，将noble替换为jammy即可</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/apt/sources.list &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">deb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse</span><br><span class=\"hljs-string\">deb-src http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse</span><br><span class=\"hljs-string\">deb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse</span><br><span class=\"hljs-string\">deb-src http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-comment\">## 配置完后update</span><br>apt update<br><br>apt install nodejs npm<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"WSL-本地导入CentOS\"><a href=\"#WSL-本地导入CentOS\" class=\"headerlink\" title=\"WSL 本地导入CentOS\"></a>WSL 本地导入CentOS</h2><p>WSL没有CentOS的发行版，因此需要自行导出一个。</p>\n<p>centos的tar包从docker容器导出。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">wsl <span class=\"hljs-literal\">--import</span> CentOS D:\\wsl\\centos\\ .\\centos.tar<br>wsl <span class=\"hljs-literal\">-d</span> CentOS<br><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/wsl.conf &lt;&lt;EOF<br>[<span class=\"hljs-type\">boot</span>]<br>systemd=true<br>EOF<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置-yum阿里源\"><a href=\"#配置-yum阿里源\" class=\"headerlink\" title=\"配置 yum阿里源\"></a>配置 yum阿里源</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak<br>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>yum clean all &amp;&amp; yum makecache<br><br>yum install initscripts<br>yum install net-tools<br>yum install <span class=\"hljs-built_in\">which</span><br>yum install <span class=\"hljs-built_in\">sudo</span><br>yum install tmux<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置代理\"><a href=\"#配置代理\" class=\"headerlink\" title=\"配置代理\"></a>配置代理</h2><p>此处我将自己的WSL网络设置成了<code>mirrored</code>，因此在访问一些服务的时候可以通过127.0.0.1来访问。</p>\n<p>比如 ssh可以通过<code>ssh root@127.0.0.1</code>来远程连接，方便使用其他终端程序；Web服务可以通过<a href=\"http://127.0.0.1/\">http://127.0.0.1:80</a> 访问。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 设置网络为镜像网络，完成后关闭虚拟机，等待8秒后再启动</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt;/mnt/c/Users/xxx/.wslconfig &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[experimental]</span><br><span class=\"hljs-string\">networkingMode=mirrored</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-comment\">## 配置代理</span><br><span class=\"hljs-comment\">## 根据自己选择的工具填写端口号</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; ~/.bashrc &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">alias proxy=&#x27;export all_proxy=http://127.0.0.1:7890&#x27;</span><br><span class=\"hljs-string\">alias unproxy=&#x27;unset all_proxy&#x27;</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-built_in\">source</span> ~/.bashrc<br><span class=\"hljs-comment\">## 运行即可启动代理</span><br>proxy<br><br><span class=\"hljs-comment\">## 配置npm代理</span><br>npm config <span class=\"hljs-built_in\">set</span> proxy=http://127.0.0.1:7890<br><span class=\"hljs-comment\">## 默认registry地址，可换成其他国内源</span><br>npm config <span class=\"hljs-built_in\">set</span> registry=http://registry.npmjs.org<br><br>npm install -g hexo<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-github加速\"><a href=\"#配置-github加速\" class=\"headerlink\" title=\"配置 github加速\"></a>配置 github加速</h2><p>在<code>/etc/hosts</code>下添加</p>\n<figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs accesslog\"><span class=\"hljs-number\">199.96.58.157</span> github.global.ssl.fastly.net<br><span class=\"hljs-number\">20.205.243.166</span> github.com<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h2 id=\"WSL-启动-Ubuntu\"><a href=\"#WSL-启动-Ubuntu\" class=\"headerlink\" title=\"WSL 启动 Ubuntu\"></a>WSL 启动 Ubuntu</h2><p>由于22.04 jammy不支持高版本nodejs，所以我们下载24.04 noble版本的Ubuntu。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 查看可下载的发行版</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-o</span><br><br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">-d</span> Ubuntu<span class=\"hljs-literal\">-24</span>.<span class=\"hljs-number\">04</span> <br></code></pre></td></tr></table></figure>\n\n<p><img src=\"/../images/wsl-linux-init/available_list.png\" alt=\"list\"></p>\n<p>等待下载完成就会自动进入。</p>\n<h3 id=\"配置-apt阿里源\"><a href=\"#配置-apt阿里源\" class=\"headerlink\" title=\"配置 apt阿里源\"></a>配置 apt阿里源</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak<br><br><span class=\"hljs-comment\">## 查看版本codename</span><br><span class=\"hljs-built_in\">cat</span> /etc/os-release | grep UBUNTU_CODENAME<br><span class=\"hljs-comment\">## 如用其他版本，如22.04 jammy，将noble替换为jammy即可</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/apt/sources.list &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">deb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse</span><br><span class=\"hljs-string\">deb-src http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse</span><br><span class=\"hljs-string\">deb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse</span><br><span class=\"hljs-string\">deb-src http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-comment\">## 配置完后update</span><br>apt update<br><br>apt install nodejs npm<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"WSL-本地导入CentOS\"><a href=\"#WSL-本地导入CentOS\" class=\"headerlink\" title=\"WSL 本地导入CentOS\"></a>WSL 本地导入CentOS</h2><p>WSL没有CentOS的发行版，因此需要自行导出一个。</p>\n<p>centos的tar包从docker容器导出。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">wsl <span class=\"hljs-literal\">--import</span> CentOS D:\\wsl\\centos\\ .\\centos.tar<br>wsl <span class=\"hljs-literal\">-d</span> CentOS<br><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/wsl.conf &lt;&lt;EOF<br>[<span class=\"hljs-type\">boot</span>]<br>systemd=true<br>EOF<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置-yum阿里源\"><a href=\"#配置-yum阿里源\" class=\"headerlink\" title=\"配置 yum阿里源\"></a>配置 yum阿里源</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak<br>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>yum clean all &amp;&amp; yum makecache<br><br>yum install initscripts<br>yum install net-tools<br>yum install <span class=\"hljs-built_in\">which</span><br>yum install <span class=\"hljs-built_in\">sudo</span><br>yum install tmux<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置代理\"><a href=\"#配置代理\" class=\"headerlink\" title=\"配置代理\"></a>配置代理</h2><p>此处我将自己的WSL网络设置成了<code>mirrored</code>，因此在访问一些服务的时候可以通过127.0.0.1来访问。</p>\n<p>比如 ssh可以通过<code>ssh root@127.0.0.1</code>来远程连接，方便使用其他终端程序；Web服务可以通过<a href=\"http://127.0.0.1/\">http://127.0.0.1:80</a> 访问。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 设置网络为镜像网络，完成后关闭虚拟机，等待8秒后再启动</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt;/mnt/c/Users/xxx/.wslconfig &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[experimental]</span><br><span class=\"hljs-string\">networkingMode=mirrored</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-comment\">## 配置代理</span><br><span class=\"hljs-comment\">## 根据自己选择的工具填写端口号</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; ~/.bashrc &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">alias proxy=&#x27;export all_proxy=http://127.0.0.1:7890&#x27;</span><br><span class=\"hljs-string\">alias unproxy=&#x27;unset all_proxy&#x27;</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-built_in\">source</span> ~/.bashrc<br><span class=\"hljs-comment\">## 运行即可启动代理</span><br>proxy<br><br><span class=\"hljs-comment\">## 配置npm代理</span><br>npm config <span class=\"hljs-built_in\">set</span> proxy=http://127.0.0.1:7890<br><span class=\"hljs-comment\">## 默认registry地址，可换成其他国内源</span><br>npm config <span class=\"hljs-built_in\">set</span> registry=http://registry.npmjs.org<br><br>npm install -g hexo<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-github加速\"><a href=\"#配置-github加速\" class=\"headerlink\" title=\"配置 github加速\"></a>配置 github加速</h2><p>在<code>/etc/hosts</code>下添加</p>\n<figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs accesslog\"><span class=\"hljs-number\">199.96.58.157</span> github.global.ssl.fastly.net<br><span class=\"hljs-number\">20.205.243.166</span> github.com<br></code></pre></td></tr></table></figure>\n\n"},{"title":"Ansible ad-hoc简介","date":"2024-07-12T07:59:04.000Z","_content":"# Ansible Ad-Hoc\nAd-Hoc形式应用场景主要在临时执行一些操作时会用到，更注重解决一些简单或临时任务，复杂操作会使用playbook来实现。\n比如想临时传一个文件到被控机上就可以使用ad-hoc形式来完成。\n```bash\nansible all -m copy -a \"src=/root/monitor.sh dest=/root/ backup=yes\"\n```\n## 常用选项\n```bash\n# -v 可使用-vvv输出更详细内容\n# -i 指定inventory\n# -f 指定并发线程数\n# --private-key 指定密钥文件\n# -m 指定执行模块\n# -M 指定模块存放路径\n# -a 模块参数，默认command模块\n# -t 输出信息到指定目录，文件以主机名命名\n# -T 指定最大超时时间\n# -B 后台执行命令，超过指定时间后中止执行的任务\n# -P 定期以指定时间间隔返回后台任务进度\n# --list-hosts 列出符合条件的主机，不执行任何命令\nansible -i hosts all -f 20 -B 10 -P 2 -T 1 -m shell -a \"df -h\" -vvv\nansible all --list-hosts\n```\nsuccess 表示命令执行成功，changed 是否对主机做出变更\n> 建议并发数配置为CPU核数偶数倍就行。如4C 8G的机器，最多并发20个线程\n## ansible-doc\n如果不知道有哪些模块以及模块有哪些参数可用，就可使用此命令查看\n```bash\nansible-doc -l\nansible-doc -s shell\n```\n- `-l` 选项列出所有可用模块\n- `-s` 只显示playbook说明的代码段\n## 指定主机执行任务\n```bash\n# --limit \nansible all -m shell -a \"ls -l\" --limit \"192.168.3.27\"\n# 指定IP\nansible 192.168.3.27 -m shell -a \"ls -l\"\n# : 分隔符指定多台机器做变更，但\"\"必须使用\nansible \"192.168.3.27:192.168.33.22\" -m shell -a \"ls -l\"\n# * 通配符匹配多台机器\nansible 192.168.3.* -m shell -a \"ls -l\"\n```\n\n","source":"_posts/ansible-ad-hoc.md","raw":"---\ntitle: Ansible ad-hoc简介\ndate: 2024-07-12 15:59:04\ntags: ansible\n---\n# Ansible Ad-Hoc\nAd-Hoc形式应用场景主要在临时执行一些操作时会用到，更注重解决一些简单或临时任务，复杂操作会使用playbook来实现。\n比如想临时传一个文件到被控机上就可以使用ad-hoc形式来完成。\n```bash\nansible all -m copy -a \"src=/root/monitor.sh dest=/root/ backup=yes\"\n```\n## 常用选项\n```bash\n# -v 可使用-vvv输出更详细内容\n# -i 指定inventory\n# -f 指定并发线程数\n# --private-key 指定密钥文件\n# -m 指定执行模块\n# -M 指定模块存放路径\n# -a 模块参数，默认command模块\n# -t 输出信息到指定目录，文件以主机名命名\n# -T 指定最大超时时间\n# -B 后台执行命令，超过指定时间后中止执行的任务\n# -P 定期以指定时间间隔返回后台任务进度\n# --list-hosts 列出符合条件的主机，不执行任何命令\nansible -i hosts all -f 20 -B 10 -P 2 -T 1 -m shell -a \"df -h\" -vvv\nansible all --list-hosts\n```\nsuccess 表示命令执行成功，changed 是否对主机做出变更\n> 建议并发数配置为CPU核数偶数倍就行。如4C 8G的机器，最多并发20个线程\n## ansible-doc\n如果不知道有哪些模块以及模块有哪些参数可用，就可使用此命令查看\n```bash\nansible-doc -l\nansible-doc -s shell\n```\n- `-l` 选项列出所有可用模块\n- `-s` 只显示playbook说明的代码段\n## 指定主机执行任务\n```bash\n# --limit \nansible all -m shell -a \"ls -l\" --limit \"192.168.3.27\"\n# 指定IP\nansible 192.168.3.27 -m shell -a \"ls -l\"\n# : 分隔符指定多台机器做变更，但\"\"必须使用\nansible \"192.168.3.27:192.168.33.22\" -m shell -a \"ls -l\"\n# * 通配符匹配多台机器\nansible 192.168.3.* -m shell -a \"ls -l\"\n```\n\n","slug":"ansible-ad-hoc","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yl0005uhuq90pa0t2k","content":"<h1 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h1><p>Ad-Hoc形式应用场景主要在临时执行一些操作时会用到，更注重解决一些简单或临时任务，复杂操作会使用playbook来实现。<br>比如想临时传一个文件到被控机上就可以使用ad-hoc形式来完成。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ansible all -m copy -a <span class=\"hljs-string\">&quot;src=/root/monitor.sh dest=/root/ backup=yes&quot;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"常用选项\"><a href=\"#常用选项\" class=\"headerlink\" title=\"常用选项\"></a>常用选项</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># -v 可使用-vvv输出更详细内容</span><br><span class=\"hljs-comment\"># -i 指定inventory</span><br><span class=\"hljs-comment\"># -f 指定并发线程数</span><br><span class=\"hljs-comment\"># --private-key 指定密钥文件</span><br><span class=\"hljs-comment\"># -m 指定执行模块</span><br><span class=\"hljs-comment\"># -M 指定模块存放路径</span><br><span class=\"hljs-comment\"># -a 模块参数，默认command模块</span><br><span class=\"hljs-comment\"># -t 输出信息到指定目录，文件以主机名命名</span><br><span class=\"hljs-comment\"># -T 指定最大超时时间</span><br><span class=\"hljs-comment\"># -B 后台执行命令，超过指定时间后中止执行的任务</span><br><span class=\"hljs-comment\"># -P 定期以指定时间间隔返回后台任务进度</span><br><span class=\"hljs-comment\"># --list-hosts 列出符合条件的主机，不执行任何命令</span><br>ansible -i hosts all -f 20 -B 10 -P 2 -T 1 -m shell -a <span class=\"hljs-string\">&quot;df -h&quot;</span> -vvv<br>ansible all --list-hosts<br></code></pre></td></tr></table></figure>\n<p>success 表示命令执行成功，changed 是否对主机做出变更</p>\n<blockquote>\n<p>建议并发数配置为CPU核数偶数倍就行。如4C 8G的机器，最多并发20个线程</p>\n</blockquote>\n<h2 id=\"ansible-doc\"><a href=\"#ansible-doc\" class=\"headerlink\" title=\"ansible-doc\"></a>ansible-doc</h2><p>如果不知道有哪些模块以及模块有哪些参数可用，就可使用此命令查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ansible-doc -l<br>ansible-doc -s shell<br></code></pre></td></tr></table></figure>\n<ul>\n<li><code>-l</code> 选项列出所有可用模块</li>\n<li><code>-s</code> 只显示playbook说明的代码段</li>\n</ul>\n<h2 id=\"指定主机执行任务\"><a href=\"#指定主机执行任务\" class=\"headerlink\" title=\"指定主机执行任务\"></a>指定主机执行任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># --limit </span><br>ansible all -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span> --<span class=\"hljs-built_in\">limit</span> <span class=\"hljs-string\">&quot;192.168.3.27&quot;</span><br><span class=\"hljs-comment\"># 指定IP</span><br>ansible 192.168.3.27 -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br><span class=\"hljs-comment\"># : 分隔符指定多台机器做变更，但&quot;&quot;必须使用</span><br>ansible <span class=\"hljs-string\">&quot;192.168.3.27:192.168.33.22&quot;</span> -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br><span class=\"hljs-comment\"># * 通配符匹配多台机器</span><br>ansible 192.168.3.* -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"Ansible-Ad-Hoc\"><a href=\"#Ansible-Ad-Hoc\" class=\"headerlink\" title=\"Ansible Ad-Hoc\"></a>Ansible Ad-Hoc</h1><p>Ad-Hoc形式应用场景主要在临时执行一些操作时会用到，更注重解决一些简单或临时任务，复杂操作会使用playbook来实现。<br>比如想临时传一个文件到被控机上就可以使用ad-hoc形式来完成。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ansible all -m copy -a <span class=\"hljs-string\">&quot;src=/root/monitor.sh dest=/root/ backup=yes&quot;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"常用选项\"><a href=\"#常用选项\" class=\"headerlink\" title=\"常用选项\"></a>常用选项</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># -v 可使用-vvv输出更详细内容</span><br><span class=\"hljs-comment\"># -i 指定inventory</span><br><span class=\"hljs-comment\"># -f 指定并发线程数</span><br><span class=\"hljs-comment\"># --private-key 指定密钥文件</span><br><span class=\"hljs-comment\"># -m 指定执行模块</span><br><span class=\"hljs-comment\"># -M 指定模块存放路径</span><br><span class=\"hljs-comment\"># -a 模块参数，默认command模块</span><br><span class=\"hljs-comment\"># -t 输出信息到指定目录，文件以主机名命名</span><br><span class=\"hljs-comment\"># -T 指定最大超时时间</span><br><span class=\"hljs-comment\"># -B 后台执行命令，超过指定时间后中止执行的任务</span><br><span class=\"hljs-comment\"># -P 定期以指定时间间隔返回后台任务进度</span><br><span class=\"hljs-comment\"># --list-hosts 列出符合条件的主机，不执行任何命令</span><br>ansible -i hosts all -f 20 -B 10 -P 2 -T 1 -m shell -a <span class=\"hljs-string\">&quot;df -h&quot;</span> -vvv<br>ansible all --list-hosts<br></code></pre></td></tr></table></figure>\n<p>success 表示命令执行成功，changed 是否对主机做出变更</p>\n<blockquote>\n<p>建议并发数配置为CPU核数偶数倍就行。如4C 8G的机器，最多并发20个线程</p>\n</blockquote>\n<h2 id=\"ansible-doc\"><a href=\"#ansible-doc\" class=\"headerlink\" title=\"ansible-doc\"></a>ansible-doc</h2><p>如果不知道有哪些模块以及模块有哪些参数可用，就可使用此命令查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ansible-doc -l<br>ansible-doc -s shell<br></code></pre></td></tr></table></figure>\n<ul>\n<li><code>-l</code> 选项列出所有可用模块</li>\n<li><code>-s</code> 只显示playbook说明的代码段</li>\n</ul>\n<h2 id=\"指定主机执行任务\"><a href=\"#指定主机执行任务\" class=\"headerlink\" title=\"指定主机执行任务\"></a>指定主机执行任务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># --limit </span><br>ansible all -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span> --<span class=\"hljs-built_in\">limit</span> <span class=\"hljs-string\">&quot;192.168.3.27&quot;</span><br><span class=\"hljs-comment\"># 指定IP</span><br>ansible 192.168.3.27 -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br><span class=\"hljs-comment\"># : 分隔符指定多台机器做变更，但&quot;&quot;必须使用</span><br>ansible <span class=\"hljs-string\">&quot;192.168.3.27:192.168.33.22&quot;</span> -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br><span class=\"hljs-comment\"># * 通配符匹配多台机器</span><br>ansible 192.168.3.* -m shell -a <span class=\"hljs-string\">&quot;ls -l&quot;</span><br></code></pre></td></tr></table></figure>\n\n"},{"title":"Hexo部署GitHub个人博客","date":"2024-08-05T02:42:50.000Z","_content":"\n# Hexo部署GitHub个人博客\n\n## 1. 安装Hexo\n\n安装Hexo需要\n\n- nodejs\n- npm\n\n```bash\n# 注意nodejs版本\n# 需要 ubuntu noble版本\napt install nodejs npm\n# npm 下载慢需要跟换国内源，或者添加代理\nnpm install -g hexo\n```\n\n## 2. Hexo 常用命令\n\n```bash\n# 需要一点时间\nhexo init $proj_name\n\n## 新建post\nhexo new \"My First Blog\"\n\n## 启动本地server\nhexo server\n\n## 生成页面并部署到github\nhexo generate && hexo deploy\n## 可简写\nhexo g\nhexo d\n```\n\n## 3. 配置 GitHub\n\n1. 新建一个github项目\n\n2. 点进项目找到Settings -> Pages 进行配置 GitHub Pages\n\n   ![page](../images/deploy-hexo/page.png)\n\n```bash\n# 将项目clone下来\n# 此处最好配置ssh类型, 不然后面每次部署推送都需要输入账号和token，且ssh不容易出现某些网络问题\ngit clone $url\n# 创建一个分支用来存储hexo源代码\ngit checkout -b hexo\n```\n\n**配置SSH方式**\n\n```bash\n# 生成sshkey\nssh-keygen -t rsa\n## 将公钥复制到github的项目settings -> Deploy keys里\ncat ~/.ssh/id_rsa.pub\n```\n> GitHub从2021年8月13号开始不能用密码推送，需要用token。\n>\n> token需要在右上角个人Settings -> [Developer Settings](https://github.com/settings/apps) -> [Personal access tokens](https://github.com/settings/tokens)里生成。\n>\n> 注意保管，丢失了需要重新生成。\n\n\n## 4. 配置 Hexo\n\n```bash\n## 查看目录结构\ntree -L 1 \n## 输出如下\nMyBlog/\n├── _config.landscape.yml ## 主题配置文件，默认主题landscape，主题可在 https://hexo.io/themes/ 官网自行寻找\n├── _config.yml ## hexo配置文件\n├── node_modules\n├── package-lock.json\n├── package.json\n├── scaffolds\n├── source ## post存放目录，可在同级建立image存放图片\n└── themes\n```\n\n此处`_config.yml`配置自行修改，注意url填写你的 GitHub Pages地址。\n\n![config](../images/deploy-hexo/config.png)\n\n在`_config.yml`最后有deploy的配置选项，默认如图：\n\n![](../images/deploy-hexo/deploy-config.png)\n\n修改为：\n\n![](../images/deploy-hexo/deploy-git.png)\n\nbranch填写你需要部署的分支，我这里选择master；\n\nrepo 填写git地址，可以是https形式，也可以是ssh形式。\n\n## 5. 部署&推送到仓库\n\n```bash\n## hexo 会生成一个 .deploy_git\n## 所以我们将这个文件写入 .gitignore\necho \".deploy_git/\" >> .gitignore\n## 如果之前有过推送需要删掉\ngit rm -r --cached .deploy_git\n\n## 生成页面并部署，因为配置过git仓地址，会自动触发github action 进行部署\nhexo g && hexo d\n\n## 将源文件推送到hexo分支\ngit push origin hexo\n\n```\n\n","source":"_posts/deploy-hexo.md","raw":"---\ntitle: Hexo部署GitHub个人博客\ndate: 2024-08-05 10:42:50\ntags: tools\n---\n\n# Hexo部署GitHub个人博客\n\n## 1. 安装Hexo\n\n安装Hexo需要\n\n- nodejs\n- npm\n\n```bash\n# 注意nodejs版本\n# 需要 ubuntu noble版本\napt install nodejs npm\n# npm 下载慢需要跟换国内源，或者添加代理\nnpm install -g hexo\n```\n\n## 2. Hexo 常用命令\n\n```bash\n# 需要一点时间\nhexo init $proj_name\n\n## 新建post\nhexo new \"My First Blog\"\n\n## 启动本地server\nhexo server\n\n## 生成页面并部署到github\nhexo generate && hexo deploy\n## 可简写\nhexo g\nhexo d\n```\n\n## 3. 配置 GitHub\n\n1. 新建一个github项目\n\n2. 点进项目找到Settings -> Pages 进行配置 GitHub Pages\n\n   ![page](../images/deploy-hexo/page.png)\n\n```bash\n# 将项目clone下来\n# 此处最好配置ssh类型, 不然后面每次部署推送都需要输入账号和token，且ssh不容易出现某些网络问题\ngit clone $url\n# 创建一个分支用来存储hexo源代码\ngit checkout -b hexo\n```\n\n**配置SSH方式**\n\n```bash\n# 生成sshkey\nssh-keygen -t rsa\n## 将公钥复制到github的项目settings -> Deploy keys里\ncat ~/.ssh/id_rsa.pub\n```\n> GitHub从2021年8月13号开始不能用密码推送，需要用token。\n>\n> token需要在右上角个人Settings -> [Developer Settings](https://github.com/settings/apps) -> [Personal access tokens](https://github.com/settings/tokens)里生成。\n>\n> 注意保管，丢失了需要重新生成。\n\n\n## 4. 配置 Hexo\n\n```bash\n## 查看目录结构\ntree -L 1 \n## 输出如下\nMyBlog/\n├── _config.landscape.yml ## 主题配置文件，默认主题landscape，主题可在 https://hexo.io/themes/ 官网自行寻找\n├── _config.yml ## hexo配置文件\n├── node_modules\n├── package-lock.json\n├── package.json\n├── scaffolds\n├── source ## post存放目录，可在同级建立image存放图片\n└── themes\n```\n\n此处`_config.yml`配置自行修改，注意url填写你的 GitHub Pages地址。\n\n![config](../images/deploy-hexo/config.png)\n\n在`_config.yml`最后有deploy的配置选项，默认如图：\n\n![](../images/deploy-hexo/deploy-config.png)\n\n修改为：\n\n![](../images/deploy-hexo/deploy-git.png)\n\nbranch填写你需要部署的分支，我这里选择master；\n\nrepo 填写git地址，可以是https形式，也可以是ssh形式。\n\n## 5. 部署&推送到仓库\n\n```bash\n## hexo 会生成一个 .deploy_git\n## 所以我们将这个文件写入 .gitignore\necho \".deploy_git/\" >> .gitignore\n## 如果之前有过推送需要删掉\ngit rm -r --cached .deploy_git\n\n## 生成页面并部署，因为配置过git仓地址，会自动触发github action 进行部署\nhexo g && hexo d\n\n## 将源文件推送到hexo分支\ngit push origin hexo\n\n```\n\n","slug":"deploy-hexo","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3ym0006uhuq5bnr3uzz","content":"<h1 id=\"Hexo部署GitHub个人博客\"><a href=\"#Hexo部署GitHub个人博客\" class=\"headerlink\" title=\"Hexo部署GitHub个人博客\"></a>Hexo部署GitHub个人博客</h1><h2 id=\"1-安装Hexo\"><a href=\"#1-安装Hexo\" class=\"headerlink\" title=\"1. 安装Hexo\"></a>1. 安装Hexo</h2><p>安装Hexo需要</p>\n<ul>\n<li>nodejs</li>\n<li>npm</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 注意nodejs版本</span><br><span class=\"hljs-comment\"># 需要 ubuntu noble版本</span><br>apt install nodejs npm<br><span class=\"hljs-comment\"># npm 下载慢需要跟换国内源，或者添加代理</span><br>npm install -g hexo<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"2-Hexo-常用命令\"><a href=\"#2-Hexo-常用命令\" class=\"headerlink\" title=\"2. Hexo 常用命令\"></a>2. Hexo 常用命令</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 需要一点时间</span><br>hexo init <span class=\"hljs-variable\">$proj_name</span><br><br><span class=\"hljs-comment\">## 新建post</span><br>hexo new <span class=\"hljs-string\">&quot;My First Blog&quot;</span><br><br><span class=\"hljs-comment\">## 启动本地server</span><br>hexo server<br><br><span class=\"hljs-comment\">## 生成页面并部署到github</span><br>hexo generate &amp;&amp; hexo deploy<br><span class=\"hljs-comment\">## 可简写</span><br>hexo g<br>hexo d<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"3-配置-GitHub\"><a href=\"#3-配置-GitHub\" class=\"headerlink\" title=\"3. 配置 GitHub\"></a>3. 配置 GitHub</h2><ol>\n<li><p>新建一个github项目</p>\n</li>\n<li><p>点进项目找到Settings -&gt; Pages 进行配置 GitHub Pages</p>\n<p><img src=\"/../images/deploy-hexo/page.png\" alt=\"page\"></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将项目clone下来</span><br><span class=\"hljs-comment\"># 此处最好配置ssh类型, 不然后面每次部署推送都需要输入账号和token，且ssh不容易出现某些网络问题</span><br>git <span class=\"hljs-built_in\">clone</span> <span class=\"hljs-variable\">$url</span><br><span class=\"hljs-comment\"># 创建一个分支用来存储hexo源代码</span><br>git checkout -b hexo<br></code></pre></td></tr></table></figure>\n\n<p><strong>配置SSH方式</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 生成sshkey</span><br>ssh-keygen -t rsa<br><span class=\"hljs-comment\">## 将公钥复制到github的项目settings -&gt; Deploy keys里</span><br><span class=\"hljs-built_in\">cat</span> ~/.ssh/id_rsa.pub<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>GitHub从2021年8月13号开始不能用密码推送，需要用token。</p>\n<p>token需要在右上角个人Settings -&gt; <a href=\"https://github.com/settings/apps\">Developer Settings</a> -&gt; <a href=\"https://github.com/settings/tokens\">Personal access tokens</a>里生成。</p>\n<p>注意保管，丢失了需要重新生成。</p>\n</blockquote>\n<h2 id=\"4-配置-Hexo\"><a href=\"#4-配置-Hexo\" class=\"headerlink\" title=\"4. 配置 Hexo\"></a>4. 配置 Hexo</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看目录结构</span><br>tree -L 1 <br><span class=\"hljs-comment\">## 输出如下</span><br>MyBlog/<br>├── _config.landscape.yml <span class=\"hljs-comment\">## 主题配置文件，默认主题landscape，主题可在 https://hexo.io/themes/ 官网自行寻找</span><br>├── _config.yml <span class=\"hljs-comment\">## hexo配置文件</span><br>├── node_modules<br>├── package-lock.json<br>├── package.json<br>├── scaffolds<br>├── <span class=\"hljs-built_in\">source</span> <span class=\"hljs-comment\">## post存放目录，可在同级建立image存放图片</span><br>└── themes<br></code></pre></td></tr></table></figure>\n\n<p>此处<code>_config.yml</code>配置自行修改，注意url填写你的 GitHub Pages地址。</p>\n<p><img src=\"/../images/deploy-hexo/config.png\" alt=\"config\"></p>\n<p>在<code>_config.yml</code>最后有deploy的配置选项，默认如图：</p>\n<p><img src=\"/../images/deploy-hexo/deploy-config.png\"></p>\n<p>修改为：</p>\n<p><img src=\"/../images/deploy-hexo/deploy-git.png\"></p>\n<p>branch填写你需要部署的分支，我这里选择master；</p>\n<p>repo 填写git地址，可以是https形式，也可以是ssh形式。</p>\n<h2 id=\"5-部署-推送到仓库\"><a href=\"#5-部署-推送到仓库\" class=\"headerlink\" title=\"5. 部署&amp;推送到仓库\"></a>5. 部署&amp;推送到仓库</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## hexo 会生成一个 .deploy_git</span><br><span class=\"hljs-comment\">## 所以我们将这个文件写入 .gitignore</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;.deploy_git/&quot;</span> &gt;&gt; .gitignore<br><span class=\"hljs-comment\">## 如果之前有过推送需要删掉</span><br>git <span class=\"hljs-built_in\">rm</span> -r --cached .deploy_git<br><br><span class=\"hljs-comment\">## 生成页面并部署，因为配置过git仓地址，会自动触发github action 进行部署</span><br>hexo g &amp;&amp; hexo d<br><br><span class=\"hljs-comment\">## 将源文件推送到hexo分支</span><br>git push origin hexo<br><br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"Hexo部署GitHub个人博客\"><a href=\"#Hexo部署GitHub个人博客\" class=\"headerlink\" title=\"Hexo部署GitHub个人博客\"></a>Hexo部署GitHub个人博客</h1><h2 id=\"1-安装Hexo\"><a href=\"#1-安装Hexo\" class=\"headerlink\" title=\"1. 安装Hexo\"></a>1. 安装Hexo</h2><p>安装Hexo需要</p>\n<ul>\n<li>nodejs</li>\n<li>npm</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 注意nodejs版本</span><br><span class=\"hljs-comment\"># 需要 ubuntu noble版本</span><br>apt install nodejs npm<br><span class=\"hljs-comment\"># npm 下载慢需要跟换国内源，或者添加代理</span><br>npm install -g hexo<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"2-Hexo-常用命令\"><a href=\"#2-Hexo-常用命令\" class=\"headerlink\" title=\"2. Hexo 常用命令\"></a>2. Hexo 常用命令</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 需要一点时间</span><br>hexo init <span class=\"hljs-variable\">$proj_name</span><br><br><span class=\"hljs-comment\">## 新建post</span><br>hexo new <span class=\"hljs-string\">&quot;My First Blog&quot;</span><br><br><span class=\"hljs-comment\">## 启动本地server</span><br>hexo server<br><br><span class=\"hljs-comment\">## 生成页面并部署到github</span><br>hexo generate &amp;&amp; hexo deploy<br><span class=\"hljs-comment\">## 可简写</span><br>hexo g<br>hexo d<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"3-配置-GitHub\"><a href=\"#3-配置-GitHub\" class=\"headerlink\" title=\"3. 配置 GitHub\"></a>3. 配置 GitHub</h2><ol>\n<li><p>新建一个github项目</p>\n</li>\n<li><p>点进项目找到Settings -&gt; Pages 进行配置 GitHub Pages</p>\n<p><img src=\"/../images/deploy-hexo/page.png\" alt=\"page\"></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将项目clone下来</span><br><span class=\"hljs-comment\"># 此处最好配置ssh类型, 不然后面每次部署推送都需要输入账号和token，且ssh不容易出现某些网络问题</span><br>git <span class=\"hljs-built_in\">clone</span> <span class=\"hljs-variable\">$url</span><br><span class=\"hljs-comment\"># 创建一个分支用来存储hexo源代码</span><br>git checkout -b hexo<br></code></pre></td></tr></table></figure>\n\n<p><strong>配置SSH方式</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 生成sshkey</span><br>ssh-keygen -t rsa<br><span class=\"hljs-comment\">## 将公钥复制到github的项目settings -&gt; Deploy keys里</span><br><span class=\"hljs-built_in\">cat</span> ~/.ssh/id_rsa.pub<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>GitHub从2021年8月13号开始不能用密码推送，需要用token。</p>\n<p>token需要在右上角个人Settings -&gt; <a href=\"https://github.com/settings/apps\">Developer Settings</a> -&gt; <a href=\"https://github.com/settings/tokens\">Personal access tokens</a>里生成。</p>\n<p>注意保管，丢失了需要重新生成。</p>\n</blockquote>\n<h2 id=\"4-配置-Hexo\"><a href=\"#4-配置-Hexo\" class=\"headerlink\" title=\"4. 配置 Hexo\"></a>4. 配置 Hexo</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看目录结构</span><br>tree -L 1 <br><span class=\"hljs-comment\">## 输出如下</span><br>MyBlog/<br>├── _config.landscape.yml <span class=\"hljs-comment\">## 主题配置文件，默认主题landscape，主题可在 https://hexo.io/themes/ 官网自行寻找</span><br>├── _config.yml <span class=\"hljs-comment\">## hexo配置文件</span><br>├── node_modules<br>├── package-lock.json<br>├── package.json<br>├── scaffolds<br>├── <span class=\"hljs-built_in\">source</span> <span class=\"hljs-comment\">## post存放目录，可在同级建立image存放图片</span><br>└── themes<br></code></pre></td></tr></table></figure>\n\n<p>此处<code>_config.yml</code>配置自行修改，注意url填写你的 GitHub Pages地址。</p>\n<p><img src=\"/../images/deploy-hexo/config.png\" alt=\"config\"></p>\n<p>在<code>_config.yml</code>最后有deploy的配置选项，默认如图：</p>\n<p><img src=\"/../images/deploy-hexo/deploy-config.png\"></p>\n<p>修改为：</p>\n<p><img src=\"/../images/deploy-hexo/deploy-git.png\"></p>\n<p>branch填写你需要部署的分支，我这里选择master；</p>\n<p>repo 填写git地址，可以是https形式，也可以是ssh形式。</p>\n<h2 id=\"5-部署-推送到仓库\"><a href=\"#5-部署-推送到仓库\" class=\"headerlink\" title=\"5. 部署&amp;推送到仓库\"></a>5. 部署&amp;推送到仓库</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## hexo 会生成一个 .deploy_git</span><br><span class=\"hljs-comment\">## 所以我们将这个文件写入 .gitignore</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;.deploy_git/&quot;</span> &gt;&gt; .gitignore<br><span class=\"hljs-comment\">## 如果之前有过推送需要删掉</span><br>git <span class=\"hljs-built_in\">rm</span> -r --cached .deploy_git<br><br><span class=\"hljs-comment\">## 生成页面并部署，因为配置过git仓地址，会自动触发github action 进行部署</span><br>hexo g &amp;&amp; hexo d<br><br><span class=\"hljs-comment\">## 将源文件推送到hexo分支</span><br>git push origin hexo<br><br></code></pre></td></tr></table></figure>\n\n"},{"title":"Git 基本用法","date":"2024-07-08T05:33:02.000Z","_content":"\n# Git 基本用法\n\n> git的结构就像一棵树一样\n>\n> main主干，dev，test，issue ... 都是分支树杈\n\n## pull & push\n\n```bash\n## 初始化一个git仓\ngit init \ngit remote add $alias $url\ngit branch -M master(main)\n## 查看远程仓库\ngit remote -v\ngit push -u origin master \n\n## 远程分支名:本地分支名\n## 旧版为master ，新版默认main\ngit pull origin master:master \n\n## 修改git地址\ngit remote set-url origin $url\n## 已跟踪文件取消跟踪，配合.gitignore，之后推送都忽略\ngit rm -r --cached $file\n```\n\n## reset\n\n```bash\ngit ls-files ## 查看暂存区文件\n\ngit reset --soft ## 工作区和暂存区都不清空\ngit reset --hard ## 工作区暂存区全部清空\ngit reset --mixed ## 保留工作区，清理暂存区，默认选项\n\ngit reset HEAD^ ## 回退到上一次提交\n\ngit log ## 公共提交记录\ngit reflog ## 本地操作记录\n```\n\n## switch/checkout\n\n```bash\n## 创建一个分支\ngit branch $branch \n## 可以切换分支也可以切换至某次提交或恢复某次提交的文件，如分支与文件名相同会产生冲突，默认是切换分支\ngit checkout $branch($commit) \n## 切换某分支的某次提交\ngit checkout -b $branch $commit \n## 仅切换至某分支\ngit switch $branch\n## 误删除文件，还未add时\n## 放弃所有修改，恢复全部\ngit checkout .\ngit checkout -- *\n## 放弃某个文件，恢复某个文件\ngit checkout -- $filename\n## 如果一个分支提交过后可以用-d选项删掉分支，没有提交想删除需用-D强制删除分支\ngit branch -d $branch\ngit branch -D $branch\n## 图表形式查看分支结构\ngit log --graph --oneline --decorate --all\n```\n\n## merge\n\n```bash\ngit merge $branch\n## 两个分支修改了同一个文件的同一处位置会产生冲突\n## 查看冲突具体内容，修改文件中的冲突后再提交\ngit diff\n## 中止合并\ngit merge --abort\n```\n\n## rebase\n\n```bash\n## 如果当前有两个分支，main和dev\n## 当前处在dev分支时，rebase会把dev分支接在main分支最新一次提交后\ngit switch dev\ngit rebase main\n## 当前处在main分支时，rebase会把main分支接在dev分支最新一次提交后\ngit switch main\ngit rebase dev\n```\n\n","source":"_posts/git-intro.md","raw":"---\ntitle: Git 基本用法\ndate: 2024-07-08 13:33:02\ntags: tools\n---\n\n# Git 基本用法\n\n> git的结构就像一棵树一样\n>\n> main主干，dev，test，issue ... 都是分支树杈\n\n## pull & push\n\n```bash\n## 初始化一个git仓\ngit init \ngit remote add $alias $url\ngit branch -M master(main)\n## 查看远程仓库\ngit remote -v\ngit push -u origin master \n\n## 远程分支名:本地分支名\n## 旧版为master ，新版默认main\ngit pull origin master:master \n\n## 修改git地址\ngit remote set-url origin $url\n## 已跟踪文件取消跟踪，配合.gitignore，之后推送都忽略\ngit rm -r --cached $file\n```\n\n## reset\n\n```bash\ngit ls-files ## 查看暂存区文件\n\ngit reset --soft ## 工作区和暂存区都不清空\ngit reset --hard ## 工作区暂存区全部清空\ngit reset --mixed ## 保留工作区，清理暂存区，默认选项\n\ngit reset HEAD^ ## 回退到上一次提交\n\ngit log ## 公共提交记录\ngit reflog ## 本地操作记录\n```\n\n## switch/checkout\n\n```bash\n## 创建一个分支\ngit branch $branch \n## 可以切换分支也可以切换至某次提交或恢复某次提交的文件，如分支与文件名相同会产生冲突，默认是切换分支\ngit checkout $branch($commit) \n## 切换某分支的某次提交\ngit checkout -b $branch $commit \n## 仅切换至某分支\ngit switch $branch\n## 误删除文件，还未add时\n## 放弃所有修改，恢复全部\ngit checkout .\ngit checkout -- *\n## 放弃某个文件，恢复某个文件\ngit checkout -- $filename\n## 如果一个分支提交过后可以用-d选项删掉分支，没有提交想删除需用-D强制删除分支\ngit branch -d $branch\ngit branch -D $branch\n## 图表形式查看分支结构\ngit log --graph --oneline --decorate --all\n```\n\n## merge\n\n```bash\ngit merge $branch\n## 两个分支修改了同一个文件的同一处位置会产生冲突\n## 查看冲突具体内容，修改文件中的冲突后再提交\ngit diff\n## 中止合并\ngit merge --abort\n```\n\n## rebase\n\n```bash\n## 如果当前有两个分支，main和dev\n## 当前处在dev分支时，rebase会把dev分支接在main分支最新一次提交后\ngit switch dev\ngit rebase main\n## 当前处在main分支时，rebase会把main分支接在dev分支最新一次提交后\ngit switch main\ngit rebase dev\n```\n\n","slug":"git-intro","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yn0009uhuqhvkdb9ko","content":"<h1 id=\"Git-基本用法\"><a href=\"#Git-基本用法\" class=\"headerlink\" title=\"Git 基本用法\"></a>Git 基本用法</h1><blockquote>\n<p>git的结构就像一棵树一样</p>\n<p>main主干，dev，test，issue … 都是分支树杈</p>\n</blockquote>\n<h2 id=\"pull-push\"><a href=\"#pull-push\" class=\"headerlink\" title=\"pull &amp; push\"></a>pull &amp; push</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 初始化一个git仓</span><br>git init <br>git remote add <span class=\"hljs-variable\">$alias</span> <span class=\"hljs-variable\">$url</span><br>git branch -M master(main)<br><span class=\"hljs-comment\">## 查看远程仓库</span><br>git remote -v<br>git push -u origin master <br><br><span class=\"hljs-comment\">## 远程分支名:本地分支名</span><br><span class=\"hljs-comment\">## 旧版为master ，新版默认main</span><br>git pull origin master:master <br><br><span class=\"hljs-comment\">## 修改git地址</span><br>git remote set-url origin <span class=\"hljs-variable\">$url</span><br><span class=\"hljs-comment\">## 已跟踪文件取消跟踪，配合.gitignore，之后推送都忽略</span><br>git <span class=\"hljs-built_in\">rm</span> -r --cached <span class=\"hljs-variable\">$file</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"reset\"><a href=\"#reset\" class=\"headerlink\" title=\"reset\"></a>reset</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git ls-files <span class=\"hljs-comment\">## 查看暂存区文件</span><br><br>git reset --soft <span class=\"hljs-comment\">## 工作区和暂存区都不清空</span><br>git reset --hard <span class=\"hljs-comment\">## 工作区暂存区全部清空</span><br>git reset --mixed <span class=\"hljs-comment\">## 保留工作区，清理暂存区，默认选项</span><br><br>git reset HEAD^ <span class=\"hljs-comment\">## 回退到上一次提交</span><br><br>git <span class=\"hljs-built_in\">log</span> <span class=\"hljs-comment\">## 公共提交记录</span><br>git reflog <span class=\"hljs-comment\">## 本地操作记录</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"switch-checkout\"><a href=\"#switch-checkout\" class=\"headerlink\" title=\"switch&#x2F;checkout\"></a>switch&#x2F;checkout</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 创建一个分支</span><br>git branch <span class=\"hljs-variable\">$branch</span> <br><span class=\"hljs-comment\">## 可以切换分支也可以切换至某次提交或恢复某次提交的文件，如分支与文件名相同会产生冲突，默认是切换分支</span><br>git checkout <span class=\"hljs-variable\">$branch</span>(<span class=\"hljs-variable\">$commit</span>) <br><span class=\"hljs-comment\">## 切换某分支的某次提交</span><br>git checkout -b <span class=\"hljs-variable\">$branch</span> <span class=\"hljs-variable\">$commit</span> <br><span class=\"hljs-comment\">## 仅切换至某分支</span><br>git switch <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 误删除文件，还未add时</span><br><span class=\"hljs-comment\">## 放弃所有修改，恢复全部</span><br>git checkout .<br>git checkout -- *<br><span class=\"hljs-comment\">## 放弃某个文件，恢复某个文件</span><br>git checkout -- <span class=\"hljs-variable\">$filename</span><br><span class=\"hljs-comment\">## 如果一个分支提交过后可以用-d选项删掉分支，没有提交想删除需用-D强制删除分支</span><br>git branch -d <span class=\"hljs-variable\">$branch</span><br>git branch -D <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 图表形式查看分支结构</span><br>git <span class=\"hljs-built_in\">log</span> --graph --oneline --decorate --all<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"merge\"><a href=\"#merge\" class=\"headerlink\" title=\"merge\"></a>merge</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git merge <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 两个分支修改了同一个文件的同一处位置会产生冲突</span><br><span class=\"hljs-comment\">## 查看冲突具体内容，修改文件中的冲突后再提交</span><br>git diff<br><span class=\"hljs-comment\">## 中止合并</span><br>git merge --abort<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"rebase\"><a href=\"#rebase\" class=\"headerlink\" title=\"rebase\"></a>rebase</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 如果当前有两个分支，main和dev</span><br><span class=\"hljs-comment\">## 当前处在dev分支时，rebase会把dev分支接在main分支最新一次提交后</span><br>git switch dev<br>git rebase main<br><span class=\"hljs-comment\">## 当前处在main分支时，rebase会把main分支接在dev分支最新一次提交后</span><br>git switch main<br>git rebase dev<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"Git-基本用法\"><a href=\"#Git-基本用法\" class=\"headerlink\" title=\"Git 基本用法\"></a>Git 基本用法</h1><blockquote>\n<p>git的结构就像一棵树一样</p>\n<p>main主干，dev，test，issue … 都是分支树杈</p>\n</blockquote>\n<h2 id=\"pull-push\"><a href=\"#pull-push\" class=\"headerlink\" title=\"pull &amp; push\"></a>pull &amp; push</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 初始化一个git仓</span><br>git init <br>git remote add <span class=\"hljs-variable\">$alias</span> <span class=\"hljs-variable\">$url</span><br>git branch -M master(main)<br><span class=\"hljs-comment\">## 查看远程仓库</span><br>git remote -v<br>git push -u origin master <br><br><span class=\"hljs-comment\">## 远程分支名:本地分支名</span><br><span class=\"hljs-comment\">## 旧版为master ，新版默认main</span><br>git pull origin master:master <br><br><span class=\"hljs-comment\">## 修改git地址</span><br>git remote set-url origin <span class=\"hljs-variable\">$url</span><br><span class=\"hljs-comment\">## 已跟踪文件取消跟踪，配合.gitignore，之后推送都忽略</span><br>git <span class=\"hljs-built_in\">rm</span> -r --cached <span class=\"hljs-variable\">$file</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"reset\"><a href=\"#reset\" class=\"headerlink\" title=\"reset\"></a>reset</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git ls-files <span class=\"hljs-comment\">## 查看暂存区文件</span><br><br>git reset --soft <span class=\"hljs-comment\">## 工作区和暂存区都不清空</span><br>git reset --hard <span class=\"hljs-comment\">## 工作区暂存区全部清空</span><br>git reset --mixed <span class=\"hljs-comment\">## 保留工作区，清理暂存区，默认选项</span><br><br>git reset HEAD^ <span class=\"hljs-comment\">## 回退到上一次提交</span><br><br>git <span class=\"hljs-built_in\">log</span> <span class=\"hljs-comment\">## 公共提交记录</span><br>git reflog <span class=\"hljs-comment\">## 本地操作记录</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"switch-checkout\"><a href=\"#switch-checkout\" class=\"headerlink\" title=\"switch&#x2F;checkout\"></a>switch&#x2F;checkout</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 创建一个分支</span><br>git branch <span class=\"hljs-variable\">$branch</span> <br><span class=\"hljs-comment\">## 可以切换分支也可以切换至某次提交或恢复某次提交的文件，如分支与文件名相同会产生冲突，默认是切换分支</span><br>git checkout <span class=\"hljs-variable\">$branch</span>(<span class=\"hljs-variable\">$commit</span>) <br><span class=\"hljs-comment\">## 切换某分支的某次提交</span><br>git checkout -b <span class=\"hljs-variable\">$branch</span> <span class=\"hljs-variable\">$commit</span> <br><span class=\"hljs-comment\">## 仅切换至某分支</span><br>git switch <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 误删除文件，还未add时</span><br><span class=\"hljs-comment\">## 放弃所有修改，恢复全部</span><br>git checkout .<br>git checkout -- *<br><span class=\"hljs-comment\">## 放弃某个文件，恢复某个文件</span><br>git checkout -- <span class=\"hljs-variable\">$filename</span><br><span class=\"hljs-comment\">## 如果一个分支提交过后可以用-d选项删掉分支，没有提交想删除需用-D强制删除分支</span><br>git branch -d <span class=\"hljs-variable\">$branch</span><br>git branch -D <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 图表形式查看分支结构</span><br>git <span class=\"hljs-built_in\">log</span> --graph --oneline --decorate --all<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"merge\"><a href=\"#merge\" class=\"headerlink\" title=\"merge\"></a>merge</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git merge <span class=\"hljs-variable\">$branch</span><br><span class=\"hljs-comment\">## 两个分支修改了同一个文件的同一处位置会产生冲突</span><br><span class=\"hljs-comment\">## 查看冲突具体内容，修改文件中的冲突后再提交</span><br>git diff<br><span class=\"hljs-comment\">## 中止合并</span><br>git merge --abort<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"rebase\"><a href=\"#rebase\" class=\"headerlink\" title=\"rebase\"></a>rebase</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 如果当前有两个分支，main和dev</span><br><span class=\"hljs-comment\">## 当前处在dev分支时，rebase会把dev分支接在main分支最新一次提交后</span><br>git switch dev<br>git rebase main<br><span class=\"hljs-comment\">## 当前处在main分支时，rebase会把main分支接在dev分支最新一次提交后</span><br>git switch main<br>git rebase dev<br></code></pre></td></tr></table></figure>\n\n"},{"title":"[K8s] Kubernetes Install","date":"2024-07-08T05:30:02.000Z","_content":"\n# K8s Install\n\n## 1. Standard\n\n- 2GB or more of RAM\n- 2CPUs or more\n\n## 2. Prepare\n\n- You need to install a container runtime into each node in the cluster so that Pods can run there.\n\n- Certain ports are open on your machines\n  - systemctl firewalld stop\n- Disable swap\n  - swapoff -a\n  - check /etc/fstab\n- Verify glibc is provide or not in machines\n- Verify the MAC address and product_uuid are unique for every node\n  - ip link\n  - ifconfig -a\n  - cat /sys/class/dmi/id/product_uuid\n- Check required ports\n  - nc 127.0.0.1 6443\n\n## 3. Installing kubeadm, kubelet and kubectl\n\n>kubelet version may never exceed the API server version.\n>\n>For example, the kubelet running 1.7.0 should be fully compatible with a 1.8.0 API server, but not vice versa.\n\n#### **Red Hat-based distributions**\n\n- Set SELinux to `permissive` mode\n\n  - setenforce 0\n  - sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\n- Add the Kubernetes `yum` repository\n\n  ```bash\n  cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n  [kubernetes]\n  name=Kubernetes\n  baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/\n  enabled=1\n  gpgcheck=1\n  gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key\n  exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni\n  EOF\n  ```\n\n- Install kubelet, kubeadm and kubectl, and enable kubelet to ensure it's automatically started on startup\n\n  - yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n  - systemctl enable --now kubelet\n\n#### **Without a package manager**\n\n- Install CNI plugins (required for most pod network)\n\n  ```bash\n  CNI_PLUGINS_VERSION=\"v1.3.0\"\n  ARCH=\"amd64\"\n  DEST=\"/opt/cni/bin\"\n  sudo mkdir -p \"$DEST\"\n  curl -L \"https://github.com/containernetworking/plugins/releases/download/${CNI_PLUGINS_VERSION}/cni-plugins-linux-${ARCH}-${CNI_PLUGINS_VERSION}.tgz\" | sudo tar -C \"$DEST\" -xz\n  \n  cat >> /etc/cni/net.d/10-containerd-net.conflist <<EOF\n  {\n    \"cniVersion\": \"1.0.0\",\n    \"name\": \"containerd-net\",\n    \"plugins\": [\n      {\n        \"type\": \"bridge\",\n        \"bridge\": \"cni0\",\n        \"isGateway\": true,\n        \"ipMasq\": true,\n        \"promiscMode\": true,\n        \"ipam\": {\n          \"type\": \"host-local\",\n          \"ranges\": [\n            [{\n              \"subnet\": \"10.88.0.0/16\"\n            }],\n            [{\n              \"subnet\": \"2001:4860:4860::/64\"\n            }]\n          ],\n          \"routes\": [\n            { \"dst\": \"0.0.0.0/0\" },\n            { \"dst\": \"::/0\" }\n          ]\n        }\n      },\n      {\n        \"type\": \"portmap\",\n        \"capabilities\": {\"portMappings\": true}\n      }\n    ]\n  }\n  EOF\n  ```\n\n- Define the directory to download command files\n\n  ```bash\n  DOWNLOAD_DIR=\"/usr/local/bin\"\n  sudo mkdir -p \"$DOWNLOAD_DIR\"\n  ```\n\n- Install crictl (required for kubeadm / Kubelet Container Runtime Interface (CRI))\n\n  ```bash\n  CRICTL_VERSION=\"v1.28.0\"\n  ARCH=\"amd64\"\n  curl -L \"https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-${ARCH}.tar.gz\" | sudo tar -C $DOWNLOAD_DIR -xz\n  ```\n\n- Install `kubeadm`, `kubelet`, `kubectl` and add a `kubelet` systemd service\n\n  ```bash\n  RELEASE=\"$(curl -sSL https://dl.k8s.io/release/stable.txt)\"\n  ARCH=\"amd64\"\n  cd $DOWNLOAD_DIR\n  sudo curl -L --remote-name-all https://dl.k8s.io/release/${RELEASE}/bin/linux/${ARCH}/{kubeadm,kubelet}\n  sudo chmod +x {kubeadm,kubelet}\n  \n  RELEASE_VERSION=\"v0.16.2\"\n  curl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/krel/templates/latest/kubelet/kubelet.service\" | sed \"s:/usr/bin:${DOWNLOAD_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service\n  sudo mkdir -p /etc/systemd/system/kubelet.service.d\n  curl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\" | sed \"s:/usr/bin:${DOWNLOAD_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n  ```\n\n  > Notes:\n  >\n  > Site raw.githubusercontent.com is 404 ... replace following url\n  >\n  > https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service\n  >\n  > https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\n\n  ```bash\n  cat >> /etc/systemd/system/kubelet.service << 'EOF'\n  [Unit]\n  Description=kubelet: The Kubernetes Node Agent\n  Documentation=https://kubernetes.io/docs/\n  Wants=network-online.target\n  After=network-online.target\n  \n  [Service]\n  ExecStart=/usr/bin/kubelet\n  Restart=always\n  StartLimitInterval=0\n  RestartSec=10\n  \n  [Install]\n  WantedBy=multi-user.target\n  EOF\n  cat >> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf << 'EOF'\n  # Note: This dropin only works with kubeadm and kubelet v1.11+\n  [Service]\n  Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\"\n  Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\"\n  # This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\n  EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n  # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n  # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\n  EnvironmentFile=-/etc/sysconfig/kubelet\n  ExecStart=\n  ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n  EOF\n  ```\n\n- Install and Set Up kubectl on Linux\n\n  - Install kubectl binary with curl on Linux\n\n    1. Download the latest release with the command\n\n       ```bash\n       curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\n       \n       ## View stable version\n       curl -L -s https://dl.k8s.io/release/stable.txt\n       ```\n\n    2. Validate the binary (optional)\n\n       ```bash\n       ## Download the kubectl checksum file\n       curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256\"\n       \n       ## Validate the kubectl binary against the checksum file\n       echo \"$(cat kubectl.sha256)  kubectl\" | sha256sum --check\n       ```\n\n    3. Install kubectl\n\n       ```bash\n       sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl\n       ```\n\n    4. Test to ensure the version you installed is up-to-date\n\n       ```bash\n       kubectl version --client\n       ## Or use this for detailed view of version\n       kubectl version --client --output=yaml\n       ```\n\n  - Install using native package management\n\n    1. Add the Kubernetes `yum` repository. If you want to use Kubernetes version different than v1.29, replace v1.29 with the desired minor version in the command below.\n\n       ```bash\n       # This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo\n       cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n       [kubernetes]\n       name=Kubernetes\n       baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/\n       enabled=1\n       gpgcheck=1\n       gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key\n       EOF\n       ```\n\n    2. Install kubectl using `yum`\n\n       ```bash\n       sudo yum install -y kubectl\n       ```\n\n- Enable and start `kubelet`\n\n  - ```bash\n    systemctl enable --now kubelet\n    ```\n\n> Container runtimes\n>\n> `kubeadm init` output error\n>\n> ` [ERROR CRI]: container runtime is not running`\n>\n> https://github.com/containerd/containerd/blob/main/docs/getting-started.md\n>\n> https://github.com/containerd/containerd/blob/main/containerd.service\n>\n> yum -y install socat conntrack-tools\n\n## 4. Creating a cluster with kubeadm\n\n```bash\nkubeadm init   --apiserver-advertise-address=192.168.175.133   --image-repository registry.aliyuncs.com/google_containers   --kubernetes-version v1.29.0   --service-cidr=10.1.0.0/16   --pod-network-cidr=10.244.0.0/16\n\n\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n## if you are the root user, you can run:\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n```\n\n### Installing a Pod network add-on\n\n> https://github.com/containerd/containerd/blob/main/script/setup/install-cni\n\n```bash\n#!/usr/bin/env bash\n\n#   Copyright The containerd Authors.\n\n#   Licensed under the Apache License, Version 2.0 (the \"License\");\n#   you may not use this file except in compliance with the License.\n#   You may obtain a copy of the License at\n\n#       http://www.apache.org/licenses/LICENSE-2.0\n\n#   Unless required by applicable law or agreed to in writing, software\n#   distributed under the License is distributed on an \"AS IS\" BASIS,\n#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n#   See the License for the specific language governing permissions and\n#   limitations under the License.\n\n#\n# Builds and installs cni plugins to /opt/cni/bin,\n# and create basic cni config in /etc/cni/net.d.\n# The commit defined in go.mod\n#\nset -eu -o pipefail\n\nCNI_COMMIT=${1:-$(go list -f \"{{.Version}}\" -m github.com/containernetworking/plugins)}\nCNI_DIR=${DESTDIR:=''}/opt/cni\nCNI_CONFIG_DIR=${DESTDIR}/etc/cni/net.d\n: \"${CNI_REPO:=https://github.com/containernetworking/plugins.git}\"\n\n# e2e and Cirrus will fail with \"sudo: command not found\"\nSUDO=''\nif (( $EUID != 0 )); then\n    SUDO='sudo'\nfi\n\nTMPROOT=$(mktemp -d)\ngit clone \"${CNI_REPO}\" \"${TMPROOT}\"/plugins\npushd \"${TMPROOT}\"/plugins\ngit checkout \"$CNI_COMMIT\"\n./build_linux.sh\n$SUDO mkdir -p $CNI_DIR\n$SUDO cp -r ./bin $CNI_DIR\n$SUDO mkdir -p $CNI_CONFIG_DIR\n$SUDO cat << EOF | $SUDO tee $CNI_CONFIG_DIR/10-containerd-net.conflist\n{\n  \"cniVersion\": \"1.0.0\",\n  \"name\": \"containerd-net\",\n  \"plugins\": [\n    {\n      \"type\": \"bridge\",\n      \"bridge\": \"cni0\",\n      \"isGateway\": true,\n      \"ipMasq\": true,\n      \"promiscMode\": true,\n      \"ipam\": {\n        \"type\": \"host-local\",\n        \"ranges\": [\n          [{\n            \"subnet\": \"10.88.0.0/16\"\n          }],\n          [{\n            \"subnet\": \"2001:4860:4860::/64\"\n          }]\n        ],\n        \"routes\": [\n          { \"dst\": \"0.0.0.0/0\" },\n          { \"dst\": \"::/0\" }\n        ]\n      }\n    },\n    {\n      \"type\": \"portmap\",\n      \"capabilities\": {\"portMappings\": true}\n    }\n  ]\n}\nEOF\n\npopd\nrm -fR \"${TMPROOT}\"\n```\n\n### Control plane node isolation\n\n```bash\n## By default, your cluster will not schedule Pods on the control plane nodes for security reasons. If you want to be able to schedule Pods on the control plane nodes, for example for a single machine Kubernetes cluster, run:\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\n```\n\n","source":"_posts/k8s-K8s-Install.md","raw":"---\ntitle: '[K8s] Kubernetes Install'\ndate: 2024-07-08 13:30:02\ntags: k8s\n---\n\n# K8s Install\n\n## 1. Standard\n\n- 2GB or more of RAM\n- 2CPUs or more\n\n## 2. Prepare\n\n- You need to install a container runtime into each node in the cluster so that Pods can run there.\n\n- Certain ports are open on your machines\n  - systemctl firewalld stop\n- Disable swap\n  - swapoff -a\n  - check /etc/fstab\n- Verify glibc is provide or not in machines\n- Verify the MAC address and product_uuid are unique for every node\n  - ip link\n  - ifconfig -a\n  - cat /sys/class/dmi/id/product_uuid\n- Check required ports\n  - nc 127.0.0.1 6443\n\n## 3. Installing kubeadm, kubelet and kubectl\n\n>kubelet version may never exceed the API server version.\n>\n>For example, the kubelet running 1.7.0 should be fully compatible with a 1.8.0 API server, but not vice versa.\n\n#### **Red Hat-based distributions**\n\n- Set SELinux to `permissive` mode\n\n  - setenforce 0\n  - sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\n- Add the Kubernetes `yum` repository\n\n  ```bash\n  cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n  [kubernetes]\n  name=Kubernetes\n  baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/\n  enabled=1\n  gpgcheck=1\n  gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key\n  exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni\n  EOF\n  ```\n\n- Install kubelet, kubeadm and kubectl, and enable kubelet to ensure it's automatically started on startup\n\n  - yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n  - systemctl enable --now kubelet\n\n#### **Without a package manager**\n\n- Install CNI plugins (required for most pod network)\n\n  ```bash\n  CNI_PLUGINS_VERSION=\"v1.3.0\"\n  ARCH=\"amd64\"\n  DEST=\"/opt/cni/bin\"\n  sudo mkdir -p \"$DEST\"\n  curl -L \"https://github.com/containernetworking/plugins/releases/download/${CNI_PLUGINS_VERSION}/cni-plugins-linux-${ARCH}-${CNI_PLUGINS_VERSION}.tgz\" | sudo tar -C \"$DEST\" -xz\n  \n  cat >> /etc/cni/net.d/10-containerd-net.conflist <<EOF\n  {\n    \"cniVersion\": \"1.0.0\",\n    \"name\": \"containerd-net\",\n    \"plugins\": [\n      {\n        \"type\": \"bridge\",\n        \"bridge\": \"cni0\",\n        \"isGateway\": true,\n        \"ipMasq\": true,\n        \"promiscMode\": true,\n        \"ipam\": {\n          \"type\": \"host-local\",\n          \"ranges\": [\n            [{\n              \"subnet\": \"10.88.0.0/16\"\n            }],\n            [{\n              \"subnet\": \"2001:4860:4860::/64\"\n            }]\n          ],\n          \"routes\": [\n            { \"dst\": \"0.0.0.0/0\" },\n            { \"dst\": \"::/0\" }\n          ]\n        }\n      },\n      {\n        \"type\": \"portmap\",\n        \"capabilities\": {\"portMappings\": true}\n      }\n    ]\n  }\n  EOF\n  ```\n\n- Define the directory to download command files\n\n  ```bash\n  DOWNLOAD_DIR=\"/usr/local/bin\"\n  sudo mkdir -p \"$DOWNLOAD_DIR\"\n  ```\n\n- Install crictl (required for kubeadm / Kubelet Container Runtime Interface (CRI))\n\n  ```bash\n  CRICTL_VERSION=\"v1.28.0\"\n  ARCH=\"amd64\"\n  curl -L \"https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-${ARCH}.tar.gz\" | sudo tar -C $DOWNLOAD_DIR -xz\n  ```\n\n- Install `kubeadm`, `kubelet`, `kubectl` and add a `kubelet` systemd service\n\n  ```bash\n  RELEASE=\"$(curl -sSL https://dl.k8s.io/release/stable.txt)\"\n  ARCH=\"amd64\"\n  cd $DOWNLOAD_DIR\n  sudo curl -L --remote-name-all https://dl.k8s.io/release/${RELEASE}/bin/linux/${ARCH}/{kubeadm,kubelet}\n  sudo chmod +x {kubeadm,kubelet}\n  \n  RELEASE_VERSION=\"v0.16.2\"\n  curl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/krel/templates/latest/kubelet/kubelet.service\" | sed \"s:/usr/bin:${DOWNLOAD_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service\n  sudo mkdir -p /etc/systemd/system/kubelet.service.d\n  curl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\" | sed \"s:/usr/bin:${DOWNLOAD_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n  ```\n\n  > Notes:\n  >\n  > Site raw.githubusercontent.com is 404 ... replace following url\n  >\n  > https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service\n  >\n  > https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\n\n  ```bash\n  cat >> /etc/systemd/system/kubelet.service << 'EOF'\n  [Unit]\n  Description=kubelet: The Kubernetes Node Agent\n  Documentation=https://kubernetes.io/docs/\n  Wants=network-online.target\n  After=network-online.target\n  \n  [Service]\n  ExecStart=/usr/bin/kubelet\n  Restart=always\n  StartLimitInterval=0\n  RestartSec=10\n  \n  [Install]\n  WantedBy=multi-user.target\n  EOF\n  cat >> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf << 'EOF'\n  # Note: This dropin only works with kubeadm and kubelet v1.11+\n  [Service]\n  Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\"\n  Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\"\n  # This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\n  EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n  # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n  # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\n  EnvironmentFile=-/etc/sysconfig/kubelet\n  ExecStart=\n  ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n  EOF\n  ```\n\n- Install and Set Up kubectl on Linux\n\n  - Install kubectl binary with curl on Linux\n\n    1. Download the latest release with the command\n\n       ```bash\n       curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\n       \n       ## View stable version\n       curl -L -s https://dl.k8s.io/release/stable.txt\n       ```\n\n    2. Validate the binary (optional)\n\n       ```bash\n       ## Download the kubectl checksum file\n       curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256\"\n       \n       ## Validate the kubectl binary against the checksum file\n       echo \"$(cat kubectl.sha256)  kubectl\" | sha256sum --check\n       ```\n\n    3. Install kubectl\n\n       ```bash\n       sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl\n       ```\n\n    4. Test to ensure the version you installed is up-to-date\n\n       ```bash\n       kubectl version --client\n       ## Or use this for detailed view of version\n       kubectl version --client --output=yaml\n       ```\n\n  - Install using native package management\n\n    1. Add the Kubernetes `yum` repository. If you want to use Kubernetes version different than v1.29, replace v1.29 with the desired minor version in the command below.\n\n       ```bash\n       # This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo\n       cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n       [kubernetes]\n       name=Kubernetes\n       baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/\n       enabled=1\n       gpgcheck=1\n       gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key\n       EOF\n       ```\n\n    2. Install kubectl using `yum`\n\n       ```bash\n       sudo yum install -y kubectl\n       ```\n\n- Enable and start `kubelet`\n\n  - ```bash\n    systemctl enable --now kubelet\n    ```\n\n> Container runtimes\n>\n> `kubeadm init` output error\n>\n> ` [ERROR CRI]: container runtime is not running`\n>\n> https://github.com/containerd/containerd/blob/main/docs/getting-started.md\n>\n> https://github.com/containerd/containerd/blob/main/containerd.service\n>\n> yum -y install socat conntrack-tools\n\n## 4. Creating a cluster with kubeadm\n\n```bash\nkubeadm init   --apiserver-advertise-address=192.168.175.133   --image-repository registry.aliyuncs.com/google_containers   --kubernetes-version v1.29.0   --service-cidr=10.1.0.0/16   --pod-network-cidr=10.244.0.0/16\n\n\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n## if you are the root user, you can run:\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n```\n\n### Installing a Pod network add-on\n\n> https://github.com/containerd/containerd/blob/main/script/setup/install-cni\n\n```bash\n#!/usr/bin/env bash\n\n#   Copyright The containerd Authors.\n\n#   Licensed under the Apache License, Version 2.0 (the \"License\");\n#   you may not use this file except in compliance with the License.\n#   You may obtain a copy of the License at\n\n#       http://www.apache.org/licenses/LICENSE-2.0\n\n#   Unless required by applicable law or agreed to in writing, software\n#   distributed under the License is distributed on an \"AS IS\" BASIS,\n#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n#   See the License for the specific language governing permissions and\n#   limitations under the License.\n\n#\n# Builds and installs cni plugins to /opt/cni/bin,\n# and create basic cni config in /etc/cni/net.d.\n# The commit defined in go.mod\n#\nset -eu -o pipefail\n\nCNI_COMMIT=${1:-$(go list -f \"{{.Version}}\" -m github.com/containernetworking/plugins)}\nCNI_DIR=${DESTDIR:=''}/opt/cni\nCNI_CONFIG_DIR=${DESTDIR}/etc/cni/net.d\n: \"${CNI_REPO:=https://github.com/containernetworking/plugins.git}\"\n\n# e2e and Cirrus will fail with \"sudo: command not found\"\nSUDO=''\nif (( $EUID != 0 )); then\n    SUDO='sudo'\nfi\n\nTMPROOT=$(mktemp -d)\ngit clone \"${CNI_REPO}\" \"${TMPROOT}\"/plugins\npushd \"${TMPROOT}\"/plugins\ngit checkout \"$CNI_COMMIT\"\n./build_linux.sh\n$SUDO mkdir -p $CNI_DIR\n$SUDO cp -r ./bin $CNI_DIR\n$SUDO mkdir -p $CNI_CONFIG_DIR\n$SUDO cat << EOF | $SUDO tee $CNI_CONFIG_DIR/10-containerd-net.conflist\n{\n  \"cniVersion\": \"1.0.0\",\n  \"name\": \"containerd-net\",\n  \"plugins\": [\n    {\n      \"type\": \"bridge\",\n      \"bridge\": \"cni0\",\n      \"isGateway\": true,\n      \"ipMasq\": true,\n      \"promiscMode\": true,\n      \"ipam\": {\n        \"type\": \"host-local\",\n        \"ranges\": [\n          [{\n            \"subnet\": \"10.88.0.0/16\"\n          }],\n          [{\n            \"subnet\": \"2001:4860:4860::/64\"\n          }]\n        ],\n        \"routes\": [\n          { \"dst\": \"0.0.0.0/0\" },\n          { \"dst\": \"::/0\" }\n        ]\n      }\n    },\n    {\n      \"type\": \"portmap\",\n      \"capabilities\": {\"portMappings\": true}\n    }\n  ]\n}\nEOF\n\npopd\nrm -fR \"${TMPROOT}\"\n```\n\n### Control plane node isolation\n\n```bash\n## By default, your cluster will not schedule Pods on the control plane nodes for security reasons. If you want to be able to schedule Pods on the control plane nodes, for example for a single machine Kubernetes cluster, run:\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\n```\n\n","slug":"k8s-K8s-Install","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yo000buhuqdk7f4xf9","content":"<h1 id=\"K8s-Install\"><a href=\"#K8s-Install\" class=\"headerlink\" title=\"K8s Install\"></a>K8s Install</h1><h2 id=\"1-Standard\"><a href=\"#1-Standard\" class=\"headerlink\" title=\"1. Standard\"></a>1. Standard</h2><ul>\n<li>2GB or more of RAM</li>\n<li>2CPUs or more</li>\n</ul>\n<h2 id=\"2-Prepare\"><a href=\"#2-Prepare\" class=\"headerlink\" title=\"2. Prepare\"></a>2. Prepare</h2><ul>\n<li><p>You need to install a container runtime into each node in the cluster so that Pods can run there.</p>\n</li>\n<li><p>Certain ports are open on your machines</p>\n<ul>\n<li>systemctl firewalld stop</li>\n</ul>\n</li>\n<li><p>Disable swap</p>\n<ul>\n<li>swapoff -a</li>\n<li>check &#x2F;etc&#x2F;fstab</li>\n</ul>\n</li>\n<li><p>Verify glibc is provide or not in machines</p>\n</li>\n<li><p>Verify the MAC address and product_uuid are unique for every node</p>\n<ul>\n<li>ip link</li>\n<li>ifconfig -a</li>\n<li>cat &#x2F;sys&#x2F;class&#x2F;dmi&#x2F;id&#x2F;product_uuid</li>\n</ul>\n</li>\n<li><p>Check required ports</p>\n<ul>\n<li>nc 127.0.0.1 6443</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"3-Installing-kubeadm-kubelet-and-kubectl\"><a href=\"#3-Installing-kubeadm-kubelet-and-kubectl\" class=\"headerlink\" title=\"3. Installing kubeadm, kubelet and kubectl\"></a>3. Installing kubeadm, kubelet and kubectl</h2><blockquote>\n<p>kubelet version may never exceed the API server version.</p>\n<p>For example, the kubelet running 1.7.0 should be fully compatible with a 1.8.0 API server, but not vice versa.</p>\n</blockquote>\n<h4 id=\"Red-Hat-based-distributions\"><a href=\"#Red-Hat-based-distributions\" class=\"headerlink\" title=\"Red Hat-based distributions\"></a><strong>Red Hat-based distributions</strong></h4><ul>\n<li><p>Set SELinux to <code>permissive</code> mode</p>\n<ul>\n<li>setenforce 0</li>\n<li>sed -i ‘s&#x2F;^SELINUX&#x3D;enforcing$&#x2F;SELINUX&#x3D;permissive&#x2F;‘ &#x2F;etc&#x2F;selinux&#x2F;config</li>\n</ul>\n</li>\n<li><p>Add the Kubernetes <code>yum</code> repository</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-string\">[kubernetes]</span><br><span class=\"hljs-string\">name=Kubernetes</span><br><span class=\"hljs-string\">baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/</span><br><span class=\"hljs-string\">enabled=1</span><br><span class=\"hljs-string\">gpgcheck=1</span><br><span class=\"hljs-string\">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key</span><br><span class=\"hljs-string\">exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubelet, kubeadm and kubectl, and enable kubelet to ensure it’s automatically started on startup</p>\n<ul>\n<li>yum install -y kubelet kubeadm kubectl –disableexcludes&#x3D;kubernetes</li>\n<li>systemctl enable –now kubelet</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Without-a-package-manager\"><a href=\"#Without-a-package-manager\" class=\"headerlink\" title=\"Without a package manager\"></a><strong>Without a package manager</strong></h4><ul>\n<li><p>Install CNI plugins (required for most pod network)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CNI_PLUGINS_VERSION=<span class=\"hljs-string\">&quot;v1.3.0&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br>DEST=<span class=\"hljs-string\">&quot;/opt/cni/bin&quot;</span><br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DEST</span>&quot;</span><br>curl -L <span class=\"hljs-string\">&quot;https://github.com/containernetworking/plugins/releases/download/<span class=\"hljs-variable\">$&#123;CNI_PLUGINS_VERSION&#125;</span>/cni-plugins-linux-<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>-<span class=\"hljs-variable\">$&#123;CNI_PLUGINS_VERSION&#125;</span>.tgz&quot;</span> | <span class=\"hljs-built_in\">sudo</span> tar -C <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DEST</span>&quot;</span> -xz<br><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/cni/net.d/10-containerd-net.conflist &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">&#123;</span><br><span class=\"hljs-string\">  &quot;cniVersion&quot;: &quot;1.0.0&quot;,</span><br><span class=\"hljs-string\">  &quot;name&quot;: &quot;containerd-net&quot;,</span><br><span class=\"hljs-string\">  &quot;plugins&quot;: [</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;type&quot;: &quot;bridge&quot;,</span><br><span class=\"hljs-string\">      &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class=\"hljs-string\">      &quot;isGateway&quot;: true,</span><br><span class=\"hljs-string\">      &quot;ipMasq&quot;: true,</span><br><span class=\"hljs-string\">      &quot;promiscMode&quot;: true,</span><br><span class=\"hljs-string\">      &quot;ipam&quot;: &#123;</span><br><span class=\"hljs-string\">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class=\"hljs-string\">        &quot;ranges&quot;: [</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;subnet&quot;: &quot;10.88.0.0/16&quot;</span><br><span class=\"hljs-string\">          &#125;],</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;subnet&quot;: &quot;2001:4860:4860::/64&quot;</span><br><span class=\"hljs-string\">          &#125;]</span><br><span class=\"hljs-string\">        ],</span><br><span class=\"hljs-string\">        &quot;routes&quot;: [</span><br><span class=\"hljs-string\">          &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;,</span><br><span class=\"hljs-string\">          &#123; &quot;dst&quot;: &quot;::/0&quot; &#125;</span><br><span class=\"hljs-string\">        ]</span><br><span class=\"hljs-string\">      &#125;</span><br><span class=\"hljs-string\">    &#125;,</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class=\"hljs-string\">      &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">  ]</span><br><span class=\"hljs-string\">&#125;</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Define the directory to download command files</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">DOWNLOAD_DIR=<span class=\"hljs-string\">&quot;/usr/local/bin&quot;</span><br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DOWNLOAD_DIR</span>&quot;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install crictl (required for kubeadm &#x2F; Kubelet Container Runtime Interface (CRI))</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CRICTL_VERSION=<span class=\"hljs-string\">&quot;v1.28.0&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br>curl -L <span class=\"hljs-string\">&quot;https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class=\"hljs-variable\">$&#123;CRICTL_VERSION&#125;</span>/crictl-<span class=\"hljs-variable\">$&#123;CRICTL_VERSION&#125;</span>-linux-<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>.tar.gz&quot;</span> | <span class=\"hljs-built_in\">sudo</span> tar -C <span class=\"hljs-variable\">$DOWNLOAD_DIR</span> -xz<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install <code>kubeadm</code>, <code>kubelet</code>, <code>kubectl</code> and add a <code>kubelet</code> systemd service</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">RELEASE=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(curl -sSL https://dl.k8s.io/release/stable.txt)</span>&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$DOWNLOAD_DIR</span><br><span class=\"hljs-built_in\">sudo</span> curl -L --remote-name-all https://dl.k8s.io/release/<span class=\"hljs-variable\">$&#123;RELEASE&#125;</span>/bin/linux/<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>/&#123;kubeadm,kubelet&#125;<br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">chmod</span> +x &#123;kubeadm,kubelet&#125;<br><br>RELEASE_VERSION=<span class=\"hljs-string\">&quot;v0.16.2&quot;</span><br>curl -sSL <span class=\"hljs-string\">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class=\"hljs-variable\">$&#123;RELEASE_VERSION&#125;</span>/cmd/krel/templates/latest/kubelet/kubelet.service&quot;</span> | sed <span class=\"hljs-string\">&quot;s:/usr/bin:<span class=\"hljs-variable\">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/systemd/system/kubelet.service<br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p /etc/systemd/system/kubelet.service.d<br>curl -sSL <span class=\"hljs-string\">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class=\"hljs-variable\">$&#123;RELEASE_VERSION&#125;</span>/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf&quot;</span> | sed <span class=\"hljs-string\">&quot;s:/usr/bin:<span class=\"hljs-variable\">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Notes:</p>\n<p>Site raw.githubusercontent.com is 404 … replace following url</p>\n<p><a href=\"https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service\">https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service</a></p>\n<p><a href=\"https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\">https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/kubelet.service &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br>[Unit]<br>Description=kubelet: The Kubernetes Node Agent<br>Documentation=https://kubernetes.io/docs/<br>Wants=network-online.target<br>After=network-online.target<br><br>[Service]<br>ExecStart=/usr/bin/kubelet<br>Restart=always<br>StartLimitInterval=0<br>RestartSec=10<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br>[Service]<br>Environment=<span class=\"hljs-string\">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br>Environment=<span class=\"hljs-string\">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class=\"hljs-comment\"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br>EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env<br><span class=\"hljs-comment\"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class=\"hljs-comment\"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br>EnvironmentFile=-/etc/sysconfig/kubelet<br>ExecStart=<br>ExecStart=/usr/bin/kubelet <span class=\"hljs-variable\">$KUBELET_KUBECONFIG_ARGS</span> <span class=\"hljs-variable\">$KUBELET_CONFIG_ARGS</span> <span class=\"hljs-variable\">$KUBELET_KUBEADM_ARGS</span> <span class=\"hljs-variable\">$KUBELET_EXTRA_ARGS</span><br>EOF<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install and Set Up kubectl on Linux</p>\n<ul>\n<li><p>Install kubectl binary with curl on Linux</p>\n<ol>\n<li><p>Download the latest release with the command</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">curl -LO <span class=\"hljs-string\">&quot;https://dl.k8s.io/release/<span class=\"hljs-subst\">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span><br><br><span class=\"hljs-comment\">## View stable version</span><br>curl -L -s https://dl.k8s.io/release/stable.txt<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Validate the binary (optional)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## Download the kubectl checksum file</span><br>curl -LO <span class=\"hljs-string\">&quot;https://dl.k8s.io/release/<span class=\"hljs-subst\">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl.sha256&quot;</span><br><br><span class=\"hljs-comment\">## Validate the kubectl binary against the checksum file</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(cat kubectl.sha256)</span>  kubectl&quot;</span> | <span class=\"hljs-built_in\">sha256sum</span> --check<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubectl</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Test to ensure the version you installed is up-to-date</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">kubectl version --client<br><span class=\"hljs-comment\">## Or use this for detailed view of version</span><br>kubectl version --client --output=yaml<br></code></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>Install using native package management</p>\n<ol>\n<li><p>Add the Kubernetes <code>yum</code> repository. If you want to use Kubernetes version different than v1.29, replace v1.29 with the desired minor version in the command below.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-string\">[kubernetes]</span><br><span class=\"hljs-string\">name=Kubernetes</span><br><span class=\"hljs-string\">baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/</span><br><span class=\"hljs-string\">enabled=1</span><br><span class=\"hljs-string\">gpgcheck=1</span><br><span class=\"hljs-string\">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubectl using <code>yum</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> yum install -y kubectl<br></code></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><p>Enable and start <code>kubelet</code></p>\n<ul>\n<li><pre><code class=\"bash\">systemctl enable --now kubelet\n<figure class=\"highlight node-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs node-repl\"><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-title class_\">Container</span> runtimes</span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-string\">`kubeadm init`</span> output error</span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-string\">` [ERROR CRI]: container runtime is not running`</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//github.com/containerd/containerd/blob/main/docs/getting-started.md</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//github.com/containerd/containerd/blob/main/containerd.service</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\">yum -y install socat conntrack-tools</span><br><br>## 4. Creating a cluster with kubeadm<br><br>```bash<br>kubeadm init   --apiserver-advertise-address=192.168.175.133   --image-repository registry.aliyuncs.com/google_containers   --kubernetes-version v1.29.0   --service-cidr=10.1.0.0/16   --pod-network-cidr=10.244.0.0/16<br><br><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><br>## if you are the root user, you can run:<br>  export KUBECONFIG=/etc/kubernetes/admin.conf<br></code></pre></td></tr></table></figure>\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Installing-a-Pod-network-add-on\"><a href=\"#Installing-a-Pod-network-add-on\" class=\"headerlink\" title=\"Installing a Pod network add-on\"></a>Installing a Pod network add-on</h3><blockquote>\n<p><a href=\"https://github.com/containerd/containerd/blob/main/script/setup/install-cni\">https://github.com/containerd/containerd/blob/main/script/setup/install-cni</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><br><span class=\"hljs-comment\">#   Copyright The containerd Authors.</span><br><br><span class=\"hljs-comment\">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"hljs-comment\">#   you may not use this file except in compliance with the License.</span><br><span class=\"hljs-comment\">#   You may obtain a copy of the License at</span><br><br><span class=\"hljs-comment\">#       http://www.apache.org/licenses/LICENSE-2.0</span><br><br><span class=\"hljs-comment\">#   Unless required by applicable law or agreed to in writing, software</span><br><span class=\"hljs-comment\">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"hljs-comment\">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"hljs-comment\">#   See the License for the specific language governing permissions and</span><br><span class=\"hljs-comment\">#   limitations under the License.</span><br><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Builds and installs cni plugins to /opt/cni/bin,</span><br><span class=\"hljs-comment\"># and create basic cni config in /etc/cni/net.d.</span><br><span class=\"hljs-comment\"># The commit defined in go.mod</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-built_in\">set</span> -eu -o pipefail<br><br>CNI_COMMIT=<span class=\"hljs-variable\">$&#123;1:-$(go list -f &quot;&#123;&#123;.Version&#125;</span>&#125;<span class=\"hljs-string\">&quot; -m github.com/containernetworking/plugins)&#125;</span><br><span class=\"hljs-string\">CNI_DIR=<span class=\"hljs-variable\">$&#123;DESTDIR:=&#x27;&#x27;&#125;</span>/opt/cni</span><br><span class=\"hljs-string\">CNI_CONFIG_DIR=<span class=\"hljs-variable\">$&#123;DESTDIR&#125;</span>/etc/cni/net.d</span><br><span class=\"hljs-string\">: &quot;</span><span class=\"hljs-variable\">$&#123;CNI_REPO:=https://github.com/containernetworking/plugins.git&#125;</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\"># e2e and Cirrus will fail with &quot;</span><span class=\"hljs-built_in\">sudo</span>: <span class=\"hljs-built_in\">command</span> not found<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">SUDO=&#x27;&#x27;</span><br><span class=\"hljs-string\">if (( <span class=\"hljs-variable\">$EUID</span> != 0 )); then</span><br><span class=\"hljs-string\">    SUDO=&#x27;sudo&#x27;</span><br><span class=\"hljs-string\">fi</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">TMPROOT=<span class=\"hljs-subst\">$(mktemp -d)</span></span><br><span class=\"hljs-string\">git clone &quot;</span><span class=\"hljs-variable\">$&#123;CNI_REPO&#125;</span><span class=\"hljs-string\">&quot; &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;/plugins</span><br><span class=\"hljs-string\">pushd &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;/plugins</span><br><span class=\"hljs-string\">git checkout &quot;</span><span class=\"hljs-variable\">$CNI_COMMIT</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">./build_linux.sh</span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> mkdir -p <span class=\"hljs-variable\">$CNI_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> cp -r ./bin <span class=\"hljs-variable\">$CNI_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> mkdir -p <span class=\"hljs-variable\">$CNI_CONFIG_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> cat &lt;&lt; EOF | <span class=\"hljs-variable\">$SUDO</span> tee <span class=\"hljs-variable\">$CNI_CONFIG_DIR</span>/10-containerd-net.conflist</span><br><span class=\"hljs-string\">&#123;</span><br><span class=\"hljs-string\">  &quot;</span>cniVersion<span class=\"hljs-string\">&quot;: &quot;</span>1.0.0<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">  &quot;</span>name<span class=\"hljs-string\">&quot;: &quot;</span>containerd-net<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">  &quot;</span>plugins<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>bridge<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>bridge<span class=\"hljs-string\">&quot;: &quot;</span>cni0<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>isGateway<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>ipMasq<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>promiscMode<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>ipam<span class=\"hljs-string\">&quot;: &#123;</span><br><span class=\"hljs-string\">        &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>host-local<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">        &quot;</span>ranges<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;</span>subnet<span class=\"hljs-string\">&quot;: &quot;</span>10.88.0.0/16<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">          &#125;],</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;</span>subnet<span class=\"hljs-string\">&quot;: &quot;</span>2001:4860:4860::/64<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">          &#125;]</span><br><span class=\"hljs-string\">        ],</span><br><span class=\"hljs-string\">        &quot;</span>routes<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">          &#123; &quot;</span>dst<span class=\"hljs-string\">&quot;: &quot;</span>0.0.0.0/0<span class=\"hljs-string\">&quot; &#125;,</span><br><span class=\"hljs-string\">          &#123; &quot;</span>dst<span class=\"hljs-string\">&quot;: &quot;</span>::/0<span class=\"hljs-string\">&quot; &#125;</span><br><span class=\"hljs-string\">        ]</span><br><span class=\"hljs-string\">      &#125;</span><br><span class=\"hljs-string\">    &#125;,</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>portmap<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>capabilities<span class=\"hljs-string\">&quot;: &#123;&quot;</span>portMappings<span class=\"hljs-string\">&quot;: true&#125;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">  ]</span><br><span class=\"hljs-string\">&#125;</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">popd</span><br><span class=\"hljs-string\">rm -fR &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Control-plane-node-isolation\"><a href=\"#Control-plane-node-isolation\" class=\"headerlink\" title=\"Control plane node isolation\"></a>Control plane node isolation</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## By default, your cluster will not schedule Pods on the control plane nodes for security reasons. If you want to be able to schedule Pods on the control plane nodes, for example for a single machine Kubernetes cluster, run:</span><br>kubectl taint nodes --all node-role.kubernetes.io/control-plane-<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"K8s-Install\"><a href=\"#K8s-Install\" class=\"headerlink\" title=\"K8s Install\"></a>K8s Install</h1><h2 id=\"1-Standard\"><a href=\"#1-Standard\" class=\"headerlink\" title=\"1. Standard\"></a>1. Standard</h2><ul>\n<li>2GB or more of RAM</li>\n<li>2CPUs or more</li>\n</ul>\n<h2 id=\"2-Prepare\"><a href=\"#2-Prepare\" class=\"headerlink\" title=\"2. Prepare\"></a>2. Prepare</h2><ul>\n<li><p>You need to install a container runtime into each node in the cluster so that Pods can run there.</p>\n</li>\n<li><p>Certain ports are open on your machines</p>\n<ul>\n<li>systemctl firewalld stop</li>\n</ul>\n</li>\n<li><p>Disable swap</p>\n<ul>\n<li>swapoff -a</li>\n<li>check &#x2F;etc&#x2F;fstab</li>\n</ul>\n</li>\n<li><p>Verify glibc is provide or not in machines</p>\n</li>\n<li><p>Verify the MAC address and product_uuid are unique for every node</p>\n<ul>\n<li>ip link</li>\n<li>ifconfig -a</li>\n<li>cat &#x2F;sys&#x2F;class&#x2F;dmi&#x2F;id&#x2F;product_uuid</li>\n</ul>\n</li>\n<li><p>Check required ports</p>\n<ul>\n<li>nc 127.0.0.1 6443</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"3-Installing-kubeadm-kubelet-and-kubectl\"><a href=\"#3-Installing-kubeadm-kubelet-and-kubectl\" class=\"headerlink\" title=\"3. Installing kubeadm, kubelet and kubectl\"></a>3. Installing kubeadm, kubelet and kubectl</h2><blockquote>\n<p>kubelet version may never exceed the API server version.</p>\n<p>For example, the kubelet running 1.7.0 should be fully compatible with a 1.8.0 API server, but not vice versa.</p>\n</blockquote>\n<h4 id=\"Red-Hat-based-distributions\"><a href=\"#Red-Hat-based-distributions\" class=\"headerlink\" title=\"Red Hat-based distributions\"></a><strong>Red Hat-based distributions</strong></h4><ul>\n<li><p>Set SELinux to <code>permissive</code> mode</p>\n<ul>\n<li>setenforce 0</li>\n<li>sed -i ‘s&#x2F;^SELINUX&#x3D;enforcing$&#x2F;SELINUX&#x3D;permissive&#x2F;‘ &#x2F;etc&#x2F;selinux&#x2F;config</li>\n</ul>\n</li>\n<li><p>Add the Kubernetes <code>yum</code> repository</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-string\">[kubernetes]</span><br><span class=\"hljs-string\">name=Kubernetes</span><br><span class=\"hljs-string\">baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/</span><br><span class=\"hljs-string\">enabled=1</span><br><span class=\"hljs-string\">gpgcheck=1</span><br><span class=\"hljs-string\">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key</span><br><span class=\"hljs-string\">exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubelet, kubeadm and kubectl, and enable kubelet to ensure it’s automatically started on startup</p>\n<ul>\n<li>yum install -y kubelet kubeadm kubectl –disableexcludes&#x3D;kubernetes</li>\n<li>systemctl enable –now kubelet</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Without-a-package-manager\"><a href=\"#Without-a-package-manager\" class=\"headerlink\" title=\"Without a package manager\"></a><strong>Without a package manager</strong></h4><ul>\n<li><p>Install CNI plugins (required for most pod network)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CNI_PLUGINS_VERSION=<span class=\"hljs-string\">&quot;v1.3.0&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br>DEST=<span class=\"hljs-string\">&quot;/opt/cni/bin&quot;</span><br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DEST</span>&quot;</span><br>curl -L <span class=\"hljs-string\">&quot;https://github.com/containernetworking/plugins/releases/download/<span class=\"hljs-variable\">$&#123;CNI_PLUGINS_VERSION&#125;</span>/cni-plugins-linux-<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>-<span class=\"hljs-variable\">$&#123;CNI_PLUGINS_VERSION&#125;</span>.tgz&quot;</span> | <span class=\"hljs-built_in\">sudo</span> tar -C <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DEST</span>&quot;</span> -xz<br><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/cni/net.d/10-containerd-net.conflist &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">&#123;</span><br><span class=\"hljs-string\">  &quot;cniVersion&quot;: &quot;1.0.0&quot;,</span><br><span class=\"hljs-string\">  &quot;name&quot;: &quot;containerd-net&quot;,</span><br><span class=\"hljs-string\">  &quot;plugins&quot;: [</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;type&quot;: &quot;bridge&quot;,</span><br><span class=\"hljs-string\">      &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class=\"hljs-string\">      &quot;isGateway&quot;: true,</span><br><span class=\"hljs-string\">      &quot;ipMasq&quot;: true,</span><br><span class=\"hljs-string\">      &quot;promiscMode&quot;: true,</span><br><span class=\"hljs-string\">      &quot;ipam&quot;: &#123;</span><br><span class=\"hljs-string\">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class=\"hljs-string\">        &quot;ranges&quot;: [</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;subnet&quot;: &quot;10.88.0.0/16&quot;</span><br><span class=\"hljs-string\">          &#125;],</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;subnet&quot;: &quot;2001:4860:4860::/64&quot;</span><br><span class=\"hljs-string\">          &#125;]</span><br><span class=\"hljs-string\">        ],</span><br><span class=\"hljs-string\">        &quot;routes&quot;: [</span><br><span class=\"hljs-string\">          &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;,</span><br><span class=\"hljs-string\">          &#123; &quot;dst&quot;: &quot;::/0&quot; &#125;</span><br><span class=\"hljs-string\">        ]</span><br><span class=\"hljs-string\">      &#125;</span><br><span class=\"hljs-string\">    &#125;,</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class=\"hljs-string\">      &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">  ]</span><br><span class=\"hljs-string\">&#125;</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Define the directory to download command files</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">DOWNLOAD_DIR=<span class=\"hljs-string\">&quot;/usr/local/bin&quot;</span><br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$DOWNLOAD_DIR</span>&quot;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install crictl (required for kubeadm &#x2F; Kubelet Container Runtime Interface (CRI))</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CRICTL_VERSION=<span class=\"hljs-string\">&quot;v1.28.0&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br>curl -L <span class=\"hljs-string\">&quot;https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class=\"hljs-variable\">$&#123;CRICTL_VERSION&#125;</span>/crictl-<span class=\"hljs-variable\">$&#123;CRICTL_VERSION&#125;</span>-linux-<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>.tar.gz&quot;</span> | <span class=\"hljs-built_in\">sudo</span> tar -C <span class=\"hljs-variable\">$DOWNLOAD_DIR</span> -xz<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install <code>kubeadm</code>, <code>kubelet</code>, <code>kubectl</code> and add a <code>kubelet</code> systemd service</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">RELEASE=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(curl -sSL https://dl.k8s.io/release/stable.txt)</span>&quot;</span><br>ARCH=<span class=\"hljs-string\">&quot;amd64&quot;</span><br><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$DOWNLOAD_DIR</span><br><span class=\"hljs-built_in\">sudo</span> curl -L --remote-name-all https://dl.k8s.io/release/<span class=\"hljs-variable\">$&#123;RELEASE&#125;</span>/bin/linux/<span class=\"hljs-variable\">$&#123;ARCH&#125;</span>/&#123;kubeadm,kubelet&#125;<br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">chmod</span> +x &#123;kubeadm,kubelet&#125;<br><br>RELEASE_VERSION=<span class=\"hljs-string\">&quot;v0.16.2&quot;</span><br>curl -sSL <span class=\"hljs-string\">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class=\"hljs-variable\">$&#123;RELEASE_VERSION&#125;</span>/cmd/krel/templates/latest/kubelet/kubelet.service&quot;</span> | sed <span class=\"hljs-string\">&quot;s:/usr/bin:<span class=\"hljs-variable\">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/systemd/system/kubelet.service<br><span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">mkdir</span> -p /etc/systemd/system/kubelet.service.d<br>curl -sSL <span class=\"hljs-string\">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class=\"hljs-variable\">$&#123;RELEASE_VERSION&#125;</span>/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf&quot;</span> | sed <span class=\"hljs-string\">&quot;s:/usr/bin:<span class=\"hljs-variable\">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Notes:</p>\n<p>Site raw.githubusercontent.com is 404 … replace following url</p>\n<p><a href=\"https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service\">https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubelet/kubelet.service</a></p>\n<p><a href=\"https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf\">https://github.com/kubernetes/release/blob/master/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/kubelet.service &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br>[Unit]<br>Description=kubelet: The Kubernetes Node Agent<br>Documentation=https://kubernetes.io/docs/<br>Wants=network-online.target<br>After=network-online.target<br><br>[Service]<br>ExecStart=/usr/bin/kubelet<br>Restart=always<br>StartLimitInterval=0<br>RestartSec=10<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><br>[Service]<br>Environment=<span class=\"hljs-string\">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br>Environment=<span class=\"hljs-string\">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class=\"hljs-comment\"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><br>EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env<br><span class=\"hljs-comment\"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><br><span class=\"hljs-comment\"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><br>EnvironmentFile=-/etc/sysconfig/kubelet<br>ExecStart=<br>ExecStart=/usr/bin/kubelet <span class=\"hljs-variable\">$KUBELET_KUBECONFIG_ARGS</span> <span class=\"hljs-variable\">$KUBELET_CONFIG_ARGS</span> <span class=\"hljs-variable\">$KUBELET_KUBEADM_ARGS</span> <span class=\"hljs-variable\">$KUBELET_EXTRA_ARGS</span><br>EOF<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install and Set Up kubectl on Linux</p>\n<ul>\n<li><p>Install kubectl binary with curl on Linux</p>\n<ol>\n<li><p>Download the latest release with the command</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">curl -LO <span class=\"hljs-string\">&quot;https://dl.k8s.io/release/<span class=\"hljs-subst\">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span><br><br><span class=\"hljs-comment\">## View stable version</span><br>curl -L -s https://dl.k8s.io/release/stable.txt<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Validate the binary (optional)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## Download the kubectl checksum file</span><br>curl -LO <span class=\"hljs-string\">&quot;https://dl.k8s.io/release/<span class=\"hljs-subst\">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl.sha256&quot;</span><br><br><span class=\"hljs-comment\">## Validate the kubectl binary against the checksum file</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$(cat kubectl.sha256)</span>  kubectl&quot;</span> | <span class=\"hljs-built_in\">sha256sum</span> --check<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubectl</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Test to ensure the version you installed is up-to-date</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">kubectl version --client<br><span class=\"hljs-comment\">## Or use this for detailed view of version</span><br>kubectl version --client --output=yaml<br></code></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>Install using native package management</p>\n<ol>\n<li><p>Add the Kubernetes <code>yum</code> repository. If you want to use Kubernetes version different than v1.29, replace v1.29 with the desired minor version in the command below.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"hljs-string\">[kubernetes]</span><br><span class=\"hljs-string\">name=Kubernetes</span><br><span class=\"hljs-string\">baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/</span><br><span class=\"hljs-string\">enabled=1</span><br><span class=\"hljs-string\">gpgcheck=1</span><br><span class=\"hljs-string\">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>Install kubectl using <code>yum</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> yum install -y kubectl<br></code></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><p>Enable and start <code>kubelet</code></p>\n<ul>\n<li><pre><code class=\"bash\">systemctl enable --now kubelet\n<figure class=\"highlight node-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs node-repl\"><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-title class_\">Container</span> runtimes</span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-string\">`kubeadm init`</span> output error</span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-string\">` [ERROR CRI]: container runtime is not running`</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//github.com/containerd/containerd/blob/main/docs/getting-started.md</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\"><span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//github.com/containerd/containerd/blob/main/containerd.service</span></span><br><span class=\"hljs-meta prompt_\">&gt;</span><br><span class=\"hljs-meta prompt_\">&gt;</span> <span class=\"language-javascript\">yum -y install socat conntrack-tools</span><br><br>## 4. Creating a cluster with kubeadm<br><br>```bash<br>kubeadm init   --apiserver-advertise-address=192.168.175.133   --image-repository registry.aliyuncs.com/google_containers   --kubernetes-version v1.29.0   --service-cidr=10.1.0.0/16   --pod-network-cidr=10.244.0.0/16<br><br><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><br>## if you are the root user, you can run:<br>  export KUBECONFIG=/etc/kubernetes/admin.conf<br></code></pre></td></tr></table></figure>\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Installing-a-Pod-network-add-on\"><a href=\"#Installing-a-Pod-network-add-on\" class=\"headerlink\" title=\"Installing a Pod network add-on\"></a>Installing a Pod network add-on</h3><blockquote>\n<p><a href=\"https://github.com/containerd/containerd/blob/main/script/setup/install-cni\">https://github.com/containerd/containerd/blob/main/script/setup/install-cni</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><br><span class=\"hljs-comment\">#   Copyright The containerd Authors.</span><br><br><span class=\"hljs-comment\">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"hljs-comment\">#   you may not use this file except in compliance with the License.</span><br><span class=\"hljs-comment\">#   You may obtain a copy of the License at</span><br><br><span class=\"hljs-comment\">#       http://www.apache.org/licenses/LICENSE-2.0</span><br><br><span class=\"hljs-comment\">#   Unless required by applicable law or agreed to in writing, software</span><br><span class=\"hljs-comment\">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"hljs-comment\">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"hljs-comment\">#   See the License for the specific language governing permissions and</span><br><span class=\"hljs-comment\">#   limitations under the License.</span><br><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Builds and installs cni plugins to /opt/cni/bin,</span><br><span class=\"hljs-comment\"># and create basic cni config in /etc/cni/net.d.</span><br><span class=\"hljs-comment\"># The commit defined in go.mod</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-built_in\">set</span> -eu -o pipefail<br><br>CNI_COMMIT=<span class=\"hljs-variable\">$&#123;1:-$(go list -f &quot;&#123;&#123;.Version&#125;</span>&#125;<span class=\"hljs-string\">&quot; -m github.com/containernetworking/plugins)&#125;</span><br><span class=\"hljs-string\">CNI_DIR=<span class=\"hljs-variable\">$&#123;DESTDIR:=&#x27;&#x27;&#125;</span>/opt/cni</span><br><span class=\"hljs-string\">CNI_CONFIG_DIR=<span class=\"hljs-variable\">$&#123;DESTDIR&#125;</span>/etc/cni/net.d</span><br><span class=\"hljs-string\">: &quot;</span><span class=\"hljs-variable\">$&#123;CNI_REPO:=https://github.com/containernetworking/plugins.git&#125;</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\"># e2e and Cirrus will fail with &quot;</span><span class=\"hljs-built_in\">sudo</span>: <span class=\"hljs-built_in\">command</span> not found<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">SUDO=&#x27;&#x27;</span><br><span class=\"hljs-string\">if (( <span class=\"hljs-variable\">$EUID</span> != 0 )); then</span><br><span class=\"hljs-string\">    SUDO=&#x27;sudo&#x27;</span><br><span class=\"hljs-string\">fi</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">TMPROOT=<span class=\"hljs-subst\">$(mktemp -d)</span></span><br><span class=\"hljs-string\">git clone &quot;</span><span class=\"hljs-variable\">$&#123;CNI_REPO&#125;</span><span class=\"hljs-string\">&quot; &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;/plugins</span><br><span class=\"hljs-string\">pushd &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;/plugins</span><br><span class=\"hljs-string\">git checkout &quot;</span><span class=\"hljs-variable\">$CNI_COMMIT</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">./build_linux.sh</span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> mkdir -p <span class=\"hljs-variable\">$CNI_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> cp -r ./bin <span class=\"hljs-variable\">$CNI_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> mkdir -p <span class=\"hljs-variable\">$CNI_CONFIG_DIR</span></span><br><span class=\"hljs-string\"><span class=\"hljs-variable\">$SUDO</span> cat &lt;&lt; EOF | <span class=\"hljs-variable\">$SUDO</span> tee <span class=\"hljs-variable\">$CNI_CONFIG_DIR</span>/10-containerd-net.conflist</span><br><span class=\"hljs-string\">&#123;</span><br><span class=\"hljs-string\">  &quot;</span>cniVersion<span class=\"hljs-string\">&quot;: &quot;</span>1.0.0<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">  &quot;</span>name<span class=\"hljs-string\">&quot;: &quot;</span>containerd-net<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">  &quot;</span>plugins<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>bridge<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>bridge<span class=\"hljs-string\">&quot;: &quot;</span>cni0<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>isGateway<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>ipMasq<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>promiscMode<span class=\"hljs-string\">&quot;: true,</span><br><span class=\"hljs-string\">      &quot;</span>ipam<span class=\"hljs-string\">&quot;: &#123;</span><br><span class=\"hljs-string\">        &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>host-local<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">        &quot;</span>ranges<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;</span>subnet<span class=\"hljs-string\">&quot;: &quot;</span>10.88.0.0/16<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">          &#125;],</span><br><span class=\"hljs-string\">          [&#123;</span><br><span class=\"hljs-string\">            &quot;</span>subnet<span class=\"hljs-string\">&quot;: &quot;</span>2001:4860:4860::/64<span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">          &#125;]</span><br><span class=\"hljs-string\">        ],</span><br><span class=\"hljs-string\">        &quot;</span>routes<span class=\"hljs-string\">&quot;: [</span><br><span class=\"hljs-string\">          &#123; &quot;</span>dst<span class=\"hljs-string\">&quot;: &quot;</span>0.0.0.0/0<span class=\"hljs-string\">&quot; &#125;,</span><br><span class=\"hljs-string\">          &#123; &quot;</span>dst<span class=\"hljs-string\">&quot;: &quot;</span>::/0<span class=\"hljs-string\">&quot; &#125;</span><br><span class=\"hljs-string\">        ]</span><br><span class=\"hljs-string\">      &#125;</span><br><span class=\"hljs-string\">    &#125;,</span><br><span class=\"hljs-string\">    &#123;</span><br><span class=\"hljs-string\">      &quot;</span><span class=\"hljs-built_in\">type</span><span class=\"hljs-string\">&quot;: &quot;</span>portmap<span class=\"hljs-string\">&quot;,</span><br><span class=\"hljs-string\">      &quot;</span>capabilities<span class=\"hljs-string\">&quot;: &#123;&quot;</span>portMappings<span class=\"hljs-string\">&quot;: true&#125;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">  ]</span><br><span class=\"hljs-string\">&#125;</span><br><span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">popd</span><br><span class=\"hljs-string\">rm -fR &quot;</span><span class=\"hljs-variable\">$&#123;TMPROOT&#125;</span><span class=\"hljs-string\">&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Control-plane-node-isolation\"><a href=\"#Control-plane-node-isolation\" class=\"headerlink\" title=\"Control plane node isolation\"></a>Control plane node isolation</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## By default, your cluster will not schedule Pods on the control plane nodes for security reasons. If you want to be able to schedule Pods on the control plane nodes, for example for a single machine Kubernetes cluster, run:</span><br>kubectl taint nodes --all node-role.kubernetes.io/control-plane-<br></code></pre></td></tr></table></figure>\n\n"},{"title":"[K8s] Prepare Environment","date":"2024-07-08T05:26:38.000Z","_content":"\n# Prepare Environment\n\n## Containerd Install\n\n> Container Runtimes\n>\n> Kubernetes 1.29 requires that you use a runtime that conforms with the [Container Runtime Interface](https://kubernetes.io/docs/concepts/overview/components/#container-runtime) (CRI).\n\n###  1. Installing containerd\n\n```bash\nwget https://github.com/containerd/containerd/releases/download/v1.7.11/containerd-1.7.11-linux-amd64.tar.gz\n\ntar -xvf containerd-1.6.26-linux-amd64.tar.gz -C /usr/local/\n```\n\n> https://github.com/containerd/containerd/blob/main/containerd.service\n\n```bash\ncat >> /etc/systemd/system/containerd.service << 'EOF'\n# Copyright The containerd Authors.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/containerd\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\n\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable --now containerd\nsystemctl status containerd\n```\n\n### 2. Installing runc\n\n```bash\nwget https://github.com/opencontainers/runc/releases/download/v1.1.11/runc.amd64\n\ninstall -m 755 runc.amd64 /usr/local/sbin/runc\n```\n\n### 3. Installing CNI plugins\n\n```bash\nwget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz\n\nmkdir -p /opt/cni/bin\ntar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz\n```\n\n### Default config\n\n> containerd uses a configuration file located in `/etc/containerd/config.toml` for specifying daemon level options. A sample configuration file can be found [here](https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md).\n>\n> The default configuration can be generated via `containerd config default > /etc/containerd/config.toml`.\n\n```\nversion = 2\n\nroot = \"/var/lib/containerd\"\nstate = \"/run/containerd\"\noom_score = 0\nimports = [\"/etc/containerd/runtime_*.toml\", \"./debug.toml\"]\n\n[grpc]\n  address = \"/run/containerd/containerd.sock\"\n  uid = 0\n  gid = 0\n\n[debug]\n  address = \"/run/containerd/debug.sock\"\n  uid = 0\n  gid = 0\n  level = \"info\"\n\n[metrics]\n  address = \"\"\n  grpc_histogram = false\n\n[cgroup]\n  path = \"\"\n\n[plugins]\n  [plugins.\"io.containerd.monitor.v1.cgroups\"]\n    no_prometheus = false\n  [plugins.\"io.containerd.service.v1.diff-service\"]\n    default = [\"walking\"]\n  [plugins.\"io.containerd.gc.v1.scheduler\"]\n    pause_threshold = 0.02\n    deletion_threshold = 0\n    mutation_threshold = 100\n    schedule_delay = 0\n    startup_delay = \"100ms\"\n  [plugins.\"io.containerd.runtime.v2.task\"]\n    platforms = [\"linux/amd64\"]\n    sched_core = true\n  [plugins.\"io.containerd.service.v1.tasks-service\"]\n    blockio_config_file = \"\"\n    rdt_config_file = \"\"\n```\n\n## Install and configure prerequisites\n\n```bash\n## Forwarding IPv4 and letting iptables see bridged traffic\ncat <<EOF | sudo tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\n\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n## sysctl params required by setup, params persist across reboots\ncat <<EOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n\n# Apply sysctl params without reboot\nsudo sysctl --system\n\n## Verify that the br_netfilter, overlay modules are loaded by running the following commands:\nlsmod | grep br_netfilter\nlsmod | grep overlay\n\n## Verify that the net.bridge.bridge-nf-call-iptables, net.bridge.bridge-nf-call-ip6tables, and net.ipv4.ip_forward system variables are set to 1 in your sysctl config by running the following command:\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n```\n\n## Cgroup drivers\n\n- cgroupfs\n\n  - The `cgroupfs` driver is **not** recommended when [systemd](https://www.freedesktop.org/wiki/Software/systemd/) is the init system because systemd expects a single cgroup manager on the system. Additionally, if you use [cgroup v2](https://kubernetes.io/docs/concepts/architecture/cgroups), use the `systemd` cgroup driver instead of `cgroupfs`.\n\n- systemd\n\n  - To set `systemd` as the cgroup driver, edit the [`KubeletConfiguration`](https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/) option of `cgroupDriver` and set it to `systemd`. For example:\n\n    ```yaml\n    apiVersion: kubelet.config.k8s.io/v1beta1\n    kind: KubeletConfiguration\n    ...\n    cgroupDriver: systemd\n    ```\n\n  > Note: Starting with v1.22 and later, when creating a cluster with kubeadm, if the user does not set the cgroupDriver field under KubeletConfiguration, kubeadm defaults it to systemd\n\n##  Container runtimes\n\n> In this step once you've created a valid `config.toml` configuration file.\n>\n> You can find this file under the path `/etc/containerd/config.toml`.\n>\n> On Linux the default CRI socket for containerd is `/run/containerd/containerd.sock`.\n\n### Configuring the systemd cgroup driver\n\n> The `systemd` cgroup driver is recommended if you use [cgroup v2](https://kubernetes.io/docs/concepts/architecture/cgroups).\n\n```bash\n[plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc]\n  ...\n  [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n    SystemdCgroup = true\n    \nsudo sed -i \"s#SystemdCgroup = false#SystemdCgroup = true#g\" /etc/containerd/config.toml\n### If you apply this change, make sure to restart containerd:\nsudo systemctl restart containerd\n```\n\n###  Overriding the sandbox (pause) image\n\nIn your [containerd config](https://github.com/containerd/containerd/blob/main/docs/cri/config.md) you can overwrite the sandbox image by setting the following config:\n\n```\n[plugins.\"io.containerd.grpc.v1.cri\"]\n  sandbox_image = \"registry.k8s.io/pause:3.2\"\n```\n\n```bash\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n### add following config in China   [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n      endpoint = [\"registry.cn-hangzhou.aliyuncs.com/google_containers\"]\n\n### This is important if you live in China.\nsudo sed -i \"s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g\" /etc/containerd/config.toml\nsudo systemctl restart containerd\n```\n\n```bash\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4\n\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3 k8s.gcr.io/kube-apiserver:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3 k8s.gcr.io/kube-controller-manager:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3 k8s.gcr.io/kube-scheduler:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3 k8s.gcr.io/kube-proxy:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4\n```\n\n","source":"_posts/k8s-Prepare-Environment.md","raw":"---\ntitle: '[K8s] Prepare Environment'\ndate: 2024-07-08 13:26:38\ntags: k8s\n---\n\n# Prepare Environment\n\n## Containerd Install\n\n> Container Runtimes\n>\n> Kubernetes 1.29 requires that you use a runtime that conforms with the [Container Runtime Interface](https://kubernetes.io/docs/concepts/overview/components/#container-runtime) (CRI).\n\n###  1. Installing containerd\n\n```bash\nwget https://github.com/containerd/containerd/releases/download/v1.7.11/containerd-1.7.11-linux-amd64.tar.gz\n\ntar -xvf containerd-1.6.26-linux-amd64.tar.gz -C /usr/local/\n```\n\n> https://github.com/containerd/containerd/blob/main/containerd.service\n\n```bash\ncat >> /etc/systemd/system/containerd.service << 'EOF'\n# Copyright The containerd Authors.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/containerd\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\n\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable --now containerd\nsystemctl status containerd\n```\n\n### 2. Installing runc\n\n```bash\nwget https://github.com/opencontainers/runc/releases/download/v1.1.11/runc.amd64\n\ninstall -m 755 runc.amd64 /usr/local/sbin/runc\n```\n\n### 3. Installing CNI plugins\n\n```bash\nwget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz\n\nmkdir -p /opt/cni/bin\ntar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz\n```\n\n### Default config\n\n> containerd uses a configuration file located in `/etc/containerd/config.toml` for specifying daemon level options. A sample configuration file can be found [here](https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md).\n>\n> The default configuration can be generated via `containerd config default > /etc/containerd/config.toml`.\n\n```\nversion = 2\n\nroot = \"/var/lib/containerd\"\nstate = \"/run/containerd\"\noom_score = 0\nimports = [\"/etc/containerd/runtime_*.toml\", \"./debug.toml\"]\n\n[grpc]\n  address = \"/run/containerd/containerd.sock\"\n  uid = 0\n  gid = 0\n\n[debug]\n  address = \"/run/containerd/debug.sock\"\n  uid = 0\n  gid = 0\n  level = \"info\"\n\n[metrics]\n  address = \"\"\n  grpc_histogram = false\n\n[cgroup]\n  path = \"\"\n\n[plugins]\n  [plugins.\"io.containerd.monitor.v1.cgroups\"]\n    no_prometheus = false\n  [plugins.\"io.containerd.service.v1.diff-service\"]\n    default = [\"walking\"]\n  [plugins.\"io.containerd.gc.v1.scheduler\"]\n    pause_threshold = 0.02\n    deletion_threshold = 0\n    mutation_threshold = 100\n    schedule_delay = 0\n    startup_delay = \"100ms\"\n  [plugins.\"io.containerd.runtime.v2.task\"]\n    platforms = [\"linux/amd64\"]\n    sched_core = true\n  [plugins.\"io.containerd.service.v1.tasks-service\"]\n    blockio_config_file = \"\"\n    rdt_config_file = \"\"\n```\n\n## Install and configure prerequisites\n\n```bash\n## Forwarding IPv4 and letting iptables see bridged traffic\ncat <<EOF | sudo tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\n\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n## sysctl params required by setup, params persist across reboots\ncat <<EOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n\n# Apply sysctl params without reboot\nsudo sysctl --system\n\n## Verify that the br_netfilter, overlay modules are loaded by running the following commands:\nlsmod | grep br_netfilter\nlsmod | grep overlay\n\n## Verify that the net.bridge.bridge-nf-call-iptables, net.bridge.bridge-nf-call-ip6tables, and net.ipv4.ip_forward system variables are set to 1 in your sysctl config by running the following command:\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n```\n\n## Cgroup drivers\n\n- cgroupfs\n\n  - The `cgroupfs` driver is **not** recommended when [systemd](https://www.freedesktop.org/wiki/Software/systemd/) is the init system because systemd expects a single cgroup manager on the system. Additionally, if you use [cgroup v2](https://kubernetes.io/docs/concepts/architecture/cgroups), use the `systemd` cgroup driver instead of `cgroupfs`.\n\n- systemd\n\n  - To set `systemd` as the cgroup driver, edit the [`KubeletConfiguration`](https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/) option of `cgroupDriver` and set it to `systemd`. For example:\n\n    ```yaml\n    apiVersion: kubelet.config.k8s.io/v1beta1\n    kind: KubeletConfiguration\n    ...\n    cgroupDriver: systemd\n    ```\n\n  > Note: Starting with v1.22 and later, when creating a cluster with kubeadm, if the user does not set the cgroupDriver field under KubeletConfiguration, kubeadm defaults it to systemd\n\n##  Container runtimes\n\n> In this step once you've created a valid `config.toml` configuration file.\n>\n> You can find this file under the path `/etc/containerd/config.toml`.\n>\n> On Linux the default CRI socket for containerd is `/run/containerd/containerd.sock`.\n\n### Configuring the systemd cgroup driver\n\n> The `systemd` cgroup driver is recommended if you use [cgroup v2](https://kubernetes.io/docs/concepts/architecture/cgroups).\n\n```bash\n[plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc]\n  ...\n  [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n    SystemdCgroup = true\n    \nsudo sed -i \"s#SystemdCgroup = false#SystemdCgroup = true#g\" /etc/containerd/config.toml\n### If you apply this change, make sure to restart containerd:\nsudo systemctl restart containerd\n```\n\n###  Overriding the sandbox (pause) image\n\nIn your [containerd config](https://github.com/containerd/containerd/blob/main/docs/cri/config.md) you can overwrite the sandbox image by setting the following config:\n\n```\n[plugins.\"io.containerd.grpc.v1.cri\"]\n  sandbox_image = \"registry.k8s.io/pause:3.2\"\n```\n\n```bash\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n### add following config in China   [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n      endpoint = [\"registry.cn-hangzhou.aliyuncs.com/google_containers\"]\n\n### This is important if you live in China.\nsudo sed -i \"s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g\" /etc/containerd/config.toml\nsudo systemctl restart containerd\n```\n\n```bash\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0\nctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4\n\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3 k8s.gcr.io/kube-apiserver:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3 k8s.gcr.io/kube-controller-manager:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3 k8s.gcr.io/kube-scheduler:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3 k8s.gcr.io/kube-proxy:v1.22.3\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0\nctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4\n```\n\n","slug":"k8s-Prepare-Environment","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yp000duhuq7c9m7yio","content":"<h1 id=\"Prepare-Environment\"><a href=\"#Prepare-Environment\" class=\"headerlink\" title=\"Prepare Environment\"></a>Prepare Environment</h1><h2 id=\"Containerd-Install\"><a href=\"#Containerd-Install\" class=\"headerlink\" title=\"Containerd Install\"></a>Containerd Install</h2><blockquote>\n<p>Container Runtimes</p>\n<p>Kubernetes 1.29 requires that you use a runtime that conforms with the <a href=\"https://kubernetes.io/docs/concepts/overview/components/#container-runtime\">Container Runtime Interface</a> (CRI).</p>\n</blockquote>\n<h3 id=\"1-Installing-containerd\"><a href=\"#1-Installing-containerd\" class=\"headerlink\" title=\"1. Installing containerd\"></a>1. Installing containerd</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/containerd/containerd/releases/download/v1.7.11/containerd-1.7.11-linux-amd64.tar.gz<br><br>tar -xvf containerd-1.6.26-linux-amd64.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><a href=\"https://github.com/containerd/containerd/blob/main/containerd.service\">https://github.com/containerd/containerd/blob/main/containerd.service</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/containerd.service &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># Copyright The containerd Authors.</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"hljs-comment\"># you may not use this file except in compliance with the License.</span><br><span class=\"hljs-comment\"># You may obtain a copy of the License at</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Unless required by applicable law or agreed to in writing, software</span><br><span class=\"hljs-comment\"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"hljs-comment\"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"hljs-comment\"># See the License for the specific language governing permissions and</span><br><span class=\"hljs-comment\"># limitations under the License.</span><br><br>[Unit]<br>Description=containerd container runtime<br>Documentation=https://containerd.io<br>After=network.target local-fs.target<br><br>[Service]<br>ExecStartPre=-/sbin/modprobe overlay<br>ExecStart=/usr/local/bin/containerd<br><br>Type=notify<br>Delegate=<span class=\"hljs-built_in\">yes</span><br>KillMode=process<br>Restart=always<br>RestartSec=5<br><br><span class=\"hljs-comment\"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class=\"hljs-comment\"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br>LimitNPROC=infinity<br>LimitCORE=infinity<br><br><span class=\"hljs-comment\"># Comment TasksMax if your systemd version does not supports it.</span><br><span class=\"hljs-comment\"># Only systemd 226 and above support this version.</span><br>TasksMax=infinity<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br>systemctl daemon-reload<br>systemctl <span class=\"hljs-built_in\">enable</span> --now containerd<br>systemctl status containerd<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-Installing-runc\"><a href=\"#2-Installing-runc\" class=\"headerlink\" title=\"2. Installing runc\"></a>2. Installing runc</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/opencontainers/runc/releases/download/v1.1.11/runc.amd64<br><br>install -m 755 runc.amd64 /usr/local/sbin/runc<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-Installing-CNI-plugins\"><a href=\"#3-Installing-CNI-plugins\" class=\"headerlink\" title=\"3. Installing CNI plugins\"></a>3. Installing CNI plugins</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz<br><br><span class=\"hljs-built_in\">mkdir</span> -p /opt/cni/bin<br>tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Default-config\"><a href=\"#Default-config\" class=\"headerlink\" title=\"Default config\"></a>Default config</h3><blockquote>\n<p>containerd uses a configuration file located in <code>/etc/containerd/config.toml</code> for specifying daemon level options. A sample configuration file can be found <a href=\"https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md\">here</a>.</p>\n<p>The default configuration can be generated via <code>containerd config default &gt; /etc/containerd/config.toml</code>.</p>\n</blockquote>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">version</span> = <span class=\"hljs-number\">2</span><br><br><span class=\"hljs-attr\">root</span> = <span class=\"hljs-string\">&quot;/var/lib/containerd&quot;</span><br><span class=\"hljs-attr\">state</span> = <span class=\"hljs-string\">&quot;/run/containerd&quot;</span><br><span class=\"hljs-attr\">oom_score</span> = <span class=\"hljs-number\">0</span><br><span class=\"hljs-attr\">imports</span> = [<span class=\"hljs-string\">&quot;/etc/containerd/runtime_*.toml&quot;</span>, <span class=\"hljs-string\">&quot;./debug.toml&quot;</span>]<br><br><span class=\"hljs-section\">[grpc]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;/run/containerd/containerd.sock&quot;</span><br>  <span class=\"hljs-attr\">uid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">gid</span> = <span class=\"hljs-number\">0</span><br><br><span class=\"hljs-section\">[debug]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;/run/containerd/debug.sock&quot;</span><br>  <span class=\"hljs-attr\">uid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">gid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">level</span> = <span class=\"hljs-string\">&quot;info&quot;</span><br><br><span class=\"hljs-section\">[metrics]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;&quot;</span><br>  <span class=\"hljs-attr\">grpc_histogram</span> = <span class=\"hljs-literal\">false</span><br><br><span class=\"hljs-section\">[cgroup]</span><br>  <span class=\"hljs-attr\">path</span> = <span class=\"hljs-string\">&quot;&quot;</span><br><br><span class=\"hljs-section\">[plugins]</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br>    <span class=\"hljs-attr\">no_prometheus</span> = <span class=\"hljs-literal\">false</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br>    <span class=\"hljs-attr\">default</span> = [<span class=\"hljs-string\">&quot;walking&quot;</span>]<br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br>    <span class=\"hljs-attr\">pause_threshold</span> = <span class=\"hljs-number\">0.02</span><br>    <span class=\"hljs-attr\">deletion_threshold</span> = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">mutation_threshold</span> = <span class=\"hljs-number\">100</span><br>    <span class=\"hljs-attr\">schedule_delay</span> = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">startup_delay</span> = <span class=\"hljs-string\">&quot;100ms&quot;</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br>    <span class=\"hljs-attr\">platforms</span> = [<span class=\"hljs-string\">&quot;linux/amd64&quot;</span>]<br>    <span class=\"hljs-attr\">sched_core</span> = <span class=\"hljs-literal\">true</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.service.v1.tasks-service&quot;]</span><br>    <span class=\"hljs-attr\">blockio_config_file</span> = <span class=\"hljs-string\">&quot;&quot;</span><br>    <span class=\"hljs-attr\">rdt_config_file</span> = <span class=\"hljs-string\">&quot;&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Install-and-configure-prerequisites\"><a href=\"#Install-and-configure-prerequisites\" class=\"headerlink\" title=\"Install and configure prerequisites\"></a>Install and configure prerequisites</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## Forwarding IPv4 and letting iptables see bridged traffic</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class=\"hljs-string\">overlay</span><br><span class=\"hljs-string\">br_netfilter</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-built_in\">sudo</span> modprobe overlay<br><span class=\"hljs-built_in\">sudo</span> modprobe br_netfilter<br><br><span class=\"hljs-comment\">## sysctl params required by setup, params persist across reboots</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class=\"hljs-string\">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class=\"hljs-string\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"hljs-string\">net.ipv4.ip_forward                 = 1</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-comment\"># Apply sysctl params without reboot</span><br><span class=\"hljs-built_in\">sudo</span> sysctl --system<br><br><span class=\"hljs-comment\">## Verify that the br_netfilter, overlay modules are loaded by running the following commands:</span><br>lsmod | grep br_netfilter<br>lsmod | grep overlay<br><br><span class=\"hljs-comment\">## Verify that the net.bridge.bridge-nf-call-iptables, net.bridge.bridge-nf-call-ip6tables, and net.ipv4.ip_forward system variables are set to 1 in your sysctl config by running the following command:</span><br>sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Cgroup-drivers\"><a href=\"#Cgroup-drivers\" class=\"headerlink\" title=\"Cgroup drivers\"></a>Cgroup drivers</h2><ul>\n<li><p>cgroupfs</p>\n<ul>\n<li>The <code>cgroupfs</code> driver is <strong>not</strong> recommended when <a href=\"https://www.freedesktop.org/wiki/Software/systemd/\">systemd</a> is the init system because systemd expects a single cgroup manager on the system. Additionally, if you use <a href=\"https://kubernetes.io/docs/concepts/architecture/cgroups\">cgroup v2</a>, use the <code>systemd</code> cgroup driver instead of <code>cgroupfs</code>.</li>\n</ul>\n</li>\n<li><p>systemd</p>\n<ul>\n<li><p>To set <code>systemd</code> as the cgroup driver, edit the <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/\"><code>KubeletConfiguration</code></a> option of <code>cgroupDriver</code> and set it to <code>systemd</code>. For example:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">kubelet.config.k8s.io/v1beta1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">KubeletConfiguration</span><br><span class=\"hljs-string\">...</span><br><span class=\"hljs-attr\">cgroupDriver:</span> <span class=\"hljs-string\">systemd</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n<blockquote>\n<p>Note: Starting with v1.22 and later, when creating a cluster with kubeadm, if the user does not set the cgroupDriver field under KubeletConfiguration, kubeadm defaults it to systemd</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"Container-runtimes\"><a href=\"#Container-runtimes\" class=\"headerlink\" title=\"Container runtimes\"></a>Container runtimes</h2><blockquote>\n<p>In this step once you’ve created a valid <code>config.toml</code> configuration file.</p>\n<p>You can find this file under the path <code>/etc/containerd/config.toml</code>.</p>\n<p>On Linux the default CRI socket for containerd is <code>/run/containerd/containerd.sock</code>.</p>\n</blockquote>\n<h3 id=\"Configuring-the-systemd-cgroup-driver\"><a href=\"#Configuring-the-systemd-cgroup-driver\" class=\"headerlink\" title=\"Configuring the systemd cgroup driver\"></a>Configuring the systemd cgroup driver</h3><blockquote>\n<p>The <code>systemd</code> cgroup driver is recommended if you use <a href=\"https://kubernetes.io/docs/concepts/architecture/cgroups\">cgroup v2</a>.</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc]<br>  ...<br>  [plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]<br>    SystemdCgroup = <span class=\"hljs-literal\">true</span><br>    <br><span class=\"hljs-built_in\">sudo</span> sed -i <span class=\"hljs-string\">&quot;s#SystemdCgroup = false#SystemdCgroup = true#g&quot;</span> /etc/containerd/config.toml<br><span class=\"hljs-comment\">### If you apply this change, make sure to restart containerd:</span><br><span class=\"hljs-built_in\">sudo</span> systemctl restart containerd<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Overriding-the-sandbox-pause-image\"><a href=\"#Overriding-the-sandbox-pause-image\" class=\"headerlink\" title=\"Overriding the sandbox (pause) image\"></a>Overriding the sandbox (pause) image</h3><p>In your <a href=\"https://github.com/containerd/containerd/blob/main/docs/cri/config.md\">containerd config</a> you can overwrite the sandbox image by setting the following config:</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br>  <span class=\"hljs-attr\">sandbox_image</span> = <span class=\"hljs-string\">&quot;registry.k8s.io/pause:3.2&quot;</span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]<br><span class=\"hljs-comment\">### add following config in China   [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span><br>      endpoint = [<span class=\"hljs-string\">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers&quot;</span>]<br><br><span class=\"hljs-comment\">### This is important if you live in China.</span><br><span class=\"hljs-built_in\">sudo</span> sed -i <span class=\"hljs-string\">&quot;s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g&quot;</span> /etc/containerd/config.toml<br><span class=\"hljs-built_in\">sudo</span> systemctl restart containerd<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4<br><br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3 k8s.gcr.io/kube-apiserver:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3 k8s.gcr.io/kube-controller-manager:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3 k8s.gcr.io/kube-scheduler:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3 k8s.gcr.io/kube-proxy:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"Prepare-Environment\"><a href=\"#Prepare-Environment\" class=\"headerlink\" title=\"Prepare Environment\"></a>Prepare Environment</h1><h2 id=\"Containerd-Install\"><a href=\"#Containerd-Install\" class=\"headerlink\" title=\"Containerd Install\"></a>Containerd Install</h2><blockquote>\n<p>Container Runtimes</p>\n<p>Kubernetes 1.29 requires that you use a runtime that conforms with the <a href=\"https://kubernetes.io/docs/concepts/overview/components/#container-runtime\">Container Runtime Interface</a> (CRI).</p>\n</blockquote>\n<h3 id=\"1-Installing-containerd\"><a href=\"#1-Installing-containerd\" class=\"headerlink\" title=\"1. Installing containerd\"></a>1. Installing containerd</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/containerd/containerd/releases/download/v1.7.11/containerd-1.7.11-linux-amd64.tar.gz<br><br>tar -xvf containerd-1.6.26-linux-amd64.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><a href=\"https://github.com/containerd/containerd/blob/main/containerd.service\">https://github.com/containerd/containerd/blob/main/containerd.service</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/systemd/system/containerd.service &lt;&lt; <span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># Copyright The containerd Authors.</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"hljs-comment\"># you may not use this file except in compliance with the License.</span><br><span class=\"hljs-comment\"># You may obtain a copy of the License at</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># Unless required by applicable law or agreed to in writing, software</span><br><span class=\"hljs-comment\"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"hljs-comment\"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"hljs-comment\"># See the License for the specific language governing permissions and</span><br><span class=\"hljs-comment\"># limitations under the License.</span><br><br>[Unit]<br>Description=containerd container runtime<br>Documentation=https://containerd.io<br>After=network.target local-fs.target<br><br>[Service]<br>ExecStartPre=-/sbin/modprobe overlay<br>ExecStart=/usr/local/bin/containerd<br><br>Type=notify<br>Delegate=<span class=\"hljs-built_in\">yes</span><br>KillMode=process<br>Restart=always<br>RestartSec=5<br><br><span class=\"hljs-comment\"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class=\"hljs-comment\"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br>LimitNPROC=infinity<br>LimitCORE=infinity<br><br><span class=\"hljs-comment\"># Comment TasksMax if your systemd version does not supports it.</span><br><span class=\"hljs-comment\"># Only systemd 226 and above support this version.</span><br>TasksMax=infinity<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br>systemctl daemon-reload<br>systemctl <span class=\"hljs-built_in\">enable</span> --now containerd<br>systemctl status containerd<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-Installing-runc\"><a href=\"#2-Installing-runc\" class=\"headerlink\" title=\"2. Installing runc\"></a>2. Installing runc</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/opencontainers/runc/releases/download/v1.1.11/runc.amd64<br><br>install -m 755 runc.amd64 /usr/local/sbin/runc<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-Installing-CNI-plugins\"><a href=\"#3-Installing-CNI-plugins\" class=\"headerlink\" title=\"3. Installing CNI plugins\"></a>3. Installing CNI plugins</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">wget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz<br><br><span class=\"hljs-built_in\">mkdir</span> -p /opt/cni/bin<br>tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Default-config\"><a href=\"#Default-config\" class=\"headerlink\" title=\"Default config\"></a>Default config</h3><blockquote>\n<p>containerd uses a configuration file located in <code>/etc/containerd/config.toml</code> for specifying daemon level options. A sample configuration file can be found <a href=\"https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md\">here</a>.</p>\n<p>The default configuration can be generated via <code>containerd config default &gt; /etc/containerd/config.toml</code>.</p>\n</blockquote>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">version</span> = <span class=\"hljs-number\">2</span><br><br><span class=\"hljs-attr\">root</span> = <span class=\"hljs-string\">&quot;/var/lib/containerd&quot;</span><br><span class=\"hljs-attr\">state</span> = <span class=\"hljs-string\">&quot;/run/containerd&quot;</span><br><span class=\"hljs-attr\">oom_score</span> = <span class=\"hljs-number\">0</span><br><span class=\"hljs-attr\">imports</span> = [<span class=\"hljs-string\">&quot;/etc/containerd/runtime_*.toml&quot;</span>, <span class=\"hljs-string\">&quot;./debug.toml&quot;</span>]<br><br><span class=\"hljs-section\">[grpc]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;/run/containerd/containerd.sock&quot;</span><br>  <span class=\"hljs-attr\">uid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">gid</span> = <span class=\"hljs-number\">0</span><br><br><span class=\"hljs-section\">[debug]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;/run/containerd/debug.sock&quot;</span><br>  <span class=\"hljs-attr\">uid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">gid</span> = <span class=\"hljs-number\">0</span><br>  <span class=\"hljs-attr\">level</span> = <span class=\"hljs-string\">&quot;info&quot;</span><br><br><span class=\"hljs-section\">[metrics]</span><br>  <span class=\"hljs-attr\">address</span> = <span class=\"hljs-string\">&quot;&quot;</span><br>  <span class=\"hljs-attr\">grpc_histogram</span> = <span class=\"hljs-literal\">false</span><br><br><span class=\"hljs-section\">[cgroup]</span><br>  <span class=\"hljs-attr\">path</span> = <span class=\"hljs-string\">&quot;&quot;</span><br><br><span class=\"hljs-section\">[plugins]</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br>    <span class=\"hljs-attr\">no_prometheus</span> = <span class=\"hljs-literal\">false</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br>    <span class=\"hljs-attr\">default</span> = [<span class=\"hljs-string\">&quot;walking&quot;</span>]<br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br>    <span class=\"hljs-attr\">pause_threshold</span> = <span class=\"hljs-number\">0.02</span><br>    <span class=\"hljs-attr\">deletion_threshold</span> = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">mutation_threshold</span> = <span class=\"hljs-number\">100</span><br>    <span class=\"hljs-attr\">schedule_delay</span> = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">startup_delay</span> = <span class=\"hljs-string\">&quot;100ms&quot;</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br>    <span class=\"hljs-attr\">platforms</span> = [<span class=\"hljs-string\">&quot;linux/amd64&quot;</span>]<br>    <span class=\"hljs-attr\">sched_core</span> = <span class=\"hljs-literal\">true</span><br>  <span class=\"hljs-section\">[plugins.&quot;io.containerd.service.v1.tasks-service&quot;]</span><br>    <span class=\"hljs-attr\">blockio_config_file</span> = <span class=\"hljs-string\">&quot;&quot;</span><br>    <span class=\"hljs-attr\">rdt_config_file</span> = <span class=\"hljs-string\">&quot;&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Install-and-configure-prerequisites\"><a href=\"#Install-and-configure-prerequisites\" class=\"headerlink\" title=\"Install and configure prerequisites\"></a>Install and configure prerequisites</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## Forwarding IPv4 and letting iptables see bridged traffic</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class=\"hljs-string\">overlay</span><br><span class=\"hljs-string\">br_netfilter</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-built_in\">sudo</span> modprobe overlay<br><span class=\"hljs-built_in\">sudo</span> modprobe br_netfilter<br><br><span class=\"hljs-comment\">## sysctl params required by setup, params persist across reboots</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt;<span class=\"hljs-string\">EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class=\"hljs-string\">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class=\"hljs-string\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"hljs-string\">net.ipv4.ip_forward                 = 1</span><br><span class=\"hljs-string\">EOF</span><br><br><span class=\"hljs-comment\"># Apply sysctl params without reboot</span><br><span class=\"hljs-built_in\">sudo</span> sysctl --system<br><br><span class=\"hljs-comment\">## Verify that the br_netfilter, overlay modules are loaded by running the following commands:</span><br>lsmod | grep br_netfilter<br>lsmod | grep overlay<br><br><span class=\"hljs-comment\">## Verify that the net.bridge.bridge-nf-call-iptables, net.bridge.bridge-nf-call-ip6tables, and net.ipv4.ip_forward system variables are set to 1 in your sysctl config by running the following command:</span><br>sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Cgroup-drivers\"><a href=\"#Cgroup-drivers\" class=\"headerlink\" title=\"Cgroup drivers\"></a>Cgroup drivers</h2><ul>\n<li><p>cgroupfs</p>\n<ul>\n<li>The <code>cgroupfs</code> driver is <strong>not</strong> recommended when <a href=\"https://www.freedesktop.org/wiki/Software/systemd/\">systemd</a> is the init system because systemd expects a single cgroup manager on the system. Additionally, if you use <a href=\"https://kubernetes.io/docs/concepts/architecture/cgroups\">cgroup v2</a>, use the <code>systemd</code> cgroup driver instead of <code>cgroupfs</code>.</li>\n</ul>\n</li>\n<li><p>systemd</p>\n<ul>\n<li><p>To set <code>systemd</code> as the cgroup driver, edit the <a href=\"https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/\"><code>KubeletConfiguration</code></a> option of <code>cgroupDriver</code> and set it to <code>systemd</code>. For example:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">kubelet.config.k8s.io/v1beta1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">KubeletConfiguration</span><br><span class=\"hljs-string\">...</span><br><span class=\"hljs-attr\">cgroupDriver:</span> <span class=\"hljs-string\">systemd</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n<blockquote>\n<p>Note: Starting with v1.22 and later, when creating a cluster with kubeadm, if the user does not set the cgroupDriver field under KubeletConfiguration, kubeadm defaults it to systemd</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"Container-runtimes\"><a href=\"#Container-runtimes\" class=\"headerlink\" title=\"Container runtimes\"></a>Container runtimes</h2><blockquote>\n<p>In this step once you’ve created a valid <code>config.toml</code> configuration file.</p>\n<p>You can find this file under the path <code>/etc/containerd/config.toml</code>.</p>\n<p>On Linux the default CRI socket for containerd is <code>/run/containerd/containerd.sock</code>.</p>\n</blockquote>\n<h3 id=\"Configuring-the-systemd-cgroup-driver\"><a href=\"#Configuring-the-systemd-cgroup-driver\" class=\"headerlink\" title=\"Configuring the systemd cgroup driver\"></a>Configuring the systemd cgroup driver</h3><blockquote>\n<p>The <code>systemd</code> cgroup driver is recommended if you use <a href=\"https://kubernetes.io/docs/concepts/architecture/cgroups\">cgroup v2</a>.</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc]<br>  ...<br>  [plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]<br>    SystemdCgroup = <span class=\"hljs-literal\">true</span><br>    <br><span class=\"hljs-built_in\">sudo</span> sed -i <span class=\"hljs-string\">&quot;s#SystemdCgroup = false#SystemdCgroup = true#g&quot;</span> /etc/containerd/config.toml<br><span class=\"hljs-comment\">### If you apply this change, make sure to restart containerd:</span><br><span class=\"hljs-built_in\">sudo</span> systemctl restart containerd<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Overriding-the-sandbox-pause-image\"><a href=\"#Overriding-the-sandbox-pause-image\" class=\"headerlink\" title=\"Overriding the sandbox (pause) image\"></a>Overriding the sandbox (pause) image</h3><p>In your <a href=\"https://github.com/containerd/containerd/blob/main/docs/cri/config.md\">containerd config</a> you can overwrite the sandbox image by setting the following config:</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-section\">[plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br>  <span class=\"hljs-attr\">sandbox_image</span> = <span class=\"hljs-string\">&quot;registry.k8s.io/pause:3.2&quot;</span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">[plugins.<span class=\"hljs-string\">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]<br><span class=\"hljs-comment\">### add following config in China   [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span><br>      endpoint = [<span class=\"hljs-string\">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers&quot;</span>]<br><br><span class=\"hljs-comment\">### This is important if you live in China.</span><br><span class=\"hljs-built_in\">sudo</span> sed -i <span class=\"hljs-string\">&quot;s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g&quot;</span> /etc/containerd/config.toml<br><span class=\"hljs-built_in\">sudo</span> systemctl restart containerd<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0<br>ctr images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4<br><br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3 k8s.gcr.io/kube-apiserver:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3 k8s.gcr.io/kube-controller-manager:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3 k8s.gcr.io/kube-scheduler:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3 k8s.gcr.io/kube-proxy:v1.22.3<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0<br>ctr images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4<br></code></pre></td></tr></table></figure>\n\n"},{"title":"本地大模型部署","date":"2024-08-04T10:59:10.000Z","_content":"\n# 本地大模型部署\n\n> Windows根据官网下载安装即可\n>\n> [Linux 官方安装步骤](https://github.com/ollama/ollama/blob/main/docs/linux.md)\n\n## 1. 安装ollama\n\n```bash\n## 可能会比较慢，需要magic\ncurl -fsSL https://ollama.com/install.sh | sh\n## 也可先把ollama-linux-amd64下载到本地\n## 然后上传到linux\n## 修改安装脚本两处地方再安装\ncurl -fsSL https://ollama.com/install.sh >> ollama_install.sh\nsed -i.bak -e '/TEMP_DIR=/c TEMP_DIR=/tmp' -e '/curl --fail.*-o/s/^/#/' ollama_install.sh\n## 将 ollama-linux-amd64放到tmp下，并重命名为ollama\nmv ollama-linux-amd64 /tmp/ollama\n## 运行ollama_install.sh即可\nsh ollama_install.sh\n## 查看ollama状态\nsystemctl status ollama\n```\n\n```\nroot@localhost:~/mp_mount/llm# sh ollama_install.sh\n>>> Downloading ollama...\n>>> Installing ollama to /usr/local/bin...\n>>> Creating ollama user...\n>>> Adding ollama user to render group...\n>>> Adding ollama user to video group...\n>>> Adding current user to ollama group...\n>>> Creating ollama systemd service...\n>>> Enabling and starting ollama service...\nCreated symlink /etc/systemd/system/default.target.wants/ollama.service → /etc/systemd/system/ollama.service.\n>>> The Ollama API is now available at 127.0.0.1:11434.\n>>> Install complete. Run \"ollama\" from the command line.\n```\n\n此时访问`127.0.0.1:11434`显示`Ollama is running`，则部署成功。\n\n## 2. 选择模型\n\nhttps://ollama.com/ 官网右上角 model\n\n![select-model](../images/local-llm-deploy/select-model.png)\n\n\n\n这里模型我们选择阿里的千问2，复制命令`ollama run qwen2`在linux上运行即可，下载时间会有点长，耐心等待。\n\n![open-webui](../images/local-llm-deploy/qwen2.png)\n\n## 3. 安装open-webui\n\nhttps://github.com/open-webui/open-webui\n\n通过容器化部署。\n\n```bash\ndocker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main\n```\n\nhttp://127.0.0.1:3000 访问，需要注册，随便填写即可。\n\n登录后效果如图：\n\n![open-webui](../images/local-llm-deploy/open-webui.png)\n\n至此，我们就成功部署了一个由CPU提供算力的大语言模型。\n\n由于CPU和GPU设计结构的不同，CPU在处理大模型语言时效果并不理想。\n\n根据前面部署完后，使用时会发现模型给出回复的时候反应很慢，且是一个字一个字蹦出来的。\n\n然而GPU驱动大模型能够显著提高其反应速度，回复也是一段一段显示。\n\n下面容器化部署一并介绍如何使用GPU提供算力。\n\n## 4. 容器化部署\n\n使用Nvidia显卡需要下载驱动\n\n> Nvidia 官网\n>\n> https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html\n\n```bash\n## 配置apt包仓库地址\ncurl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \\\n  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\\n    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \\\n    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list\n    \n## 更新仓库包列表\nsudo apt-get update\n\n## 安装工具\nsudo apt-get install -y nvidia-container-toolkit\n\n## 可使用该命令查看gpu\nnvidia-smi\n## 查看显卡列表\nnvidia-smi -L\n## 在使用过程中可观察gpu运行情况变化\nwatch -n 1 nvidia-smi\n# 或\nnvidia-smi -l\n\n## 运行由gpu驱动的ollama，将大模型存放路径持久化，--gpus all将所有gpu设备加入容器\ndocker run --gpus all -d -v /opt/ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama\n\n## 下载大模型\ndocker exec -it ollama ollama pull qwen2:7b\n```\n\n**其他包管理工具配置**\n\n```bash\n## yum 地址\ncurl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\\n  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo\n  \n## zypper地址\nsudo zypper ar https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo\nsudo zypper --gpg-auto-import-keys install -y nvidia-container-toolkit\n```\n\n","source":"_posts/local-llm-deploy.md","raw":"---\ntitle: 本地大模型部署\ndate: 2024-08-04 18:59:10\ntags: tools\n---\n\n# 本地大模型部署\n\n> Windows根据官网下载安装即可\n>\n> [Linux 官方安装步骤](https://github.com/ollama/ollama/blob/main/docs/linux.md)\n\n## 1. 安装ollama\n\n```bash\n## 可能会比较慢，需要magic\ncurl -fsSL https://ollama.com/install.sh | sh\n## 也可先把ollama-linux-amd64下载到本地\n## 然后上传到linux\n## 修改安装脚本两处地方再安装\ncurl -fsSL https://ollama.com/install.sh >> ollama_install.sh\nsed -i.bak -e '/TEMP_DIR=/c TEMP_DIR=/tmp' -e '/curl --fail.*-o/s/^/#/' ollama_install.sh\n## 将 ollama-linux-amd64放到tmp下，并重命名为ollama\nmv ollama-linux-amd64 /tmp/ollama\n## 运行ollama_install.sh即可\nsh ollama_install.sh\n## 查看ollama状态\nsystemctl status ollama\n```\n\n```\nroot@localhost:~/mp_mount/llm# sh ollama_install.sh\n>>> Downloading ollama...\n>>> Installing ollama to /usr/local/bin...\n>>> Creating ollama user...\n>>> Adding ollama user to render group...\n>>> Adding ollama user to video group...\n>>> Adding current user to ollama group...\n>>> Creating ollama systemd service...\n>>> Enabling and starting ollama service...\nCreated symlink /etc/systemd/system/default.target.wants/ollama.service → /etc/systemd/system/ollama.service.\n>>> The Ollama API is now available at 127.0.0.1:11434.\n>>> Install complete. Run \"ollama\" from the command line.\n```\n\n此时访问`127.0.0.1:11434`显示`Ollama is running`，则部署成功。\n\n## 2. 选择模型\n\nhttps://ollama.com/ 官网右上角 model\n\n![select-model](../images/local-llm-deploy/select-model.png)\n\n\n\n这里模型我们选择阿里的千问2，复制命令`ollama run qwen2`在linux上运行即可，下载时间会有点长，耐心等待。\n\n![open-webui](../images/local-llm-deploy/qwen2.png)\n\n## 3. 安装open-webui\n\nhttps://github.com/open-webui/open-webui\n\n通过容器化部署。\n\n```bash\ndocker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main\n```\n\nhttp://127.0.0.1:3000 访问，需要注册，随便填写即可。\n\n登录后效果如图：\n\n![open-webui](../images/local-llm-deploy/open-webui.png)\n\n至此，我们就成功部署了一个由CPU提供算力的大语言模型。\n\n由于CPU和GPU设计结构的不同，CPU在处理大模型语言时效果并不理想。\n\n根据前面部署完后，使用时会发现模型给出回复的时候反应很慢，且是一个字一个字蹦出来的。\n\n然而GPU驱动大模型能够显著提高其反应速度，回复也是一段一段显示。\n\n下面容器化部署一并介绍如何使用GPU提供算力。\n\n## 4. 容器化部署\n\n使用Nvidia显卡需要下载驱动\n\n> Nvidia 官网\n>\n> https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html\n\n```bash\n## 配置apt包仓库地址\ncurl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \\\n  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\\n    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \\\n    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list\n    \n## 更新仓库包列表\nsudo apt-get update\n\n## 安装工具\nsudo apt-get install -y nvidia-container-toolkit\n\n## 可使用该命令查看gpu\nnvidia-smi\n## 查看显卡列表\nnvidia-smi -L\n## 在使用过程中可观察gpu运行情况变化\nwatch -n 1 nvidia-smi\n# 或\nnvidia-smi -l\n\n## 运行由gpu驱动的ollama，将大模型存放路径持久化，--gpus all将所有gpu设备加入容器\ndocker run --gpus all -d -v /opt/ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama\n\n## 下载大模型\ndocker exec -it ollama ollama pull qwen2:7b\n```\n\n**其他包管理工具配置**\n\n```bash\n## yum 地址\ncurl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\\n  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo\n  \n## zypper地址\nsudo zypper ar https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo\nsudo zypper --gpg-auto-import-keys install -y nvidia-container-toolkit\n```\n\n","slug":"local-llm-deploy","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yp000fuhuq44wa3q0j","content":"<h1 id=\"本地大模型部署\"><a href=\"#本地大模型部署\" class=\"headerlink\" title=\"本地大模型部署\"></a>本地大模型部署</h1><blockquote>\n<p>Windows根据官网下载安装即可</p>\n<p><a href=\"https://github.com/ollama/ollama/blob/main/docs/linux.md\">Linux 官方安装步骤</a></p>\n</blockquote>\n<h2 id=\"1-安装ollama\"><a href=\"#1-安装ollama\" class=\"headerlink\" title=\"1. 安装ollama\"></a>1. 安装ollama</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可能会比较慢，需要magic</span><br>curl -fsSL https://ollama.com/install.sh | sh<br><span class=\"hljs-comment\">## 也可先把ollama-linux-amd64下载到本地</span><br><span class=\"hljs-comment\">## 然后上传到linux</span><br><span class=\"hljs-comment\">## 修改安装脚本两处地方再安装</span><br>curl -fsSL https://ollama.com/install.sh &gt;&gt; ollama_install.sh<br>sed -i.bak -e <span class=\"hljs-string\">&#x27;/TEMP_DIR=/c TEMP_DIR=/tmp&#x27;</span> -e <span class=\"hljs-string\">&#x27;/curl --fail.*-o/s/^/#/&#x27;</span> ollama_install.sh<br><span class=\"hljs-comment\">## 将 ollama-linux-amd64放到tmp下，并重命名为ollama</span><br><span class=\"hljs-built_in\">mv</span> ollama-linux-amd64 /tmp/ollama<br><span class=\"hljs-comment\">## 运行ollama_install.sh即可</span><br>sh ollama_install.sh<br><span class=\"hljs-comment\">## 查看ollama状态</span><br>systemctl status ollama<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight python-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python-repl\">root@localhost:~/mp_mount/llm# sh ollama_install.sh<br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Downloading ollama...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Installing ollama to /usr/local/<span class=\"hljs-built_in\">bin</span>...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Creating ollama user...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding ollama user to render group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding ollama user to video group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding current user to ollama group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Creating ollama systemd service...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Enabling <span class=\"hljs-keyword\">and</span> starting ollama service...</span><br>Created symlink /etc/systemd/system/default.target.wants/ollama.service → /etc/systemd/system/ollama.service.<br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">The Ollama API <span class=\"hljs-keyword\">is</span> now available at <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">11434.</span></span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Install complete. Run <span class=\"hljs-string\">&quot;ollama&quot;</span> <span class=\"hljs-keyword\">from</span> the command line.</span><br></code></pre></td></tr></table></figure>\n\n<p>此时访问<code>127.0.0.1:11434</code>显示<code>Ollama is running</code>，则部署成功。</p>\n<h2 id=\"2-选择模型\"><a href=\"#2-选择模型\" class=\"headerlink\" title=\"2. 选择模型\"></a>2. 选择模型</h2><p><a href=\"https://ollama.com/\">https://ollama.com/</a> 官网右上角 model</p>\n<p><img src=\"/../images/local-llm-deploy/select-model.png\" alt=\"select-model\"></p>\n<p>这里模型我们选择阿里的千问2，复制命令<code>ollama run qwen2</code>在linux上运行即可，下载时间会有点长，耐心等待。</p>\n<p><img src=\"/../images/local-llm-deploy/qwen2.png\" alt=\"open-webui\"></p>\n<h2 id=\"3-安装open-webui\"><a href=\"#3-安装open-webui\" class=\"headerlink\" title=\"3. 安装open-webui\"></a>3. 安装open-webui</h2><p><a href=\"https://github.com/open-webui/open-webui\">https://github.com/open-webui/open-webui</a></p>\n<p>通过容器化部署。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main<br></code></pre></td></tr></table></figure>\n\n<p><a href=\"http://127.0.0.1:3000/\">http://127.0.0.1:3000</a> 访问，需要注册，随便填写即可。</p>\n<p>登录后效果如图：</p>\n<p><img src=\"/../images/local-llm-deploy/open-webui.png\" alt=\"open-webui\"></p>\n<p>至此，我们就成功部署了一个由CPU提供算力的大语言模型。</p>\n<p>由于CPU和GPU设计结构的不同，CPU在处理大模型语言时效果并不理想。</p>\n<p>根据前面部署完后，使用时会发现模型给出回复的时候反应很慢，且是一个字一个字蹦出来的。</p>\n<p>然而GPU驱动大模型能够显著提高其反应速度，回复也是一段一段显示。</p>\n<p>下面容器化部署一并介绍如何使用GPU提供算力。</p>\n<h2 id=\"4-容器化部署\"><a href=\"#4-容器化部署\" class=\"headerlink\" title=\"4. 容器化部署\"></a>4. 容器化部署</h2><p>使用Nvidia显卡需要下载驱动</p>\n<blockquote>\n<p>Nvidia 官网</p>\n<p><a href=\"https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html\">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 配置apt包仓库地址</span><br>curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | <span class=\"hljs-built_in\">sudo</span> gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \\<br>  &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\<br>    sed <span class=\"hljs-string\">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \\<br>    <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list<br>    <br><span class=\"hljs-comment\">## 更新仓库包列表</span><br><span class=\"hljs-built_in\">sudo</span> apt-get update<br><br><span class=\"hljs-comment\">## 安装工具</span><br><span class=\"hljs-built_in\">sudo</span> apt-get install -y nvidia-container-toolkit<br><br><span class=\"hljs-comment\">## 可使用该命令查看gpu</span><br>nvidia-smi<br><span class=\"hljs-comment\">## 查看显卡列表</span><br>nvidia-smi -L<br><span class=\"hljs-comment\">## 在使用过程中可观察gpu运行情况变化</span><br>watch -n 1 nvidia-smi<br><span class=\"hljs-comment\"># 或</span><br>nvidia-smi -l<br><br><span class=\"hljs-comment\">## 运行由gpu驱动的ollama，将大模型存放路径持久化，--gpus all将所有gpu设备加入容器</span><br>docker run --gpus all -d -v /opt/ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama<br><br><span class=\"hljs-comment\">## 下载大模型</span><br>docker <span class=\"hljs-built_in\">exec</span> -it ollama ollama pull qwen2:7b<br></code></pre></td></tr></table></figure>\n\n<p><strong>其他包管理工具配置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## yum 地址</span><br>curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\<br>  <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/yum.repos.d/nvidia-container-toolkit.repo<br>  <br><span class=\"hljs-comment\">## zypper地址</span><br><span class=\"hljs-built_in\">sudo</span> zypper ar https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo<br><span class=\"hljs-built_in\">sudo</span> zypper --gpg-auto-import-keys install -y nvidia-container-toolkit<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"本地大模型部署\"><a href=\"#本地大模型部署\" class=\"headerlink\" title=\"本地大模型部署\"></a>本地大模型部署</h1><blockquote>\n<p>Windows根据官网下载安装即可</p>\n<p><a href=\"https://github.com/ollama/ollama/blob/main/docs/linux.md\">Linux 官方安装步骤</a></p>\n</blockquote>\n<h2 id=\"1-安装ollama\"><a href=\"#1-安装ollama\" class=\"headerlink\" title=\"1. 安装ollama\"></a>1. 安装ollama</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可能会比较慢，需要magic</span><br>curl -fsSL https://ollama.com/install.sh | sh<br><span class=\"hljs-comment\">## 也可先把ollama-linux-amd64下载到本地</span><br><span class=\"hljs-comment\">## 然后上传到linux</span><br><span class=\"hljs-comment\">## 修改安装脚本两处地方再安装</span><br>curl -fsSL https://ollama.com/install.sh &gt;&gt; ollama_install.sh<br>sed -i.bak -e <span class=\"hljs-string\">&#x27;/TEMP_DIR=/c TEMP_DIR=/tmp&#x27;</span> -e <span class=\"hljs-string\">&#x27;/curl --fail.*-o/s/^/#/&#x27;</span> ollama_install.sh<br><span class=\"hljs-comment\">## 将 ollama-linux-amd64放到tmp下，并重命名为ollama</span><br><span class=\"hljs-built_in\">mv</span> ollama-linux-amd64 /tmp/ollama<br><span class=\"hljs-comment\">## 运行ollama_install.sh即可</span><br>sh ollama_install.sh<br><span class=\"hljs-comment\">## 查看ollama状态</span><br>systemctl status ollama<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight python-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python-repl\">root@localhost:~/mp_mount/llm# sh ollama_install.sh<br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Downloading ollama...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Installing ollama to /usr/local/<span class=\"hljs-built_in\">bin</span>...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Creating ollama user...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding ollama user to render group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding ollama user to video group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Adding current user to ollama group...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Creating ollama systemd service...</span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Enabling <span class=\"hljs-keyword\">and</span> starting ollama service...</span><br>Created symlink /etc/systemd/system/default.target.wants/ollama.service → /etc/systemd/system/ollama.service.<br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">The Ollama API <span class=\"hljs-keyword\">is</span> now available at <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">11434.</span></span><br><span class=\"hljs-meta prompt_\">&gt;&gt;&gt;</span> <span class=\"language-python\">Install complete. Run <span class=\"hljs-string\">&quot;ollama&quot;</span> <span class=\"hljs-keyword\">from</span> the command line.</span><br></code></pre></td></tr></table></figure>\n\n<p>此时访问<code>127.0.0.1:11434</code>显示<code>Ollama is running</code>，则部署成功。</p>\n<h2 id=\"2-选择模型\"><a href=\"#2-选择模型\" class=\"headerlink\" title=\"2. 选择模型\"></a>2. 选择模型</h2><p><a href=\"https://ollama.com/\">https://ollama.com/</a> 官网右上角 model</p>\n<p><img src=\"/../images/local-llm-deploy/select-model.png\" alt=\"select-model\"></p>\n<p>这里模型我们选择阿里的千问2，复制命令<code>ollama run qwen2</code>在linux上运行即可，下载时间会有点长，耐心等待。</p>\n<p><img src=\"/../images/local-llm-deploy/qwen2.png\" alt=\"open-webui\"></p>\n<h2 id=\"3-安装open-webui\"><a href=\"#3-安装open-webui\" class=\"headerlink\" title=\"3. 安装open-webui\"></a>3. 安装open-webui</h2><p><a href=\"https://github.com/open-webui/open-webui\">https://github.com/open-webui/open-webui</a></p>\n<p>通过容器化部署。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main<br></code></pre></td></tr></table></figure>\n\n<p><a href=\"http://127.0.0.1:3000/\">http://127.0.0.1:3000</a> 访问，需要注册，随便填写即可。</p>\n<p>登录后效果如图：</p>\n<p><img src=\"/../images/local-llm-deploy/open-webui.png\" alt=\"open-webui\"></p>\n<p>至此，我们就成功部署了一个由CPU提供算力的大语言模型。</p>\n<p>由于CPU和GPU设计结构的不同，CPU在处理大模型语言时效果并不理想。</p>\n<p>根据前面部署完后，使用时会发现模型给出回复的时候反应很慢，且是一个字一个字蹦出来的。</p>\n<p>然而GPU驱动大模型能够显著提高其反应速度，回复也是一段一段显示。</p>\n<p>下面容器化部署一并介绍如何使用GPU提供算力。</p>\n<h2 id=\"4-容器化部署\"><a href=\"#4-容器化部署\" class=\"headerlink\" title=\"4. 容器化部署\"></a>4. 容器化部署</h2><p>使用Nvidia显卡需要下载驱动</p>\n<blockquote>\n<p>Nvidia 官网</p>\n<p><a href=\"https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html\">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 配置apt包仓库地址</span><br>curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | <span class=\"hljs-built_in\">sudo</span> gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \\<br>  &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\<br>    sed <span class=\"hljs-string\">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \\<br>    <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list<br>    <br><span class=\"hljs-comment\">## 更新仓库包列表</span><br><span class=\"hljs-built_in\">sudo</span> apt-get update<br><br><span class=\"hljs-comment\">## 安装工具</span><br><span class=\"hljs-built_in\">sudo</span> apt-get install -y nvidia-container-toolkit<br><br><span class=\"hljs-comment\">## 可使用该命令查看gpu</span><br>nvidia-smi<br><span class=\"hljs-comment\">## 查看显卡列表</span><br>nvidia-smi -L<br><span class=\"hljs-comment\">## 在使用过程中可观察gpu运行情况变化</span><br>watch -n 1 nvidia-smi<br><span class=\"hljs-comment\"># 或</span><br>nvidia-smi -l<br><br><span class=\"hljs-comment\">## 运行由gpu驱动的ollama，将大模型存放路径持久化，--gpus all将所有gpu设备加入容器</span><br>docker run --gpus all -d -v /opt/ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama<br><br><span class=\"hljs-comment\">## 下载大模型</span><br>docker <span class=\"hljs-built_in\">exec</span> -it ollama ollama pull qwen2:7b<br></code></pre></td></tr></table></figure>\n\n<p><strong>其他包管理工具配置</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## yum 地址</span><br>curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\<br>  <span class=\"hljs-built_in\">sudo</span> <span class=\"hljs-built_in\">tee</span> /etc/yum.repos.d/nvidia-container-toolkit.repo<br>  <br><span class=\"hljs-comment\">## zypper地址</span><br><span class=\"hljs-built_in\">sudo</span> zypper ar https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo<br><span class=\"hljs-built_in\">sudo</span> zypper --gpg-auto-import-keys install -y nvidia-container-toolkit<br></code></pre></td></tr></table></figure>\n\n"},{"title":"Multipass 基本用法及常见问题","date":"2024-07-08T03:02:11.000Z","_content":"这是一份Multipass基本操作文档，以及包含一些常见问题的解决方法。\n\nMultipass 是一个轻量级的虚拟机管理工具，旨在简化在本地环境中创建和管理 Ubuntu 虚拟机。\n\n参考资料\n\n- [Multipass 官网](https://multipass.run/)\n- [Multipass 文档](https://multipass.run/docs)\n\n# 安装Multipass\n\n1. **在 Linux 上安装**:\n\n   ```bash\n   sudo snap install multipass\n   ```\n\n2. **在 macOS 上安装**:\n   使用 Homebrew:\n\n   ```bash\n   brew install --cask multipass\n   ```\n\n3. **在 Windows 上安装**:\n   访问 [Multipass 官网](https://multipass.run/) 下载适用于 Windows 的安装程序，并按照提示完成安装。\n\n## 基本命令\n\n1. **启动一个新的虚拟机**:\n\n   ```bash\n   multipass launch --name <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass launch --name my-vm\n   ```\n\n2. **列出所有虚拟机**:\n\n   ```bash\n   multipass list\n   ```\n\n3. **进入虚拟机**:\n\n   ```bash\n   multipass shell <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass shell my-vm\n   ```\n\n4. **停止虚拟机**:\n\n   ```bash\n   multipass stop <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass stop my-vm\n   ```\n\n5. **删除虚拟机**:\n\n   ```bash\n   multipass delete <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass delete my-vm\n   ```\n\n6. **清理已删除的虚拟机**:\n\n   ```bash\n   multipass purge\n   ```\n\n## 进阶用法\n\n1. **指定 Ubuntu 版本**:\n\n   ```bash\n   multipass launch --name <instance-name> <ubuntu-version>\n   ```\n\n   例如，启动一个 Ubuntu 20.04 的虚拟机:\n\n   ```bash\n   multipass launch --name my-vm 20.04\n   ```\n\n2. **分配更多资源（CPU、内存、磁盘）**:\n\n   ```bash\n   multipass launch --name <instance-name> --cpus <number> --mem <size> --disk <size>\n   ```\n\n   例如，分配 2 个 CPU，4GB 内存，20GB 磁盘:\n\n   ```bash\n   multipass launch --name my-vm --cpus 2 --mem 4G --disk 20G\n   ```\n\n3. **共享文件夹**:\n\n   ```bash\n   multipass mount <host-directory> <instance-name>:<target-directory>\n   ```\n\n   例如，将本地目录 `/home/user/projects` 挂载到虚拟机的 `/home/ubuntu/projects`:\n\n   ```bash\n   multipass mount /home/user/projects my-vm:/home/ubuntu/projects\n   ```\n\n4. **运行命令**:\n   可以在虚拟机中运行命令而不进入虚拟机：\n\n   ```bash\n   multipass exec <instance-name> -- <command>\n   ```\n\n   例如，更新虚拟机中的包列表:\n\n   ```bash\n   multipass exec my-vm -- sudo apt update\n   ```\n\n# 启动前配置\n\n```bash\n## 开启mount挂载，方便拿或传文件到服务器，默认false\nmultipass set local.privileged-mounts=true\n## 选择虚拟机驱动，hyperv/virtualbox\n## win专业版可用hyperv，家庭版只能virtualbox\nmultipass set local.driver=hyperv\n## 设置默认操作实例\nmultipass get client.primary-name=primary\n```\n\n# 启动实例\n\n```bash\nmultipass launch -n $name -d 10G -m 2G -c 2 --bridged --mount <local-path>:<instance-path>\n```\n\n> 如果启动不了可以尝试重启multipass\n\n# 调整实例配置\n\n```bash\nmultipass stop handsome-ling\nmultipass set local.handsome-ling.cpus=4\nmultipass set local.handsome-ling.disk=60G\nmultipass set local.handsome-ling.memory=7G\n```\n\n# 删除\n\n```bash\n## 删除并清除\n## delete 相当于把实例转为删除状态 \n## -p or --purge 删除并清除\nmultipass delete $instance -p\n## purge\nmultipass purge $instance\n```\n\n# IPv4 N/A\n\n- 重启实例\n\n  ```bash\n  multipass restart $instance\n  ```\n\n- 停止后再启动实例\n\n  ```bash\n  multipass stop $instance\n  multipass start $instance\n  ```\n\n- 重启multipass服务\n\n  - 可直接杀进程\n\n  ```powershell\n  taskkill /f /pid $pid\n  ```\n\n- 状态suspending ，尝试suspend实例\n\n  ```bash\n  multipass suspend $instance\n  ```\n\n- 状态suspended， shell连接即可\n\n  ```bash\n  multipass shell $instance\n  ```\n\n  \n","source":"_posts/multipass.md","raw":"---\ntitle: Multipass 基本用法及常见问题\ndate: 2024-07-08 11:02:11\ntags: tools\n---\n这是一份Multipass基本操作文档，以及包含一些常见问题的解决方法。\n\nMultipass 是一个轻量级的虚拟机管理工具，旨在简化在本地环境中创建和管理 Ubuntu 虚拟机。\n\n参考资料\n\n- [Multipass 官网](https://multipass.run/)\n- [Multipass 文档](https://multipass.run/docs)\n\n# 安装Multipass\n\n1. **在 Linux 上安装**:\n\n   ```bash\n   sudo snap install multipass\n   ```\n\n2. **在 macOS 上安装**:\n   使用 Homebrew:\n\n   ```bash\n   brew install --cask multipass\n   ```\n\n3. **在 Windows 上安装**:\n   访问 [Multipass 官网](https://multipass.run/) 下载适用于 Windows 的安装程序，并按照提示完成安装。\n\n## 基本命令\n\n1. **启动一个新的虚拟机**:\n\n   ```bash\n   multipass launch --name <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass launch --name my-vm\n   ```\n\n2. **列出所有虚拟机**:\n\n   ```bash\n   multipass list\n   ```\n\n3. **进入虚拟机**:\n\n   ```bash\n   multipass shell <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass shell my-vm\n   ```\n\n4. **停止虚拟机**:\n\n   ```bash\n   multipass stop <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass stop my-vm\n   ```\n\n5. **删除虚拟机**:\n\n   ```bash\n   multipass delete <instance-name>\n   ```\n\n   例如:\n\n   ```bash\n   multipass delete my-vm\n   ```\n\n6. **清理已删除的虚拟机**:\n\n   ```bash\n   multipass purge\n   ```\n\n## 进阶用法\n\n1. **指定 Ubuntu 版本**:\n\n   ```bash\n   multipass launch --name <instance-name> <ubuntu-version>\n   ```\n\n   例如，启动一个 Ubuntu 20.04 的虚拟机:\n\n   ```bash\n   multipass launch --name my-vm 20.04\n   ```\n\n2. **分配更多资源（CPU、内存、磁盘）**:\n\n   ```bash\n   multipass launch --name <instance-name> --cpus <number> --mem <size> --disk <size>\n   ```\n\n   例如，分配 2 个 CPU，4GB 内存，20GB 磁盘:\n\n   ```bash\n   multipass launch --name my-vm --cpus 2 --mem 4G --disk 20G\n   ```\n\n3. **共享文件夹**:\n\n   ```bash\n   multipass mount <host-directory> <instance-name>:<target-directory>\n   ```\n\n   例如，将本地目录 `/home/user/projects` 挂载到虚拟机的 `/home/ubuntu/projects`:\n\n   ```bash\n   multipass mount /home/user/projects my-vm:/home/ubuntu/projects\n   ```\n\n4. **运行命令**:\n   可以在虚拟机中运行命令而不进入虚拟机：\n\n   ```bash\n   multipass exec <instance-name> -- <command>\n   ```\n\n   例如，更新虚拟机中的包列表:\n\n   ```bash\n   multipass exec my-vm -- sudo apt update\n   ```\n\n# 启动前配置\n\n```bash\n## 开启mount挂载，方便拿或传文件到服务器，默认false\nmultipass set local.privileged-mounts=true\n## 选择虚拟机驱动，hyperv/virtualbox\n## win专业版可用hyperv，家庭版只能virtualbox\nmultipass set local.driver=hyperv\n## 设置默认操作实例\nmultipass get client.primary-name=primary\n```\n\n# 启动实例\n\n```bash\nmultipass launch -n $name -d 10G -m 2G -c 2 --bridged --mount <local-path>:<instance-path>\n```\n\n> 如果启动不了可以尝试重启multipass\n\n# 调整实例配置\n\n```bash\nmultipass stop handsome-ling\nmultipass set local.handsome-ling.cpus=4\nmultipass set local.handsome-ling.disk=60G\nmultipass set local.handsome-ling.memory=7G\n```\n\n# 删除\n\n```bash\n## 删除并清除\n## delete 相当于把实例转为删除状态 \n## -p or --purge 删除并清除\nmultipass delete $instance -p\n## purge\nmultipass purge $instance\n```\n\n# IPv4 N/A\n\n- 重启实例\n\n  ```bash\n  multipass restart $instance\n  ```\n\n- 停止后再启动实例\n\n  ```bash\n  multipass stop $instance\n  multipass start $instance\n  ```\n\n- 重启multipass服务\n\n  - 可直接杀进程\n\n  ```powershell\n  taskkill /f /pid $pid\n  ```\n\n- 状态suspending ，尝试suspend实例\n\n  ```bash\n  multipass suspend $instance\n  ```\n\n- 状态suspended， shell连接即可\n\n  ```bash\n  multipass shell $instance\n  ```\n\n  \n","slug":"multipass","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yr000huhuq8amy089o","content":"<p>这是一份Multipass基本操作文档，以及包含一些常见问题的解决方法。</p>\n<p>Multipass 是一个轻量级的虚拟机管理工具，旨在简化在本地环境中创建和管理 Ubuntu 虚拟机。</p>\n<p>参考资料</p>\n<ul>\n<li><a href=\"https://multipass.run/\">Multipass 官网</a></li>\n<li><a href=\"https://multipass.run/docs\">Multipass 文档</a></li>\n</ul>\n<h1 id=\"安装Multipass\"><a href=\"#安装Multipass\" class=\"headerlink\" title=\"安装Multipass\"></a>安装Multipass</h1><ol>\n<li><p><strong>在 Linux 上安装</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> snap install multipass<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在 macOS 上安装</strong>:<br>使用 Homebrew:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">brew install --cask multipass<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在 Windows 上安装</strong>:<br>访问 <a href=\"https://multipass.run/\">Multipass 官网</a> 下载适用于 Windows 的安装程序，并按照提示完成安装。</p>\n</li>\n</ol>\n<h2 id=\"基本命令\"><a href=\"#基本命令\" class=\"headerlink\" title=\"基本命令\"></a>基本命令</h2><ol>\n<li><p><strong>启动一个新的虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>列出所有虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass list<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>进入虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>停止虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>删除虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass delete &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass delete my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>清理已删除的虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass purge<br></code></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"进阶用法\"><a href=\"#进阶用法\" class=\"headerlink\" title=\"进阶用法\"></a>进阶用法</h2><ol>\n<li><p><strong>指定 Ubuntu 版本</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt; &lt;ubuntu-version&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，启动一个 Ubuntu 20.04 的虚拟机:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm 20.04<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>分配更多资源（CPU、内存、磁盘）</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt; --cpus &lt;number&gt; --mem &lt;size&gt; --disk &lt;size&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，分配 2 个 CPU，4GB 内存，20GB 磁盘:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm --cpus 2 --mem 4G --disk 20G<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>共享文件夹</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass mount &lt;host-directory&gt; &lt;instance-name&gt;:&lt;target-directory&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，将本地目录 <code>/home/user/projects</code> 挂载到虚拟机的 <code>/home/ubuntu/projects</code>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass mount /home/user/projects my-vm:/home/ubuntu/projects<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>运行命令</strong>:<br>可以在虚拟机中运行命令而不进入虚拟机：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">exec</span> &lt;instance-name&gt; -- &lt;<span class=\"hljs-built_in\">command</span>&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，更新虚拟机中的包列表:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">exec</span> my-vm -- <span class=\"hljs-built_in\">sudo</span> apt update<br></code></pre></td></tr></table></figure></li>\n</ol>\n<h1 id=\"启动前配置\"><a href=\"#启动前配置\" class=\"headerlink\" title=\"启动前配置\"></a>启动前配置</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 开启mount挂载，方便拿或传文件到服务器，默认false</span><br>multipass <span class=\"hljs-built_in\">set</span> local.privileged-mounts=<span class=\"hljs-literal\">true</span><br><span class=\"hljs-comment\">## 选择虚拟机驱动，hyperv/virtualbox</span><br><span class=\"hljs-comment\">## win专业版可用hyperv，家庭版只能virtualbox</span><br>multipass <span class=\"hljs-built_in\">set</span> local.driver=hyperv<br><span class=\"hljs-comment\">## 设置默认操作实例</span><br>multipass get client.primary-name=primary<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"启动实例\"><a href=\"#启动实例\" class=\"headerlink\" title=\"启动实例\"></a>启动实例</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch -n <span class=\"hljs-variable\">$name</span> -d 10G -m 2G -c 2 --bridged --mount &lt;local-path&gt;:&lt;instance-path&gt;<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果启动不了可以尝试重启multipass</p>\n</blockquote>\n<h1 id=\"调整实例配置\"><a href=\"#调整实例配置\" class=\"headerlink\" title=\"调整实例配置\"></a>调整实例配置</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop handsome-ling<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.cpus=4<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.disk=60G<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.memory=7G<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"删除\"><a href=\"#删除\" class=\"headerlink\" title=\"删除\"></a>删除</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 删除并清除</span><br><span class=\"hljs-comment\">## delete 相当于把实例转为删除状态 </span><br><span class=\"hljs-comment\">## -p or --purge 删除并清除</span><br>multipass delete <span class=\"hljs-variable\">$instance</span> -p<br><span class=\"hljs-comment\">## purge</span><br>multipass purge <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"IPv4-N-A\"><a href=\"#IPv4-N-A\" class=\"headerlink\" title=\"IPv4 N&#x2F;A\"></a>IPv4 N&#x2F;A</h1><ul>\n<li><p>重启实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass restart <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>停止后再启动实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop <span class=\"hljs-variable\">$instance</span><br>multipass start <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>重启multipass服务</p>\n<ul>\n<li>可直接杀进程</li>\n</ul>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">taskkill /f /pid <span class=\"hljs-variable\">$pid</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>状态suspending ，尝试suspend实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">suspend</span> <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>状态suspended， shell连接即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n","excerpt":"","more":"<p>这是一份Multipass基本操作文档，以及包含一些常见问题的解决方法。</p>\n<p>Multipass 是一个轻量级的虚拟机管理工具，旨在简化在本地环境中创建和管理 Ubuntu 虚拟机。</p>\n<p>参考资料</p>\n<ul>\n<li><a href=\"https://multipass.run/\">Multipass 官网</a></li>\n<li><a href=\"https://multipass.run/docs\">Multipass 文档</a></li>\n</ul>\n<h1 id=\"安装Multipass\"><a href=\"#安装Multipass\" class=\"headerlink\" title=\"安装Multipass\"></a>安装Multipass</h1><ol>\n<li><p><strong>在 Linux 上安装</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> snap install multipass<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在 macOS 上安装</strong>:<br>使用 Homebrew:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">brew install --cask multipass<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在 Windows 上安装</strong>:<br>访问 <a href=\"https://multipass.run/\">Multipass 官网</a> 下载适用于 Windows 的安装程序，并按照提示完成安装。</p>\n</li>\n</ol>\n<h2 id=\"基本命令\"><a href=\"#基本命令\" class=\"headerlink\" title=\"基本命令\"></a>基本命令</h2><ol>\n<li><p><strong>启动一个新的虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>列出所有虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass list<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>进入虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>停止虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>删除虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass delete &lt;instance-name&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass delete my-vm<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>清理已删除的虚拟机</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass purge<br></code></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"进阶用法\"><a href=\"#进阶用法\" class=\"headerlink\" title=\"进阶用法\"></a>进阶用法</h2><ol>\n<li><p><strong>指定 Ubuntu 版本</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt; &lt;ubuntu-version&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，启动一个 Ubuntu 20.04 的虚拟机:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm 20.04<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>分配更多资源（CPU、内存、磁盘）</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name &lt;instance-name&gt; --cpus &lt;number&gt; --mem &lt;size&gt; --disk &lt;size&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，分配 2 个 CPU，4GB 内存，20GB 磁盘:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch --name my-vm --cpus 2 --mem 4G --disk 20G<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>共享文件夹</strong>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass mount &lt;host-directory&gt; &lt;instance-name&gt;:&lt;target-directory&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，将本地目录 <code>/home/user/projects</code> 挂载到虚拟机的 <code>/home/ubuntu/projects</code>:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass mount /home/user/projects my-vm:/home/ubuntu/projects<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>运行命令</strong>:<br>可以在虚拟机中运行命令而不进入虚拟机：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">exec</span> &lt;instance-name&gt; -- &lt;<span class=\"hljs-built_in\">command</span>&gt;<br></code></pre></td></tr></table></figure>\n\n<p>例如，更新虚拟机中的包列表:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">exec</span> my-vm -- <span class=\"hljs-built_in\">sudo</span> apt update<br></code></pre></td></tr></table></figure></li>\n</ol>\n<h1 id=\"启动前配置\"><a href=\"#启动前配置\" class=\"headerlink\" title=\"启动前配置\"></a>启动前配置</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 开启mount挂载，方便拿或传文件到服务器，默认false</span><br>multipass <span class=\"hljs-built_in\">set</span> local.privileged-mounts=<span class=\"hljs-literal\">true</span><br><span class=\"hljs-comment\">## 选择虚拟机驱动，hyperv/virtualbox</span><br><span class=\"hljs-comment\">## win专业版可用hyperv，家庭版只能virtualbox</span><br>multipass <span class=\"hljs-built_in\">set</span> local.driver=hyperv<br><span class=\"hljs-comment\">## 设置默认操作实例</span><br>multipass get client.primary-name=primary<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"启动实例\"><a href=\"#启动实例\" class=\"headerlink\" title=\"启动实例\"></a>启动实例</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass launch -n <span class=\"hljs-variable\">$name</span> -d 10G -m 2G -c 2 --bridged --mount &lt;local-path&gt;:&lt;instance-path&gt;<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果启动不了可以尝试重启multipass</p>\n</blockquote>\n<h1 id=\"调整实例配置\"><a href=\"#调整实例配置\" class=\"headerlink\" title=\"调整实例配置\"></a>调整实例配置</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop handsome-ling<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.cpus=4<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.disk=60G<br>multipass <span class=\"hljs-built_in\">set</span> local.handsome-ling.memory=7G<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"删除\"><a href=\"#删除\" class=\"headerlink\" title=\"删除\"></a>删除</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 删除并清除</span><br><span class=\"hljs-comment\">## delete 相当于把实例转为删除状态 </span><br><span class=\"hljs-comment\">## -p or --purge 删除并清除</span><br>multipass delete <span class=\"hljs-variable\">$instance</span> -p<br><span class=\"hljs-comment\">## purge</span><br>multipass purge <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n\n<h1 id=\"IPv4-N-A\"><a href=\"#IPv4-N-A\" class=\"headerlink\" title=\"IPv4 N&#x2F;A\"></a>IPv4 N&#x2F;A</h1><ul>\n<li><p>重启实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass restart <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>停止后再启动实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass stop <span class=\"hljs-variable\">$instance</span><br>multipass start <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>重启multipass服务</p>\n<ul>\n<li>可直接杀进程</li>\n</ul>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">taskkill /f /pid <span class=\"hljs-variable\">$pid</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>状态suspending ，尝试suspend实例</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass <span class=\"hljs-built_in\">suspend</span> <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p>状态suspended， shell连接即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">multipass shell <span class=\"hljs-variable\">$instance</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"Shell 实用技巧（一）","date":"2024-08-06T12:06:47.000Z","_content":"# Shell 实用技巧\n1. **保存多个命令的输出**\n    - 使用`{}`将命令组合在一起，然后重定向\n        - 花括号实际上是保留字，两侧必须有空白字符，闭合括号前面的命令的分号不能少\n    - 使用`()`将命令放入子shell重定向输出\n\n    用子shell的方式不会改变当前shell的环境，比如下面的命令组包含`cd ..`，在用花括号的方式中会切换当前路径，而子shell方式中不会切换当前shell的路径，所有的命令都在子shell当中执行，不影响当前shell环境。\n\n    ```bash\n    ## 可以用{} or ()\n    { ls; cd ..; pwd; ls; } > /tmp/all.out\n    (ls; cd ..; pwd; ls) > /tmp/all.out\n\n    test $result -eq 1 && { echo \"Result\" is 1; exit 0; } \\\n        || { echo \"Run Away!\"; exit 120; }\n    ```\n\n2. **跳过文件标题**\n```bash\n## 显示后十行\ntail -n 10\ntail -10 \n## 跳过第一行, 可用于一些跳过标题的情况\ntail -n +2\n```\n\n3. **使用或替换内建命令与外部命令**\n```bash\n## type 可查看命令属于哪种,builtin属于内建命令\nroot@localhost:~# type cd\ncd is a shell builtin\n\n## 可查看有哪些内建命令\nenable -a\n## 关闭shell内建命令\nenable -n $cmd\n## 忽略shell函数的ls,执行内建ls命令\ncommand ls\n```\n4. **交换STDERR和STDOUT**\n```bash\n./myscript 3>&1 1>&2 2>&3\n\n## 操作完成后关闭文件描述符3\n./myscript 3>&1 1>stdout.logfile 2>&3- | tee -a stderr.logfile\n```\n\n5. **避免意外覆盖文件**\n```bash\n## 告诉bash重定向输出时不要覆盖任何现有文件\nset -o noclobber\n## 关闭该选项\nset +o noclobber\n## 使用 >| 重定向输出。即便是设置了 noclobber，bash 也会忽略该选项，并覆盖文件\necho rewrite >| tmp.txt\n```\n> noclobber 选项仅针对 shell 重定向输出时的文件覆盖行为。它并不能阻止其他程序覆盖文件\n\n6. **将数据与脚本存放在一起**\n```bash\n$ cat ext\n#\n# 下面是here-document\n#\ngrep $1 <<EOF\nmike x.123\njoe  x.234\nsue  x.555\npete x.818\nsara x.822\nbill x.919\nEOF\n\n$ cat donors\n#\n# 里面的$100中的$1会被误解释为参数$1, 因此需要加''或\\EOF\n# \ngrep $1 <<'EOF'\n# 捐赠人及其捐赠额\npete $100\njoe  $200\nsam  $ 25\nbill $ 9\nEOF\n\n$ cat myscript.sh\n## 使用 <<-，然后就可以在每行的开头用制表符（仅限制表符！）缩进shell 脚本中的 here-document 部分\n...\n    grep $1 <<-'EOF'\n        lots of data\n        can go here\n        it's indented with tabs\n        to match the script's indenting\n        but the leading tabs are\n        discarded when read\n        EOF\n    ls\n...\n```\n7. **until, select**\n\n    until 循环用于在条件为假时重复执行一组命令。与 while 循环相反，它在每次迭代开始时检查条件。\n\n    select 循环用于创建一个简单的菜单选择。它会显示一个菜单并等待用户输入选择，然后根据选择执行相应的命令。\n    select 语句能够轻松地在 STDERR 上为用户生成编号列表。\n    用户所输入的选项编号保存在 $REPLY 中，选项值保存在 select 语句指定的变量中。\n\n8. **同时执行多个命令**\n```bash\n## 3 个命令的输出会在屏幕上交错出现\n## 最后一条命令不在后台运行\nls & date & cd \n## 三条命令都在后台运行\nls & date & cd &\n```\n\n9. **在shell脚本中嵌入文档**\n\n```bash\n:<<'DOC'\n    Write some notes.\nDOC\n```\n\n10. **导出变量**\n\n> bash 中一切都是字符串\n\n将希望传给其他脚本的变量导出\n要想查看所有已导出的变量，敲入命令 env（或者内建命令export -p）\n\n```bash\nexport MYVAR\nexport NAME=value\n```\nenv 生成的列表是 set 生成的列表的子集，因为并非所有变量都被导出了。\n\n11. **处理包含空格的参数**\n\n将所有可能包含文件名的命令参数全部加上引号。引用变量时，将其放入双引号中。\n```bash\n$ cat quoted.sh\n# note the quotes\nls -l \"${1}\"\n$\n$ ./quoted.sh \"Oh the Waste\"\n-rw-r--r--  1 smith users 28470 2007-01-11 19:22 Oh the Waste\n$\n```\n\n12. **获取默认值**\n\n如果指定参数（这里是 $1）不存在或为空，则将运算符之后的内容（本例为 /tmp）作为值。否则，使用已经设置好的参数值\n\n```bash\n## 如果值为路径直接写，或者加 \"\"双引号，用单引号会导致路径失效\n${1:-/tmp}\n```\n13. **设置默认值**\n\n首次引用 shell 变量时，如果该变量没有值，则使用赋值运算符为其赋值\n\n赋值运算符有一个重要的例外：不能对位置参数（如 $1或 $*）赋值\n\n```bash\ncd ${HOME:=/tmp}\n```\n> := 执行赋值操作，同时返回运算符右侧的值。:- 只做了前者一半的工作：返回值，但不赋值\n\n14. **使用空值作为有效的默认值**\n\n如果写成不带冒号的 ${HOME=/tmp}，那么赋值操作仅会在该变量不存在的情况下（从未设置或已明确删除）发生\n\n15. **不只使用字符串常量作为默认值**\n\n能出现在 shell 变量引用右侧的内容并不局限于字符串常量。\n\n```bash\ncd ${BASE:=\"$(pwd)\"}\n```\n\n16. **对不存在的参数输出错误消息**\n\n使用 set -u 命令，​“在变量替换时，将不存在的变量视为一种错误”​。\n\n```bash\n #!/usr/bin/env bash\n# 实例文件：check_unset_parms\n#\nUSAGE=\"usage: myscript scratchdir sourcefile conversion\"\nFILEDIR=${1:?\"Error. You must supply a scratch directory.\"}\nFILESRC=${2:?\"Error. You must supply a source file.\"}\nCVTTYPE=${3:?\"Error. ${USAGE}\"}\n \n ## 还可以在其中执行其他命令\n CVTTYPE=${3:?\"Error. $USAGE. $(rm $SCRATCHFILE)\"}\n```\n\n17. **变量字符串替换**\n\n```bash\n# 从字符串name的索引位置start开始，返回长度为number的子串\n# 如果子串为空格分隔的字符串，转为数组，比如 name=\"jack rose lucy\", name=(${name})\n# 然后用 ${name[@]:0:1}形式进行引用，不然会按字符串数量计数取子集\n# 如果不转换为数组，直接 ${name:0:1} 会输出 j\n${name:start:number}\n# 返回字符串长度\n${#name}\n## 从字符串起始位置开始，删除匹配pattern的最短子串\n${name#pattern}\n## 从字符串起始位置开始，删除匹配pattern的最长子串\n${name##pattern}\n## 从字符串结束位置开始，删除匹配pattern的最短子串\n${name%pattern}\n## 从字符串结束位置开始，删除匹配pattern的最长子串\n${name%%pattern}\n## 替换字符串中第一次出现的pattern\n${name/pattern/string}\n## 替换字符串中出现的所有pattern\n${name//pattern/string}\n\n## 变量不为空，替换为逗号\n${LIST:+,}\n```\n\n> FILE=${FULLPATHTOFILE##*/}\n> 等价于（结尾处不含/时）\n> basename $FULLPATHTOFILE\n\n18. **变量字符串大小写转换**\n\n```bash\n# 转换成小写\n${name,,}\n# 转换成大写\n${name^^}\n# 首字母转换成大写\n${name^}\n# 大写转成小写，小写转大写\n${name~~}\n# 变量内容会转换成小写字母\ndeclare -l name\n# 全部大写\ndeclare -u name\n# 仅首字母大写\ndeclare -c name\n```\n\n19. **简单算数**\n\n用 `$(( ))` 或 `let` 进行整数运算\n```bash\n##  $(( ))可以用 ** 进行幂运算\nCOUNT=$((COUNT + 5 + MAX * 2))\nlet COUNT+='5+MAX*2'\n\nlet COUNT+=5\n```\n\n20. **测试文件属性**\n\n```bash\n# 是否更新（检查文件的修改时间）​。现有文件要比不存在的文件“新”​。\ntest FILE1 -nt FILE2　　\n# 是否更旧。同样，不存在的文件要比现有文件“旧”​。\ntest FILE1 -ot FILE2　　\n# 具有相同设备和 inode 编号（即便由不同链接所指向，也视为相同的文件）​。\ntest FILE1 -ef FILE2　　\n# 测试文件大小是否不为空\ntest -s FILE\n```\n\n21. **用正则表达式匹配**\n\n> bash 3.0 或更高版本\n\n使用 =~ 运算符进行正则表达式匹配。只要能够匹配到某个字符串，就可以在 shell 数组变量 $BASH_REMATCH 中找到模式中的各个部分所匹配到的内容\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：trackmatch\n#\nfor CDTRACK in *\ndo\n    if [[ \"$CDTRACK\" =~ \"([[:alpha:][:blank:]]*)- ([[:digit:]]*) - (.*)$\" ]]\n    then\n        echo Track ${BASH_REMATCH[2]} is ${BASH_REMATCH[3]}\n        mv \"$CDTRACK\" \"Track${BASH_REMATCH[2]}\"\n    fi\ndone\n```\n\n22. **循环**\n```bash\n## while 循环\n$ svn status bcb\nM      bcb/amin.c\n?      bcb/dmin.c\n?      bcb/mdiv.tmp\nA      bcb/optrn.c\nM      bcb/optson.c\n?      bcb/prtbout.4161\n?      bcb/rideaslist.odt\n?      bcb/x.maxc\n\n## cut提取从第 8 列开始（一直到行尾）的字符串\nsvn status mysrc | grep '^?' | cut -c8- |\n  while read FN; do echo \"$FN\"; rm -rf \"$FN\"; done\n\n## 将输入传给两个变量，最后一个变量获得输入行中剩余的所有内容\nsvn status mysrc |\nwhile read TAG FN\ndo\n    if [[ $TAG == \\? ]]\n    then\n        echo $FN\n        rm -rf \"$FN\"\n    fi\ndone\n\n## for 循环\n## 双括号表明这是算术表达式，在其中引用变量时，不用加 $（但 $1 等位置参数除外）​，只要是 bash 中出现双括号的地方，均是如此\nfor (( expr1 ; expr2 ; expr3 )) ; do list ; done\n\nfor (( i=0, j=0 ; i+j < 10 ; i++, j++ ))\ndo\n    echo $((i*j))\ndone\n\n## seq 可以生成浮点值，参数依次是起始值、增量、结束值\nfor fp in $(seq 1.0 .01 1.1)\ndo\n    echo $fp; other stuff too\ndone\n\nseq 1.0 .01 1.1 |\nwhile read fp\ndo\n    echo $fp; other stuff too\ndone\n## $() 在子 shell 中执行命令\n\n## 在第一个例子的for 循环中，seq 必须先运行完毕，然后用全部的输出结果替换掉 $()。对于冗长的数值序列来说，这种方法的时间开销和内存开销都不小。\n## 在第二个例子中，seq 作为单独的命令运行，通过管道将其输出传入 while 循环，后者读取其中的每一行并做相应处理，seq 命令是与 while 并行运行的\n```","source":"_posts/shell-action.md","raw":"---\ntitle: Shell 实用技巧（一）\ndate: 2024-08-06 20:06:47\ntags: linux\n---\n# Shell 实用技巧\n1. **保存多个命令的输出**\n    - 使用`{}`将命令组合在一起，然后重定向\n        - 花括号实际上是保留字，两侧必须有空白字符，闭合括号前面的命令的分号不能少\n    - 使用`()`将命令放入子shell重定向输出\n\n    用子shell的方式不会改变当前shell的环境，比如下面的命令组包含`cd ..`，在用花括号的方式中会切换当前路径，而子shell方式中不会切换当前shell的路径，所有的命令都在子shell当中执行，不影响当前shell环境。\n\n    ```bash\n    ## 可以用{} or ()\n    { ls; cd ..; pwd; ls; } > /tmp/all.out\n    (ls; cd ..; pwd; ls) > /tmp/all.out\n\n    test $result -eq 1 && { echo \"Result\" is 1; exit 0; } \\\n        || { echo \"Run Away!\"; exit 120; }\n    ```\n\n2. **跳过文件标题**\n```bash\n## 显示后十行\ntail -n 10\ntail -10 \n## 跳过第一行, 可用于一些跳过标题的情况\ntail -n +2\n```\n\n3. **使用或替换内建命令与外部命令**\n```bash\n## type 可查看命令属于哪种,builtin属于内建命令\nroot@localhost:~# type cd\ncd is a shell builtin\n\n## 可查看有哪些内建命令\nenable -a\n## 关闭shell内建命令\nenable -n $cmd\n## 忽略shell函数的ls,执行内建ls命令\ncommand ls\n```\n4. **交换STDERR和STDOUT**\n```bash\n./myscript 3>&1 1>&2 2>&3\n\n## 操作完成后关闭文件描述符3\n./myscript 3>&1 1>stdout.logfile 2>&3- | tee -a stderr.logfile\n```\n\n5. **避免意外覆盖文件**\n```bash\n## 告诉bash重定向输出时不要覆盖任何现有文件\nset -o noclobber\n## 关闭该选项\nset +o noclobber\n## 使用 >| 重定向输出。即便是设置了 noclobber，bash 也会忽略该选项，并覆盖文件\necho rewrite >| tmp.txt\n```\n> noclobber 选项仅针对 shell 重定向输出时的文件覆盖行为。它并不能阻止其他程序覆盖文件\n\n6. **将数据与脚本存放在一起**\n```bash\n$ cat ext\n#\n# 下面是here-document\n#\ngrep $1 <<EOF\nmike x.123\njoe  x.234\nsue  x.555\npete x.818\nsara x.822\nbill x.919\nEOF\n\n$ cat donors\n#\n# 里面的$100中的$1会被误解释为参数$1, 因此需要加''或\\EOF\n# \ngrep $1 <<'EOF'\n# 捐赠人及其捐赠额\npete $100\njoe  $200\nsam  $ 25\nbill $ 9\nEOF\n\n$ cat myscript.sh\n## 使用 <<-，然后就可以在每行的开头用制表符（仅限制表符！）缩进shell 脚本中的 here-document 部分\n...\n    grep $1 <<-'EOF'\n        lots of data\n        can go here\n        it's indented with tabs\n        to match the script's indenting\n        but the leading tabs are\n        discarded when read\n        EOF\n    ls\n...\n```\n7. **until, select**\n\n    until 循环用于在条件为假时重复执行一组命令。与 while 循环相反，它在每次迭代开始时检查条件。\n\n    select 循环用于创建一个简单的菜单选择。它会显示一个菜单并等待用户输入选择，然后根据选择执行相应的命令。\n    select 语句能够轻松地在 STDERR 上为用户生成编号列表。\n    用户所输入的选项编号保存在 $REPLY 中，选项值保存在 select 语句指定的变量中。\n\n8. **同时执行多个命令**\n```bash\n## 3 个命令的输出会在屏幕上交错出现\n## 最后一条命令不在后台运行\nls & date & cd \n## 三条命令都在后台运行\nls & date & cd &\n```\n\n9. **在shell脚本中嵌入文档**\n\n```bash\n:<<'DOC'\n    Write some notes.\nDOC\n```\n\n10. **导出变量**\n\n> bash 中一切都是字符串\n\n将希望传给其他脚本的变量导出\n要想查看所有已导出的变量，敲入命令 env（或者内建命令export -p）\n\n```bash\nexport MYVAR\nexport NAME=value\n```\nenv 生成的列表是 set 生成的列表的子集，因为并非所有变量都被导出了。\n\n11. **处理包含空格的参数**\n\n将所有可能包含文件名的命令参数全部加上引号。引用变量时，将其放入双引号中。\n```bash\n$ cat quoted.sh\n# note the quotes\nls -l \"${1}\"\n$\n$ ./quoted.sh \"Oh the Waste\"\n-rw-r--r--  1 smith users 28470 2007-01-11 19:22 Oh the Waste\n$\n```\n\n12. **获取默认值**\n\n如果指定参数（这里是 $1）不存在或为空，则将运算符之后的内容（本例为 /tmp）作为值。否则，使用已经设置好的参数值\n\n```bash\n## 如果值为路径直接写，或者加 \"\"双引号，用单引号会导致路径失效\n${1:-/tmp}\n```\n13. **设置默认值**\n\n首次引用 shell 变量时，如果该变量没有值，则使用赋值运算符为其赋值\n\n赋值运算符有一个重要的例外：不能对位置参数（如 $1或 $*）赋值\n\n```bash\ncd ${HOME:=/tmp}\n```\n> := 执行赋值操作，同时返回运算符右侧的值。:- 只做了前者一半的工作：返回值，但不赋值\n\n14. **使用空值作为有效的默认值**\n\n如果写成不带冒号的 ${HOME=/tmp}，那么赋值操作仅会在该变量不存在的情况下（从未设置或已明确删除）发生\n\n15. **不只使用字符串常量作为默认值**\n\n能出现在 shell 变量引用右侧的内容并不局限于字符串常量。\n\n```bash\ncd ${BASE:=\"$(pwd)\"}\n```\n\n16. **对不存在的参数输出错误消息**\n\n使用 set -u 命令，​“在变量替换时，将不存在的变量视为一种错误”​。\n\n```bash\n #!/usr/bin/env bash\n# 实例文件：check_unset_parms\n#\nUSAGE=\"usage: myscript scratchdir sourcefile conversion\"\nFILEDIR=${1:?\"Error. You must supply a scratch directory.\"}\nFILESRC=${2:?\"Error. You must supply a source file.\"}\nCVTTYPE=${3:?\"Error. ${USAGE}\"}\n \n ## 还可以在其中执行其他命令\n CVTTYPE=${3:?\"Error. $USAGE. $(rm $SCRATCHFILE)\"}\n```\n\n17. **变量字符串替换**\n\n```bash\n# 从字符串name的索引位置start开始，返回长度为number的子串\n# 如果子串为空格分隔的字符串，转为数组，比如 name=\"jack rose lucy\", name=(${name})\n# 然后用 ${name[@]:0:1}形式进行引用，不然会按字符串数量计数取子集\n# 如果不转换为数组，直接 ${name:0:1} 会输出 j\n${name:start:number}\n# 返回字符串长度\n${#name}\n## 从字符串起始位置开始，删除匹配pattern的最短子串\n${name#pattern}\n## 从字符串起始位置开始，删除匹配pattern的最长子串\n${name##pattern}\n## 从字符串结束位置开始，删除匹配pattern的最短子串\n${name%pattern}\n## 从字符串结束位置开始，删除匹配pattern的最长子串\n${name%%pattern}\n## 替换字符串中第一次出现的pattern\n${name/pattern/string}\n## 替换字符串中出现的所有pattern\n${name//pattern/string}\n\n## 变量不为空，替换为逗号\n${LIST:+,}\n```\n\n> FILE=${FULLPATHTOFILE##*/}\n> 等价于（结尾处不含/时）\n> basename $FULLPATHTOFILE\n\n18. **变量字符串大小写转换**\n\n```bash\n# 转换成小写\n${name,,}\n# 转换成大写\n${name^^}\n# 首字母转换成大写\n${name^}\n# 大写转成小写，小写转大写\n${name~~}\n# 变量内容会转换成小写字母\ndeclare -l name\n# 全部大写\ndeclare -u name\n# 仅首字母大写\ndeclare -c name\n```\n\n19. **简单算数**\n\n用 `$(( ))` 或 `let` 进行整数运算\n```bash\n##  $(( ))可以用 ** 进行幂运算\nCOUNT=$((COUNT + 5 + MAX * 2))\nlet COUNT+='5+MAX*2'\n\nlet COUNT+=5\n```\n\n20. **测试文件属性**\n\n```bash\n# 是否更新（检查文件的修改时间）​。现有文件要比不存在的文件“新”​。\ntest FILE1 -nt FILE2　　\n# 是否更旧。同样，不存在的文件要比现有文件“旧”​。\ntest FILE1 -ot FILE2　　\n# 具有相同设备和 inode 编号（即便由不同链接所指向，也视为相同的文件）​。\ntest FILE1 -ef FILE2　　\n# 测试文件大小是否不为空\ntest -s FILE\n```\n\n21. **用正则表达式匹配**\n\n> bash 3.0 或更高版本\n\n使用 =~ 运算符进行正则表达式匹配。只要能够匹配到某个字符串，就可以在 shell 数组变量 $BASH_REMATCH 中找到模式中的各个部分所匹配到的内容\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：trackmatch\n#\nfor CDTRACK in *\ndo\n    if [[ \"$CDTRACK\" =~ \"([[:alpha:][:blank:]]*)- ([[:digit:]]*) - (.*)$\" ]]\n    then\n        echo Track ${BASH_REMATCH[2]} is ${BASH_REMATCH[3]}\n        mv \"$CDTRACK\" \"Track${BASH_REMATCH[2]}\"\n    fi\ndone\n```\n\n22. **循环**\n```bash\n## while 循环\n$ svn status bcb\nM      bcb/amin.c\n?      bcb/dmin.c\n?      bcb/mdiv.tmp\nA      bcb/optrn.c\nM      bcb/optson.c\n?      bcb/prtbout.4161\n?      bcb/rideaslist.odt\n?      bcb/x.maxc\n\n## cut提取从第 8 列开始（一直到行尾）的字符串\nsvn status mysrc | grep '^?' | cut -c8- |\n  while read FN; do echo \"$FN\"; rm -rf \"$FN\"; done\n\n## 将输入传给两个变量，最后一个变量获得输入行中剩余的所有内容\nsvn status mysrc |\nwhile read TAG FN\ndo\n    if [[ $TAG == \\? ]]\n    then\n        echo $FN\n        rm -rf \"$FN\"\n    fi\ndone\n\n## for 循环\n## 双括号表明这是算术表达式，在其中引用变量时，不用加 $（但 $1 等位置参数除外）​，只要是 bash 中出现双括号的地方，均是如此\nfor (( expr1 ; expr2 ; expr3 )) ; do list ; done\n\nfor (( i=0, j=0 ; i+j < 10 ; i++, j++ ))\ndo\n    echo $((i*j))\ndone\n\n## seq 可以生成浮点值，参数依次是起始值、增量、结束值\nfor fp in $(seq 1.0 .01 1.1)\ndo\n    echo $fp; other stuff too\ndone\n\nseq 1.0 .01 1.1 |\nwhile read fp\ndo\n    echo $fp; other stuff too\ndone\n## $() 在子 shell 中执行命令\n\n## 在第一个例子的for 循环中，seq 必须先运行完毕，然后用全部的输出结果替换掉 $()。对于冗长的数值序列来说，这种方法的时间开销和内存开销都不小。\n## 在第二个例子中，seq 作为单独的命令运行，通过管道将其输出传入 while 循环，后者读取其中的每一行并做相应处理，seq 命令是与 while 并行运行的\n```","slug":"shell-action","published":1,"updated":"2024-08-12T15:57:52.667Z","_id":"clzkkh3ys000juhuqh0ddd01i","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"Shell-实用技巧\"><a href=\"#Shell-实用技巧\" class=\"headerlink\" title=\"Shell 实用技巧\"></a>Shell 实用技巧</h1><ol>\n<li><p><strong>保存多个命令的输出</strong></p>\n<ul>\n<li>使用<code>&#123;&#125;</code>将命令组合在一起，然后重定向<ul>\n<li>花括号实际上是保留字，两侧必须有空白字符，闭合括号前面的命令的分号不能少</li>\n</ul>\n</li>\n<li>使用<code>()</code>将命令放入子shell重定向输出</li>\n</ul>\n<p> 用子shell的方式不会改变当前shell的环境，比如下面的命令组包含<code>cd ..</code>，在用花括号的方式中会切换当前路径，而子shell方式中不会切换当前shell的路径，所有的命令都在子shell当中执行，不影响当前shell环境。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可以用&#123;&#125; or ()</span><br>&#123; <span class=\"hljs-built_in\">ls</span>; <span class=\"hljs-built_in\">cd</span> ..; <span class=\"hljs-built_in\">pwd</span>; <span class=\"hljs-built_in\">ls</span>; &#125; &gt; /tmp/all.out<br>(<span class=\"hljs-built_in\">ls</span>; <span class=\"hljs-built_in\">cd</span> ..; <span class=\"hljs-built_in\">pwd</span>; <span class=\"hljs-built_in\">ls</span>) &gt; /tmp/all.out<br><br><span class=\"hljs-built_in\">test</span> <span class=\"hljs-variable\">$result</span> -eq 1 &amp;&amp; &#123; <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Result&quot;</span> is 1; <span class=\"hljs-built_in\">exit</span> 0; &#125; \\<br>    || &#123; <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Run Away!&quot;</span>; <span class=\"hljs-built_in\">exit</span> 120; &#125;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>跳过文件标题</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 显示后十行</span><br><span class=\"hljs-built_in\">tail</span> -n 10<br><span class=\"hljs-built_in\">tail</span> -10 <br><span class=\"hljs-comment\">## 跳过第一行, 可用于一些跳过标题的情况</span><br><span class=\"hljs-built_in\">tail</span> -n +2<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>使用或替换内建命令与外部命令</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## type 可查看命令属于哪种,builtin属于内建命令</span><br>root@localhost:~# <span class=\"hljs-built_in\">type</span> <span class=\"hljs-built_in\">cd</span><br><span class=\"hljs-built_in\">cd</span> is a shell <span class=\"hljs-built_in\">builtin</span><br><br><span class=\"hljs-comment\">## 可查看有哪些内建命令</span><br><span class=\"hljs-built_in\">enable</span> -a<br><span class=\"hljs-comment\">## 关闭shell内建命令</span><br><span class=\"hljs-built_in\">enable</span> -n <span class=\"hljs-variable\">$cmd</span><br><span class=\"hljs-comment\">## 忽略shell函数的ls,执行内建ls命令</span><br><span class=\"hljs-built_in\">command</span> <span class=\"hljs-built_in\">ls</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>交换STDERR和STDOUT</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./myscript 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3<br><br><span class=\"hljs-comment\">## 操作完成后关闭文件描述符3</span><br>./myscript 3&gt;&amp;1 1&gt;stdout.logfile 2&gt;&amp;3- | <span class=\"hljs-built_in\">tee</span> -a stderr.logfile<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>避免意外覆盖文件</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 告诉bash重定向输出时不要覆盖任何现有文件</span><br><span class=\"hljs-built_in\">set</span> -o noclobber<br><span class=\"hljs-comment\">## 关闭该选项</span><br><span class=\"hljs-built_in\">set</span> +o noclobber<br><span class=\"hljs-comment\">## 使用 &gt;| 重定向输出。即便是设置了 noclobber，bash 也会忽略该选项，并覆盖文件</span><br><span class=\"hljs-built_in\">echo</span> rewrite &gt;| tmp.txt<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>noclobber 选项仅针对 shell 重定向输出时的文件覆盖行为。它并不能阻止其他程序覆盖文件</p>\n</blockquote>\n</li>\n<li><p><strong>将数据与脚本存放在一起</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> ext<br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 下面是here-document</span><br><span class=\"hljs-comment\">#</span><br>grep <span class=\"hljs-variable\">$1</span> &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">mike x.123</span><br><span class=\"hljs-string\">joe  x.234</span><br><span class=\"hljs-string\">sue  x.555</span><br><span class=\"hljs-string\">pete x.818</span><br><span class=\"hljs-string\">sara x.822</span><br><span class=\"hljs-string\">bill x.919</span><br><span class=\"hljs-string\">EOF</span><br><br>$ <span class=\"hljs-built_in\">cat</span> donors<br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 里面的$100中的$1会被误解释为参数$1, 因此需要加&#x27;&#x27;或\\EOF</span><br><span class=\"hljs-comment\"># </span><br>grep <span class=\"hljs-variable\">$1</span> &lt;&lt;<span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># 捐赠人及其捐赠额</span><br>pete <span class=\"hljs-variable\">$100</span><br>joe  <span class=\"hljs-variable\">$200</span><br>sam  $ 25<br>bill $ 9<br>EOF<br><br>$ <span class=\"hljs-built_in\">cat</span> myscript.sh<br><span class=\"hljs-comment\">## 使用 &lt;&lt;-，然后就可以在每行的开头用制表符（仅限制表符！）缩进shell 脚本中的 here-document 部分</span><br>...<br>    grep <span class=\"hljs-variable\">$1</span> &lt;&lt;-<span class=\"hljs-string\">&#x27;EOF&#x27;</span><br>        lots of data<br>        can go here<br>        it<span class=\"hljs-string\">&#x27;s indented with tabs</span><br><span class=\"hljs-string\">        to match the script&#x27;</span>s indenting<br>        but the leading tabs are<br>        discarded when <span class=\"hljs-built_in\">read</span><br>        EOF<br>    <span class=\"hljs-built_in\">ls</span><br>...<br></code></pre></td></tr></table></figure></li>\n<li><p><strong>until, select</strong></p>\n<p> until 循环用于在条件为假时重复执行一组命令。与 while 循环相反，它在每次迭代开始时检查条件。</p>\n<p> select 循环用于创建一个简单的菜单选择。它会显示一个菜单并等待用户输入选择，然后根据选择执行相应的命令。<br> select 语句能够轻松地在 STDERR 上为用户生成编号列表。<br> 用户所输入的选项编号保存在 $REPLY 中，选项值保存在 select 语句指定的变量中。</p>\n</li>\n<li><p><strong>同时执行多个命令</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 3 个命令的输出会在屏幕上交错出现</span><br><span class=\"hljs-comment\">## 最后一条命令不在后台运行</span><br><span class=\"hljs-built_in\">ls</span> &amp; <span class=\"hljs-built_in\">date</span> &amp; <span class=\"hljs-built_in\">cd</span> <br><span class=\"hljs-comment\">## 三条命令都在后台运行</span><br><span class=\"hljs-built_in\">ls</span> &amp; <span class=\"hljs-built_in\">date</span> &amp; <span class=\"hljs-built_in\">cd</span> &amp;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在shell脚本中嵌入文档</strong></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">:&lt;&lt;<span class=\"hljs-string\">&#x27;DOC&#x27;</span><br>    Write some notes.<br>DOC<br></code></pre></td></tr></table></figure>\n\n<ol start=\"10\">\n<li><strong>导出变量</strong></li>\n</ol>\n<blockquote>\n<p>bash 中一切都是字符串</p>\n</blockquote>\n<p>将希望传给其他脚本的变量导出<br>要想查看所有已导出的变量，敲入命令 env（或者内建命令export -p）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">export</span> MYVAR<br><span class=\"hljs-built_in\">export</span> NAME=value<br></code></pre></td></tr></table></figure>\n<p>env 生成的列表是 set 生成的列表的子集，因为并非所有变量都被导出了。</p>\n<ol start=\"11\">\n<li><strong>处理包含空格的参数</strong></li>\n</ol>\n<p>将所有可能包含文件名的命令参数全部加上引号。引用变量时，将其放入双引号中。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> quoted.sh<br><span class=\"hljs-comment\"># note the quotes</span><br><span class=\"hljs-built_in\">ls</span> -l <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;1&#125;</span>&quot;</span><br>$<br>$ ./quoted.sh <span class=\"hljs-string\">&quot;Oh the Waste&quot;</span><br>-rw-r--r--  1 smith <span class=\"hljs-built_in\">users</span> 28470 2007-01-11 19:22 Oh the Waste<br>$<br></code></pre></td></tr></table></figure>\n\n<ol start=\"12\">\n<li><strong>获取默认值</strong></li>\n</ol>\n<p>如果指定参数（这里是 $1）不存在或为空，则将运算符之后的内容（本例为 &#x2F;tmp）作为值。否则，使用已经设置好的参数值</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 如果值为路径直接写，或者加 &quot;&quot;双引号，用单引号会导致路径失效</span><br><span class=\"hljs-variable\">$&#123;1:-/tmp&#125;</span><br></code></pre></td></tr></table></figure>\n<ol start=\"13\">\n<li><strong>设置默认值</strong></li>\n</ol>\n<p>首次引用 shell 变量时，如果该变量没有值，则使用赋值运算符为其赋值</p>\n<p>赋值运算符有一个重要的例外：不能对位置参数（如 $1或 $*）赋值</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$&#123;HOME:=/tmp&#125;</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>:&#x3D; 执行赋值操作，同时返回运算符右侧的值。:- 只做了前者一半的工作：返回值，但不赋值</p>\n</blockquote>\n<ol start=\"14\">\n<li><strong>使用空值作为有效的默认值</strong></li>\n</ol>\n<p>如果写成不带冒号的 ${HOME&#x3D;&#x2F;tmp}，那么赋值操作仅会在该变量不存在的情况下（从未设置或已明确删除）发生</p>\n<ol start=\"15\">\n<li><strong>不只使用字符串常量作为默认值</strong></li>\n</ol>\n<p>能出现在 shell 变量引用右侧的内容并不局限于字符串常量。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$&#123;BASE:=&quot;$(pwd)&quot;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"16\">\n<li><strong>对不存在的参数输出错误消息</strong></li>\n</ol>\n<p>使用 set -u 命令，​“在变量替换时，将不存在的变量视为一种错误”​。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"> <span class=\"hljs-comment\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：check_unset_parms</span><br><span class=\"hljs-comment\">#</span><br>USAGE=<span class=\"hljs-string\">&quot;usage: myscript scratchdir sourcefile conversion&quot;</span><br>FILEDIR=<span class=\"hljs-variable\">$&#123;1:?&quot;Error. You must supply a scratch directory.&quot;&#125;</span><br>FILESRC=<span class=\"hljs-variable\">$&#123;2:?&quot;Error. You must supply a source file.&quot;&#125;</span><br>CVTTYPE=<span class=\"hljs-variable\">$&#123;3:?&quot;Error. <span class=\"hljs-variable\">$&#123;USAGE&#125;</span>&quot;&#125;</span><br> <br> <span class=\"hljs-comment\">## 还可以在其中执行其他命令</span><br> CVTTYPE=<span class=\"hljs-variable\">$&#123;3:?&quot;Error. $USAGE. $(rm $SCRATCHFILE)&quot;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"17\">\n<li><strong>变量字符串替换</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 从字符串name的索引位置start开始，返回长度为number的子串</span><br><span class=\"hljs-comment\"># 如果子串为空格分隔的字符串，转为数组，比如 name=&quot;jack rose lucy&quot;, name=($&#123;name&#125;)</span><br><span class=\"hljs-comment\"># 然后用 $&#123;name[@]:0:1&#125;形式进行引用，不然会按字符串数量计数取子集</span><br><span class=\"hljs-comment\"># 如果不转换为数组，直接 $&#123;name:0:1&#125; 会输出 j</span><br><span class=\"hljs-variable\">$&#123;name:start:number&#125;</span><br><span class=\"hljs-comment\"># 返回字符串长度</span><br><span class=\"hljs-variable\">$&#123;#name&#125;</span><br><span class=\"hljs-comment\">## 从字符串起始位置开始，删除匹配pattern的最短子串</span><br><span class=\"hljs-variable\">$&#123;name#pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串起始位置开始，删除匹配pattern的最长子串</span><br><span class=\"hljs-variable\">$&#123;name##pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串结束位置开始，删除匹配pattern的最短子串</span><br><span class=\"hljs-variable\">$&#123;name%pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串结束位置开始，删除匹配pattern的最长子串</span><br><span class=\"hljs-variable\">$&#123;name%%pattern&#125;</span><br><span class=\"hljs-comment\">## 替换字符串中第一次出现的pattern</span><br><span class=\"hljs-variable\">$&#123;name/pattern/string&#125;</span><br><span class=\"hljs-comment\">## 替换字符串中出现的所有pattern</span><br><span class=\"hljs-variable\">$&#123;name//pattern/string&#125;</span><br><br><span class=\"hljs-comment\">## 变量不为空，替换为逗号</span><br><span class=\"hljs-variable\">$&#123;LIST:+,&#125;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>FILE&#x3D;${FULLPATHTOFILE##*&#x2F;}<br>等价于（结尾处不含&#x2F;时）<br>basename $FULLPATHTOFILE</p>\n</blockquote>\n<ol start=\"18\">\n<li><strong>变量字符串大小写转换</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 转换成小写</span><br><span class=\"hljs-variable\">$&#123;name,,&#125;</span><br><span class=\"hljs-comment\"># 转换成大写</span><br><span class=\"hljs-variable\">$&#123;name^^&#125;</span><br><span class=\"hljs-comment\"># 首字母转换成大写</span><br><span class=\"hljs-variable\">$&#123;name^&#125;</span><br><span class=\"hljs-comment\"># 大写转成小写，小写转大写</span><br><span class=\"hljs-variable\">$&#123;name~~&#125;</span><br><span class=\"hljs-comment\"># 变量内容会转换成小写字母</span><br><span class=\"hljs-built_in\">declare</span> -l name<br><span class=\"hljs-comment\"># 全部大写</span><br><span class=\"hljs-built_in\">declare</span> -u name<br><span class=\"hljs-comment\"># 仅首字母大写</span><br><span class=\"hljs-built_in\">declare</span> -c name<br></code></pre></td></tr></table></figure>\n\n<ol start=\"19\">\n<li><strong>简单算数</strong></li>\n</ol>\n<p>用 <code>$(( ))</code> 或 <code>let</code> 进行整数运算</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">##  $(( ))可以用 ** 进行幂运算</span><br>COUNT=$((COUNT + <span class=\"hljs-number\">5</span> + MAX * <span class=\"hljs-number\">2</span>))<br><span class=\"hljs-built_in\">let</span> COUNT+=<span class=\"hljs-string\">&#x27;5+MAX*2&#x27;</span><br><br><span class=\"hljs-built_in\">let</span> COUNT+=5<br></code></pre></td></tr></table></figure>\n\n<ol start=\"20\">\n<li><strong>测试文件属性</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 是否更新（检查文件的修改时间）​。现有文件要比不存在的文件“新”​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -nt FILE2　　<br><span class=\"hljs-comment\"># 是否更旧。同样，不存在的文件要比现有文件“旧”​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -ot FILE2　　<br><span class=\"hljs-comment\"># 具有相同设备和 inode 编号（即便由不同链接所指向，也视为相同的文件）​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -ef FILE2　　<br><span class=\"hljs-comment\"># 测试文件大小是否不为空</span><br><span class=\"hljs-built_in\">test</span> -s FILE<br></code></pre></td></tr></table></figure>\n\n<ol start=\"21\">\n<li><strong>用正则表达式匹配</strong></li>\n</ol>\n<blockquote>\n<p>bash 3.0 或更高版本</p>\n</blockquote>\n<p>使用 &#x3D;~ 运算符进行正则表达式匹配。只要能够匹配到某个字符串，就可以在 shell 数组变量 $BASH_REMATCH 中找到模式中的各个部分所匹配到的内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：trackmatch</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-keyword\">for</span> CDTRACK <span class=\"hljs-keyword\">in</span> *<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [[ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$CDTRACK</span>&quot;</span> =~ <span class=\"hljs-string\">&quot;([[:alpha:][:blank:]]*)- ([[:digit:]]*) - (.*)$&quot;</span> ]]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> Track <span class=\"hljs-variable\">$&#123;BASH_REMATCH[2]&#125;</span> is <span class=\"hljs-variable\">$&#123;BASH_REMATCH[3]&#125;</span><br>        <span class=\"hljs-built_in\">mv</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$CDTRACK</span>&quot;</span> <span class=\"hljs-string\">&quot;Track<span class=\"hljs-variable\">$&#123;BASH_REMATCH[2]&#125;</span>&quot;</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"22\">\n<li><strong>循环</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## while 循环</span><br>$ svn status bcb<br>M      bcb/amin.c<br>?      bcb/dmin.c<br>?      bcb/mdiv.tmp<br>A      bcb/optrn.c<br>M      bcb/optson.c<br>?      bcb/prtbout.4161<br>?      bcb/rideaslist.odt<br>?      bcb/x.maxc<br><br><span class=\"hljs-comment\">## cut提取从第 8 列开始（一直到行尾）的字符串</span><br>svn status mysrc | grep <span class=\"hljs-string\">&#x27;^?&#x27;</span> | <span class=\"hljs-built_in\">cut</span> -c8- |<br>  <span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> FN; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span>; <span class=\"hljs-built_in\">rm</span> -rf <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span>; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## 将输入传给两个变量，最后一个变量获得输入行中剩余的所有内容</span><br>svn status mysrc |<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> TAG FN<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [[ <span class=\"hljs-variable\">$TAG</span> == \\? ]]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$FN</span><br>        <span class=\"hljs-built_in\">rm</span> -rf <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## for 循环</span><br><span class=\"hljs-comment\">## 双括号表明这是算术表达式，在其中引用变量时，不用加 $（但 $1 等位置参数除外）​，只要是 bash 中出现双括号的地方，均是如此</span><br><span class=\"hljs-keyword\">for</span> (( expr1 ; expr2 ; expr3 )) ; <span class=\"hljs-keyword\">do</span> list ; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-keyword\">for</span> (( i=<span class=\"hljs-number\">0</span>, j=<span class=\"hljs-number\">0</span> ; i+j &lt; <span class=\"hljs-number\">10</span> ; i++, j++ ))<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> $((i*j))<br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## seq 可以生成浮点值，参数依次是起始值、增量、结束值</span><br><span class=\"hljs-keyword\">for</span> fp <span class=\"hljs-keyword\">in</span> $(<span class=\"hljs-built_in\">seq</span> 1.0 .01 1.1)<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$fp</span>; other stuff too<br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-built_in\">seq</span> 1.0 .01 1.1 |<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> fp<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$fp</span>; other stuff too<br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-comment\">## $() 在子 shell 中执行命令</span><br><br><span class=\"hljs-comment\">## 在第一个例子的for 循环中，seq 必须先运行完毕，然后用全部的输出结果替换掉 $()。对于冗长的数值序列来说，这种方法的时间开销和内存开销都不小。</span><br><span class=\"hljs-comment\">## 在第二个例子中，seq 作为单独的命令运行，通过管道将其输出传入 while 循环，后者读取其中的每一行并做相应处理，seq 命令是与 while 并行运行的</span><br></code></pre></td></tr></table></figure></li>\n</ol>\n","excerpt":"","more":"<h1 id=\"Shell-实用技巧\"><a href=\"#Shell-实用技巧\" class=\"headerlink\" title=\"Shell 实用技巧\"></a>Shell 实用技巧</h1><ol>\n<li><p><strong>保存多个命令的输出</strong></p>\n<ul>\n<li>使用<code>&#123;&#125;</code>将命令组合在一起，然后重定向<ul>\n<li>花括号实际上是保留字，两侧必须有空白字符，闭合括号前面的命令的分号不能少</li>\n</ul>\n</li>\n<li>使用<code>()</code>将命令放入子shell重定向输出</li>\n</ul>\n<p> 用子shell的方式不会改变当前shell的环境，比如下面的命令组包含<code>cd ..</code>，在用花括号的方式中会切换当前路径，而子shell方式中不会切换当前shell的路径，所有的命令都在子shell当中执行，不影响当前shell环境。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 可以用&#123;&#125; or ()</span><br>&#123; <span class=\"hljs-built_in\">ls</span>; <span class=\"hljs-built_in\">cd</span> ..; <span class=\"hljs-built_in\">pwd</span>; <span class=\"hljs-built_in\">ls</span>; &#125; &gt; /tmp/all.out<br>(<span class=\"hljs-built_in\">ls</span>; <span class=\"hljs-built_in\">cd</span> ..; <span class=\"hljs-built_in\">pwd</span>; <span class=\"hljs-built_in\">ls</span>) &gt; /tmp/all.out<br><br><span class=\"hljs-built_in\">test</span> <span class=\"hljs-variable\">$result</span> -eq 1 &amp;&amp; &#123; <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Result&quot;</span> is 1; <span class=\"hljs-built_in\">exit</span> 0; &#125; \\<br>    || &#123; <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Run Away!&quot;</span>; <span class=\"hljs-built_in\">exit</span> 120; &#125;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>跳过文件标题</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 显示后十行</span><br><span class=\"hljs-built_in\">tail</span> -n 10<br><span class=\"hljs-built_in\">tail</span> -10 <br><span class=\"hljs-comment\">## 跳过第一行, 可用于一些跳过标题的情况</span><br><span class=\"hljs-built_in\">tail</span> -n +2<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>使用或替换内建命令与外部命令</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## type 可查看命令属于哪种,builtin属于内建命令</span><br>root@localhost:~# <span class=\"hljs-built_in\">type</span> <span class=\"hljs-built_in\">cd</span><br><span class=\"hljs-built_in\">cd</span> is a shell <span class=\"hljs-built_in\">builtin</span><br><br><span class=\"hljs-comment\">## 可查看有哪些内建命令</span><br><span class=\"hljs-built_in\">enable</span> -a<br><span class=\"hljs-comment\">## 关闭shell内建命令</span><br><span class=\"hljs-built_in\">enable</span> -n <span class=\"hljs-variable\">$cmd</span><br><span class=\"hljs-comment\">## 忽略shell函数的ls,执行内建ls命令</span><br><span class=\"hljs-built_in\">command</span> <span class=\"hljs-built_in\">ls</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>交换STDERR和STDOUT</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">./myscript 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3<br><br><span class=\"hljs-comment\">## 操作完成后关闭文件描述符3</span><br>./myscript 3&gt;&amp;1 1&gt;stdout.logfile 2&gt;&amp;3- | <span class=\"hljs-built_in\">tee</span> -a stderr.logfile<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>避免意外覆盖文件</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 告诉bash重定向输出时不要覆盖任何现有文件</span><br><span class=\"hljs-built_in\">set</span> -o noclobber<br><span class=\"hljs-comment\">## 关闭该选项</span><br><span class=\"hljs-built_in\">set</span> +o noclobber<br><span class=\"hljs-comment\">## 使用 &gt;| 重定向输出。即便是设置了 noclobber，bash 也会忽略该选项，并覆盖文件</span><br><span class=\"hljs-built_in\">echo</span> rewrite &gt;| tmp.txt<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>noclobber 选项仅针对 shell 重定向输出时的文件覆盖行为。它并不能阻止其他程序覆盖文件</p>\n</blockquote>\n</li>\n<li><p><strong>将数据与脚本存放在一起</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> ext<br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 下面是here-document</span><br><span class=\"hljs-comment\">#</span><br>grep <span class=\"hljs-variable\">$1</span> &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">mike x.123</span><br><span class=\"hljs-string\">joe  x.234</span><br><span class=\"hljs-string\">sue  x.555</span><br><span class=\"hljs-string\">pete x.818</span><br><span class=\"hljs-string\">sara x.822</span><br><span class=\"hljs-string\">bill x.919</span><br><span class=\"hljs-string\">EOF</span><br><br>$ <span class=\"hljs-built_in\">cat</span> donors<br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 里面的$100中的$1会被误解释为参数$1, 因此需要加&#x27;&#x27;或\\EOF</span><br><span class=\"hljs-comment\"># </span><br>grep <span class=\"hljs-variable\">$1</span> &lt;&lt;<span class=\"hljs-string\">&#x27;EOF&#x27;</span><br><span class=\"hljs-comment\"># 捐赠人及其捐赠额</span><br>pete <span class=\"hljs-variable\">$100</span><br>joe  <span class=\"hljs-variable\">$200</span><br>sam  $ 25<br>bill $ 9<br>EOF<br><br>$ <span class=\"hljs-built_in\">cat</span> myscript.sh<br><span class=\"hljs-comment\">## 使用 &lt;&lt;-，然后就可以在每行的开头用制表符（仅限制表符！）缩进shell 脚本中的 here-document 部分</span><br>...<br>    grep <span class=\"hljs-variable\">$1</span> &lt;&lt;-<span class=\"hljs-string\">&#x27;EOF&#x27;</span><br>        lots of data<br>        can go here<br>        it<span class=\"hljs-string\">&#x27;s indented with tabs</span><br><span class=\"hljs-string\">        to match the script&#x27;</span>s indenting<br>        but the leading tabs are<br>        discarded when <span class=\"hljs-built_in\">read</span><br>        EOF<br>    <span class=\"hljs-built_in\">ls</span><br>...<br></code></pre></td></tr></table></figure></li>\n<li><p><strong>until, select</strong></p>\n<p> until 循环用于在条件为假时重复执行一组命令。与 while 循环相反，它在每次迭代开始时检查条件。</p>\n<p> select 循环用于创建一个简单的菜单选择。它会显示一个菜单并等待用户输入选择，然后根据选择执行相应的命令。<br> select 语句能够轻松地在 STDERR 上为用户生成编号列表。<br> 用户所输入的选项编号保存在 $REPLY 中，选项值保存在 select 语句指定的变量中。</p>\n</li>\n<li><p><strong>同时执行多个命令</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 3 个命令的输出会在屏幕上交错出现</span><br><span class=\"hljs-comment\">## 最后一条命令不在后台运行</span><br><span class=\"hljs-built_in\">ls</span> &amp; <span class=\"hljs-built_in\">date</span> &amp; <span class=\"hljs-built_in\">cd</span> <br><span class=\"hljs-comment\">## 三条命令都在后台运行</span><br><span class=\"hljs-built_in\">ls</span> &amp; <span class=\"hljs-built_in\">date</span> &amp; <span class=\"hljs-built_in\">cd</span> &amp;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在shell脚本中嵌入文档</strong></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">:&lt;&lt;<span class=\"hljs-string\">&#x27;DOC&#x27;</span><br>    Write some notes.<br>DOC<br></code></pre></td></tr></table></figure>\n\n<ol start=\"10\">\n<li><strong>导出变量</strong></li>\n</ol>\n<blockquote>\n<p>bash 中一切都是字符串</p>\n</blockquote>\n<p>将希望传给其他脚本的变量导出<br>要想查看所有已导出的变量，敲入命令 env（或者内建命令export -p）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">export</span> MYVAR<br><span class=\"hljs-built_in\">export</span> NAME=value<br></code></pre></td></tr></table></figure>\n<p>env 生成的列表是 set 生成的列表的子集，因为并非所有变量都被导出了。</p>\n<ol start=\"11\">\n<li><strong>处理包含空格的参数</strong></li>\n</ol>\n<p>将所有可能包含文件名的命令参数全部加上引号。引用变量时，将其放入双引号中。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> quoted.sh<br><span class=\"hljs-comment\"># note the quotes</span><br><span class=\"hljs-built_in\">ls</span> -l <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;1&#125;</span>&quot;</span><br>$<br>$ ./quoted.sh <span class=\"hljs-string\">&quot;Oh the Waste&quot;</span><br>-rw-r--r--  1 smith <span class=\"hljs-built_in\">users</span> 28470 2007-01-11 19:22 Oh the Waste<br>$<br></code></pre></td></tr></table></figure>\n\n<ol start=\"12\">\n<li><strong>获取默认值</strong></li>\n</ol>\n<p>如果指定参数（这里是 $1）不存在或为空，则将运算符之后的内容（本例为 &#x2F;tmp）作为值。否则，使用已经设置好的参数值</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 如果值为路径直接写，或者加 &quot;&quot;双引号，用单引号会导致路径失效</span><br><span class=\"hljs-variable\">$&#123;1:-/tmp&#125;</span><br></code></pre></td></tr></table></figure>\n<ol start=\"13\">\n<li><strong>设置默认值</strong></li>\n</ol>\n<p>首次引用 shell 变量时，如果该变量没有值，则使用赋值运算符为其赋值</p>\n<p>赋值运算符有一个重要的例外：不能对位置参数（如 $1或 $*）赋值</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$&#123;HOME:=/tmp&#125;</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>:&#x3D; 执行赋值操作，同时返回运算符右侧的值。:- 只做了前者一半的工作：返回值，但不赋值</p>\n</blockquote>\n<ol start=\"14\">\n<li><strong>使用空值作为有效的默认值</strong></li>\n</ol>\n<p>如果写成不带冒号的 ${HOME&#x3D;&#x2F;tmp}，那么赋值操作仅会在该变量不存在的情况下（从未设置或已明确删除）发生</p>\n<ol start=\"15\">\n<li><strong>不只使用字符串常量作为默认值</strong></li>\n</ol>\n<p>能出现在 shell 变量引用右侧的内容并不局限于字符串常量。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cd</span> <span class=\"hljs-variable\">$&#123;BASE:=&quot;$(pwd)&quot;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"16\">\n<li><strong>对不存在的参数输出错误消息</strong></li>\n</ol>\n<p>使用 set -u 命令，​“在变量替换时，将不存在的变量视为一种错误”​。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"> <span class=\"hljs-comment\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：check_unset_parms</span><br><span class=\"hljs-comment\">#</span><br>USAGE=<span class=\"hljs-string\">&quot;usage: myscript scratchdir sourcefile conversion&quot;</span><br>FILEDIR=<span class=\"hljs-variable\">$&#123;1:?&quot;Error. You must supply a scratch directory.&quot;&#125;</span><br>FILESRC=<span class=\"hljs-variable\">$&#123;2:?&quot;Error. You must supply a source file.&quot;&#125;</span><br>CVTTYPE=<span class=\"hljs-variable\">$&#123;3:?&quot;Error. <span class=\"hljs-variable\">$&#123;USAGE&#125;</span>&quot;&#125;</span><br> <br> <span class=\"hljs-comment\">## 还可以在其中执行其他命令</span><br> CVTTYPE=<span class=\"hljs-variable\">$&#123;3:?&quot;Error. $USAGE. $(rm $SCRATCHFILE)&quot;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"17\">\n<li><strong>变量字符串替换</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 从字符串name的索引位置start开始，返回长度为number的子串</span><br><span class=\"hljs-comment\"># 如果子串为空格分隔的字符串，转为数组，比如 name=&quot;jack rose lucy&quot;, name=($&#123;name&#125;)</span><br><span class=\"hljs-comment\"># 然后用 $&#123;name[@]:0:1&#125;形式进行引用，不然会按字符串数量计数取子集</span><br><span class=\"hljs-comment\"># 如果不转换为数组，直接 $&#123;name:0:1&#125; 会输出 j</span><br><span class=\"hljs-variable\">$&#123;name:start:number&#125;</span><br><span class=\"hljs-comment\"># 返回字符串长度</span><br><span class=\"hljs-variable\">$&#123;#name&#125;</span><br><span class=\"hljs-comment\">## 从字符串起始位置开始，删除匹配pattern的最短子串</span><br><span class=\"hljs-variable\">$&#123;name#pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串起始位置开始，删除匹配pattern的最长子串</span><br><span class=\"hljs-variable\">$&#123;name##pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串结束位置开始，删除匹配pattern的最短子串</span><br><span class=\"hljs-variable\">$&#123;name%pattern&#125;</span><br><span class=\"hljs-comment\">## 从字符串结束位置开始，删除匹配pattern的最长子串</span><br><span class=\"hljs-variable\">$&#123;name%%pattern&#125;</span><br><span class=\"hljs-comment\">## 替换字符串中第一次出现的pattern</span><br><span class=\"hljs-variable\">$&#123;name/pattern/string&#125;</span><br><span class=\"hljs-comment\">## 替换字符串中出现的所有pattern</span><br><span class=\"hljs-variable\">$&#123;name//pattern/string&#125;</span><br><br><span class=\"hljs-comment\">## 变量不为空，替换为逗号</span><br><span class=\"hljs-variable\">$&#123;LIST:+,&#125;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>FILE&#x3D;${FULLPATHTOFILE##*&#x2F;}<br>等价于（结尾处不含&#x2F;时）<br>basename $FULLPATHTOFILE</p>\n</blockquote>\n<ol start=\"18\">\n<li><strong>变量字符串大小写转换</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 转换成小写</span><br><span class=\"hljs-variable\">$&#123;name,,&#125;</span><br><span class=\"hljs-comment\"># 转换成大写</span><br><span class=\"hljs-variable\">$&#123;name^^&#125;</span><br><span class=\"hljs-comment\"># 首字母转换成大写</span><br><span class=\"hljs-variable\">$&#123;name^&#125;</span><br><span class=\"hljs-comment\"># 大写转成小写，小写转大写</span><br><span class=\"hljs-variable\">$&#123;name~~&#125;</span><br><span class=\"hljs-comment\"># 变量内容会转换成小写字母</span><br><span class=\"hljs-built_in\">declare</span> -l name<br><span class=\"hljs-comment\"># 全部大写</span><br><span class=\"hljs-built_in\">declare</span> -u name<br><span class=\"hljs-comment\"># 仅首字母大写</span><br><span class=\"hljs-built_in\">declare</span> -c name<br></code></pre></td></tr></table></figure>\n\n<ol start=\"19\">\n<li><strong>简单算数</strong></li>\n</ol>\n<p>用 <code>$(( ))</code> 或 <code>let</code> 进行整数运算</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">##  $(( ))可以用 ** 进行幂运算</span><br>COUNT=$((COUNT + <span class=\"hljs-number\">5</span> + MAX * <span class=\"hljs-number\">2</span>))<br><span class=\"hljs-built_in\">let</span> COUNT+=<span class=\"hljs-string\">&#x27;5+MAX*2&#x27;</span><br><br><span class=\"hljs-built_in\">let</span> COUNT+=5<br></code></pre></td></tr></table></figure>\n\n<ol start=\"20\">\n<li><strong>测试文件属性</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 是否更新（检查文件的修改时间）​。现有文件要比不存在的文件“新”​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -nt FILE2　　<br><span class=\"hljs-comment\"># 是否更旧。同样，不存在的文件要比现有文件“旧”​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -ot FILE2　　<br><span class=\"hljs-comment\"># 具有相同设备和 inode 编号（即便由不同链接所指向，也视为相同的文件）​。</span><br><span class=\"hljs-built_in\">test</span> FILE1 -ef FILE2　　<br><span class=\"hljs-comment\"># 测试文件大小是否不为空</span><br><span class=\"hljs-built_in\">test</span> -s FILE<br></code></pre></td></tr></table></figure>\n\n<ol start=\"21\">\n<li><strong>用正则表达式匹配</strong></li>\n</ol>\n<blockquote>\n<p>bash 3.0 或更高版本</p>\n</blockquote>\n<p>使用 &#x3D;~ 运算符进行正则表达式匹配。只要能够匹配到某个字符串，就可以在 shell 数组变量 $BASH_REMATCH 中找到模式中的各个部分所匹配到的内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：trackmatch</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-keyword\">for</span> CDTRACK <span class=\"hljs-keyword\">in</span> *<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [[ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$CDTRACK</span>&quot;</span> =~ <span class=\"hljs-string\">&quot;([[:alpha:][:blank:]]*)- ([[:digit:]]*) - (.*)$&quot;</span> ]]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> Track <span class=\"hljs-variable\">$&#123;BASH_REMATCH[2]&#125;</span> is <span class=\"hljs-variable\">$&#123;BASH_REMATCH[3]&#125;</span><br>        <span class=\"hljs-built_in\">mv</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$CDTRACK</span>&quot;</span> <span class=\"hljs-string\">&quot;Track<span class=\"hljs-variable\">$&#123;BASH_REMATCH[2]&#125;</span>&quot;</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"22\">\n<li><strong>循环</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## while 循环</span><br>$ svn status bcb<br>M      bcb/amin.c<br>?      bcb/dmin.c<br>?      bcb/mdiv.tmp<br>A      bcb/optrn.c<br>M      bcb/optson.c<br>?      bcb/prtbout.4161<br>?      bcb/rideaslist.odt<br>?      bcb/x.maxc<br><br><span class=\"hljs-comment\">## cut提取从第 8 列开始（一直到行尾）的字符串</span><br>svn status mysrc | grep <span class=\"hljs-string\">&#x27;^?&#x27;</span> | <span class=\"hljs-built_in\">cut</span> -c8- |<br>  <span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> FN; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span>; <span class=\"hljs-built_in\">rm</span> -rf <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span>; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## 将输入传给两个变量，最后一个变量获得输入行中剩余的所有内容</span><br>svn status mysrc |<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> TAG FN<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [[ <span class=\"hljs-variable\">$TAG</span> == \\? ]]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$FN</span><br>        <span class=\"hljs-built_in\">rm</span> -rf <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$FN</span>&quot;</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## for 循环</span><br><span class=\"hljs-comment\">## 双括号表明这是算术表达式，在其中引用变量时，不用加 $（但 $1 等位置参数除外）​，只要是 bash 中出现双括号的地方，均是如此</span><br><span class=\"hljs-keyword\">for</span> (( expr1 ; expr2 ; expr3 )) ; <span class=\"hljs-keyword\">do</span> list ; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-keyword\">for</span> (( i=<span class=\"hljs-number\">0</span>, j=<span class=\"hljs-number\">0</span> ; i+j &lt; <span class=\"hljs-number\">10</span> ; i++, j++ ))<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> $((i*j))<br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## seq 可以生成浮点值，参数依次是起始值、增量、结束值</span><br><span class=\"hljs-keyword\">for</span> fp <span class=\"hljs-keyword\">in</span> $(<span class=\"hljs-built_in\">seq</span> 1.0 .01 1.1)<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$fp</span>; other stuff too<br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-built_in\">seq</span> 1.0 .01 1.1 |<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> fp<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$fp</span>; other stuff too<br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-comment\">## $() 在子 shell 中执行命令</span><br><br><span class=\"hljs-comment\">## 在第一个例子的for 循环中，seq 必须先运行完毕，然后用全部的输出结果替换掉 $()。对于冗长的数值序列来说，这种方法的时间开销和内存开销都不小。</span><br><span class=\"hljs-comment\">## 在第二个例子中，seq 作为单独的命令运行，通过管道将其输出传入 while 循环，后者读取其中的每一行并做相应处理，seq 命令是与 while 并行运行的</span><br></code></pre></td></tr></table></figure></li>\n</ol>\n"},{"title":"Shell 实用技巧（二）","date":"2024-08-07T12:58:11.000Z","_content":"\n## Shell 实用技巧\n1. **创建简单的菜单**\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：dbinit.1\n#\n## 修改提示符\n## PS1 命令行提示符\n## PS2 续行提示符\n## PS3 select提示符\nDBLIST=$(sh ./listdb | tail -n +2)\n\nPS3=\"0 inits >\"\n\nselect DB in $DBLIST\ndo\n    if [ $DB ]\n    then\n        echo Initializing database: $DB\n\n        PS3=\"$((++i)) inits> \"\n\n        mysql -u user -p $DB <myinit.sql\n    fi\ndone\n```\n\n2. **简单的RPN计算器**\n> 6RPN（Reverse Polish notation，逆波兰表示法或逆波兰记法）是一种由波兰数学家扬 • 武卡谢维奇于1920 年引入的数学表达式方式。在逆波兰记法中，所有运算符都置于操作数的后面，因此也被称为后缀表示法。逆波兰记法不需要括号来标识运算符的优先级。\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：rpncalc\n#\n# 简单的RPN命令行（整数）计算器\n#\n# 获取用户提供的参数并计算\n# 参数形式为：a b运算符\n# 允许使用*x*代替*\n#\n# 检查参数数量：\nif [ \\( $# -lt 3 \\) -o \\( $(($# % 2)) -eq 0 \\) ]\nthen\n    echo \"usage: calc number number op [ number op ] ...\"\n    echo \"use x or '*' for multiplication\"\n    exit 1\nfi\n\nANS=$(($1 ${3//x/*} $2))\nshift 3\nwhile [ $# -gt 0 ]\ndo\n    # 在 $(( )) 中，除了位置参数（如 $1、$2）​，变量名前面并不需要加 $\n    ANS=$((ANS ${2//x/*} $1))\n    shift 2\ndone\necho $ANS\n```\n\n3. **浮点数计算**\n\n```bash\n# 实例文件：func_calc\n\n# 简单的命令行计算器\nfunction calc {\n    # 仅适用于整数！--> echo The answer is: $(( $* ))\n    # 浮点数\n    awk \"BEGIN {print \\\"The answer is: \\\" $* }\";\n} # 函数calc定义完毕\n```\n4. **正则模式**\n\n    - `.`匹配任意单个字符\n    - 星号`*`匹配上一个字符的 0 次或多次出现\n        -  `.*` 匹配 0 个或多个任意字符,甚至是空行\n        - `..*` 匹配任意单个字符以及紧随其后的 0 个或多个任意字符,也就是一个或多个字符，但不能是空行\n    - 脱字符 `^` 匹配文本行的行首位置\n    - 美元符号 `$` 匹配文本行的行尾位置，因此 `^$` 匹配空行\n    - 方括号`[]`中的一组字符匹配其中任意某个字符\n    - 如果方括号内的第一个字符是脱字符`[^abcd]`，则匹配的是**不在该字符组中的**任意字符\n    - `{}` 区间表达式\n        - `\\{n,m\\}`n 是重复的最小次数，m 是重复的最大次数\n        - `\\{n\\}`，则表示“只重复 n 次”​\n        - `\\{n,\\}`，则表示“至少重复 n 次”​\n\n5. **搜索压缩文件**\n    - zcat\n    - zgrep\n\n6. **awk**\n\n    - 反转每行单词\n        ```bash\n        $ awk '{\n            for (i=NF; i>=0; i--) {\n                printf \"%s \", $i;\n            }\n            printf \"\\n\"\n        }' <filename>\n        ```\n\n    - 汇总数字列表\n        ```bash\n        ## next 命令，它会停止处理该输入行，并从下一行输入重新开始\n        ls -l | awk '/^total/{next} {sum += $5}; END {print sum}'\n\n        ## tail +2 可实现同样的效果\n        ls -l | tail +2 | awk '/^total/{next} {sum += $5}; END {print sum}'\n        ```\n    - 统计字符串出现次数\n        ```awk\n        #!/usr/bin/awk -f\n        # 实例文件：asar.awk\n        # Awk关联数组\n        # 用法：ls -lR /usr/local | asar.awk\n\n        NF > 7 {\n            ## 变量初始为空\n            ## ++ 变为 1\n            user[$3]++\n        }\n\n        END {\n            for (i in user) {\n                printf \"%s owns %d files\\n\", i, user[i]\n            }\n        }\n        ```\n        ```bash\n        $ ls -lR /usr/local | awk -f asar.awk\n        bin owns 68 files\n        albing owns 1801 files\n        root owns 13755 files\n        man owns 11491 files\n        $\n        ```\n    - 输出直方图\n        ```awk\n        #!/usr/bin/awk -f\n        # 实例文件：hist.awk\n        # 用Awk生成直方图\n        # 用法：ls -lR /usr/local | hist.awk\n\n        function max(arr, big)\n        {\n            big = 0;\n            for (i in user)\n            {\n                if (user[i] > big) { big=user[i];}\n            }\n            return big\n        }\n\n        NF > 7 {\n            user[$3]++\n        }\n        END {\n            # 进行缩放\n            maxm = max(user);\n            for (i in user) {\n                #printf \"%s owns %d files\\n\", i, user[i]\n                scaled = 60 * user[i] / maxm ;\n                printf \"%-10.10s [%8d]:\", i, user[i]\n                for (i=0; i<scaled; i++) {\n                    printf \"#\";\n                }\n                printf \"\\n\";\n            }\n        }\n        ```\n    - 输出匹配词之后的文本\n        ```bash\n        $ cat para.awk\n        /keyphrase/ { flag=1 }\n        flag == 1 { print }\n        /^$/ { flag=0 }\n\n        $ awk -f para.awk < searchthis.txt\n        ```\n\n7. **bash 关联数组**\n\n> 其他语言中也称为散列或字典\n\n```bash\n# 实例文件：cnt_owner\n# 使用bash统计文件所有者\n# 将“ls -l”的输出通过管道传入该脚本\n\n## 定义关联数组\ndeclare -A AACOUNT\n## -a 后的变量会被认为是数组，默认以空格为分割符\nwhile read  -a LSL\ndo\n    # 只考虑包含7个及以上字段的行\n    if (( ${#LSL[*]} > 7 ))         # 数组大小\n    then\n        NDX=${LSL[3]}               # 字符串赋值\n        (( AACOUNT[${NDX}] += 1 ))  # 算术递增\n    fi\ndone\n\n## ${AACOUNT[@]} 会生成数组所有元素值的列表，如果加上惊叹号变成${!AACOUNT[@]}，则得到的是该数组所有索引的列表。\nfor VALS in \"${!AACOUNT[@]}\"        # 各个元素的索引\ndo\n    echo $VALS \"owns\" ${AACOUNT[$VALS]} \"files\"\ndone\n```\n\n8. **sort 排序**\n```bash\nsort -r # reverse\nsort -f # 不区分大小写\nsort -n # 数值排序\nsort -u # 去掉重复输出\n```\n\n如果配合 `uniq -c` 使用，`sort -rn` 可以非常方便地给出一个按照降序排列的列表。\n> uniq -d  只查看重复行\n\n- IP地址排序\n\n    ```bash\n    ## -t 选项用于指定字段之间的分隔符\n    $ sort -t . -k 1,1n -k 2,2n -k 3,3n -k 4,4n ipaddr.list\n    10.0.0.2\n    10.0.0.5\n    10.0.0.20\n    192.168.0.2\n    192.168.0.4\n    192.168.0.12\n    ```\n\n9. **tr**\n```bash\ntr ';:.!?' ',' <other.punct >commas.all\n# 将大写字母转换为小写字母\ntr 'A-Z' 'a-z' <be.fore >af.ter\n# 删除所有回车符\ntr -d '\\r' <file.dos >file.txt\n```\n\n10. **wc**\n```bash\n$ wc data_file\n5     15     60 data_file\n# 只显示行数\n$ wc -l data_file\n5 data_file\n\n# 只显示单词数\n$ wc -w data_file\n15 data_file\n\n# 只显示字符数（通常等同于字节数）\n$ wc -c data_file\n60 data_file\n\n## 输出数字及文件名\nwc -l data_file\n## 只输出数字\nwc -l < data_file\n# 虽然也能只输出数字，但是cat增加了脚本运行开销\ncat data_file | wc -l\n```\n\n11. **find**\n    - `-delete`\n    - `-newermt`\n    - `-mtime`\n    - `-size`\n    - `-print0` 往往配合 `xargs -0`\n    - `-type`\n    - `-exec` \n> 文件大小还包含了单位 k（千字节）​。如果单位是 c，则表示字节（或字符）​。如果使用 b 作为单位或者不写任何单位，则表示块。 \\\n> 对于碰到的每个文件，先测试其是否为目录，如果是，才测试名称是否符合模式。 \\\n> 所以 type放到name前面使用能略微提高搜索效率。\n\n12. **locate**\n\n13. **查找命令**\n    - `which`\n        - 在各版本linux表现不同，且不是内建命令\n    - `type -P`\n        - shell内建命令，命令不存在时不会输出错误消息，脚本中建议用\n    - `command -v/-V`\n        - shell内建命令，`v`找不到时不输出错误消息，`V`找不到时输出错误消息\n\n14. **函数参数及返回值**\n    - 向函数内部的变量赋值\n    - 用`echo`或`printf`将输出发送到标准输出，并用`$()`或者` `` `调用函数\n    ```bash\n    # 实例文件：func_max.1\n\n    # 定义函数：\n    ## 函数内部没有用local声明的变量都是全局变量\n    function max ()\n    {\n        local HIDN\n        if [ $1 -gt $2 ]\n        then\n            BIGR=$1\n        else\n            BIGR=$2\n        fi\n        HIDN=5\n    }\n    \n    # 实例文件：func_max.2\n\n    # 定义函数：\n    function max ()\n    {\n        if [ $1 -gt $2 ]\n        then\n            echo $1\n        else\n            echo $2\n        fi\n    }\n    # 调用函数\n    max 10 20\n    # 调用函数并将结果赋值给变量\n    BIGR=$(max 10 20)\n    echo $BIGR\n    # 调用函数并将结果赋值给变量\n    BIGR=`max 10 20`\n    echo $BIGR\n    ```\n    > 在函数中引用参数也是使用 $1、$2 等。但是，$0 保持不变，其中包含的还是所调用脚本的名称。\n    >\n    > $FUNCNAME 本身引用的是该数组的第 0 个元素，其中包含的是当前执行函数的名称。\n    >\n    > $FUNCNAME 仅存在于函数执行期间。\n\n15. **信号捕获**\n    其实`-SIGKILL（-9）`无法捕获。该信号可以立刻“杀死”进程，压根没机会捕获。\n\n    ```bash\n    ## 列出所有可捕获的信号\n    trap -l\n\n    ## 第一个参数填捕获到对应信号后的行为\n    ## 比如捕获退出信号时清理临时文件\n    trap \"Clean tmp files\" EXIT\n\n    ## 如果命令是被信号 signal number 终止的，则脚本的退出状态码为 128+signal number。\n    ```\n16. **alias**\n    - `''` 单引号包括的变量会在执行别名命令时生效变量值\n    - `\"\"` 双引号包括的变量，在设置别名时就会使值生效，写死\n    ```bash\n    ## 删除别名 h\n    ## \\ 可以使别名失效，防止有人将unalias命令设置成别名，如果有人将其设置为 : 就会使其失效\n    \\unalias h\n    ## 删除所有别名\n    unalias -a \n    # 定义别名时不允许使用参数，如 $1, $2\n    ```\n\n17. **避开别名和函数**\n    - 使用 bash shell 的 builtin 命令来忽略 shell 函数和别名，执行实际的内建命令。\n    - 使用 `command` 命令来忽略 shell 函数和别名，并执行实际的外部命令。\n    - 如果只是想避开别名扩展，但仍允许执行函数，在命令前加上 `\\` 前缀即可。\n    > type -a cmd 会显示所有包含cmd命令的地方，如果是函数，还会显示出函数代码\n\n18. **计算已过去的时间**\n    - 使用内建命令 `time` 或 bash 变量 `$SECONDS`\n    - `$SECONDS` 会记录 shell 启动以来的时长（秒数）​。如果为其赋值，那么随后在扩展该变量时，得到的值就是先前的赋值与赋值操作以后的时长（秒数）之和。\n\n19. **自定义文件描述符及重定向**\n    ```bash\n    # 将标准输出定向到 out.log文件\n    exec 1> out.log\n    # 将错误输出重定向标准输出\n    exec 2>&1\n    # 定义文件描述符 3 输出到other.log文件\n    exec 3> other.log\n    # 关闭文件描述符 3\n    exec 3>&- \n\n    ## 函数也可重定向输出\n    # 根据传进参数会分别进行输出，无需写迭代循环\n    ERROUT(){\n        printf \"Error: %b\\n\" \"$@\"\n    } >&2\n    ## printf 小技巧\n    test=\"a b c\"\n    printf \"Print %b\\n\" \"${test[@]}\"\n    ## 会打印三条输出\n\n    ```\n\n    重定向的顺序通常很重要\n    ```bash\n    # 标准输出被重定向到文件 my.file，然后标准错误被重定向到和标准输出相同的地方。所有的输出都会出现在 my.file 中\n    somecmd >my.file 2>&1\n    # 标准错误被重定向到标准输出（此时标准输出指向的是屏幕）​，然后标准输出被重定向到 my.file。因此，只有标准输出消息会出现在文件中，而错误消息仍旧会出现在屏幕上。\n    somecmd 2>&1 >my.file\n\n    somecmd 2>&1 | othercmd\n    # bash 4.x 版本中的一种便捷语法可以同时将标准输出和标准错误连入管道。\n    somecmd |& othercmd\n    ```\n\n20. **处理日期和时间**\n\n    - `date`\n\n    ```bash\n    # 将日期转为纪元秒格式\n    date -d \"20230113\" \"+%s\" \n    # 纪元秒格式转换需要加 @符号\n    date -d \"@1673000000\"\n\n    # 更多形式查阅其他文档\n    date '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'today' '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'tomorrow' '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'yesterday' '+%Y-%m-%d %H:%M:%S %z'\n    date -d '1 day ago' '+%Y-%m-%d %H:%M:%S %z'\n    date -d '-1 days' '+%Y-%m-%d %H:\n    %M:%S %z'\n    ```\n\n    - `printf`\n        - `printf` 有一个二进制版本\n        - 这里的`printf`指的是bash内建版本\n    ```bash\n    # 输出日期\n    printf '%(%F %T)T\\n' '-1'\n    # 可以为变量赋值\n    printf -v today '%(%F)T' '-1'\n    echo $today\n    # 有两个特殊的参数值可以使用：-1代表当前时间，-2 代表 shell 被调用的时间。\n    ```\n21. **比较文件**\n\n    - 比较纯文本文件\n    - 比较二进制文件\n\n    通用方法：\n    以上两种文件都可以通过计算sha值来确认是否相同。\n\n    比较纯文本文件比较简单，直接使用 `diff` 命令即可。\n    diff 常用选项：\n    - `-b` 忽略空白行\n    - `-c` 显示差异的上下文\n    - `-u` 显示差异的上下文，并且显示差异的行号\n    - `-y` 显示差异的上下行\n    - `-B` 忽略大小写\n    - `-i` 忽略大小写\n    - `-q` 不显示差异的上下文\n    - `-r` 递归比较目录\n    \n    diff 比较二进制文件不会显示太多信息，只会告诉两个文件不一样，需要使用 `cmp` 命令。\n    \n    或者通过解压word文档，用解压出来的xml文件进行对比。\n\n    ```bash\n    # 此行 sed可以将每个<>替换为自身加上换行符，从而将包含内容的行独立出来\n    sed -e 's/>/>\\\n    /g; s/</\\\n    </g' document.xml > word.xml\n    ```\n    > word文档实际上是由里面的图片和xml文件压缩所得，可以尝试用zip解压出来看看\n\n","source":"_posts/shell-action-2.md","raw":"---\ntitle: Shell 实用技巧（二）\ndate: 2024-08-07 20:58:11\ntags: linux\n---\n\n## Shell 实用技巧\n1. **创建简单的菜单**\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：dbinit.1\n#\n## 修改提示符\n## PS1 命令行提示符\n## PS2 续行提示符\n## PS3 select提示符\nDBLIST=$(sh ./listdb | tail -n +2)\n\nPS3=\"0 inits >\"\n\nselect DB in $DBLIST\ndo\n    if [ $DB ]\n    then\n        echo Initializing database: $DB\n\n        PS3=\"$((++i)) inits> \"\n\n        mysql -u user -p $DB <myinit.sql\n    fi\ndone\n```\n\n2. **简单的RPN计算器**\n> 6RPN（Reverse Polish notation，逆波兰表示法或逆波兰记法）是一种由波兰数学家扬 • 武卡谢维奇于1920 年引入的数学表达式方式。在逆波兰记法中，所有运算符都置于操作数的后面，因此也被称为后缀表示法。逆波兰记法不需要括号来标识运算符的优先级。\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：rpncalc\n#\n# 简单的RPN命令行（整数）计算器\n#\n# 获取用户提供的参数并计算\n# 参数形式为：a b运算符\n# 允许使用*x*代替*\n#\n# 检查参数数量：\nif [ \\( $# -lt 3 \\) -o \\( $(($# % 2)) -eq 0 \\) ]\nthen\n    echo \"usage: calc number number op [ number op ] ...\"\n    echo \"use x or '*' for multiplication\"\n    exit 1\nfi\n\nANS=$(($1 ${3//x/*} $2))\nshift 3\nwhile [ $# -gt 0 ]\ndo\n    # 在 $(( )) 中，除了位置参数（如 $1、$2）​，变量名前面并不需要加 $\n    ANS=$((ANS ${2//x/*} $1))\n    shift 2\ndone\necho $ANS\n```\n\n3. **浮点数计算**\n\n```bash\n# 实例文件：func_calc\n\n# 简单的命令行计算器\nfunction calc {\n    # 仅适用于整数！--> echo The answer is: $(( $* ))\n    # 浮点数\n    awk \"BEGIN {print \\\"The answer is: \\\" $* }\";\n} # 函数calc定义完毕\n```\n4. **正则模式**\n\n    - `.`匹配任意单个字符\n    - 星号`*`匹配上一个字符的 0 次或多次出现\n        -  `.*` 匹配 0 个或多个任意字符,甚至是空行\n        - `..*` 匹配任意单个字符以及紧随其后的 0 个或多个任意字符,也就是一个或多个字符，但不能是空行\n    - 脱字符 `^` 匹配文本行的行首位置\n    - 美元符号 `$` 匹配文本行的行尾位置，因此 `^$` 匹配空行\n    - 方括号`[]`中的一组字符匹配其中任意某个字符\n    - 如果方括号内的第一个字符是脱字符`[^abcd]`，则匹配的是**不在该字符组中的**任意字符\n    - `{}` 区间表达式\n        - `\\{n,m\\}`n 是重复的最小次数，m 是重复的最大次数\n        - `\\{n\\}`，则表示“只重复 n 次”​\n        - `\\{n,\\}`，则表示“至少重复 n 次”​\n\n5. **搜索压缩文件**\n    - zcat\n    - zgrep\n\n6. **awk**\n\n    - 反转每行单词\n        ```bash\n        $ awk '{\n            for (i=NF; i>=0; i--) {\n                printf \"%s \", $i;\n            }\n            printf \"\\n\"\n        }' <filename>\n        ```\n\n    - 汇总数字列表\n        ```bash\n        ## next 命令，它会停止处理该输入行，并从下一行输入重新开始\n        ls -l | awk '/^total/{next} {sum += $5}; END {print sum}'\n\n        ## tail +2 可实现同样的效果\n        ls -l | tail +2 | awk '/^total/{next} {sum += $5}; END {print sum}'\n        ```\n    - 统计字符串出现次数\n        ```awk\n        #!/usr/bin/awk -f\n        # 实例文件：asar.awk\n        # Awk关联数组\n        # 用法：ls -lR /usr/local | asar.awk\n\n        NF > 7 {\n            ## 变量初始为空\n            ## ++ 变为 1\n            user[$3]++\n        }\n\n        END {\n            for (i in user) {\n                printf \"%s owns %d files\\n\", i, user[i]\n            }\n        }\n        ```\n        ```bash\n        $ ls -lR /usr/local | awk -f asar.awk\n        bin owns 68 files\n        albing owns 1801 files\n        root owns 13755 files\n        man owns 11491 files\n        $\n        ```\n    - 输出直方图\n        ```awk\n        #!/usr/bin/awk -f\n        # 实例文件：hist.awk\n        # 用Awk生成直方图\n        # 用法：ls -lR /usr/local | hist.awk\n\n        function max(arr, big)\n        {\n            big = 0;\n            for (i in user)\n            {\n                if (user[i] > big) { big=user[i];}\n            }\n            return big\n        }\n\n        NF > 7 {\n            user[$3]++\n        }\n        END {\n            # 进行缩放\n            maxm = max(user);\n            for (i in user) {\n                #printf \"%s owns %d files\\n\", i, user[i]\n                scaled = 60 * user[i] / maxm ;\n                printf \"%-10.10s [%8d]:\", i, user[i]\n                for (i=0; i<scaled; i++) {\n                    printf \"#\";\n                }\n                printf \"\\n\";\n            }\n        }\n        ```\n    - 输出匹配词之后的文本\n        ```bash\n        $ cat para.awk\n        /keyphrase/ { flag=1 }\n        flag == 1 { print }\n        /^$/ { flag=0 }\n\n        $ awk -f para.awk < searchthis.txt\n        ```\n\n7. **bash 关联数组**\n\n> 其他语言中也称为散列或字典\n\n```bash\n# 实例文件：cnt_owner\n# 使用bash统计文件所有者\n# 将“ls -l”的输出通过管道传入该脚本\n\n## 定义关联数组\ndeclare -A AACOUNT\n## -a 后的变量会被认为是数组，默认以空格为分割符\nwhile read  -a LSL\ndo\n    # 只考虑包含7个及以上字段的行\n    if (( ${#LSL[*]} > 7 ))         # 数组大小\n    then\n        NDX=${LSL[3]}               # 字符串赋值\n        (( AACOUNT[${NDX}] += 1 ))  # 算术递增\n    fi\ndone\n\n## ${AACOUNT[@]} 会生成数组所有元素值的列表，如果加上惊叹号变成${!AACOUNT[@]}，则得到的是该数组所有索引的列表。\nfor VALS in \"${!AACOUNT[@]}\"        # 各个元素的索引\ndo\n    echo $VALS \"owns\" ${AACOUNT[$VALS]} \"files\"\ndone\n```\n\n8. **sort 排序**\n```bash\nsort -r # reverse\nsort -f # 不区分大小写\nsort -n # 数值排序\nsort -u # 去掉重复输出\n```\n\n如果配合 `uniq -c` 使用，`sort -rn` 可以非常方便地给出一个按照降序排列的列表。\n> uniq -d  只查看重复行\n\n- IP地址排序\n\n    ```bash\n    ## -t 选项用于指定字段之间的分隔符\n    $ sort -t . -k 1,1n -k 2,2n -k 3,3n -k 4,4n ipaddr.list\n    10.0.0.2\n    10.0.0.5\n    10.0.0.20\n    192.168.0.2\n    192.168.0.4\n    192.168.0.12\n    ```\n\n9. **tr**\n```bash\ntr ';:.!?' ',' <other.punct >commas.all\n# 将大写字母转换为小写字母\ntr 'A-Z' 'a-z' <be.fore >af.ter\n# 删除所有回车符\ntr -d '\\r' <file.dos >file.txt\n```\n\n10. **wc**\n```bash\n$ wc data_file\n5     15     60 data_file\n# 只显示行数\n$ wc -l data_file\n5 data_file\n\n# 只显示单词数\n$ wc -w data_file\n15 data_file\n\n# 只显示字符数（通常等同于字节数）\n$ wc -c data_file\n60 data_file\n\n## 输出数字及文件名\nwc -l data_file\n## 只输出数字\nwc -l < data_file\n# 虽然也能只输出数字，但是cat增加了脚本运行开销\ncat data_file | wc -l\n```\n\n11. **find**\n    - `-delete`\n    - `-newermt`\n    - `-mtime`\n    - `-size`\n    - `-print0` 往往配合 `xargs -0`\n    - `-type`\n    - `-exec` \n> 文件大小还包含了单位 k（千字节）​。如果单位是 c，则表示字节（或字符）​。如果使用 b 作为单位或者不写任何单位，则表示块。 \\\n> 对于碰到的每个文件，先测试其是否为目录，如果是，才测试名称是否符合模式。 \\\n> 所以 type放到name前面使用能略微提高搜索效率。\n\n12. **locate**\n\n13. **查找命令**\n    - `which`\n        - 在各版本linux表现不同，且不是内建命令\n    - `type -P`\n        - shell内建命令，命令不存在时不会输出错误消息，脚本中建议用\n    - `command -v/-V`\n        - shell内建命令，`v`找不到时不输出错误消息，`V`找不到时输出错误消息\n\n14. **函数参数及返回值**\n    - 向函数内部的变量赋值\n    - 用`echo`或`printf`将输出发送到标准输出，并用`$()`或者` `` `调用函数\n    ```bash\n    # 实例文件：func_max.1\n\n    # 定义函数：\n    ## 函数内部没有用local声明的变量都是全局变量\n    function max ()\n    {\n        local HIDN\n        if [ $1 -gt $2 ]\n        then\n            BIGR=$1\n        else\n            BIGR=$2\n        fi\n        HIDN=5\n    }\n    \n    # 实例文件：func_max.2\n\n    # 定义函数：\n    function max ()\n    {\n        if [ $1 -gt $2 ]\n        then\n            echo $1\n        else\n            echo $2\n        fi\n    }\n    # 调用函数\n    max 10 20\n    # 调用函数并将结果赋值给变量\n    BIGR=$(max 10 20)\n    echo $BIGR\n    # 调用函数并将结果赋值给变量\n    BIGR=`max 10 20`\n    echo $BIGR\n    ```\n    > 在函数中引用参数也是使用 $1、$2 等。但是，$0 保持不变，其中包含的还是所调用脚本的名称。\n    >\n    > $FUNCNAME 本身引用的是该数组的第 0 个元素，其中包含的是当前执行函数的名称。\n    >\n    > $FUNCNAME 仅存在于函数执行期间。\n\n15. **信号捕获**\n    其实`-SIGKILL（-9）`无法捕获。该信号可以立刻“杀死”进程，压根没机会捕获。\n\n    ```bash\n    ## 列出所有可捕获的信号\n    trap -l\n\n    ## 第一个参数填捕获到对应信号后的行为\n    ## 比如捕获退出信号时清理临时文件\n    trap \"Clean tmp files\" EXIT\n\n    ## 如果命令是被信号 signal number 终止的，则脚本的退出状态码为 128+signal number。\n    ```\n16. **alias**\n    - `''` 单引号包括的变量会在执行别名命令时生效变量值\n    - `\"\"` 双引号包括的变量，在设置别名时就会使值生效，写死\n    ```bash\n    ## 删除别名 h\n    ## \\ 可以使别名失效，防止有人将unalias命令设置成别名，如果有人将其设置为 : 就会使其失效\n    \\unalias h\n    ## 删除所有别名\n    unalias -a \n    # 定义别名时不允许使用参数，如 $1, $2\n    ```\n\n17. **避开别名和函数**\n    - 使用 bash shell 的 builtin 命令来忽略 shell 函数和别名，执行实际的内建命令。\n    - 使用 `command` 命令来忽略 shell 函数和别名，并执行实际的外部命令。\n    - 如果只是想避开别名扩展，但仍允许执行函数，在命令前加上 `\\` 前缀即可。\n    > type -a cmd 会显示所有包含cmd命令的地方，如果是函数，还会显示出函数代码\n\n18. **计算已过去的时间**\n    - 使用内建命令 `time` 或 bash 变量 `$SECONDS`\n    - `$SECONDS` 会记录 shell 启动以来的时长（秒数）​。如果为其赋值，那么随后在扩展该变量时，得到的值就是先前的赋值与赋值操作以后的时长（秒数）之和。\n\n19. **自定义文件描述符及重定向**\n    ```bash\n    # 将标准输出定向到 out.log文件\n    exec 1> out.log\n    # 将错误输出重定向标准输出\n    exec 2>&1\n    # 定义文件描述符 3 输出到other.log文件\n    exec 3> other.log\n    # 关闭文件描述符 3\n    exec 3>&- \n\n    ## 函数也可重定向输出\n    # 根据传进参数会分别进行输出，无需写迭代循环\n    ERROUT(){\n        printf \"Error: %b\\n\" \"$@\"\n    } >&2\n    ## printf 小技巧\n    test=\"a b c\"\n    printf \"Print %b\\n\" \"${test[@]}\"\n    ## 会打印三条输出\n\n    ```\n\n    重定向的顺序通常很重要\n    ```bash\n    # 标准输出被重定向到文件 my.file，然后标准错误被重定向到和标准输出相同的地方。所有的输出都会出现在 my.file 中\n    somecmd >my.file 2>&1\n    # 标准错误被重定向到标准输出（此时标准输出指向的是屏幕）​，然后标准输出被重定向到 my.file。因此，只有标准输出消息会出现在文件中，而错误消息仍旧会出现在屏幕上。\n    somecmd 2>&1 >my.file\n\n    somecmd 2>&1 | othercmd\n    # bash 4.x 版本中的一种便捷语法可以同时将标准输出和标准错误连入管道。\n    somecmd |& othercmd\n    ```\n\n20. **处理日期和时间**\n\n    - `date`\n\n    ```bash\n    # 将日期转为纪元秒格式\n    date -d \"20230113\" \"+%s\" \n    # 纪元秒格式转换需要加 @符号\n    date -d \"@1673000000\"\n\n    # 更多形式查阅其他文档\n    date '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'today' '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'tomorrow' '+%Y-%m-%d %H:%M:%S %z'\n    date -d 'yesterday' '+%Y-%m-%d %H:%M:%S %z'\n    date -d '1 day ago' '+%Y-%m-%d %H:%M:%S %z'\n    date -d '-1 days' '+%Y-%m-%d %H:\n    %M:%S %z'\n    ```\n\n    - `printf`\n        - `printf` 有一个二进制版本\n        - 这里的`printf`指的是bash内建版本\n    ```bash\n    # 输出日期\n    printf '%(%F %T)T\\n' '-1'\n    # 可以为变量赋值\n    printf -v today '%(%F)T' '-1'\n    echo $today\n    # 有两个特殊的参数值可以使用：-1代表当前时间，-2 代表 shell 被调用的时间。\n    ```\n21. **比较文件**\n\n    - 比较纯文本文件\n    - 比较二进制文件\n\n    通用方法：\n    以上两种文件都可以通过计算sha值来确认是否相同。\n\n    比较纯文本文件比较简单，直接使用 `diff` 命令即可。\n    diff 常用选项：\n    - `-b` 忽略空白行\n    - `-c` 显示差异的上下文\n    - `-u` 显示差异的上下文，并且显示差异的行号\n    - `-y` 显示差异的上下行\n    - `-B` 忽略大小写\n    - `-i` 忽略大小写\n    - `-q` 不显示差异的上下文\n    - `-r` 递归比较目录\n    \n    diff 比较二进制文件不会显示太多信息，只会告诉两个文件不一样，需要使用 `cmp` 命令。\n    \n    或者通过解压word文档，用解压出来的xml文件进行对比。\n\n    ```bash\n    # 此行 sed可以将每个<>替换为自身加上换行符，从而将包含内容的行独立出来\n    sed -e 's/>/>\\\n    /g; s/</\\\n    </g' document.xml > word.xml\n    ```\n    > word文档实际上是由里面的图片和xml文件压缩所得，可以尝试用zip解压出来看看\n\n","slug":"shell-action-2","published":1,"updated":"2024-08-15T02:54:46.753Z","_id":"clzkkh3yt000muhuq0xot89y9","comments":1,"layout":"post","photos":[],"content":"<h2 id=\"Shell-实用技巧\"><a href=\"#Shell-实用技巧\" class=\"headerlink\" title=\"Shell 实用技巧\"></a>Shell 实用技巧</h2><ol>\n<li><strong>创建简单的菜单</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：dbinit.1</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\">## 修改提示符</span><br><span class=\"hljs-comment\">## PS1 命令行提示符</span><br><span class=\"hljs-comment\">## PS2 续行提示符</span><br><span class=\"hljs-comment\">## PS3 select提示符</span><br>DBLIST=$(sh ./listdb | <span class=\"hljs-built_in\">tail</span> -n +2)<br><br>PS3=<span class=\"hljs-string\">&quot;0 inits &gt;&quot;</span><br><br><span class=\"hljs-keyword\">select</span> DB <span class=\"hljs-keyword\">in</span> <span class=\"hljs-variable\">$DBLIST</span><br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$DB</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> Initializing database: <span class=\"hljs-variable\">$DB</span><br><br>        PS3=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$((++i)</span>) inits&gt; &quot;</span><br><br>        mysql -u user -p <span class=\"hljs-variable\">$DB</span> &lt;myinit.sql<br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>简单的RPN计算器</strong><blockquote>\n<p>6RPN（Reverse Polish notation，逆波兰表示法或逆波兰记法）是一种由波兰数学家扬 • 武卡谢维奇于1920 年引入的数学表达式方式。在逆波兰记法中，所有运算符都置于操作数的后面，因此也被称为后缀表示法。逆波兰记法不需要括号来标识运算符的优先级。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：rpncalc</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 简单的RPN命令行（整数）计算器</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 获取用户提供的参数并计算</span><br><span class=\"hljs-comment\"># 参数形式为：a b运算符</span><br><span class=\"hljs-comment\"># 允许使用*x*代替*</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 检查参数数量：</span><br><span class=\"hljs-keyword\">if</span> [ \\( <span class=\"hljs-variable\">$#</span> -lt 3 \\) -o \\( $((<span class=\"hljs-variable\">$#</span> % <span class=\"hljs-number\">2</span>)) -eq 0 \\) ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;usage: calc number number op [ number op ] ...&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;use x or &#x27;*&#x27; for multiplication&quot;</span><br>    <span class=\"hljs-built_in\">exit</span> 1<br><span class=\"hljs-keyword\">fi</span><br><br>ANS=$((<span class=\"hljs-variable\">$1</span> <span class=\"hljs-variable\">$&#123;3//x/*&#125;</span> <span class=\"hljs-variable\">$2</span>))<br><span class=\"hljs-built_in\">shift</span> 3<br><span class=\"hljs-keyword\">while</span> [ <span class=\"hljs-variable\">$#</span> -gt 0 ]<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-comment\"># 在 $(( )) 中，除了位置参数（如 $1、$2）​，变量名前面并不需要加 $</span><br>    ANS=$((ANS <span class=\"hljs-variable\">$&#123;2//x/*&#125;</span> <span class=\"hljs-variable\">$1</span>))<br>    <span class=\"hljs-built_in\">shift</span> 2<br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$ANS</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>浮点数计算</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：func_calc</span><br><br><span class=\"hljs-comment\"># 简单的命令行计算器</span><br><span class=\"hljs-keyword\">function</span> calc &#123;<br>    <span class=\"hljs-comment\"># 仅适用于整数！--&gt; echo The answer is: $(( $* ))</span><br>    <span class=\"hljs-comment\"># 浮点数</span><br>    awk <span class=\"hljs-string\">&quot;BEGIN &#123;print \\&quot;The answer is: \\&quot; $* &#125;&quot;</span>;<br>&#125; <span class=\"hljs-comment\"># 函数calc定义完毕</span><br></code></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li><p><strong>正则模式</strong></p>\n<ul>\n<li><code>.</code>匹配任意单个字符</li>\n<li>星号<code>*</code>匹配上一个字符的 0 次或多次出现<ul>\n<li><code>.*</code> 匹配 0 个或多个任意字符,甚至是空行</li>\n<li><code>..*</code> 匹配任意单个字符以及紧随其后的 0 个或多个任意字符,也就是一个或多个字符，但不能是空行</li>\n</ul>\n</li>\n<li>脱字符 <code>^</code> 匹配文本行的行首位置</li>\n<li>美元符号 <code>$</code> 匹配文本行的行尾位置，因此 <code>^$</code> 匹配空行</li>\n<li>方括号<code>[]</code>中的一组字符匹配其中任意某个字符</li>\n<li>如果方括号内的第一个字符是脱字符<code>[^abcd]</code>，则匹配的是<strong>不在该字符组中的</strong>任意字符</li>\n<li><code>&#123;&#125;</code> 区间表达式<ul>\n<li><code>\\&#123;n,m\\&#125;</code>n 是重复的最小次数，m 是重复的最大次数</li>\n<li><code>\\&#123;n\\&#125;</code>，则表示“只重复 n 次”​</li>\n<li><code>\\&#123;n,\\&#125;</code>，则表示“至少重复 n 次”​</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>搜索压缩文件</strong></p>\n<ul>\n<li>zcat</li>\n<li>zgrep</li>\n</ul>\n</li>\n<li><p><strong>awk</strong></p>\n<ul>\n<li><p>反转每行单词</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ awk <span class=\"hljs-string\">&#x27;&#123;</span><br><span class=\"hljs-string\">    for (i=NF; i&gt;=0; i--) &#123;</span><br><span class=\"hljs-string\">        printf &quot;%s &quot;, $i;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">    printf &quot;\\n&quot;</span><br><span class=\"hljs-string\">&#125;&#x27;</span> &lt;filename&gt;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>汇总数字列表</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## next 命令，它会停止处理该输入行，并从下一行输入重新开始</span><br><span class=\"hljs-built_in\">ls</span> -l | awk <span class=\"hljs-string\">&#x27;/^total/&#123;next&#125; &#123;sum += $5&#125;; END &#123;print sum&#125;&#x27;</span><br><br><span class=\"hljs-comment\">## tail +2 可实现同样的效果</span><br><span class=\"hljs-built_in\">ls</span> -l | <span class=\"hljs-built_in\">tail</span> +2 | awk <span class=\"hljs-string\">&#x27;/^total/&#123;next&#125; &#123;sum += $5&#125;; END &#123;print sum&#125;&#x27;</span><br></code></pre></td></tr></table></figure></li>\n<li><p>统计字符串出现次数</p>\n  <figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/usr/bin/awk -f</span><br><span class=\"hljs-comment\"># 实例文件：asar.awk</span><br><span class=\"hljs-comment\"># Awk关联数组</span><br><span class=\"hljs-comment\"># 用法：ls -lR /usr/local | asar.awk</span><br><br>NF &gt; <span class=\"hljs-number\">7</span> &#123;<br>    <span class=\"hljs-comment\">## 变量初始为空</span><br>    <span class=\"hljs-comment\">## ++ 变为 1</span><br>    user[<span class=\"hljs-variable\">$3</span>]++<br>&#125;<br><br><span class=\"hljs-keyword\">END</span> &#123;<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user) &#123;<br>        printf <span class=\"hljs-string\">&quot;%s owns %d files\\n&quot;</span>, i, user[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">ls</span> -lR /usr/local | awk -f asar.awk<br>bin owns 68 files<br>albing owns 1801 files<br>root owns 13755 files<br>man owns 11491 files<br>$<br></code></pre></td></tr></table></figure></li>\n<li><p>输出直方图</p>\n  <figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/usr/bin/awk -f</span><br><span class=\"hljs-comment\"># 实例文件：hist.awk</span><br><span class=\"hljs-comment\"># 用Awk生成直方图</span><br><span class=\"hljs-comment\"># 用法：ls -lR /usr/local | hist.awk</span><br><br><span class=\"hljs-keyword\">function</span> max(arr, big)<br>&#123;<br>    big = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user)<br>    &#123;<br>        <span class=\"hljs-keyword\">if</span> (user[i] &gt; big) &#123; big=user[i];&#125;<br>    &#125;<br>    return big<br>&#125;<br><br>NF &gt; <span class=\"hljs-number\">7</span> &#123;<br>    user[<span class=\"hljs-variable\">$3</span>]++<br>&#125;<br><span class=\"hljs-keyword\">END</span> &#123;<br>    <span class=\"hljs-comment\"># 进行缩放</span><br>    maxm = max(user);<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user) &#123;<br>        <span class=\"hljs-comment\">#printf &quot;%s owns %d files\\n&quot;, i, user[i]</span><br>        scaled = <span class=\"hljs-number\">60</span> * user[i] / maxm ;<br>        printf <span class=\"hljs-string\">&quot;%-10.10s [%8d]:&quot;</span>, i, user[i]<br>        <span class=\"hljs-keyword\">for</span> (i=<span class=\"hljs-number\">0</span>; i&lt;scaled; i++) &#123;<br>            printf <span class=\"hljs-string\">&quot;#&quot;</span>;<br>        &#125;<br>        printf <span class=\"hljs-string\">&quot;\\n&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li><p>输出匹配词之后的文本</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> para.awk<br>/keyphrase/ &#123; flag=1 &#125;<br>flag == 1 &#123; <span class=\"hljs-built_in\">print</span> &#125;<br>/^$/ &#123; flag=0 &#125;<br><br>$ awk -f para.awk &lt; searchthis.txt<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>bash 关联数组</strong></p>\n</li>\n</ol>\n<blockquote>\n<p>其他语言中也称为散列或字典</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：cnt_owner</span><br><span class=\"hljs-comment\"># 使用bash统计文件所有者</span><br><span class=\"hljs-comment\"># 将“ls -l”的输出通过管道传入该脚本</span><br><br><span class=\"hljs-comment\">## 定义关联数组</span><br><span class=\"hljs-built_in\">declare</span> -A AACOUNT<br><span class=\"hljs-comment\">## -a 后的变量会被认为是数组，默认以空格为分割符</span><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span>  -a LSL<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-comment\"># 只考虑包含7个及以上字段的行</span><br>    <span class=\"hljs-keyword\">if</span> (( <span class=\"hljs-variable\">$&#123;#LSL[*]&#125;</span> &gt; <span class=\"hljs-number\">7</span> ))         <span class=\"hljs-comment\"># 数组大小</span><br>    <span class=\"hljs-keyword\">then</span><br>        NDX=<span class=\"hljs-variable\">$&#123;LSL[3]&#125;</span>               <span class=\"hljs-comment\"># 字符串赋值</span><br>        (( AACOUNT[<span class=\"hljs-variable\">$&#123;NDX&#125;</span>] += <span class=\"hljs-number\">1</span> ))  <span class=\"hljs-comment\"># 算术递增</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## $&#123;AACOUNT[@]&#125; 会生成数组所有元素值的列表，如果加上惊叹号变成$&#123;!AACOUNT[@]&#125;，则得到的是该数组所有索引的列表。</span><br><span class=\"hljs-keyword\">for</span> VALS <span class=\"hljs-keyword\">in</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;!AACOUNT[@]&#125;</span>&quot;</span>        <span class=\"hljs-comment\"># 各个元素的索引</span><br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$VALS</span> <span class=\"hljs-string\">&quot;owns&quot;</span> <span class=\"hljs-variable\">$&#123;AACOUNT[$VALS]&#125;</span> <span class=\"hljs-string\">&quot;files&quot;</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"8\">\n<li><strong>sort 排序</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sort</span> -r <span class=\"hljs-comment\"># reverse</span><br><span class=\"hljs-built_in\">sort</span> -f <span class=\"hljs-comment\"># 不区分大小写</span><br><span class=\"hljs-built_in\">sort</span> -n <span class=\"hljs-comment\"># 数值排序</span><br><span class=\"hljs-built_in\">sort</span> -u <span class=\"hljs-comment\"># 去掉重复输出</span><br></code></pre></td></tr></table></figure></li>\n</ol>\n<p>如果配合 <code>uniq -c</code> 使用，<code>sort -rn</code> 可以非常方便地给出一个按照降序排列的列表。</p>\n<blockquote>\n<p>uniq -d  只查看重复行</p>\n</blockquote>\n<ul>\n<li><p>IP地址排序</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## -t 选项用于指定字段之间的分隔符</span><br>$ <span class=\"hljs-built_in\">sort</span> -t . -k 1,1n -k 2,2n -k 3,3n -k 4,4n ipaddr.list<br>10.0.0.2<br>10.0.0.5<br>10.0.0.20<br>192.168.0.2<br>192.168.0.4<br>192.168.0.12<br></code></pre></td></tr></table></figure></li>\n</ul>\n<ol start=\"9\">\n<li><p><strong>tr</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">tr</span> <span class=\"hljs-string\">&#x27;;:.!?&#x27;</span> <span class=\"hljs-string\">&#x27;,&#x27;</span> &lt;other.punct &gt;commas.all<br><span class=\"hljs-comment\"># 将大写字母转换为小写字母</span><br><span class=\"hljs-built_in\">tr</span> <span class=\"hljs-string\">&#x27;A-Z&#x27;</span> <span class=\"hljs-string\">&#x27;a-z&#x27;</span> &lt;be.fore &gt;af.ter<br><span class=\"hljs-comment\"># 删除所有回车符</span><br><span class=\"hljs-built_in\">tr</span> -d <span class=\"hljs-string\">&#x27;\\r&#x27;</span> &lt;file.dos &gt;file.txt<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>wc</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">wc</span> data_file<br>5     15     60 data_file<br><span class=\"hljs-comment\"># 只显示行数</span><br>$ <span class=\"hljs-built_in\">wc</span> -l data_file<br>5 data_file<br><br><span class=\"hljs-comment\"># 只显示单词数</span><br>$ <span class=\"hljs-built_in\">wc</span> -w data_file<br>15 data_file<br><br><span class=\"hljs-comment\"># 只显示字符数（通常等同于字节数）</span><br>$ <span class=\"hljs-built_in\">wc</span> -c data_file<br>60 data_file<br><br><span class=\"hljs-comment\">## 输出数字及文件名</span><br><span class=\"hljs-built_in\">wc</span> -l data_file<br><span class=\"hljs-comment\">## 只输出数字</span><br><span class=\"hljs-built_in\">wc</span> -l &lt; data_file<br><span class=\"hljs-comment\"># 虽然也能只输出数字，但是cat增加了脚本运行开销</span><br><span class=\"hljs-built_in\">cat</span> data_file | <span class=\"hljs-built_in\">wc</span> -l<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>find</strong></p>\n<ul>\n<li><code>-delete</code></li>\n<li><code>-newermt</code></li>\n<li><code>-mtime</code></li>\n<li><code>-size</code></li>\n<li><code>-print0</code> 往往配合 <code>xargs -0</code></li>\n<li><code>-type</code></li>\n<li><code>-exec</code> <blockquote>\n<p>文件大小还包含了单位 k（千字节）​。如果单位是 c，则表示字节（或字符）​。如果使用 b 作为单位或者不写任何单位，则表示块。 <br>对于碰到的每个文件，先测试其是否为目录，如果是，才测试名称是否符合模式。 <br>所以 type放到name前面使用能略微提高搜索效率。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>locate</strong></p>\n</li>\n<li><p><strong>查找命令</strong></p>\n<ul>\n<li><code>which</code><ul>\n<li>在各版本linux表现不同，且不是内建命令</li>\n</ul>\n</li>\n<li><code>type -P</code><ul>\n<li>shell内建命令，命令不存在时不会输出错误消息，脚本中建议用</li>\n</ul>\n</li>\n<li><code>command -v/-V</code><ul>\n<li>shell内建命令，<code>v</code>找不到时不输出错误消息，<code>V</code>找不到时输出错误消息</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>函数参数及返回值</strong></p>\n<ul>\n<li>向函数内部的变量赋值</li>\n<li>用<code>echo</code>或<code>printf</code>将输出发送到标准输出，并用<code>$()</code>或者<code>``</code>调用函数<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：func_max.1</span><br><br><span class=\"hljs-comment\"># 定义函数：</span><br><span class=\"hljs-comment\">## 函数内部没有用local声明的变量都是全局变量</span><br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-function\"><span class=\"hljs-title\">max</span></span> ()<br>&#123;<br>    <span class=\"hljs-built_in\">local</span> HIDN<br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$1</span> -gt <span class=\"hljs-variable\">$2</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        BIGR=<span class=\"hljs-variable\">$1</span><br>    <span class=\"hljs-keyword\">else</span><br>        BIGR=<span class=\"hljs-variable\">$2</span><br>    <span class=\"hljs-keyword\">fi</span><br>    HIDN=5<br>&#125;<br><br><span class=\"hljs-comment\"># 实例文件：func_max.2</span><br><br><span class=\"hljs-comment\"># 定义函数：</span><br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-function\"><span class=\"hljs-title\">max</span></span> ()<br>&#123;<br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$1</span> -gt <span class=\"hljs-variable\">$2</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$1</span><br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$2</span><br>    <span class=\"hljs-keyword\">fi</span><br>&#125;<br><span class=\"hljs-comment\"># 调用函数</span><br>max 10 20<br><span class=\"hljs-comment\"># 调用函数并将结果赋值给变量</span><br>BIGR=$(max 10 20)<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$BIGR</span><br><span class=\"hljs-comment\"># 调用函数并将结果赋值给变量</span><br>BIGR=`max 10 20`<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$BIGR</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>在函数中引用参数也是使用 $1、$2 等。但是，$0 保持不变，其中包含的还是所调用脚本的名称。</p>\n<p>$FUNCNAME 本身引用的是该数组的第 0 个元素，其中包含的是当前执行函数的名称。</p>\n<p>$FUNCNAME 仅存在于函数执行期间。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>信号捕获</strong><br>其实<code>-SIGKILL（-9）</code>无法捕获。该信号可以立刻“杀死”进程，压根没机会捕获。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 列出所有可捕获的信号</span><br><span class=\"hljs-built_in\">trap</span> -l<br><br><span class=\"hljs-comment\">## 第一个参数填捕获到对应信号后的行为</span><br><span class=\"hljs-comment\">## 比如捕获退出信号时清理临时文件</span><br><span class=\"hljs-built_in\">trap</span> <span class=\"hljs-string\">&quot;Clean tmp files&quot;</span> EXIT<br><br><span class=\"hljs-comment\">## 如果命令是被信号 signal number 终止的，则脚本的退出状态码为 128+signal number。</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>alias</strong></p>\n<ul>\n<li><code>&#39;&#39;</code> 单引号包括的变量会在执行别名命令时生效变量值</li>\n<li><code>&quot;&quot;</code> 双引号包括的变量，在设置别名时就会使值生效，写死<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 删除别名 h</span><br><span class=\"hljs-comment\">## \\ 可以使别名失效，防止有人将unalias命令设置成别名，如果有人将其设置为 : 就会使其失效</span><br>\\<span class=\"hljs-built_in\">unalias</span> h<br><span class=\"hljs-comment\">## 删除所有别名</span><br><span class=\"hljs-built_in\">unalias</span> -a <br><span class=\"hljs-comment\"># 定义别名时不允许使用参数，如 $1, $2</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>避开别名和函数</strong></p>\n<ul>\n<li>使用 bash shell 的 builtin 命令来忽略 shell 函数和别名，执行实际的内建命令。</li>\n<li>使用 <code>command</code> 命令来忽略 shell 函数和别名，并执行实际的外部命令。</li>\n<li>如果只是想避开别名扩展，但仍允许执行函数，在命令前加上 <code>\\</code> 前缀即可。<blockquote>\n<p>type -a cmd 会显示所有包含cmd命令的地方，如果是函数，还会显示出函数代码</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>计算已过去的时间</strong></p>\n<ul>\n<li>使用内建命令 <code>time</code> 或 bash 变量 <code>$SECONDS</code></li>\n<li><code>$SECONDS</code> 会记录 shell 启动以来的时长（秒数）​。如果为其赋值，那么随后在扩展该变量时，得到的值就是先前的赋值与赋值操作以后的时长（秒数）之和。</li>\n</ul>\n</li>\n<li><p><strong>自定义文件描述符及重定向</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将标准输出定向到 out.log文件</span><br><span class=\"hljs-built_in\">exec</span> 1&gt; out.log<br><span class=\"hljs-comment\"># 将错误输出重定向标准输出</span><br><span class=\"hljs-built_in\">exec</span> 2&gt;&amp;1<br><span class=\"hljs-comment\"># 定义文件描述符 3 输出到other.log文件</span><br><span class=\"hljs-built_in\">exec</span> 3&gt; other.log<br><span class=\"hljs-comment\"># 关闭文件描述符 3</span><br><span class=\"hljs-built_in\">exec</span> 3&gt;&amp;- <br><br><span class=\"hljs-comment\">## 函数也可重定向输出</span><br><span class=\"hljs-comment\"># 根据传进参数会分别进行输出，无需写迭代循环</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ERROUT</span></span>()&#123;<br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Error: %b\\n&quot;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$@</span>&quot;</span><br>&#125; &gt;&amp;2<br><span class=\"hljs-comment\">## printf 小技巧</span><br><span class=\"hljs-built_in\">test</span>=<span class=\"hljs-string\">&quot;a b c&quot;</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Print %b\\n&quot;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;test[@]&#125;</span>&quot;</span><br><span class=\"hljs-comment\">## 会打印三条输出</span><br><br></code></pre></td></tr></table></figure>\n\n<p>重定向的顺序通常很重要</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 标准输出被重定向到文件 my.file，然后标准错误被重定向到和标准输出相同的地方。所有的输出都会出现在 my.file 中</span><br>somecmd &gt;my.file 2&gt;&amp;1<br><span class=\"hljs-comment\"># 标准错误被重定向到标准输出（此时标准输出指向的是屏幕）​，然后标准输出被重定向到 my.file。因此，只有标准输出消息会出现在文件中，而错误消息仍旧会出现在屏幕上。</span><br>somecmd 2&gt;&amp;1 &gt;my.file<br><br>somecmd 2&gt;&amp;1 | othercmd<br><span class=\"hljs-comment\"># bash 4.x 版本中的一种便捷语法可以同时将标准输出和标准错误连入管道。</span><br>somecmd |&amp; othercmd<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>处理日期和时间</strong></p>\n<ul>\n<li><code>date</code></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将日期转为纪元秒格式</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&quot;20230113&quot;</span> <span class=\"hljs-string\">&quot;+%s&quot;</span> <br><span class=\"hljs-comment\"># 纪元秒格式转换需要加 @符号</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&quot;@1673000000&quot;</span><br><br><span class=\"hljs-comment\"># 更多形式查阅其他文档</span><br><span class=\"hljs-built_in\">date</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;today&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;tomorrow&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;yesterday&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;1 day ago&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;-1 days&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:</span><br><span class=\"hljs-string\">%M:%S %z&#x27;</span><br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>printf</code><ul>\n<li><code>printf</code> 有一个二进制版本</li>\n<li>这里的<code>printf</code>指的是bash内建版本<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 输出日期</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;%(%F %T)T\\n&#x27;</span> <span class=\"hljs-string\">&#x27;-1&#x27;</span><br><span class=\"hljs-comment\"># 可以为变量赋值</span><br><span class=\"hljs-built_in\">printf</span> -v today <span class=\"hljs-string\">&#x27;%(%F)T&#x27;</span> <span class=\"hljs-string\">&#x27;-1&#x27;</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$today</span><br><span class=\"hljs-comment\"># 有两个特殊的参数值可以使用：-1代表当前时间，-2 代表 shell 被调用的时间。</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>比较文件</strong></p>\n<ul>\n<li>比较纯文本文件</li>\n<li>比较二进制文件</li>\n</ul>\n<p>通用方法：<br>以上两种文件都可以通过计算sha值来确认是否相同。</p>\n<p>比较纯文本文件比较简单，直接使用 <code>diff</code> 命令即可。<br>diff 常用选项：</p>\n<ul>\n<li><code>-b</code> 忽略空白行</li>\n<li><code>-c</code> 显示差异的上下文</li>\n<li><code>-u</code> 显示差异的上下文，并且显示差异的行号</li>\n<li><code>-y</code> 显示差异的上下行</li>\n<li><code>-B</code> 忽略大小写</li>\n<li><code>-i</code> 忽略大小写</li>\n<li><code>-q</code> 不显示差异的上下文</li>\n<li><code>-r</code> 递归比较目录</li>\n</ul>\n<p>diff 比较二进制文件不会显示太多信息，只会告诉两个文件不一样，需要使用 <code>cmp</code> 命令。</p>\n<p>或者通过解压word文档，用解压出来的xml文件进行对比。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 此行 sed可以将每个&lt;&gt;替换为自身加上换行符，从而将包含内容的行独立出来</span><br>sed -e <span class=\"hljs-string\">&#x27;s/&gt;/&gt;\\</span><br><span class=\"hljs-string\">/g; s/&lt;/\\</span><br><span class=\"hljs-string\">&lt;/g&#x27;</span> document.xml &gt; word.xml<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>word文档实际上是由里面的图片和xml文件压缩所得，可以尝试用zip解压出来看看</p>\n</blockquote>\n</li>\n</ol>\n","excerpt":"","more":"<h2 id=\"Shell-实用技巧\"><a href=\"#Shell-实用技巧\" class=\"headerlink\" title=\"Shell 实用技巧\"></a>Shell 实用技巧</h2><ol>\n<li><strong>创建简单的菜单</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：dbinit.1</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\">## 修改提示符</span><br><span class=\"hljs-comment\">## PS1 命令行提示符</span><br><span class=\"hljs-comment\">## PS2 续行提示符</span><br><span class=\"hljs-comment\">## PS3 select提示符</span><br>DBLIST=$(sh ./listdb | <span class=\"hljs-built_in\">tail</span> -n +2)<br><br>PS3=<span class=\"hljs-string\">&quot;0 inits &gt;&quot;</span><br><br><span class=\"hljs-keyword\">select</span> DB <span class=\"hljs-keyword\">in</span> <span class=\"hljs-variable\">$DBLIST</span><br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$DB</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> Initializing database: <span class=\"hljs-variable\">$DB</span><br><br>        PS3=<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">$((++i)</span>) inits&gt; &quot;</span><br><br>        mysql -u user -p <span class=\"hljs-variable\">$DB</span> &lt;myinit.sql<br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>简单的RPN计算器</strong><blockquote>\n<p>6RPN（Reverse Polish notation，逆波兰表示法或逆波兰记法）是一种由波兰数学家扬 • 武卡谢维奇于1920 年引入的数学表达式方式。在逆波兰记法中，所有运算符都置于操作数的后面，因此也被称为后缀表示法。逆波兰记法不需要括号来标识运算符的优先级。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：rpncalc</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 简单的RPN命令行（整数）计算器</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 获取用户提供的参数并计算</span><br><span class=\"hljs-comment\"># 参数形式为：a b运算符</span><br><span class=\"hljs-comment\"># 允许使用*x*代替*</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 检查参数数量：</span><br><span class=\"hljs-keyword\">if</span> [ \\( <span class=\"hljs-variable\">$#</span> -lt 3 \\) -o \\( $((<span class=\"hljs-variable\">$#</span> % <span class=\"hljs-number\">2</span>)) -eq 0 \\) ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;usage: calc number number op [ number op ] ...&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;use x or &#x27;*&#x27; for multiplication&quot;</span><br>    <span class=\"hljs-built_in\">exit</span> 1<br><span class=\"hljs-keyword\">fi</span><br><br>ANS=$((<span class=\"hljs-variable\">$1</span> <span class=\"hljs-variable\">$&#123;3//x/*&#125;</span> <span class=\"hljs-variable\">$2</span>))<br><span class=\"hljs-built_in\">shift</span> 3<br><span class=\"hljs-keyword\">while</span> [ <span class=\"hljs-variable\">$#</span> -gt 0 ]<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-comment\"># 在 $(( )) 中，除了位置参数（如 $1、$2）​，变量名前面并不需要加 $</span><br>    ANS=$((ANS <span class=\"hljs-variable\">$&#123;2//x/*&#125;</span> <span class=\"hljs-variable\">$1</span>))<br>    <span class=\"hljs-built_in\">shift</span> 2<br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$ANS</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>浮点数计算</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：func_calc</span><br><br><span class=\"hljs-comment\"># 简单的命令行计算器</span><br><span class=\"hljs-keyword\">function</span> calc &#123;<br>    <span class=\"hljs-comment\"># 仅适用于整数！--&gt; echo The answer is: $(( $* ))</span><br>    <span class=\"hljs-comment\"># 浮点数</span><br>    awk <span class=\"hljs-string\">&quot;BEGIN &#123;print \\&quot;The answer is: \\&quot; $* &#125;&quot;</span>;<br>&#125; <span class=\"hljs-comment\"># 函数calc定义完毕</span><br></code></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li><p><strong>正则模式</strong></p>\n<ul>\n<li><code>.</code>匹配任意单个字符</li>\n<li>星号<code>*</code>匹配上一个字符的 0 次或多次出现<ul>\n<li><code>.*</code> 匹配 0 个或多个任意字符,甚至是空行</li>\n<li><code>..*</code> 匹配任意单个字符以及紧随其后的 0 个或多个任意字符,也就是一个或多个字符，但不能是空行</li>\n</ul>\n</li>\n<li>脱字符 <code>^</code> 匹配文本行的行首位置</li>\n<li>美元符号 <code>$</code> 匹配文本行的行尾位置，因此 <code>^$</code> 匹配空行</li>\n<li>方括号<code>[]</code>中的一组字符匹配其中任意某个字符</li>\n<li>如果方括号内的第一个字符是脱字符<code>[^abcd]</code>，则匹配的是<strong>不在该字符组中的</strong>任意字符</li>\n<li><code>&#123;&#125;</code> 区间表达式<ul>\n<li><code>\\&#123;n,m\\&#125;</code>n 是重复的最小次数，m 是重复的最大次数</li>\n<li><code>\\&#123;n\\&#125;</code>，则表示“只重复 n 次”​</li>\n<li><code>\\&#123;n,\\&#125;</code>，则表示“至少重复 n 次”​</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>搜索压缩文件</strong></p>\n<ul>\n<li>zcat</li>\n<li>zgrep</li>\n</ul>\n</li>\n<li><p><strong>awk</strong></p>\n<ul>\n<li><p>反转每行单词</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ awk <span class=\"hljs-string\">&#x27;&#123;</span><br><span class=\"hljs-string\">    for (i=NF; i&gt;=0; i--) &#123;</span><br><span class=\"hljs-string\">        printf &quot;%s &quot;, $i;</span><br><span class=\"hljs-string\">    &#125;</span><br><span class=\"hljs-string\">    printf &quot;\\n&quot;</span><br><span class=\"hljs-string\">&#125;&#x27;</span> &lt;filename&gt;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>汇总数字列表</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## next 命令，它会停止处理该输入行，并从下一行输入重新开始</span><br><span class=\"hljs-built_in\">ls</span> -l | awk <span class=\"hljs-string\">&#x27;/^total/&#123;next&#125; &#123;sum += $5&#125;; END &#123;print sum&#125;&#x27;</span><br><br><span class=\"hljs-comment\">## tail +2 可实现同样的效果</span><br><span class=\"hljs-built_in\">ls</span> -l | <span class=\"hljs-built_in\">tail</span> +2 | awk <span class=\"hljs-string\">&#x27;/^total/&#123;next&#125; &#123;sum += $5&#125;; END &#123;print sum&#125;&#x27;</span><br></code></pre></td></tr></table></figure></li>\n<li><p>统计字符串出现次数</p>\n  <figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/usr/bin/awk -f</span><br><span class=\"hljs-comment\"># 实例文件：asar.awk</span><br><span class=\"hljs-comment\"># Awk关联数组</span><br><span class=\"hljs-comment\"># 用法：ls -lR /usr/local | asar.awk</span><br><br>NF &gt; <span class=\"hljs-number\">7</span> &#123;<br>    <span class=\"hljs-comment\">## 变量初始为空</span><br>    <span class=\"hljs-comment\">## ++ 变为 1</span><br>    user[<span class=\"hljs-variable\">$3</span>]++<br>&#125;<br><br><span class=\"hljs-keyword\">END</span> &#123;<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user) &#123;<br>        printf <span class=\"hljs-string\">&quot;%s owns %d files\\n&quot;</span>, i, user[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">ls</span> -lR /usr/local | awk -f asar.awk<br>bin owns 68 files<br>albing owns 1801 files<br>root owns 13755 files<br>man owns 11491 files<br>$<br></code></pre></td></tr></table></figure></li>\n<li><p>输出直方图</p>\n  <figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/usr/bin/awk -f</span><br><span class=\"hljs-comment\"># 实例文件：hist.awk</span><br><span class=\"hljs-comment\"># 用Awk生成直方图</span><br><span class=\"hljs-comment\"># 用法：ls -lR /usr/local | hist.awk</span><br><br><span class=\"hljs-keyword\">function</span> max(arr, big)<br>&#123;<br>    big = <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user)<br>    &#123;<br>        <span class=\"hljs-keyword\">if</span> (user[i] &gt; big) &#123; big=user[i];&#125;<br>    &#125;<br>    return big<br>&#125;<br><br>NF &gt; <span class=\"hljs-number\">7</span> &#123;<br>    user[<span class=\"hljs-variable\">$3</span>]++<br>&#125;<br><span class=\"hljs-keyword\">END</span> &#123;<br>    <span class=\"hljs-comment\"># 进行缩放</span><br>    maxm = max(user);<br>    <span class=\"hljs-keyword\">for</span> (i <span class=\"hljs-keyword\">in</span> user) &#123;<br>        <span class=\"hljs-comment\">#printf &quot;%s owns %d files\\n&quot;, i, user[i]</span><br>        scaled = <span class=\"hljs-number\">60</span> * user[i] / maxm ;<br>        printf <span class=\"hljs-string\">&quot;%-10.10s [%8d]:&quot;</span>, i, user[i]<br>        <span class=\"hljs-keyword\">for</span> (i=<span class=\"hljs-number\">0</span>; i&lt;scaled; i++) &#123;<br>            printf <span class=\"hljs-string\">&quot;#&quot;</span>;<br>        &#125;<br>        printf <span class=\"hljs-string\">&quot;\\n&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>\n<li><p>输出匹配词之后的文本</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> para.awk<br>/keyphrase/ &#123; flag=1 &#125;<br>flag == 1 &#123; <span class=\"hljs-built_in\">print</span> &#125;<br>/^$/ &#123; flag=0 &#125;<br><br>$ awk -f para.awk &lt; searchthis.txt<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>bash 关联数组</strong></p>\n</li>\n</ol>\n<blockquote>\n<p>其他语言中也称为散列或字典</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：cnt_owner</span><br><span class=\"hljs-comment\"># 使用bash统计文件所有者</span><br><span class=\"hljs-comment\"># 将“ls -l”的输出通过管道传入该脚本</span><br><br><span class=\"hljs-comment\">## 定义关联数组</span><br><span class=\"hljs-built_in\">declare</span> -A AACOUNT<br><span class=\"hljs-comment\">## -a 后的变量会被认为是数组，默认以空格为分割符</span><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span>  -a LSL<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-comment\"># 只考虑包含7个及以上字段的行</span><br>    <span class=\"hljs-keyword\">if</span> (( <span class=\"hljs-variable\">$&#123;#LSL[*]&#125;</span> &gt; <span class=\"hljs-number\">7</span> ))         <span class=\"hljs-comment\"># 数组大小</span><br>    <span class=\"hljs-keyword\">then</span><br>        NDX=<span class=\"hljs-variable\">$&#123;LSL[3]&#125;</span>               <span class=\"hljs-comment\"># 字符串赋值</span><br>        (( AACOUNT[<span class=\"hljs-variable\">$&#123;NDX&#125;</span>] += <span class=\"hljs-number\">1</span> ))  <span class=\"hljs-comment\"># 算术递增</span><br>    <span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-comment\">## $&#123;AACOUNT[@]&#125; 会生成数组所有元素值的列表，如果加上惊叹号变成$&#123;!AACOUNT[@]&#125;，则得到的是该数组所有索引的列表。</span><br><span class=\"hljs-keyword\">for</span> VALS <span class=\"hljs-keyword\">in</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;!AACOUNT[@]&#125;</span>&quot;</span>        <span class=\"hljs-comment\"># 各个元素的索引</span><br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$VALS</span> <span class=\"hljs-string\">&quot;owns&quot;</span> <span class=\"hljs-variable\">$&#123;AACOUNT[$VALS]&#125;</span> <span class=\"hljs-string\">&quot;files&quot;</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"8\">\n<li><strong>sort 排序</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sort</span> -r <span class=\"hljs-comment\"># reverse</span><br><span class=\"hljs-built_in\">sort</span> -f <span class=\"hljs-comment\"># 不区分大小写</span><br><span class=\"hljs-built_in\">sort</span> -n <span class=\"hljs-comment\"># 数值排序</span><br><span class=\"hljs-built_in\">sort</span> -u <span class=\"hljs-comment\"># 去掉重复输出</span><br></code></pre></td></tr></table></figure></li>\n</ol>\n<p>如果配合 <code>uniq -c</code> 使用，<code>sort -rn</code> 可以非常方便地给出一个按照降序排列的列表。</p>\n<blockquote>\n<p>uniq -d  只查看重复行</p>\n</blockquote>\n<ul>\n<li><p>IP地址排序</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## -t 选项用于指定字段之间的分隔符</span><br>$ <span class=\"hljs-built_in\">sort</span> -t . -k 1,1n -k 2,2n -k 3,3n -k 4,4n ipaddr.list<br>10.0.0.2<br>10.0.0.5<br>10.0.0.20<br>192.168.0.2<br>192.168.0.4<br>192.168.0.12<br></code></pre></td></tr></table></figure></li>\n</ul>\n<ol start=\"9\">\n<li><p><strong>tr</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">tr</span> <span class=\"hljs-string\">&#x27;;:.!?&#x27;</span> <span class=\"hljs-string\">&#x27;,&#x27;</span> &lt;other.punct &gt;commas.all<br><span class=\"hljs-comment\"># 将大写字母转换为小写字母</span><br><span class=\"hljs-built_in\">tr</span> <span class=\"hljs-string\">&#x27;A-Z&#x27;</span> <span class=\"hljs-string\">&#x27;a-z&#x27;</span> &lt;be.fore &gt;af.ter<br><span class=\"hljs-comment\"># 删除所有回车符</span><br><span class=\"hljs-built_in\">tr</span> -d <span class=\"hljs-string\">&#x27;\\r&#x27;</span> &lt;file.dos &gt;file.txt<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>wc</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">wc</span> data_file<br>5     15     60 data_file<br><span class=\"hljs-comment\"># 只显示行数</span><br>$ <span class=\"hljs-built_in\">wc</span> -l data_file<br>5 data_file<br><br><span class=\"hljs-comment\"># 只显示单词数</span><br>$ <span class=\"hljs-built_in\">wc</span> -w data_file<br>15 data_file<br><br><span class=\"hljs-comment\"># 只显示字符数（通常等同于字节数）</span><br>$ <span class=\"hljs-built_in\">wc</span> -c data_file<br>60 data_file<br><br><span class=\"hljs-comment\">## 输出数字及文件名</span><br><span class=\"hljs-built_in\">wc</span> -l data_file<br><span class=\"hljs-comment\">## 只输出数字</span><br><span class=\"hljs-built_in\">wc</span> -l &lt; data_file<br><span class=\"hljs-comment\"># 虽然也能只输出数字，但是cat增加了脚本运行开销</span><br><span class=\"hljs-built_in\">cat</span> data_file | <span class=\"hljs-built_in\">wc</span> -l<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>find</strong></p>\n<ul>\n<li><code>-delete</code></li>\n<li><code>-newermt</code></li>\n<li><code>-mtime</code></li>\n<li><code>-size</code></li>\n<li><code>-print0</code> 往往配合 <code>xargs -0</code></li>\n<li><code>-type</code></li>\n<li><code>-exec</code> <blockquote>\n<p>文件大小还包含了单位 k（千字节）​。如果单位是 c，则表示字节（或字符）​。如果使用 b 作为单位或者不写任何单位，则表示块。 <br>对于碰到的每个文件，先测试其是否为目录，如果是，才测试名称是否符合模式。 <br>所以 type放到name前面使用能略微提高搜索效率。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>locate</strong></p>\n</li>\n<li><p><strong>查找命令</strong></p>\n<ul>\n<li><code>which</code><ul>\n<li>在各版本linux表现不同，且不是内建命令</li>\n</ul>\n</li>\n<li><code>type -P</code><ul>\n<li>shell内建命令，命令不存在时不会输出错误消息，脚本中建议用</li>\n</ul>\n</li>\n<li><code>command -v/-V</code><ul>\n<li>shell内建命令，<code>v</code>找不到时不输出错误消息，<code>V</code>找不到时输出错误消息</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>函数参数及返回值</strong></p>\n<ul>\n<li>向函数内部的变量赋值</li>\n<li>用<code>echo</code>或<code>printf</code>将输出发送到标准输出，并用<code>$()</code>或者<code>``</code>调用函数<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：func_max.1</span><br><br><span class=\"hljs-comment\"># 定义函数：</span><br><span class=\"hljs-comment\">## 函数内部没有用local声明的变量都是全局变量</span><br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-function\"><span class=\"hljs-title\">max</span></span> ()<br>&#123;<br>    <span class=\"hljs-built_in\">local</span> HIDN<br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$1</span> -gt <span class=\"hljs-variable\">$2</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        BIGR=<span class=\"hljs-variable\">$1</span><br>    <span class=\"hljs-keyword\">else</span><br>        BIGR=<span class=\"hljs-variable\">$2</span><br>    <span class=\"hljs-keyword\">fi</span><br>    HIDN=5<br>&#125;<br><br><span class=\"hljs-comment\"># 实例文件：func_max.2</span><br><br><span class=\"hljs-comment\"># 定义函数：</span><br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-function\"><span class=\"hljs-title\">max</span></span> ()<br>&#123;<br>    <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-variable\">$1</span> -gt <span class=\"hljs-variable\">$2</span> ]<br>    <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$1</span><br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$2</span><br>    <span class=\"hljs-keyword\">fi</span><br>&#125;<br><span class=\"hljs-comment\"># 调用函数</span><br>max 10 20<br><span class=\"hljs-comment\"># 调用函数并将结果赋值给变量</span><br>BIGR=$(max 10 20)<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$BIGR</span><br><span class=\"hljs-comment\"># 调用函数并将结果赋值给变量</span><br>BIGR=`max 10 20`<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$BIGR</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>在函数中引用参数也是使用 $1、$2 等。但是，$0 保持不变，其中包含的还是所调用脚本的名称。</p>\n<p>$FUNCNAME 本身引用的是该数组的第 0 个元素，其中包含的是当前执行函数的名称。</p>\n<p>$FUNCNAME 仅存在于函数执行期间。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>信号捕获</strong><br>其实<code>-SIGKILL（-9）</code>无法捕获。该信号可以立刻“杀死”进程，压根没机会捕获。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 列出所有可捕获的信号</span><br><span class=\"hljs-built_in\">trap</span> -l<br><br><span class=\"hljs-comment\">## 第一个参数填捕获到对应信号后的行为</span><br><span class=\"hljs-comment\">## 比如捕获退出信号时清理临时文件</span><br><span class=\"hljs-built_in\">trap</span> <span class=\"hljs-string\">&quot;Clean tmp files&quot;</span> EXIT<br><br><span class=\"hljs-comment\">## 如果命令是被信号 signal number 终止的，则脚本的退出状态码为 128+signal number。</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>alias</strong></p>\n<ul>\n<li><code>&#39;&#39;</code> 单引号包括的变量会在执行别名命令时生效变量值</li>\n<li><code>&quot;&quot;</code> 双引号包括的变量，在设置别名时就会使值生效，写死<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 删除别名 h</span><br><span class=\"hljs-comment\">## \\ 可以使别名失效，防止有人将unalias命令设置成别名，如果有人将其设置为 : 就会使其失效</span><br>\\<span class=\"hljs-built_in\">unalias</span> h<br><span class=\"hljs-comment\">## 删除所有别名</span><br><span class=\"hljs-built_in\">unalias</span> -a <br><span class=\"hljs-comment\"># 定义别名时不允许使用参数，如 $1, $2</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>避开别名和函数</strong></p>\n<ul>\n<li>使用 bash shell 的 builtin 命令来忽略 shell 函数和别名，执行实际的内建命令。</li>\n<li>使用 <code>command</code> 命令来忽略 shell 函数和别名，并执行实际的外部命令。</li>\n<li>如果只是想避开别名扩展，但仍允许执行函数，在命令前加上 <code>\\</code> 前缀即可。<blockquote>\n<p>type -a cmd 会显示所有包含cmd命令的地方，如果是函数，还会显示出函数代码</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p><strong>计算已过去的时间</strong></p>\n<ul>\n<li>使用内建命令 <code>time</code> 或 bash 变量 <code>$SECONDS</code></li>\n<li><code>$SECONDS</code> 会记录 shell 启动以来的时长（秒数）​。如果为其赋值，那么随后在扩展该变量时，得到的值就是先前的赋值与赋值操作以后的时长（秒数）之和。</li>\n</ul>\n</li>\n<li><p><strong>自定义文件描述符及重定向</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将标准输出定向到 out.log文件</span><br><span class=\"hljs-built_in\">exec</span> 1&gt; out.log<br><span class=\"hljs-comment\"># 将错误输出重定向标准输出</span><br><span class=\"hljs-built_in\">exec</span> 2&gt;&amp;1<br><span class=\"hljs-comment\"># 定义文件描述符 3 输出到other.log文件</span><br><span class=\"hljs-built_in\">exec</span> 3&gt; other.log<br><span class=\"hljs-comment\"># 关闭文件描述符 3</span><br><span class=\"hljs-built_in\">exec</span> 3&gt;&amp;- <br><br><span class=\"hljs-comment\">## 函数也可重定向输出</span><br><span class=\"hljs-comment\"># 根据传进参数会分别进行输出，无需写迭代循环</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ERROUT</span></span>()&#123;<br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Error: %b\\n&quot;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$@</span>&quot;</span><br>&#125; &gt;&amp;2<br><span class=\"hljs-comment\">## printf 小技巧</span><br><span class=\"hljs-built_in\">test</span>=<span class=\"hljs-string\">&quot;a b c&quot;</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Print %b\\n&quot;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;test[@]&#125;</span>&quot;</span><br><span class=\"hljs-comment\">## 会打印三条输出</span><br><br></code></pre></td></tr></table></figure>\n\n<p>重定向的顺序通常很重要</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 标准输出被重定向到文件 my.file，然后标准错误被重定向到和标准输出相同的地方。所有的输出都会出现在 my.file 中</span><br>somecmd &gt;my.file 2&gt;&amp;1<br><span class=\"hljs-comment\"># 标准错误被重定向到标准输出（此时标准输出指向的是屏幕）​，然后标准输出被重定向到 my.file。因此，只有标准输出消息会出现在文件中，而错误消息仍旧会出现在屏幕上。</span><br>somecmd 2&gt;&amp;1 &gt;my.file<br><br>somecmd 2&gt;&amp;1 | othercmd<br><span class=\"hljs-comment\"># bash 4.x 版本中的一种便捷语法可以同时将标准输出和标准错误连入管道。</span><br>somecmd |&amp; othercmd<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>处理日期和时间</strong></p>\n<ul>\n<li><code>date</code></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将日期转为纪元秒格式</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&quot;20230113&quot;</span> <span class=\"hljs-string\">&quot;+%s&quot;</span> <br><span class=\"hljs-comment\"># 纪元秒格式转换需要加 @符号</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&quot;@1673000000&quot;</span><br><br><span class=\"hljs-comment\"># 更多形式查阅其他文档</span><br><span class=\"hljs-built_in\">date</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;today&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;tomorrow&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;yesterday&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;1 day ago&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:%M:%S %z&#x27;</span><br><span class=\"hljs-built_in\">date</span> -d <span class=\"hljs-string\">&#x27;-1 days&#x27;</span> <span class=\"hljs-string\">&#x27;+%Y-%m-%d %H:</span><br><span class=\"hljs-string\">%M:%S %z&#x27;</span><br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>printf</code><ul>\n<li><code>printf</code> 有一个二进制版本</li>\n<li>这里的<code>printf</code>指的是bash内建版本<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 输出日期</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;%(%F %T)T\\n&#x27;</span> <span class=\"hljs-string\">&#x27;-1&#x27;</span><br><span class=\"hljs-comment\"># 可以为变量赋值</span><br><span class=\"hljs-built_in\">printf</span> -v today <span class=\"hljs-string\">&#x27;%(%F)T&#x27;</span> <span class=\"hljs-string\">&#x27;-1&#x27;</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$today</span><br><span class=\"hljs-comment\"># 有两个特殊的参数值可以使用：-1代表当前时间，-2 代表 shell 被调用的时间。</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p><strong>比较文件</strong></p>\n<ul>\n<li>比较纯文本文件</li>\n<li>比较二进制文件</li>\n</ul>\n<p>通用方法：<br>以上两种文件都可以通过计算sha值来确认是否相同。</p>\n<p>比较纯文本文件比较简单，直接使用 <code>diff</code> 命令即可。<br>diff 常用选项：</p>\n<ul>\n<li><code>-b</code> 忽略空白行</li>\n<li><code>-c</code> 显示差异的上下文</li>\n<li><code>-u</code> 显示差异的上下文，并且显示差异的行号</li>\n<li><code>-y</code> 显示差异的上下行</li>\n<li><code>-B</code> 忽略大小写</li>\n<li><code>-i</code> 忽略大小写</li>\n<li><code>-q</code> 不显示差异的上下文</li>\n<li><code>-r</code> 递归比较目录</li>\n</ul>\n<p>diff 比较二进制文件不会显示太多信息，只会告诉两个文件不一样，需要使用 <code>cmp</code> 命令。</p>\n<p>或者通过解压word文档，用解压出来的xml文件进行对比。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 此行 sed可以将每个&lt;&gt;替换为自身加上换行符，从而将包含内容的行独立出来</span><br>sed -e <span class=\"hljs-string\">&#x27;s/&gt;/&gt;\\</span><br><span class=\"hljs-string\">/g; s/&lt;/\\</span><br><span class=\"hljs-string\">&lt;/g&#x27;</span> document.xml &gt; word.xml<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>word文档实际上是由里面的图片和xml文件压缩所得，可以尝试用zip解压出来看看</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"TMUX 基础操作","date":"2024-07-11T07:20:11.000Z","_content":"# TMUX\n\n- 三个概念\n  - session - 会话\n    - 每运行一次`tmux`会创建一个session\n  - window - 窗口\n    - 在session内按前缀键后，`c`键创建的就是一个window\n  - pane - 窗格\n    - 将window进行分割后得到的就是pane\n\n## 基础操作\n\n### 1. 会话外操作\n\n```bash\ntmux attach -t 0 ## 进入一个会话\ntmux ls ## 查看当前服务器的tmux会话\ntmux kill-session -t 0\ntmux kill-pane -t 0\ntmux kill-window -t 0\n\ntmux list-commands ## 显示tmux所有命令 \ntmux show-options -g ## 显示所有选项\n```\n\n### 2. 会话内操作\n\n默认前缀键`ctrl+b`\n\n> 以下操作都在某个tmux session中操作，需要先按前缀键\n\n`\"` 上下分屏\n\n`%`左右分屏\n\n`c`创建新窗口\n\n`d`暂时退出tmux窗口\n\n`s`列出会话，选择切换会话\n\n> 切换会话也可用`:` ，然后输入以下命令，可tab补全\n>\n> switch-client -t 0  \n>\n> attach-session -t 0 \n\n数字0-9切换窗口\n\n`z`放大缩小窗格\n\n`n`切换下一个窗口\n\n`p`切换上一个窗口\n\n`q`显示窗格编号，根据提示输入对应数字切换pane\n\n`o`切换到下一个窗格，方向键亦可\n\n`space`循环切换窗格布局\n\n`&`关闭当前窗口\n\n`[`开启复制模式\n\n`{`将pane布局往前移动\n\n`}`将pane布局往后移动\n\n`?`查看帮助页\n\n## 个性化\n\n> 以下配置将会修改\n>\n> ​\t前缀键为ctrl+x\n>\n> ​\t开启鼠标模式\n>\n> ​\t绑定kjhl为上下左右，类似vim\n>\n> ​\t设置vi风格模式，这样就可以使用`[`复制模式下`/`来查找输出信息的关键字\n\n修改配置文件` ~/.tmux.conf`\n\n```bash\nset -g prefix C-x\nunbind C-b\nbind C-x send-prefix\n#set swap pane key\nbind-key k select-pane -U\nbind-key j select-pane -D\nbind-key h select-pane -L\nbind-key l select-pane -R\nset-option -g mouse on\nsetw -g mode-keys vi\n```\n\n修改完配置文件后关掉session，重开就能生效了\n```bash\n## 或者也可用此命令生效\ntmux source-file ~/.tmux.conf\n```\n\n部分终端修改后可能无法复制，需要安装`xclip`，再修改配置文件\n\n```bash\napt install xclip\n```\n\n```bash\n# 启用鼠标支持\nset -g mouse on\n\n# 允许鼠标选择文本并复制\n# 启用这种模式后，你可以通过鼠标选择来复制文本\nbind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel \"xclip -in -selection clipboard\"\n```\n\n部分终端可能直接鼠标滚轮即可在pane中翻页，部分需要配合**shift键**才能翻页。","source":"_posts/tmux.md","raw":"---\ntitle: TMUX 基础操作\ndate: 2024-07-11 15:20:11\ntags: tools\n---\n# TMUX\n\n- 三个概念\n  - session - 会话\n    - 每运行一次`tmux`会创建一个session\n  - window - 窗口\n    - 在session内按前缀键后，`c`键创建的就是一个window\n  - pane - 窗格\n    - 将window进行分割后得到的就是pane\n\n## 基础操作\n\n### 1. 会话外操作\n\n```bash\ntmux attach -t 0 ## 进入一个会话\ntmux ls ## 查看当前服务器的tmux会话\ntmux kill-session -t 0\ntmux kill-pane -t 0\ntmux kill-window -t 0\n\ntmux list-commands ## 显示tmux所有命令 \ntmux show-options -g ## 显示所有选项\n```\n\n### 2. 会话内操作\n\n默认前缀键`ctrl+b`\n\n> 以下操作都在某个tmux session中操作，需要先按前缀键\n\n`\"` 上下分屏\n\n`%`左右分屏\n\n`c`创建新窗口\n\n`d`暂时退出tmux窗口\n\n`s`列出会话，选择切换会话\n\n> 切换会话也可用`:` ，然后输入以下命令，可tab补全\n>\n> switch-client -t 0  \n>\n> attach-session -t 0 \n\n数字0-9切换窗口\n\n`z`放大缩小窗格\n\n`n`切换下一个窗口\n\n`p`切换上一个窗口\n\n`q`显示窗格编号，根据提示输入对应数字切换pane\n\n`o`切换到下一个窗格，方向键亦可\n\n`space`循环切换窗格布局\n\n`&`关闭当前窗口\n\n`[`开启复制模式\n\n`{`将pane布局往前移动\n\n`}`将pane布局往后移动\n\n`?`查看帮助页\n\n## 个性化\n\n> 以下配置将会修改\n>\n> ​\t前缀键为ctrl+x\n>\n> ​\t开启鼠标模式\n>\n> ​\t绑定kjhl为上下左右，类似vim\n>\n> ​\t设置vi风格模式，这样就可以使用`[`复制模式下`/`来查找输出信息的关键字\n\n修改配置文件` ~/.tmux.conf`\n\n```bash\nset -g prefix C-x\nunbind C-b\nbind C-x send-prefix\n#set swap pane key\nbind-key k select-pane -U\nbind-key j select-pane -D\nbind-key h select-pane -L\nbind-key l select-pane -R\nset-option -g mouse on\nsetw -g mode-keys vi\n```\n\n修改完配置文件后关掉session，重开就能生效了\n```bash\n## 或者也可用此命令生效\ntmux source-file ~/.tmux.conf\n```\n\n部分终端修改后可能无法复制，需要安装`xclip`，再修改配置文件\n\n```bash\napt install xclip\n```\n\n```bash\n# 启用鼠标支持\nset -g mouse on\n\n# 允许鼠标选择文本并复制\n# 启用这种模式后，你可以通过鼠标选择来复制文本\nbind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel \"xclip -in -selection clipboard\"\n```\n\n部分终端可能直接鼠标滚轮即可在pane中翻页，部分需要配合**shift键**才能翻页。","slug":"tmux","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yw000wuhuq8krd0in4","content":"<h1 id=\"TMUX\"><a href=\"#TMUX\" class=\"headerlink\" title=\"TMUX\"></a>TMUX</h1><ul>\n<li>三个概念<ul>\n<li>session - 会话<ul>\n<li>每运行一次<code>tmux</code>会创建一个session</li>\n</ul>\n</li>\n<li>window - 窗口<ul>\n<li>在session内按前缀键后，<code>c</code>键创建的就是一个window</li>\n</ul>\n</li>\n<li>pane - 窗格<ul>\n<li>将window进行分割后得到的就是pane</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"基础操作\"><a href=\"#基础操作\" class=\"headerlink\" title=\"基础操作\"></a>基础操作</h2><h3 id=\"1-会话外操作\"><a href=\"#1-会话外操作\" class=\"headerlink\" title=\"1. 会话外操作\"></a>1. 会话外操作</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">tmux attach -t 0 <span class=\"hljs-comment\">## 进入一个会话</span><br>tmux <span class=\"hljs-built_in\">ls</span> <span class=\"hljs-comment\">## 查看当前服务器的tmux会话</span><br>tmux kill-session -t 0<br>tmux kill-pane -t 0<br>tmux kill-window -t 0<br><br>tmux list-commands <span class=\"hljs-comment\">## 显示tmux所有命令 </span><br>tmux show-options -g <span class=\"hljs-comment\">## 显示所有选项</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-会话内操作\"><a href=\"#2-会话内操作\" class=\"headerlink\" title=\"2. 会话内操作\"></a>2. 会话内操作</h3><p>默认前缀键<code>ctrl+b</code></p>\n<blockquote>\n<p>以下操作都在某个tmux session中操作，需要先按前缀键</p>\n</blockquote>\n<p><code>&quot;</code> 上下分屏</p>\n<p><code>%</code>左右分屏</p>\n<p><code>c</code>创建新窗口</p>\n<p><code>d</code>暂时退出tmux窗口</p>\n<p><code>s</code>列出会话，选择切换会话</p>\n<blockquote>\n<p>切换会话也可用<code>:</code> ，然后输入以下命令，可tab补全</p>\n<p>switch-client -t 0  </p>\n<p>attach-session -t 0 </p>\n</blockquote>\n<p>数字0-9切换窗口</p>\n<p><code>z</code>放大缩小窗格</p>\n<p><code>n</code>切换下一个窗口</p>\n<p><code>p</code>切换上一个窗口</p>\n<p><code>q</code>显示窗格编号，根据提示输入对应数字切换pane</p>\n<p><code>o</code>切换到下一个窗格，方向键亦可</p>\n<p><code>space</code>循环切换窗格布局</p>\n<p><code>&amp;</code>关闭当前窗口</p>\n<p><code>[</code>开启复制模式</p>\n<p><code>&#123;</code>将pane布局往前移动</p>\n<p><code>&#125;</code>将pane布局往后移动</p>\n<p><code>?</code>查看帮助页</p>\n<h2 id=\"个性化\"><a href=\"#个性化\" class=\"headerlink\" title=\"个性化\"></a>个性化</h2><blockquote>\n<p>以下配置将会修改</p>\n<p>​\t前缀键为ctrl+x</p>\n<p>​\t开启鼠标模式</p>\n<p>​\t绑定kjhl为上下左右，类似vim</p>\n<p>​\t设置vi风格模式，这样就可以使用<code>[</code>复制模式下<code>/</code>来查找输出信息的关键字</p>\n</blockquote>\n<p>修改配置文件<code> ~/.tmux.conf</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">set</span> -g prefix C-x<br>unbind C-b<br><span class=\"hljs-built_in\">bind</span> C-x send-prefix<br><span class=\"hljs-comment\">#set swap pane key</span><br>bind-key k select-pane -U<br>bind-key j select-pane -D<br>bind-key h select-pane -L<br>bind-key l select-pane -R<br>set-option -g mouse on<br>setw -g mode-keys vi<br></code></pre></td></tr></table></figure>\n\n<p>修改完配置文件后关掉session，重开就能生效了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 或者也可用此命令生效</span><br>tmux source-file ~/.tmux.conf<br></code></pre></td></tr></table></figure>\n\n<p>部分终端修改后可能无法复制，需要安装<code>xclip</code>，再修改配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">apt install xclip<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 启用鼠标支持</span><br><span class=\"hljs-built_in\">set</span> -g mouse on<br><br><span class=\"hljs-comment\"># 允许鼠标选择文本并复制</span><br><span class=\"hljs-comment\"># 启用这种模式后，你可以通过鼠标选择来复制文本</span><br><span class=\"hljs-built_in\">bind</span> -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel <span class=\"hljs-string\">&quot;xclip -in -selection clipboard&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>部分终端可能直接鼠标滚轮即可在pane中翻页，部分需要配合<strong>shift键</strong>才能翻页。</p>\n","excerpt":"","more":"<h1 id=\"TMUX\"><a href=\"#TMUX\" class=\"headerlink\" title=\"TMUX\"></a>TMUX</h1><ul>\n<li>三个概念<ul>\n<li>session - 会话<ul>\n<li>每运行一次<code>tmux</code>会创建一个session</li>\n</ul>\n</li>\n<li>window - 窗口<ul>\n<li>在session内按前缀键后，<code>c</code>键创建的就是一个window</li>\n</ul>\n</li>\n<li>pane - 窗格<ul>\n<li>将window进行分割后得到的就是pane</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"基础操作\"><a href=\"#基础操作\" class=\"headerlink\" title=\"基础操作\"></a>基础操作</h2><h3 id=\"1-会话外操作\"><a href=\"#1-会话外操作\" class=\"headerlink\" title=\"1. 会话外操作\"></a>1. 会话外操作</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">tmux attach -t 0 <span class=\"hljs-comment\">## 进入一个会话</span><br>tmux <span class=\"hljs-built_in\">ls</span> <span class=\"hljs-comment\">## 查看当前服务器的tmux会话</span><br>tmux kill-session -t 0<br>tmux kill-pane -t 0<br>tmux kill-window -t 0<br><br>tmux list-commands <span class=\"hljs-comment\">## 显示tmux所有命令 </span><br>tmux show-options -g <span class=\"hljs-comment\">## 显示所有选项</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-会话内操作\"><a href=\"#2-会话内操作\" class=\"headerlink\" title=\"2. 会话内操作\"></a>2. 会话内操作</h3><p>默认前缀键<code>ctrl+b</code></p>\n<blockquote>\n<p>以下操作都在某个tmux session中操作，需要先按前缀键</p>\n</blockquote>\n<p><code>&quot;</code> 上下分屏</p>\n<p><code>%</code>左右分屏</p>\n<p><code>c</code>创建新窗口</p>\n<p><code>d</code>暂时退出tmux窗口</p>\n<p><code>s</code>列出会话，选择切换会话</p>\n<blockquote>\n<p>切换会话也可用<code>:</code> ，然后输入以下命令，可tab补全</p>\n<p>switch-client -t 0  </p>\n<p>attach-session -t 0 </p>\n</blockquote>\n<p>数字0-9切换窗口</p>\n<p><code>z</code>放大缩小窗格</p>\n<p><code>n</code>切换下一个窗口</p>\n<p><code>p</code>切换上一个窗口</p>\n<p><code>q</code>显示窗格编号，根据提示输入对应数字切换pane</p>\n<p><code>o</code>切换到下一个窗格，方向键亦可</p>\n<p><code>space</code>循环切换窗格布局</p>\n<p><code>&amp;</code>关闭当前窗口</p>\n<p><code>[</code>开启复制模式</p>\n<p><code>&#123;</code>将pane布局往前移动</p>\n<p><code>&#125;</code>将pane布局往后移动</p>\n<p><code>?</code>查看帮助页</p>\n<h2 id=\"个性化\"><a href=\"#个性化\" class=\"headerlink\" title=\"个性化\"></a>个性化</h2><blockquote>\n<p>以下配置将会修改</p>\n<p>​\t前缀键为ctrl+x</p>\n<p>​\t开启鼠标模式</p>\n<p>​\t绑定kjhl为上下左右，类似vim</p>\n<p>​\t设置vi风格模式，这样就可以使用<code>[</code>复制模式下<code>/</code>来查找输出信息的关键字</p>\n</blockquote>\n<p>修改配置文件<code> ~/.tmux.conf</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">set</span> -g prefix C-x<br>unbind C-b<br><span class=\"hljs-built_in\">bind</span> C-x send-prefix<br><span class=\"hljs-comment\">#set swap pane key</span><br>bind-key k select-pane -U<br>bind-key j select-pane -D<br>bind-key h select-pane -L<br>bind-key l select-pane -R<br>set-option -g mouse on<br>setw -g mode-keys vi<br></code></pre></td></tr></table></figure>\n\n<p>修改完配置文件后关掉session，重开就能生效了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 或者也可用此命令生效</span><br>tmux source-file ~/.tmux.conf<br></code></pre></td></tr></table></figure>\n\n<p>部分终端修改后可能无法复制，需要安装<code>xclip</code>，再修改配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">apt install xclip<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 启用鼠标支持</span><br><span class=\"hljs-built_in\">set</span> -g mouse on<br><br><span class=\"hljs-comment\"># 允许鼠标选择文本并复制</span><br><span class=\"hljs-comment\"># 启用这种模式后，你可以通过鼠标选择来复制文本</span><br><span class=\"hljs-built_in\">bind</span> -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel <span class=\"hljs-string\">&quot;xclip -in -selection clipboard&quot;</span><br></code></pre></td></tr></table></figure>\n\n<p>部分终端可能直接鼠标滚轮即可在pane中翻页，部分需要配合<strong>shift键</strong>才能翻页。</p>\n"},{"title":"WSL 基础用法","date":"2024-08-04T06:40:41.000Z","_content":"\n# WSL 基础用法\n\n## 检查 WSL是否安装\n\n```powershell\n## 检查版本\nwsl --version\n```\n\n![wsl-version](../images/wsl-base/wsl-version.png)\n\n有输出如图则为已安装。\n\n## 安装 WSL\n\n> [旧版安装方式](https://learn.microsoft.com/zh-cn/windows/wsl/install-manual)\n\n安装 WSL 2 之前，必须启用“虚拟机平台”可选功能。\n\n运行如下命令：\n\n```powershell\ndism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart\n```\n\n必须运行 Windows 10 版本 2004 及更高版本（内部版本 19041 及更高版本）或 Windows 11 才能使用以下命令。 \n\n在管理员模式下打开 PowerShell 或 Windows 命令提示符，输入如下命令，然后重启计算机。\n\n```powershell\n# 此命令将启用运行 WSL 并安装 Linux 的 Ubuntu 发行版所需的功能\nwsl --install\n\n## 更新内核\n## Linux 内核更新包会安装最新版本的 WSL 2 Linux 内核，以便在 Windows 操作系统中运行 WSL\nwsl --update\n\n## 设置默认版本\nwsl --set-default-version 2\n```\n\n## 查看发行版本\n\n```powershell\n## 查看可安装发行版\nwsl --list --online\nwsl -l -o\n## 查看已安装发行版\nwsl -l -v\n```\n\n## 安装一个发行版\n\n```powershell\n## 可直接运行下载安装\nwsl --install -d <Distribution Name>\nwsl --install --web-download -d <Distribution Name>\n## 也可直接本地导入\n## docker导出的容器tar包可用在wsl\ndocker export $container -o $container.tar\nwsl --import centos D:\\wsl\\centos\\ .\\centos.tar\n```\n\n> [导入任意发行版](https://learn.microsoft.com/zh-cn/windows/wsl/use-custom-distro)\n\n## 操作虚拟机\n\n使用`wsl -l -v`可看到如图有四个已安装发行版\n\n![installed](../images/wsl-base/installed.png)\n\n```powershell\n## 进入centos版本linux\nwsl -d centos\n```\n\n要设置与 `wsl` 命令一起使用的默认 Linux 发行版，输入 `wsl -s ` 或 `wsl --set-default `。\n\n例如，从 PowerShell/CMD 输入 `wsl -s Debian`，将默认发行版设置为 Debian。 现在从 Powershell 运行 `wsl npm init` 将在 Debian 中运行 `npm init` 命令。\n\n## 修改 WSL配置\n\n1. 机器内配置\n\n   进入虚拟机后，运行`df -h`可以查看到宿主机的各个盘符都已挂载到该机器上。\n\n```bash\n## 默认不可用systemctl控制服务，需要WSL版本0.67.6以上\n## 默认windows访问wsl linux 以默认用户访问，因此无法访问root用户文件\n## 修改为可用systemd及默认root用户登录\ncat >> /etc/wsl.conf <<EOF\n[boot]\nsystemd=true\n[user]\ndefault=root\nEOF\n```\n\n2. WSL 全局配置\n\n   开启镜像ip地址，虚拟机地址会变更为宿主机同一个ip。\n\n```bash\ncat >>/mnt/c/Users/xxx/.wslconfig <<EOF\n[experimental]\nnetworkingMode=mirrored\nautoProxy=true\ndnsTunneling=true\nfirewall=true\nEOF\n```\n\n修改完配置文件后需要运行`wsl --shutdown`，并需要**间隔8秒**后再启动虚拟机。\n\n> [高级设置配置](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config)\n\n## 删除不需要的发行版\n\n```powershell\nwsl --unregister <Distro>\n```\n\n","source":"_posts/wsl-base.md","raw":"---\ntitle: WSL 基础用法\ndate: 2024-08-04 14:40:41\ntags: tools\n---\n\n# WSL 基础用法\n\n## 检查 WSL是否安装\n\n```powershell\n## 检查版本\nwsl --version\n```\n\n![wsl-version](../images/wsl-base/wsl-version.png)\n\n有输出如图则为已安装。\n\n## 安装 WSL\n\n> [旧版安装方式](https://learn.microsoft.com/zh-cn/windows/wsl/install-manual)\n\n安装 WSL 2 之前，必须启用“虚拟机平台”可选功能。\n\n运行如下命令：\n\n```powershell\ndism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart\n```\n\n必须运行 Windows 10 版本 2004 及更高版本（内部版本 19041 及更高版本）或 Windows 11 才能使用以下命令。 \n\n在管理员模式下打开 PowerShell 或 Windows 命令提示符，输入如下命令，然后重启计算机。\n\n```powershell\n# 此命令将启用运行 WSL 并安装 Linux 的 Ubuntu 发行版所需的功能\nwsl --install\n\n## 更新内核\n## Linux 内核更新包会安装最新版本的 WSL 2 Linux 内核，以便在 Windows 操作系统中运行 WSL\nwsl --update\n\n## 设置默认版本\nwsl --set-default-version 2\n```\n\n## 查看发行版本\n\n```powershell\n## 查看可安装发行版\nwsl --list --online\nwsl -l -o\n## 查看已安装发行版\nwsl -l -v\n```\n\n## 安装一个发行版\n\n```powershell\n## 可直接运行下载安装\nwsl --install -d <Distribution Name>\nwsl --install --web-download -d <Distribution Name>\n## 也可直接本地导入\n## docker导出的容器tar包可用在wsl\ndocker export $container -o $container.tar\nwsl --import centos D:\\wsl\\centos\\ .\\centos.tar\n```\n\n> [导入任意发行版](https://learn.microsoft.com/zh-cn/windows/wsl/use-custom-distro)\n\n## 操作虚拟机\n\n使用`wsl -l -v`可看到如图有四个已安装发行版\n\n![installed](../images/wsl-base/installed.png)\n\n```powershell\n## 进入centos版本linux\nwsl -d centos\n```\n\n要设置与 `wsl` 命令一起使用的默认 Linux 发行版，输入 `wsl -s ` 或 `wsl --set-default `。\n\n例如，从 PowerShell/CMD 输入 `wsl -s Debian`，将默认发行版设置为 Debian。 现在从 Powershell 运行 `wsl npm init` 将在 Debian 中运行 `npm init` 命令。\n\n## 修改 WSL配置\n\n1. 机器内配置\n\n   进入虚拟机后，运行`df -h`可以查看到宿主机的各个盘符都已挂载到该机器上。\n\n```bash\n## 默认不可用systemctl控制服务，需要WSL版本0.67.6以上\n## 默认windows访问wsl linux 以默认用户访问，因此无法访问root用户文件\n## 修改为可用systemd及默认root用户登录\ncat >> /etc/wsl.conf <<EOF\n[boot]\nsystemd=true\n[user]\ndefault=root\nEOF\n```\n\n2. WSL 全局配置\n\n   开启镜像ip地址，虚拟机地址会变更为宿主机同一个ip。\n\n```bash\ncat >>/mnt/c/Users/xxx/.wslconfig <<EOF\n[experimental]\nnetworkingMode=mirrored\nautoProxy=true\ndnsTunneling=true\nfirewall=true\nEOF\n```\n\n修改完配置文件后需要运行`wsl --shutdown`，并需要**间隔8秒**后再启动虚拟机。\n\n> [高级设置配置](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config)\n\n## 删除不需要的发行版\n\n```powershell\nwsl --unregister <Distro>\n```\n\n","slug":"wsl-base","published":1,"updated":"2024-08-08T00:55:28.795Z","comments":1,"layout":"post","photos":[],"_id":"clzkkh3yx000xuhuq2o058jx3","content":"<h1 id=\"WSL-基础用法\"><a href=\"#WSL-基础用法\" class=\"headerlink\" title=\"WSL 基础用法\"></a>WSL 基础用法</h1><h2 id=\"检查-WSL是否安装\"><a href=\"#检查-WSL是否安装\" class=\"headerlink\" title=\"检查 WSL是否安装\"></a>检查 WSL是否安装</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 检查版本</span><br>wsl <span class=\"hljs-literal\">--version</span><br></code></pre></td></tr></table></figure>\n\n<p><img src=\"/../images/wsl-base/wsl-version.png\" alt=\"wsl-version\"></p>\n<p>有输出如图则为已安装。</p>\n<h2 id=\"安装-WSL\"><a href=\"#安装-WSL\" class=\"headerlink\" title=\"安装 WSL\"></a>安装 WSL</h2><blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/install-manual\">旧版安装方式</a></p>\n</blockquote>\n<p>安装 WSL 2 之前，必须启用“虚拟机平台”可选功能。</p>\n<p>运行如下命令：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">dism.exe /online /<span class=\"hljs-built_in\">enable-feature</span> /featurename:VirtualMachinePlatform /all /norestart<br></code></pre></td></tr></table></figure>\n\n<p>必须运行 Windows 10 版本 2004 及更高版本（内部版本 19041 及更高版本）或 Windows 11 才能使用以下命令。 </p>\n<p>在管理员模式下打开 PowerShell 或 Windows 命令提示符，输入如下命令，然后重启计算机。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\"># 此命令将启用运行 WSL 并安装 Linux 的 Ubuntu 发行版所需的功能</span><br>wsl <span class=\"hljs-literal\">--install</span><br><br><span class=\"hljs-comment\">## 更新内核</span><br><span class=\"hljs-comment\">## Linux 内核更新包会安装最新版本的 WSL 2 Linux 内核，以便在 Windows 操作系统中运行 WSL</span><br>wsl <span class=\"hljs-literal\">--update</span><br><br><span class=\"hljs-comment\">## 设置默认版本</span><br>wsl <span class=\"hljs-literal\">--set-default-version</span> <span class=\"hljs-number\">2</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"查看发行版本\"><a href=\"#查看发行版本\" class=\"headerlink\" title=\"查看发行版本\"></a>查看发行版本</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 查看可安装发行版</span><br>wsl <span class=\"hljs-literal\">--list</span> <span class=\"hljs-literal\">--online</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-o</span><br><span class=\"hljs-comment\">## 查看已安装发行版</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-v</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"安装一个发行版\"><a href=\"#安装一个发行版\" class=\"headerlink\" title=\"安装一个发行版\"></a>安装一个发行版</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 可直接运行下载安装</span><br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">-d</span> &lt;Distribution Name&gt;<br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">--web-download</span> <span class=\"hljs-literal\">-d</span> &lt;Distribution Name&gt;<br><span class=\"hljs-comment\">## 也可直接本地导入</span><br><span class=\"hljs-comment\">## docker导出的容器tar包可用在wsl</span><br>docker export <span class=\"hljs-variable\">$container</span> <span class=\"hljs-literal\">-o</span> <span class=\"hljs-variable\">$container</span>.tar<br>wsl <span class=\"hljs-literal\">--import</span> centos D:\\wsl\\centos\\ .\\centos.tar<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/use-custom-distro\">导入任意发行版</a></p>\n</blockquote>\n<h2 id=\"操作虚拟机\"><a href=\"#操作虚拟机\" class=\"headerlink\" title=\"操作虚拟机\"></a>操作虚拟机</h2><p>使用<code>wsl -l -v</code>可看到如图有四个已安装发行版</p>\n<p><img src=\"/../images/wsl-base/installed.png\" alt=\"installed\"></p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 进入centos版本linux</span><br>wsl <span class=\"hljs-literal\">-d</span> centos<br></code></pre></td></tr></table></figure>\n\n<p>要设置与 <code>wsl</code> 命令一起使用的默认 Linux 发行版，输入 <code>wsl -s </code> 或 <code>wsl --set-default </code>。</p>\n<p>例如，从 PowerShell&#x2F;CMD 输入 <code>wsl -s Debian</code>，将默认发行版设置为 Debian。 现在从 Powershell 运行 <code>wsl npm init</code> 将在 Debian 中运行 <code>npm init</code> 命令。</p>\n<h2 id=\"修改-WSL配置\"><a href=\"#修改-WSL配置\" class=\"headerlink\" title=\"修改 WSL配置\"></a>修改 WSL配置</h2><ol>\n<li><p>机器内配置</p>\n<p>进入虚拟机后，运行<code>df -h</code>可以查看到宿主机的各个盘符都已挂载到该机器上。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 默认不可用systemctl控制服务，需要WSL版本0.67.6以上</span><br><span class=\"hljs-comment\">## 默认windows访问wsl linux 以默认用户访问，因此无法访问root用户文件</span><br><span class=\"hljs-comment\">## 修改为可用systemd及默认root用户登录</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/wsl.conf &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[boot]</span><br><span class=\"hljs-string\">systemd=true</span><br><span class=\"hljs-string\">[user]</span><br><span class=\"hljs-string\">default=root</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><p>WSL 全局配置</p>\n<p>开启镜像ip地址，虚拟机地址会变更为宿主机同一个ip。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt;/mnt/c/Users/xxx/.wslconfig &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[experimental]</span><br><span class=\"hljs-string\">networkingMode=mirrored</span><br><span class=\"hljs-string\">autoProxy=true</span><br><span class=\"hljs-string\">dnsTunneling=true</span><br><span class=\"hljs-string\">firewall=true</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n\n<p>修改完配置文件后需要运行<code>wsl --shutdown</code>，并需要<strong>间隔8秒</strong>后再启动虚拟机。</p>\n<blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config\">高级设置配置</a></p>\n</blockquote>\n<h2 id=\"删除不需要的发行版\"><a href=\"#删除不需要的发行版\" class=\"headerlink\" title=\"删除不需要的发行版\"></a>删除不需要的发行版</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">wsl <span class=\"hljs-literal\">--unregister</span> &lt;Distro&gt;<br></code></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<h1 id=\"WSL-基础用法\"><a href=\"#WSL-基础用法\" class=\"headerlink\" title=\"WSL 基础用法\"></a>WSL 基础用法</h1><h2 id=\"检查-WSL是否安装\"><a href=\"#检查-WSL是否安装\" class=\"headerlink\" title=\"检查 WSL是否安装\"></a>检查 WSL是否安装</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 检查版本</span><br>wsl <span class=\"hljs-literal\">--version</span><br></code></pre></td></tr></table></figure>\n\n<p><img src=\"/../images/wsl-base/wsl-version.png\" alt=\"wsl-version\"></p>\n<p>有输出如图则为已安装。</p>\n<h2 id=\"安装-WSL\"><a href=\"#安装-WSL\" class=\"headerlink\" title=\"安装 WSL\"></a>安装 WSL</h2><blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/install-manual\">旧版安装方式</a></p>\n</blockquote>\n<p>安装 WSL 2 之前，必须启用“虚拟机平台”可选功能。</p>\n<p>运行如下命令：</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">dism.exe /online /<span class=\"hljs-built_in\">enable-feature</span> /featurename:VirtualMachinePlatform /all /norestart<br></code></pre></td></tr></table></figure>\n\n<p>必须运行 Windows 10 版本 2004 及更高版本（内部版本 19041 及更高版本）或 Windows 11 才能使用以下命令。 </p>\n<p>在管理员模式下打开 PowerShell 或 Windows 命令提示符，输入如下命令，然后重启计算机。</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\"># 此命令将启用运行 WSL 并安装 Linux 的 Ubuntu 发行版所需的功能</span><br>wsl <span class=\"hljs-literal\">--install</span><br><br><span class=\"hljs-comment\">## 更新内核</span><br><span class=\"hljs-comment\">## Linux 内核更新包会安装最新版本的 WSL 2 Linux 内核，以便在 Windows 操作系统中运行 WSL</span><br>wsl <span class=\"hljs-literal\">--update</span><br><br><span class=\"hljs-comment\">## 设置默认版本</span><br>wsl <span class=\"hljs-literal\">--set-default-version</span> <span class=\"hljs-number\">2</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"查看发行版本\"><a href=\"#查看发行版本\" class=\"headerlink\" title=\"查看发行版本\"></a>查看发行版本</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 查看可安装发行版</span><br>wsl <span class=\"hljs-literal\">--list</span> <span class=\"hljs-literal\">--online</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-o</span><br><span class=\"hljs-comment\">## 查看已安装发行版</span><br>wsl <span class=\"hljs-literal\">-l</span> <span class=\"hljs-literal\">-v</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"安装一个发行版\"><a href=\"#安装一个发行版\" class=\"headerlink\" title=\"安装一个发行版\"></a>安装一个发行版</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 可直接运行下载安装</span><br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">-d</span> &lt;Distribution Name&gt;<br>wsl <span class=\"hljs-literal\">--install</span> <span class=\"hljs-literal\">--web-download</span> <span class=\"hljs-literal\">-d</span> &lt;Distribution Name&gt;<br><span class=\"hljs-comment\">## 也可直接本地导入</span><br><span class=\"hljs-comment\">## docker导出的容器tar包可用在wsl</span><br>docker export <span class=\"hljs-variable\">$container</span> <span class=\"hljs-literal\">-o</span> <span class=\"hljs-variable\">$container</span>.tar<br>wsl <span class=\"hljs-literal\">--import</span> centos D:\\wsl\\centos\\ .\\centos.tar<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/use-custom-distro\">导入任意发行版</a></p>\n</blockquote>\n<h2 id=\"操作虚拟机\"><a href=\"#操作虚拟机\" class=\"headerlink\" title=\"操作虚拟机\"></a>操作虚拟机</h2><p>使用<code>wsl -l -v</code>可看到如图有四个已安装发行版</p>\n<p><img src=\"/../images/wsl-base/installed.png\" alt=\"installed\"></p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\"><span class=\"hljs-comment\">## 进入centos版本linux</span><br>wsl <span class=\"hljs-literal\">-d</span> centos<br></code></pre></td></tr></table></figure>\n\n<p>要设置与 <code>wsl</code> 命令一起使用的默认 Linux 发行版，输入 <code>wsl -s </code> 或 <code>wsl --set-default </code>。</p>\n<p>例如，从 PowerShell&#x2F;CMD 输入 <code>wsl -s Debian</code>，将默认发行版设置为 Debian。 现在从 Powershell 运行 <code>wsl npm init</code> 将在 Debian 中运行 <code>npm init</code> 命令。</p>\n<h2 id=\"修改-WSL配置\"><a href=\"#修改-WSL配置\" class=\"headerlink\" title=\"修改 WSL配置\"></a>修改 WSL配置</h2><ol>\n<li><p>机器内配置</p>\n<p>进入虚拟机后，运行<code>df -h</code>可以查看到宿主机的各个盘符都已挂载到该机器上。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 默认不可用systemctl控制服务，需要WSL版本0.67.6以上</span><br><span class=\"hljs-comment\">## 默认windows访问wsl linux 以默认用户访问，因此无法访问root用户文件</span><br><span class=\"hljs-comment\">## 修改为可用systemd及默认root用户登录</span><br><span class=\"hljs-built_in\">cat</span> &gt;&gt; /etc/wsl.conf &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[boot]</span><br><span class=\"hljs-string\">systemd=true</span><br><span class=\"hljs-string\">[user]</span><br><span class=\"hljs-string\">default=root</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><p>WSL 全局配置</p>\n<p>开启镜像ip地址，虚拟机地址会变更为宿主机同一个ip。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt;&gt;/mnt/c/Users/xxx/.wslconfig &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">[experimental]</span><br><span class=\"hljs-string\">networkingMode=mirrored</span><br><span class=\"hljs-string\">autoProxy=true</span><br><span class=\"hljs-string\">dnsTunneling=true</span><br><span class=\"hljs-string\">firewall=true</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n\n<p>修改完配置文件后需要运行<code>wsl --shutdown</code>，并需要<strong>间隔8秒</strong>后再启动虚拟机。</p>\n<blockquote>\n<p><a href=\"https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config\">高级设置配置</a></p>\n</blockquote>\n<h2 id=\"删除不需要的发行版\"><a href=\"#删除不需要的发行版\" class=\"headerlink\" title=\"删除不需要的发行版\"></a>删除不需要的发行版</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs powershell\">wsl <span class=\"hljs-literal\">--unregister</span> &lt;Distro&gt;<br></code></pre></td></tr></table></figure>\n\n"},{"title":"搭建Docker本地仓库","date":"2024-08-11T07:38:32.000Z","_content":"\n# 搭建Docker本地仓库\n\n前提\n- 安装 docker\n- 熟悉 docker环境及基本操作\n\n## 容器化部署\n\n```bash\n# 联网环境下\n# 直接运行 registry镜像，本地没有会自动拉取\ndocker run -d -p 5000:5000 --name registry registry:2\n\n# 内网环境\n# 下载对应镜像 tar包传入内网环境\ndocker load -i registry.tar\n\n## 验证是否安装成功\n## 返回 {}表示成功\ncurl -s http://localhost:5000/v2/\n```\n\n## 推送镜像到本地仓库\n\n```bash\n## 修改镜像tag为本地仓库地址\ndocker tag $image localhost:5000/$image\n\n## 推送到本地仓库\ndocker push localhost:5000/$image\n\n## 拉取本地仓库镜像\ndocker pull localhost:5000/$image\n```\n\n## 持久化存储镜像\n```bash\ndocker run -d -p 5000:5000 --name registry -v /home/registry:/var/lib/registry registry:2\n```\n\n## 配置本地仓库HTTPS\n\n可以选择生成自签名证书或使用受信任的证书颁发机构 (CA) 签发的证书。\n\n### 生成自签名证书\n- `-newkey rsa:4096`：生成一个新的 RSA 私钥和证书请求，并使用 4096 位的密钥长度\n- `-nodes`：指定不对生成的私钥进行加密。如果不使用这个选项，需要为私钥设置一个密码。对于自动化使用，通常不设置密码。\n- `-sha256`：使用 SHA-256 哈希算法来生成证书。\n- `-keyout certs/domain.key`：指定生成的私钥文件的输出路径。\n- `-x509`：表示生成自签名的 X.509 证书。X.509 是一种标准格式，用于公钥证书。\n- `-days 365`：设置证书的有效期为 365 天，过期后需要更新。\n- `-out certs/domain.crt`：指定生成的自签名证书文件的输出路径。\n\n```bash\nmkdir -p /etc/certs\n\nopenssl req -newkey rsa:4096 -nodes -sha256 -keyout /etc/certs/domain.key -x509 -days 365 -out /etc/certs/domain.crt\n## 运行完会提示需要输入一些信息\n## Common Name是最重要的一个\n# 需要填写服务器的完全限定域名 (FQDN) 或 IP 地址。\n# 如果为 Registry 配置 HTTPS，必须匹配客户端将用来访问服务器的域名或 IP 地址\n# 比如本地localhost或者127.0.0.1\n```\n\n### registry 配置HTTPS\n\n- `REGISTRY_HTTP_ADDR=0.0.0.0:443`：配置 Registry 监听 HTTPS 请求\n- `REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt`：指定 SSL 证书路径\n- `REGISTRY_HTTP_TLS_KEY=/certs/domain.key`：指定 SSL 私钥路径\n\n```bash\ndocker run -d \\\n  -p 443:443 \\\n  --name registry \\\n  -v /etc/certs:/certs \\\n  -v /home/registry:/var/lib/registry \\\n  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\\n  registry:2\n```\n\n### 配置 Docker 客户端信任自签名证书\n\n如果使用的是自签名证书，Docker 客户端默认不会信任你生成的证书。\n\n需要将证书添加到 Docker 的信任列表。\n\n```bash\n## 之前生成证书 common name填的 localhost，因此在此处创建localhost\nmkdir -p /etc/docker/certs.d/localhost\ncp /etc/certs/domain.crt /etc/docker/certs.d/localhost/ca.crt\n```\n\n### 配置客户端的 insecure-registries\n\n如果不想配置证书，可以将 Registry 配置为 insecure-registry，但不推荐在生产环境中使用。\n\n```json\n{\n  \"insecure-registries\" : [\"localhost\"]\n}\n```\n重启docker即可生效\n\n```bash\ncurl -sSL -k https://localhost:443/v2/\n```\n\n### 使用反向代理\n\n可以使用反向代理来处理 HTTPS，而 Registry继续使用 HTTP\n\n```conf\nserver {\n    listen 443 ssl;\n    server_name yourdomain.com;\n\n    ssl_certificate /etc/nginx/certs/domain.crt;\n    ssl_certificate_key /etc/nginx/certs/domain.key;\n\n    location / {\n        proxy_pass http://localhost:5000;\n        # 容器化部署时改为容器名 \n        proxy_pass http://registry:5000;\n    }\n}\n```\n**容器化 nginx反向代理**\n```bash\n## 创建一个 bridge网络\ndocker create network proxy_network\n## 启动时 nginx和 registry两个容器都指定 proxy_network 网络\ndocker run -d --name nginx --network proxy_network -p 443:443 -v ~/nginx.conf:/etc/nginx/nginx.conf -v /etc/certs/:/etc/nginx/certs nginx:latest\n```\n\n\n## 设置仓库登陆认证\n\n### 安装 htpasswd\n```bash\nsudo apt-get install apache2-utils\nsudo yum install httpd-tools\n```\n\n### 创建认证文件\n```bash\nmkdir /etc/auth\nhtpasswd -Bc /etc/auth/htpasswd myuser\n## -B：使用 bcrypt 加密算法\n## -c：创建一个新的文件\n## /etc/auth/htpasswd：保存用户名和密码的文件路径。\n\n## 如果需要添加更多用户，不加 -c\nhtpasswd -B /etc/auth/htpasswd anotheruser\n```\n### 配置 Registry登陆认证\n\n```bash\ndocker run -d \\\n  -p 5000:5000 \\\n  --name registry \\\n  -v /etc/auth:/auth \\\n  -e \"REGISTRY_AUTH=htpasswd\" \\\n  -e \"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm\" \\\n  -e \"REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd\" \\\n  -v /home/registry:/var/lib/registry \\\n  registry:2\n# REGISTRY_AUTH=htpasswd：启用 htpasswd 认证\n# REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm：设置认证领域（可以随意设定）\n# REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd：指定 htpasswd 文件的路径。\n\n## 验证\ndocker login localhost:5000\n```\n\n\n## 通过api查看本地镜像\n\n> api 返回的信息为 json格式，可以配合linux的 `jq`命令进行筛选查看\n\n```bash\n## 获取所有镜像的名称\ncurl -sSL -k http://localhost:5000/v2/_catalog | jq\n\n## 返回输出\n{\n  \"repositories\": [\n    \"my-image1\",\n    \"my-image2\"\n  ]\n}\n\n## 设置认证后需要修改为如下命令，配合 jq使用提取信息 \ncurl -sSL -k -u $username:$passwd http://127.0.0.1:5000/v2/_catalog |jq -r \".repositories[]\"\n\n## 获取每个镜像的标签\ncurl http://localhost:5000/v2/$image/tags/list\ncurl -sSL -k -u $username:$passwd http://127.0.0.1:5000/v2/$image/tags/list\n\n## 镜像的新版本会靠前显示\n{\n  \"name\": \"my-image1\",\n  \"tags\": [\n    \"latest\",\n    \"v2.0\",\n    \"v1.0\"\n  ]\n}\n\n## 获取 digest信息\ncurl -u $username:$passwd -sSL -H \"Accept: application/vnd.docker.distribution.manifest.v2+json\" http://127.0.0.1:5000/v2/$image/manifests/$tag | jq -r \".config.digest\"\n\n## 通过delete方法删除对应镜像的 tag\ncurl -sSLf -k -X DELETE -u $username:$passwd http://127.0.0.1:5000/v2/$image/manifests/$digest\n\n## 清理未被引用的blobs\nregistry garbage-collect -m /etc/docker/registry/config.yml\n```\n","source":"_posts/docker-local-registry.md","raw":"---\ntitle: 搭建Docker本地仓库\ndate: 2024-08-11 15:38:32\ntags: docker\n---\n\n# 搭建Docker本地仓库\n\n前提\n- 安装 docker\n- 熟悉 docker环境及基本操作\n\n## 容器化部署\n\n```bash\n# 联网环境下\n# 直接运行 registry镜像，本地没有会自动拉取\ndocker run -d -p 5000:5000 --name registry registry:2\n\n# 内网环境\n# 下载对应镜像 tar包传入内网环境\ndocker load -i registry.tar\n\n## 验证是否安装成功\n## 返回 {}表示成功\ncurl -s http://localhost:5000/v2/\n```\n\n## 推送镜像到本地仓库\n\n```bash\n## 修改镜像tag为本地仓库地址\ndocker tag $image localhost:5000/$image\n\n## 推送到本地仓库\ndocker push localhost:5000/$image\n\n## 拉取本地仓库镜像\ndocker pull localhost:5000/$image\n```\n\n## 持久化存储镜像\n```bash\ndocker run -d -p 5000:5000 --name registry -v /home/registry:/var/lib/registry registry:2\n```\n\n## 配置本地仓库HTTPS\n\n可以选择生成自签名证书或使用受信任的证书颁发机构 (CA) 签发的证书。\n\n### 生成自签名证书\n- `-newkey rsa:4096`：生成一个新的 RSA 私钥和证书请求，并使用 4096 位的密钥长度\n- `-nodes`：指定不对生成的私钥进行加密。如果不使用这个选项，需要为私钥设置一个密码。对于自动化使用，通常不设置密码。\n- `-sha256`：使用 SHA-256 哈希算法来生成证书。\n- `-keyout certs/domain.key`：指定生成的私钥文件的输出路径。\n- `-x509`：表示生成自签名的 X.509 证书。X.509 是一种标准格式，用于公钥证书。\n- `-days 365`：设置证书的有效期为 365 天，过期后需要更新。\n- `-out certs/domain.crt`：指定生成的自签名证书文件的输出路径。\n\n```bash\nmkdir -p /etc/certs\n\nopenssl req -newkey rsa:4096 -nodes -sha256 -keyout /etc/certs/domain.key -x509 -days 365 -out /etc/certs/domain.crt\n## 运行完会提示需要输入一些信息\n## Common Name是最重要的一个\n# 需要填写服务器的完全限定域名 (FQDN) 或 IP 地址。\n# 如果为 Registry 配置 HTTPS，必须匹配客户端将用来访问服务器的域名或 IP 地址\n# 比如本地localhost或者127.0.0.1\n```\n\n### registry 配置HTTPS\n\n- `REGISTRY_HTTP_ADDR=0.0.0.0:443`：配置 Registry 监听 HTTPS 请求\n- `REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt`：指定 SSL 证书路径\n- `REGISTRY_HTTP_TLS_KEY=/certs/domain.key`：指定 SSL 私钥路径\n\n```bash\ndocker run -d \\\n  -p 443:443 \\\n  --name registry \\\n  -v /etc/certs:/certs \\\n  -v /home/registry:/var/lib/registry \\\n  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\\n  registry:2\n```\n\n### 配置 Docker 客户端信任自签名证书\n\n如果使用的是自签名证书，Docker 客户端默认不会信任你生成的证书。\n\n需要将证书添加到 Docker 的信任列表。\n\n```bash\n## 之前生成证书 common name填的 localhost，因此在此处创建localhost\nmkdir -p /etc/docker/certs.d/localhost\ncp /etc/certs/domain.crt /etc/docker/certs.d/localhost/ca.crt\n```\n\n### 配置客户端的 insecure-registries\n\n如果不想配置证书，可以将 Registry 配置为 insecure-registry，但不推荐在生产环境中使用。\n\n```json\n{\n  \"insecure-registries\" : [\"localhost\"]\n}\n```\n重启docker即可生效\n\n```bash\ncurl -sSL -k https://localhost:443/v2/\n```\n\n### 使用反向代理\n\n可以使用反向代理来处理 HTTPS，而 Registry继续使用 HTTP\n\n```conf\nserver {\n    listen 443 ssl;\n    server_name yourdomain.com;\n\n    ssl_certificate /etc/nginx/certs/domain.crt;\n    ssl_certificate_key /etc/nginx/certs/domain.key;\n\n    location / {\n        proxy_pass http://localhost:5000;\n        # 容器化部署时改为容器名 \n        proxy_pass http://registry:5000;\n    }\n}\n```\n**容器化 nginx反向代理**\n```bash\n## 创建一个 bridge网络\ndocker create network proxy_network\n## 启动时 nginx和 registry两个容器都指定 proxy_network 网络\ndocker run -d --name nginx --network proxy_network -p 443:443 -v ~/nginx.conf:/etc/nginx/nginx.conf -v /etc/certs/:/etc/nginx/certs nginx:latest\n```\n\n\n## 设置仓库登陆认证\n\n### 安装 htpasswd\n```bash\nsudo apt-get install apache2-utils\nsudo yum install httpd-tools\n```\n\n### 创建认证文件\n```bash\nmkdir /etc/auth\nhtpasswd -Bc /etc/auth/htpasswd myuser\n## -B：使用 bcrypt 加密算法\n## -c：创建一个新的文件\n## /etc/auth/htpasswd：保存用户名和密码的文件路径。\n\n## 如果需要添加更多用户，不加 -c\nhtpasswd -B /etc/auth/htpasswd anotheruser\n```\n### 配置 Registry登陆认证\n\n```bash\ndocker run -d \\\n  -p 5000:5000 \\\n  --name registry \\\n  -v /etc/auth:/auth \\\n  -e \"REGISTRY_AUTH=htpasswd\" \\\n  -e \"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm\" \\\n  -e \"REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd\" \\\n  -v /home/registry:/var/lib/registry \\\n  registry:2\n# REGISTRY_AUTH=htpasswd：启用 htpasswd 认证\n# REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm：设置认证领域（可以随意设定）\n# REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd：指定 htpasswd 文件的路径。\n\n## 验证\ndocker login localhost:5000\n```\n\n\n## 通过api查看本地镜像\n\n> api 返回的信息为 json格式，可以配合linux的 `jq`命令进行筛选查看\n\n```bash\n## 获取所有镜像的名称\ncurl -sSL -k http://localhost:5000/v2/_catalog | jq\n\n## 返回输出\n{\n  \"repositories\": [\n    \"my-image1\",\n    \"my-image2\"\n  ]\n}\n\n## 设置认证后需要修改为如下命令，配合 jq使用提取信息 \ncurl -sSL -k -u $username:$passwd http://127.0.0.1:5000/v2/_catalog |jq -r \".repositories[]\"\n\n## 获取每个镜像的标签\ncurl http://localhost:5000/v2/$image/tags/list\ncurl -sSL -k -u $username:$passwd http://127.0.0.1:5000/v2/$image/tags/list\n\n## 镜像的新版本会靠前显示\n{\n  \"name\": \"my-image1\",\n  \"tags\": [\n    \"latest\",\n    \"v2.0\",\n    \"v1.0\"\n  ]\n}\n\n## 获取 digest信息\ncurl -u $username:$passwd -sSL -H \"Accept: application/vnd.docker.distribution.manifest.v2+json\" http://127.0.0.1:5000/v2/$image/manifests/$tag | jq -r \".config.digest\"\n\n## 通过delete方法删除对应镜像的 tag\ncurl -sSLf -k -X DELETE -u $username:$passwd http://127.0.0.1:5000/v2/$image/manifests/$digest\n\n## 清理未被引用的blobs\nregistry garbage-collect -m /etc/docker/registry/config.yml\n```\n","slug":"docker-local-registry","published":1,"updated":"2024-08-12T06:18:21.129Z","_id":"clzpbf3wl0000ucuq78o31wqf","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"搭建Docker本地仓库\"><a href=\"#搭建Docker本地仓库\" class=\"headerlink\" title=\"搭建Docker本地仓库\"></a>搭建Docker本地仓库</h1><p>前提</p>\n<ul>\n<li>安装 docker</li>\n<li>熟悉 docker环境及基本操作</li>\n</ul>\n<h2 id=\"容器化部署\"><a href=\"#容器化部署\" class=\"headerlink\" title=\"容器化部署\"></a>容器化部署</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 联网环境下</span><br><span class=\"hljs-comment\"># 直接运行 registry镜像，本地没有会自动拉取</span><br>docker run -d -p 5000:5000 --name registry registry:2<br><br><span class=\"hljs-comment\"># 内网环境</span><br><span class=\"hljs-comment\"># 下载对应镜像 tar包传入内网环境</span><br>docker load -i registry.tar<br><br><span class=\"hljs-comment\">## 验证是否安装成功</span><br><span class=\"hljs-comment\">## 返回 &#123;&#125;表示成功</span><br>curl -s http://localhost:5000/v2/<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"推送镜像到本地仓库\"><a href=\"#推送镜像到本地仓库\" class=\"headerlink\" title=\"推送镜像到本地仓库\"></a>推送镜像到本地仓库</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 修改镜像tag为本地仓库地址</span><br>docker tag <span class=\"hljs-variable\">$image</span> localhost:5000/<span class=\"hljs-variable\">$image</span><br><br><span class=\"hljs-comment\">## 推送到本地仓库</span><br>docker push localhost:5000/<span class=\"hljs-variable\">$image</span><br><br><span class=\"hljs-comment\">## 拉取本地仓库镜像</span><br>docker pull localhost:5000/<span class=\"hljs-variable\">$image</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"持久化存储镜像\"><a href=\"#持久化存储镜像\" class=\"headerlink\" title=\"持久化存储镜像\"></a>持久化存储镜像</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d -p 5000:5000 --name registry -v /home/registry:/var/lib/registry registry:2<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置本地仓库HTTPS\"><a href=\"#配置本地仓库HTTPS\" class=\"headerlink\" title=\"配置本地仓库HTTPS\"></a>配置本地仓库HTTPS</h2><p>可以选择生成自签名证书或使用受信任的证书颁发机构 (CA) 签发的证书。</p>\n<h3 id=\"生成自签名证书\"><a href=\"#生成自签名证书\" class=\"headerlink\" title=\"生成自签名证书\"></a>生成自签名证书</h3><ul>\n<li><code>-newkey rsa:4096</code>：生成一个新的 RSA 私钥和证书请求，并使用 4096 位的密钥长度</li>\n<li><code>-nodes</code>：指定不对生成的私钥进行加密。如果不使用这个选项，需要为私钥设置一个密码。对于自动化使用，通常不设置密码。</li>\n<li><code>-sha256</code>：使用 SHA-256 哈希算法来生成证书。</li>\n<li><code>-keyout certs/domain.key</code>：指定生成的私钥文件的输出路径。</li>\n<li><code>-x509</code>：表示生成自签名的 X.509 证书。X.509 是一种标准格式，用于公钥证书。</li>\n<li><code>-days 365</code>：设置证书的有效期为 365 天，过期后需要更新。</li>\n<li><code>-out certs/domain.crt</code>：指定生成的自签名证书文件的输出路径。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mkdir</span> -p /etc/certs<br><br>openssl req -newkey rsa:4096 -nodes -sha256 -keyout /etc/certs/domain.key -x509 -days 365 -out /etc/certs/domain.crt<br><span class=\"hljs-comment\">## 运行完会提示需要输入一些信息</span><br><span class=\"hljs-comment\">## Common Name是最重要的一个</span><br><span class=\"hljs-comment\"># 需要填写服务器的完全限定域名 (FQDN) 或 IP 地址。</span><br><span class=\"hljs-comment\"># 如果为 Registry 配置 HTTPS，必须匹配客户端将用来访问服务器的域名或 IP 地址</span><br><span class=\"hljs-comment\"># 比如本地localhost或者127.0.0.1</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"registry-配置HTTPS\"><a href=\"#registry-配置HTTPS\" class=\"headerlink\" title=\"registry 配置HTTPS\"></a>registry 配置HTTPS</h3><ul>\n<li><code>REGISTRY_HTTP_ADDR=0.0.0.0:443</code>：配置 Registry 监听 HTTPS 请求</li>\n<li><code>REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt</code>：指定 SSL 证书路径</li>\n<li><code>REGISTRY_HTTP_TLS_KEY=/certs/domain.key</code>：指定 SSL 私钥路径</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d \\<br>  -p 443:443 \\<br>  --name registry \\<br>  -v /etc/certs:/certs \\<br>  -v /home/registry:/var/lib/registry \\<br>  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\<br>  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\<br>  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\<br>  registry:2<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置-Docker-客户端信任自签名证书\"><a href=\"#配置-Docker-客户端信任自签名证书\" class=\"headerlink\" title=\"配置 Docker 客户端信任自签名证书\"></a>配置 Docker 客户端信任自签名证书</h3><p>如果使用的是自签名证书，Docker 客户端默认不会信任你生成的证书。</p>\n<p>需要将证书添加到 Docker 的信任列表。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 之前生成证书 common name填的 localhost，因此在此处创建localhost</span><br><span class=\"hljs-built_in\">mkdir</span> -p /etc/docker/certs.d/localhost<br><span class=\"hljs-built_in\">cp</span> /etc/certs/domain.crt /etc/docker/certs.d/localhost/ca.crt<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置客户端的-insecure-registries\"><a href=\"#配置客户端的-insecure-registries\" class=\"headerlink\" title=\"配置客户端的 insecure-registries\"></a>配置客户端的 insecure-registries</h3><p>如果不想配置证书，可以将 Registry 配置为 insecure-registry，但不推荐在生产环境中使用。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>  <span class=\"hljs-attr\">&quot;insecure-registries&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-string\">&quot;localhost&quot;</span><span class=\"hljs-punctuation\">]</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>重启docker即可生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">curl -sSL -k https://localhost:443/v2/<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"使用反向代理\"><a href=\"#使用反向代理\" class=\"headerlink\" title=\"使用反向代理\"></a>使用反向代理</h3><p>可以使用反向代理来处理 HTTPS，而 Registry继续使用 HTTP</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs conf\">server &#123;<br>    listen 443 ssl;<br>    server_name yourdomain.com;<br><br>    ssl_certificate /etc/nginx/certs/domain.crt;<br>    ssl_certificate_key /etc/nginx/certs/domain.key;<br><br>    location / &#123;<br>        proxy_pass http://localhost:5000;<br>        # 容器化部署时改为容器名 <br>        proxy_pass http://registry:5000;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p><strong>容器化 nginx反向代理</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 创建一个 bridge网络</span><br>docker create network proxy_network<br><span class=\"hljs-comment\">## 启动时 nginx和 registry两个容器都指定 proxy_network 网络</span><br>docker run -d --name nginx --network proxy_network -p 443:443 -v ~/nginx.conf:/etc/nginx/nginx.conf -v /etc/certs/:/etc/nginx/certs nginx:latest<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"设置仓库登陆认证\"><a href=\"#设置仓库登陆认证\" class=\"headerlink\" title=\"设置仓库登陆认证\"></a>设置仓库登陆认证</h2><h3 id=\"安装-htpasswd\"><a href=\"#安装-htpasswd\" class=\"headerlink\" title=\"安装 htpasswd\"></a>安装 htpasswd</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> apt-get install apache2-utils<br><span class=\"hljs-built_in\">sudo</span> yum install httpd-tools<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"创建认证文件\"><a href=\"#创建认证文件\" class=\"headerlink\" title=\"创建认证文件\"></a>创建认证文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mkdir</span> /etc/auth<br>htpasswd -Bc /etc/auth/htpasswd myuser<br><span class=\"hljs-comment\">## -B：使用 bcrypt 加密算法</span><br><span class=\"hljs-comment\">## -c：创建一个新的文件</span><br><span class=\"hljs-comment\">## /etc/auth/htpasswd：保存用户名和密码的文件路径。</span><br><br><span class=\"hljs-comment\">## 如果需要添加更多用户，不加 -c</span><br>htpasswd -B /etc/auth/htpasswd anotheruser<br></code></pre></td></tr></table></figure>\n<h3 id=\"配置-Registry登陆认证\"><a href=\"#配置-Registry登陆认证\" class=\"headerlink\" title=\"配置 Registry登陆认证\"></a>配置 Registry登陆认证</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d \\<br>  -p 5000:5000 \\<br>  --name registry \\<br>  -v /etc/auth:/auth \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH=htpasswd&quot;</span> \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span> \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd&quot;</span> \\<br>  -v /home/registry:/var/lib/registry \\<br>  registry:2<br><span class=\"hljs-comment\"># REGISTRY_AUTH=htpasswd：启用 htpasswd 认证</span><br><span class=\"hljs-comment\"># REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm：设置认证领域（可以随意设定）</span><br><span class=\"hljs-comment\"># REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd：指定 htpasswd 文件的路径。</span><br><br><span class=\"hljs-comment\">## 验证</span><br>docker login localhost:5000<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"通过api查看本地镜像\"><a href=\"#通过api查看本地镜像\" class=\"headerlink\" title=\"通过api查看本地镜像\"></a>通过api查看本地镜像</h2><blockquote>\n<p>api 返回的信息为 json格式，可以配合linux的 <code>jq</code>命令进行筛选查看</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 获取所有镜像的名称</span><br>curl -sSL -k http://localhost:5000/v2/_catalog | jq<br><br><span class=\"hljs-comment\">## 返回输出</span><br>&#123;<br>  <span class=\"hljs-string\">&quot;repositories&quot;</span>: [<br>    <span class=\"hljs-string\">&quot;my-image1&quot;</span>,<br>    <span class=\"hljs-string\">&quot;my-image2&quot;</span><br>  ]<br>&#125;<br><br><span class=\"hljs-comment\">## 设置认证后需要修改为如下命令，配合 jq使用提取信息 </span><br>curl -sSL -k -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/_catalog |jq -r <span class=\"hljs-string\">&quot;.repositories[]&quot;</span><br><br><span class=\"hljs-comment\">## 获取每个镜像的标签</span><br>curl http://localhost:5000/v2/<span class=\"hljs-variable\">$image</span>/tags/list<br>curl -sSL -k -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/tags/list<br><br><span class=\"hljs-comment\">## 镜像的新版本会靠前显示</span><br>&#123;<br>  <span class=\"hljs-string\">&quot;name&quot;</span>: <span class=\"hljs-string\">&quot;my-image1&quot;</span>,<br>  <span class=\"hljs-string\">&quot;tags&quot;</span>: [<br>    <span class=\"hljs-string\">&quot;latest&quot;</span>,<br>    <span class=\"hljs-string\">&quot;v2.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;v1.0&quot;</span><br>  ]<br>&#125;<br><br><span class=\"hljs-comment\">## 获取 digest信息</span><br>curl -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> -sSL -H <span class=\"hljs-string\">&quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot;</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/manifests/<span class=\"hljs-variable\">$tag</span> | jq -r <span class=\"hljs-string\">&quot;.config.digest&quot;</span><br><br><span class=\"hljs-comment\">## 通过delete方法删除对应镜像的 tag</span><br>curl -sSLf -k -X DELETE -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/manifests/<span class=\"hljs-variable\">$digest</span><br><br><span class=\"hljs-comment\">## 清理未被引用的blobs</span><br>registry garbage-collect -m /etc/docker/registry/config.yml<br></code></pre></td></tr></table></figure>\n","excerpt":"","more":"<h1 id=\"搭建Docker本地仓库\"><a href=\"#搭建Docker本地仓库\" class=\"headerlink\" title=\"搭建Docker本地仓库\"></a>搭建Docker本地仓库</h1><p>前提</p>\n<ul>\n<li>安装 docker</li>\n<li>熟悉 docker环境及基本操作</li>\n</ul>\n<h2 id=\"容器化部署\"><a href=\"#容器化部署\" class=\"headerlink\" title=\"容器化部署\"></a>容器化部署</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 联网环境下</span><br><span class=\"hljs-comment\"># 直接运行 registry镜像，本地没有会自动拉取</span><br>docker run -d -p 5000:5000 --name registry registry:2<br><br><span class=\"hljs-comment\"># 内网环境</span><br><span class=\"hljs-comment\"># 下载对应镜像 tar包传入内网环境</span><br>docker load -i registry.tar<br><br><span class=\"hljs-comment\">## 验证是否安装成功</span><br><span class=\"hljs-comment\">## 返回 &#123;&#125;表示成功</span><br>curl -s http://localhost:5000/v2/<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"推送镜像到本地仓库\"><a href=\"#推送镜像到本地仓库\" class=\"headerlink\" title=\"推送镜像到本地仓库\"></a>推送镜像到本地仓库</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 修改镜像tag为本地仓库地址</span><br>docker tag <span class=\"hljs-variable\">$image</span> localhost:5000/<span class=\"hljs-variable\">$image</span><br><br><span class=\"hljs-comment\">## 推送到本地仓库</span><br>docker push localhost:5000/<span class=\"hljs-variable\">$image</span><br><br><span class=\"hljs-comment\">## 拉取本地仓库镜像</span><br>docker pull localhost:5000/<span class=\"hljs-variable\">$image</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"持久化存储镜像\"><a href=\"#持久化存储镜像\" class=\"headerlink\" title=\"持久化存储镜像\"></a>持久化存储镜像</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d -p 5000:5000 --name registry -v /home/registry:/var/lib/registry registry:2<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置本地仓库HTTPS\"><a href=\"#配置本地仓库HTTPS\" class=\"headerlink\" title=\"配置本地仓库HTTPS\"></a>配置本地仓库HTTPS</h2><p>可以选择生成自签名证书或使用受信任的证书颁发机构 (CA) 签发的证书。</p>\n<h3 id=\"生成自签名证书\"><a href=\"#生成自签名证书\" class=\"headerlink\" title=\"生成自签名证书\"></a>生成自签名证书</h3><ul>\n<li><code>-newkey rsa:4096</code>：生成一个新的 RSA 私钥和证书请求，并使用 4096 位的密钥长度</li>\n<li><code>-nodes</code>：指定不对生成的私钥进行加密。如果不使用这个选项，需要为私钥设置一个密码。对于自动化使用，通常不设置密码。</li>\n<li><code>-sha256</code>：使用 SHA-256 哈希算法来生成证书。</li>\n<li><code>-keyout certs/domain.key</code>：指定生成的私钥文件的输出路径。</li>\n<li><code>-x509</code>：表示生成自签名的 X.509 证书。X.509 是一种标准格式，用于公钥证书。</li>\n<li><code>-days 365</code>：设置证书的有效期为 365 天，过期后需要更新。</li>\n<li><code>-out certs/domain.crt</code>：指定生成的自签名证书文件的输出路径。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mkdir</span> -p /etc/certs<br><br>openssl req -newkey rsa:4096 -nodes -sha256 -keyout /etc/certs/domain.key -x509 -days 365 -out /etc/certs/domain.crt<br><span class=\"hljs-comment\">## 运行完会提示需要输入一些信息</span><br><span class=\"hljs-comment\">## Common Name是最重要的一个</span><br><span class=\"hljs-comment\"># 需要填写服务器的完全限定域名 (FQDN) 或 IP 地址。</span><br><span class=\"hljs-comment\"># 如果为 Registry 配置 HTTPS，必须匹配客户端将用来访问服务器的域名或 IP 地址</span><br><span class=\"hljs-comment\"># 比如本地localhost或者127.0.0.1</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"registry-配置HTTPS\"><a href=\"#registry-配置HTTPS\" class=\"headerlink\" title=\"registry 配置HTTPS\"></a>registry 配置HTTPS</h3><ul>\n<li><code>REGISTRY_HTTP_ADDR=0.0.0.0:443</code>：配置 Registry 监听 HTTPS 请求</li>\n<li><code>REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt</code>：指定 SSL 证书路径</li>\n<li><code>REGISTRY_HTTP_TLS_KEY=/certs/domain.key</code>：指定 SSL 私钥路径</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d \\<br>  -p 443:443 \\<br>  --name registry \\<br>  -v /etc/certs:/certs \\<br>  -v /home/registry:/var/lib/registry \\<br>  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\<br>  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\<br>  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\<br>  registry:2<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置-Docker-客户端信任自签名证书\"><a href=\"#配置-Docker-客户端信任自签名证书\" class=\"headerlink\" title=\"配置 Docker 客户端信任自签名证书\"></a>配置 Docker 客户端信任自签名证书</h3><p>如果使用的是自签名证书，Docker 客户端默认不会信任你生成的证书。</p>\n<p>需要将证书添加到 Docker 的信任列表。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 之前生成证书 common name填的 localhost，因此在此处创建localhost</span><br><span class=\"hljs-built_in\">mkdir</span> -p /etc/docker/certs.d/localhost<br><span class=\"hljs-built_in\">cp</span> /etc/certs/domain.crt /etc/docker/certs.d/localhost/ca.crt<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置客户端的-insecure-registries\"><a href=\"#配置客户端的-insecure-registries\" class=\"headerlink\" title=\"配置客户端的 insecure-registries\"></a>配置客户端的 insecure-registries</h3><p>如果不想配置证书，可以将 Registry 配置为 insecure-registry，但不推荐在生产环境中使用。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>  <span class=\"hljs-attr\">&quot;insecure-registries&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-string\">&quot;localhost&quot;</span><span class=\"hljs-punctuation\">]</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>重启docker即可生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">curl -sSL -k https://localhost:443/v2/<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"使用反向代理\"><a href=\"#使用反向代理\" class=\"headerlink\" title=\"使用反向代理\"></a>使用反向代理</h3><p>可以使用反向代理来处理 HTTPS，而 Registry继续使用 HTTP</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs conf\">server &#123;<br>    listen 443 ssl;<br>    server_name yourdomain.com;<br><br>    ssl_certificate /etc/nginx/certs/domain.crt;<br>    ssl_certificate_key /etc/nginx/certs/domain.key;<br><br>    location / &#123;<br>        proxy_pass http://localhost:5000;<br>        # 容器化部署时改为容器名 <br>        proxy_pass http://registry:5000;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p><strong>容器化 nginx反向代理</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 创建一个 bridge网络</span><br>docker create network proxy_network<br><span class=\"hljs-comment\">## 启动时 nginx和 registry两个容器都指定 proxy_network 网络</span><br>docker run -d --name nginx --network proxy_network -p 443:443 -v ~/nginx.conf:/etc/nginx/nginx.conf -v /etc/certs/:/etc/nginx/certs nginx:latest<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"设置仓库登陆认证\"><a href=\"#设置仓库登陆认证\" class=\"headerlink\" title=\"设置仓库登陆认证\"></a>设置仓库登陆认证</h2><h3 id=\"安装-htpasswd\"><a href=\"#安装-htpasswd\" class=\"headerlink\" title=\"安装 htpasswd\"></a>安装 htpasswd</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">sudo</span> apt-get install apache2-utils<br><span class=\"hljs-built_in\">sudo</span> yum install httpd-tools<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"创建认证文件\"><a href=\"#创建认证文件\" class=\"headerlink\" title=\"创建认证文件\"></a>创建认证文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mkdir</span> /etc/auth<br>htpasswd -Bc /etc/auth/htpasswd myuser<br><span class=\"hljs-comment\">## -B：使用 bcrypt 加密算法</span><br><span class=\"hljs-comment\">## -c：创建一个新的文件</span><br><span class=\"hljs-comment\">## /etc/auth/htpasswd：保存用户名和密码的文件路径。</span><br><br><span class=\"hljs-comment\">## 如果需要添加更多用户，不加 -c</span><br>htpasswd -B /etc/auth/htpasswd anotheruser<br></code></pre></td></tr></table></figure>\n<h3 id=\"配置-Registry登陆认证\"><a href=\"#配置-Registry登陆认证\" class=\"headerlink\" title=\"配置 Registry登陆认证\"></a>配置 Registry登陆认证</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker run -d \\<br>  -p 5000:5000 \\<br>  --name registry \\<br>  -v /etc/auth:/auth \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH=htpasswd&quot;</span> \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span> \\<br>  -e <span class=\"hljs-string\">&quot;REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd&quot;</span> \\<br>  -v /home/registry:/var/lib/registry \\<br>  registry:2<br><span class=\"hljs-comment\"># REGISTRY_AUTH=htpasswd：启用 htpasswd 认证</span><br><span class=\"hljs-comment\"># REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm：设置认证领域（可以随意设定）</span><br><span class=\"hljs-comment\"># REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd：指定 htpasswd 文件的路径。</span><br><br><span class=\"hljs-comment\">## 验证</span><br>docker login localhost:5000<br></code></pre></td></tr></table></figure>\n\n\n<h2 id=\"通过api查看本地镜像\"><a href=\"#通过api查看本地镜像\" class=\"headerlink\" title=\"通过api查看本地镜像\"></a>通过api查看本地镜像</h2><blockquote>\n<p>api 返回的信息为 json格式，可以配合linux的 <code>jq</code>命令进行筛选查看</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 获取所有镜像的名称</span><br>curl -sSL -k http://localhost:5000/v2/_catalog | jq<br><br><span class=\"hljs-comment\">## 返回输出</span><br>&#123;<br>  <span class=\"hljs-string\">&quot;repositories&quot;</span>: [<br>    <span class=\"hljs-string\">&quot;my-image1&quot;</span>,<br>    <span class=\"hljs-string\">&quot;my-image2&quot;</span><br>  ]<br>&#125;<br><br><span class=\"hljs-comment\">## 设置认证后需要修改为如下命令，配合 jq使用提取信息 </span><br>curl -sSL -k -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/_catalog |jq -r <span class=\"hljs-string\">&quot;.repositories[]&quot;</span><br><br><span class=\"hljs-comment\">## 获取每个镜像的标签</span><br>curl http://localhost:5000/v2/<span class=\"hljs-variable\">$image</span>/tags/list<br>curl -sSL -k -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/tags/list<br><br><span class=\"hljs-comment\">## 镜像的新版本会靠前显示</span><br>&#123;<br>  <span class=\"hljs-string\">&quot;name&quot;</span>: <span class=\"hljs-string\">&quot;my-image1&quot;</span>,<br>  <span class=\"hljs-string\">&quot;tags&quot;</span>: [<br>    <span class=\"hljs-string\">&quot;latest&quot;</span>,<br>    <span class=\"hljs-string\">&quot;v2.0&quot;</span>,<br>    <span class=\"hljs-string\">&quot;v1.0&quot;</span><br>  ]<br>&#125;<br><br><span class=\"hljs-comment\">## 获取 digest信息</span><br>curl -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> -sSL -H <span class=\"hljs-string\">&quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot;</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/manifests/<span class=\"hljs-variable\">$tag</span> | jq -r <span class=\"hljs-string\">&quot;.config.digest&quot;</span><br><br><span class=\"hljs-comment\">## 通过delete方法删除对应镜像的 tag</span><br>curl -sSLf -k -X DELETE -u <span class=\"hljs-variable\">$username</span>:<span class=\"hljs-variable\">$passwd</span> http://127.0.0.1:5000/v2/<span class=\"hljs-variable\">$image</span>/manifests/<span class=\"hljs-variable\">$digest</span><br><br><span class=\"hljs-comment\">## 清理未被引用的blobs</span><br>registry garbage-collect -m /etc/docker/registry/config.yml<br></code></pre></td></tr></table></figure>\n"},{"title":"Linux curl 基础用法","date":"2024-08-14T12:26:42.000Z","_content":"# Curl 基础用法\n\ncurl 是一个很全面的命令行浏览器，功能丰富\n\n## 基本用法\n- -f/--fail  在 HTTP 错误时返回非零状态码， echo $?, 不用-f即使HTTP错误状态码也为0\n- -s   静默输出\n- -S   输出错误消息，配合s使用，-sS，静默输出状态下也输出错误消息\n\n    -sSf 返回错误状态码 如：curl: (22) The requested URL returned error: 400\n\n\t不加S不会显示错误输出\n    \n- -k  忽略SSL证书验证\n- --connect-timeout: 设置连接超时的秒数。这是指从开始请求到完成 TCP 连接的时间限制。如果在指定时间内无法建立连接，curl 将会中止。\n- --max-time: 设置整个请求的最大时间（包括连接时间、传输时间等）。如果超过了这个时间，curl 将中止请求。\n- -H 添加header\n- -X GET/POST  指定请求方法\n- -u username:passwd  指定账号密码\n- -d 发送POST请求时附带的数据\n- -v 详细模式发送请求\n- -o 将下载的文件保存为指定文件名\n- -O 保存为原始文件名\n- -F 上传文件  header使用 Content-Type multipart/form-data\n- -C 断点续传\n- -I 显示响应码及源码\n- -i 只显示响应码\n- -c 记录cookie或session\n- -b 请求时使用携带的cookie\n\n## 使用示例\n\n```bash\n# post请求携带参数\ncurl -X POST -d \"key=value\" http://127.0.0.1\n\n# json 格式请求\ncurl -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 访问 https时忽略证书 \ncurl -sSfL -k https://127.0.0.1\n\n# 记录返回的cookie\ncurl -c cookies.txt -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 请求时携带文件中的cookie值\ncurl -b cookies.txt -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 表单上传文件\ncurl -X POST -F \"files=@/path/to/local/file\" http://127.0.0.1/upload-files\n\n# 如果请求返回是一个脚本，直接执行\ncurl -s http://127.0.0.1 -O- | bash\n```","source":"_posts/curl-action.md","raw":"---\ntitle: Linux curl 基础用法\ndate: 2024-08-14 20:26:42\ntags: linux\n---\n# Curl 基础用法\n\ncurl 是一个很全面的命令行浏览器，功能丰富\n\n## 基本用法\n- -f/--fail  在 HTTP 错误时返回非零状态码， echo $?, 不用-f即使HTTP错误状态码也为0\n- -s   静默输出\n- -S   输出错误消息，配合s使用，-sS，静默输出状态下也输出错误消息\n\n    -sSf 返回错误状态码 如：curl: (22) The requested URL returned error: 400\n\n\t不加S不会显示错误输出\n    \n- -k  忽略SSL证书验证\n- --connect-timeout: 设置连接超时的秒数。这是指从开始请求到完成 TCP 连接的时间限制。如果在指定时间内无法建立连接，curl 将会中止。\n- --max-time: 设置整个请求的最大时间（包括连接时间、传输时间等）。如果超过了这个时间，curl 将中止请求。\n- -H 添加header\n- -X GET/POST  指定请求方法\n- -u username:passwd  指定账号密码\n- -d 发送POST请求时附带的数据\n- -v 详细模式发送请求\n- -o 将下载的文件保存为指定文件名\n- -O 保存为原始文件名\n- -F 上传文件  header使用 Content-Type multipart/form-data\n- -C 断点续传\n- -I 显示响应码及源码\n- -i 只显示响应码\n- -c 记录cookie或session\n- -b 请求时使用携带的cookie\n\n## 使用示例\n\n```bash\n# post请求携带参数\ncurl -X POST -d \"key=value\" http://127.0.0.1\n\n# json 格式请求\ncurl -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 访问 https时忽略证书 \ncurl -sSfL -k https://127.0.0.1\n\n# 记录返回的cookie\ncurl -c cookies.txt -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 请求时携带文件中的cookie值\ncurl -b cookies.txt -X POST -d '{\"key\": \"value\"}' -H \"Content-Type: application/json\" http://127.0.0.1\n\n# 表单上传文件\ncurl -X POST -F \"files=@/path/to/local/file\" http://127.0.0.1/upload-files\n\n# 如果请求返回是一个脚本，直接执行\ncurl -s http://127.0.0.1 -O- | bash\n```","slug":"curl-action","published":1,"updated":"2024-10-16T09:54:30.211Z","_id":"clzvzj69d0000d0uqa9gd1zu4","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"Curl-基础用法\"><a href=\"#Curl-基础用法\" class=\"headerlink\" title=\"Curl 基础用法\"></a>Curl 基础用法</h1><p>curl 是一个很全面的命令行浏览器，功能丰富</p>\n<h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><ul>\n<li><p>-f&#x2F;–fail  在 HTTP 错误时返回非零状态码， echo $?, 不用-f即使HTTP错误状态码也为0</p>\n</li>\n<li><p>-s   静默输出</p>\n</li>\n<li><p>-S   输出错误消息，配合s使用，-sS，静默输出状态下也输出错误消息</p>\n<p>  -sSf 返回错误状态码 如：curl: (22) The requested URL returned error: 400</p>\n<p>  不加S不会显示错误输出</p>\n</li>\n<li><p>-k  忽略SSL证书验证</p>\n</li>\n<li><p>–connect-timeout: 设置连接超时的秒数。这是指从开始请求到完成 TCP 连接的时间限制。如果在指定时间内无法建立连接，curl 将会中止。</p>\n</li>\n<li><p>–max-time: 设置整个请求的最大时间（包括连接时间、传输时间等）。如果超过了这个时间，curl 将中止请求。</p>\n</li>\n<li><p>-H 添加header</p>\n</li>\n<li><p>-X GET&#x2F;POST  指定请求方法</p>\n</li>\n<li><p>-u username:passwd  指定账号密码</p>\n</li>\n<li><p>-d 发送POST请求时附带的数据</p>\n</li>\n<li><p>-v 详细模式发送请求</p>\n</li>\n<li><p>-o 将下载的文件保存为指定文件名</p>\n</li>\n<li><p>-O 保存为原始文件名</p>\n</li>\n<li><p>-F 上传文件  header使用 Content-Type multipart&#x2F;form-data</p>\n</li>\n<li><p>-C 断点续传</p>\n</li>\n<li><p>-I 显示响应码及源码</p>\n</li>\n<li><p>-i 只显示响应码</p>\n</li>\n<li><p>-c 记录cookie或session</p>\n</li>\n<li><p>-b 请求时使用携带的cookie</p>\n</li>\n</ul>\n<h2 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># post请求携带参数</span><br>curl -X POST -d <span class=\"hljs-string\">&quot;key=value&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># json 格式请求</span><br>curl -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 访问 https时忽略证书 </span><br>curl -sSfL -k https://127.0.0.1<br><br><span class=\"hljs-comment\"># 记录返回的cookie</span><br>curl -c cookies.txt -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 请求时携带文件中的cookie值</span><br>curl -b cookies.txt -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 表单上传文件</span><br>curl -X POST -F <span class=\"hljs-string\">&quot;files=@/path/to/local/file&quot;</span> http://127.0.0.1/upload-files<br><br><span class=\"hljs-comment\"># 如果请求返回是一个脚本，直接执行</span><br>curl -s http://127.0.0.1 -O- | bash<br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"Curl-基础用法\"><a href=\"#Curl-基础用法\" class=\"headerlink\" title=\"Curl 基础用法\"></a>Curl 基础用法</h1><p>curl 是一个很全面的命令行浏览器，功能丰富</p>\n<h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><ul>\n<li><p>-f&#x2F;–fail  在 HTTP 错误时返回非零状态码， echo $?, 不用-f即使HTTP错误状态码也为0</p>\n</li>\n<li><p>-s   静默输出</p>\n</li>\n<li><p>-S   输出错误消息，配合s使用，-sS，静默输出状态下也输出错误消息</p>\n<p>  -sSf 返回错误状态码 如：curl: (22) The requested URL returned error: 400</p>\n<p>  不加S不会显示错误输出</p>\n</li>\n<li><p>-k  忽略SSL证书验证</p>\n</li>\n<li><p>–connect-timeout: 设置连接超时的秒数。这是指从开始请求到完成 TCP 连接的时间限制。如果在指定时间内无法建立连接，curl 将会中止。</p>\n</li>\n<li><p>–max-time: 设置整个请求的最大时间（包括连接时间、传输时间等）。如果超过了这个时间，curl 将中止请求。</p>\n</li>\n<li><p>-H 添加header</p>\n</li>\n<li><p>-X GET&#x2F;POST  指定请求方法</p>\n</li>\n<li><p>-u username:passwd  指定账号密码</p>\n</li>\n<li><p>-d 发送POST请求时附带的数据</p>\n</li>\n<li><p>-v 详细模式发送请求</p>\n</li>\n<li><p>-o 将下载的文件保存为指定文件名</p>\n</li>\n<li><p>-O 保存为原始文件名</p>\n</li>\n<li><p>-F 上传文件  header使用 Content-Type multipart&#x2F;form-data</p>\n</li>\n<li><p>-C 断点续传</p>\n</li>\n<li><p>-I 显示响应码及源码</p>\n</li>\n<li><p>-i 只显示响应码</p>\n</li>\n<li><p>-c 记录cookie或session</p>\n</li>\n<li><p>-b 请求时使用携带的cookie</p>\n</li>\n</ul>\n<h2 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># post请求携带参数</span><br>curl -X POST -d <span class=\"hljs-string\">&quot;key=value&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># json 格式请求</span><br>curl -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 访问 https时忽略证书 </span><br>curl -sSfL -k https://127.0.0.1<br><br><span class=\"hljs-comment\"># 记录返回的cookie</span><br>curl -c cookies.txt -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 请求时携带文件中的cookie值</span><br>curl -b cookies.txt -X POST -d <span class=\"hljs-string\">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span> -H <span class=\"hljs-string\">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1<br><br><span class=\"hljs-comment\"># 表单上传文件</span><br>curl -X POST -F <span class=\"hljs-string\">&quot;files=@/path/to/local/file&quot;</span> http://127.0.0.1/upload-files<br><br><span class=\"hljs-comment\"># 如果请求返回是一个脚本，直接执行</span><br>curl -s http://127.0.0.1 -O- | bash<br></code></pre></td></tr></table></figure>"},{"title":"Shell 实用技巧（三）","date":"2024-08-15T02:53:19.000Z","_content":"1. **getopts**\n    - `getopts` 是一个内建命令，用于处理命令行选项。\n    - 它可以让脚本在运行时接受命令行参数。\n    - 它的语法是：`getopts optstring variable`。\n    - `optstring` 填入选项字符，如 `abc` 表示选项 a、b 和 c 是合法的选项。\n    - 如果是必填项要在选项后面加冒号，如`a:bc`\n    - 对于接受参数的选项，参数会保存在 shell 变量 `$OPTARG`中\n    - 当选项是不需要输入参数的时候，`$OPTARG`为空\n    - `$OPTIND` 初始值为1，每解析一个选项，`$OPTIND` 会加1\n    \n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：getopts_example\n    #\n    # getopts用法\n    #\n    aflag=\n    bflag=\n    while getopts 'ab:' OPTION\n    do\n        case $OPTION in\n            a) aflag=1\n            ;;\n            b) bflag=1\n            bval=\"$OPTARG\"\n            ;;\n            ?) printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/} >&2\n            exit 2\n            ;;\n        esac\n    done\n\n    shift $(($OPTIND - 1))\n\n    if [ \"$aflag\" ]\n    then\n        printf \"Option -a specified\\n\"\n    fi\n    if [ \"$bflag\" ]\n    then\n        printf 'Option -b \"%s\" specified\\n' \"$bval\"\n    fi\n    printf \"Remaining arguments are: %s\\n\" \"$*\"\n\n    myscript -a -b alt plow harvest reap\n    ## 这里解析完选项后 $OPTIND 为 4, 因此$OPTIND - 1，丢弃解析过的选项，剩余的参数为 plow harvest reap\n    ```\n    - 如果想让脚本输出自己自定义的错误信息，需要在 `getopts` 选项列表前加上`:`, 如`:ab:c` 使`getopts`不输出错误消息\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：getopts_custom\n    #\n    # 解析参数时使用自定义错误消息\n    #\n    aflag=\n    bflag=\n    while getopts :ab: FOUND\n    do\n        case $FOUND in\n            a) aflag=1\n            ;;\n            b) bflag=1\n            bval=\"$OPTARG\"\n                ;;\n            # 缺少参数返回 :\n            \\:) printf \"argument missing from -%s option\\n\" $OPTARG\n                printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/}\n                exit 2\n                ;;\n            # 不支持的选项返回 ?\n            \\?) printf \"unknown option: -%s\\n\" $OPTARG\n                printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/}\n                exit 2\n                ;;\n            esac >&2\n        done\n    shift $(($OPTIND - 1))\n    ```\n2. **用read解析文本**\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：parseViaRead\n    #\n    # 用read语句解析ls -l的输出\n    # ls -l的输出类似于以下这样：\n    # -rw-r--r--  1 albing users 126 2006-10-10 22:50 fnsize\n\n    ls -l \"$1\" | { read PERMS LCOUNT OWNER GROUP SIZE CRDATE CRTIME FILE ;\n    echo $FILE has $LCOUNT 'link(s)' and is $SIZE bytes long. ;\n    }\n\n    # read 将各单词读入数组变量\n    read -a MYRAY\n    ```\n\n3. **读取整个文件**\n    > mapfile 和 readarray\n    >\n    > 能够将整个文件读入数组，每个数组元素对应文件中的一行\n\n    ```bash\n    mapfile -t -s 1 -n 1500 -C showprg -c 100 BIGDATA < /tmp/myfile.data\n    # -s 1 跳过第一行输入\n    # -n 1500 读取 1500行\n    # -t 删除每行行尾的换行符\n    # -c 100 每读取 100行调用一次用户自定义函数 showprg, 默认每 5000行调用一次\n    # 结果放进数组 BIGDATA\n    ```\n\n4. **每次提取一个字符**\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：onebyone\n    #\n    # 从输入中一次解析一个字符\n\n    while read ALINE\n    do\n        for ((i=0; i < ${#ALINE}; i++))\n        do\n            ACHAR=${ALINE:i:1}\n            # 在这里执行某些操作，如echo $ACHAR\n            echo $ACHAR\n        done\n    done\n    ```\n5. **提取数据中的特定字段**\n\n    - `cut`\n    - `awk`\n    - `grep -o` 正则提取\n\n    ```bash\n    cut -d: -f1,6,7 /etc/passwd\n    cut -d: -f1-3\n\n    # 默认输出分隔符是空格，通过 OFS变量修改\n    awk 'BEGIN{FS=\":\"; OFS=\"\\t\"} {print $1 $7 $6}' /etc/passwd\n\n    ## ip地址提取\n    ip a | grep -oP '([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])'\n    ```\n\n6. **更新文件中的特定字段**\n\n    ```bash\n    $ grep csh /etc/passwd\n    root:*:0:0:Charlie &:/root:/bin/csh\n\n    $ sed 's;/csh$;/sh;' /etc/passwd | grep '^root'\n    root:*:0:0:Charlie &:/root:/bin/sh\n\n    # 对字段进行运算或修改特定字段中的内容\n    $ cat data_file\n    Line 1 ends\n    Line 2 ends\n    Line 3 ends\n    Line 4 ends\n    Line 5 ends\n\n    $ awk '{print $1, $2+5, $3}' data_file\n    Line 6 ends\n    Line 7 ends\n    Line 8 ends\n    Line 9 ends\n    Line 10 ends\n    # 如果第2个字段中包含'3'，将其修改为'8'并做标记\n    $ awk '{ if ($2 == \"3\") print $1, $2+5, $3, \"Tweaked\" ; else print $0; }' \\\n    data_file\n    Line 1 ends\n    Line 2 ends\n    Line 8 ends Tweaked\n    Line 4 ends\n    Line 5 ends\n    ```\n\n7. **修剪空白字符**\n    - `shopt -s extglob` 开启扩展通配符匹配\n    - 利用 `read`的设计方法\n    - `${##} 或 ${%%}` 变量字符串切割\n\n    ```bash\n    shopt -s extglob\n    ## 开启后可以用 +(), 匹配多个空格符\n    ${line##+([[:space:]])}\n    ${line%%+([[:space:]])}\n\n    shopt -s extglob\n\n    while IFS= read -r line; do\n    echo \"None: $line\" # 保留所有的空白字符\n    echo \"Ld: ${line##+([[:space:]])}\" # 修剪行首空白字符\n    echo \"Tr: ${line%%+([[:space:]])}\" # 修剪行尾空白字符\n    line=\"${line##+([[:space:]])}\" # 修剪行首和……\n    line=\"${line%%+([[:space:]])}\" # ……行尾的空白字符\n    echo \"All: $line\" # 显示修剪后的内容\n    done < whitespace\n    ```\n\n8. **编写安全的shell脚本**\n\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：security_template\n\n    # 设置合理的/安全的路径\n    PATH='/usr/local/bin:/bin:/usr/bin'\n    # 确保导出$PATH\n    \\export PATH\n\n    # 清除所有别名。切记：开头的\\用于禁止别名扩展\n    \\unalias -a\n\n    # 清除命令路径散列\n    hash -r\n\n    # 将硬性限制设置为0，关闭核心转储（core dumps）\n    ulimit -H -c 0 --\n\n    # 设置合理的/安全的IFS（注意，这里使用的语法仅适用于bash和ksh93，不具备可移植性！）\n    IFS=$' \\t\\n'\n\n    # 设置并使用合理的/安全的umask变量\n    # 注意，这不会影响已经在命令行上重定向的文件\n    # 022产生0755权限，077产生0700权限……\n    UMASK=022\n    umask $UMASK\n\n    until [ -n \"$temp_dir\" -a ! -d \"$temp_dir\" ]; do\n        temp_dir=\"/tmp/meaningful_prefix.${RANDOM}${RANDOM}${RANDOM}\"\n    done\n    mkdir -p -m 0700 $temp_dir \\\n    || (echo \"FATAL: Failed to create temp dir '$temp_dir': $?\"; exit 100)\n\n    # 尽全力清除临时文件\n    # 注意，一定要先设置好$temp_dir，千万不要修改！\n    cleanup=\"rm -rf $temp_dir\"\n    trap \"$cleanup\" ABRT EXIT HUP INT QUIT\n    ```\n9. **脚本重定向输出**\n\n    exec 通常会使用其参数所指定的命令来替换正在运行的 shell\n\n    ```bash\n    # 保存旧的STDERR\n    exec 3>&2\n\n    # 将所有发往STDERR的输出重定向到错误日志文件\n    exec 2> /path/to/error_log\n\n    # 通过还原STDERR并关闭文件句柄3来停止重定向\n    exec 2>&3-\n    ```\n\n10. **Argument list too long**\n\n    使用 xargs 命令（可能还要配合 find）来拆分参数列表。\n    \n    find -print0 配合 xargs -0。可以使 find 使用空字符（文件名中不会出现这种字符）代替空白字符作为输出记录分隔符，xargs 使用空字符作为输入记录分隔符。这样能正确地解析包含怪异字符的文件名。\n\n    ARG_MAX 限制了 exec* 系列系统调用的总空间需求，内核以此知道它必须分配的最大缓冲区。execve 的 3 个参数是：程序名称、参数向量和环境。\n\n    ```bash\n    ## 查看系统限制值\n    getconf ARG_MAX\n    getconf LINE_MAX\n    ```\n\n11. **自定义提示符**\n\n    提示字符串分别为 $PS0、$PS1、$PS2、$PS3、$PS4\n\n    ```bash\n    # 实例文件：prompts\n\n    # 用户名@短格式主机名、日期和时间，以及当前工作目录（CWD）：\n    export PS1='[\\u@\\h \\d \\A] \\w \\$ '\n\n    # 用户名@长格式主机名、ISO 8601格式的日期和时间、当前工作目录的基本名称（\\W）:\n    export PS1='[\\u@\\H \\D{%Y-%m-%d %H:%M:%S%z}] \\W \\$ '\n\n    # 用户名@短格式主机名、bash版本号，以及当前工作目录（\\w）：\n    export PS1='[\\u@\\h \\V \\w] \\$ '\n\n    # 换行符、用户名@短格式主机名、基本PTY、shell层级、历史编号、换行符，以及完整的工作\n    目录名称（$PWD）：\n    export PS1='\\n[\\u@\\h \\l:$SHLVL:\\!]\\n$PWD\\$ '\n\n    # 用户名@短格式主机名、上一个命令的退出状态，以及当前工作目录：\n    export PS1='[\\u@\\h $? \\w \\$ '\n\n    # 换行符、用户名@短格式主机名，以及后台作业数：\n    export PS1='\\n[\\u@\\h jobs:\\j]\\n$PWD\\$ '\n\n    # 换行符、用户名@短格式主机名、终端、shell层级、历史编号、作业数量、bash版本号，以\n    及完整的工作目录：\n    export PS1='\\n[\\u@\\h t:\\l l:$SHLVL h:\\! j:\\j v:\\V]\\n$PWD\\$ '\n\n    # 换行符、用户名@短格式主机名、代表终端的T、代表shell层级的L、代表命令编号的C，以及\n    ISO 8601格式的日期和时间：\n    export PS1='\\n[\\u@\\h:T\\l:L$SHLVL:C\\!:\\D{%Y-%m-%d_%H:%M:%S_%Z}]\\n$PWD\\$ '\n\n    # 用户名@短格式主机名、浅蓝色的当前工作目录：\n    export PS1='\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] '\n\n    # 在xterm的标题栏和提示符中同时显示用户名@短格式主机名、当前工作目录：\n    export PS1='\\[\\033]0;\\u@\\h:\\w\\007\\][\\u@\\h:\\w]\\$ '\n\n    # 同时更新颜色和xterm：\n    export PS1='\\[\\033]0;\\u@\\h:\\w\\007\\]\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] '\n    ```\n\n12. **设置$CDPATH**\n\n    CDPATH 是一个以冒号为分隔符的目录列表，用作内建命令 cd 的搜索路径​。可以将它看作 cd 的 $PATH。\n    ```bash\n    CDPATH='.:/etc:/usr'\n    ```\n\n13. **在会话间同步shell历史记录**\n\n```bash\n# 将当前历史记录追加到历史文件\nhistory -a \n\n# 将历史记录读入当前shell\nhistory -n\n\nHISTTIMEFORMAT='%Y-%m-%d_%H:%M:%S; '\n\nHISTTIMEFORMAT=': %Y-%m-%d_%H:%M:%S; '\n```\n\n14. **批量解压ZIP文件**\n\n```bash\nunzip '*.zip'\n\nfor x in /path/to/date*/name/*.zip; do unzip \"$x\"; done\n\nfor x in $(ls /path/to/date*/name/*.zip 2>/dev/null); do unzip $x; done\n```\n\n15. **获取文件元数据**\n\n- (-path /proc -o -path...) -prune 用于去除各种无关的目录\n- printf 格式以 d 作为前缀，然后是八进制模式的文件权限、用户名、用户组等。\n- -type l 表示查找符号链接并显示每个链接的指向。\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：archive_meta-data\n\nprintf \"%b\" \"Mode\\tUser\\tGroup\\tBytes\\tModified\\tFileSpec\\n\" > archive_file\nfind / \\( -path /proc -o -path /mnt -o -path /tmp -o -path /var/tmp \\\n  -o -path /var/cache -o -path /var/spool \\) -prune \\\n  -o -type d -printf 'd%m\\t%u\\t%g\\t%s\\t%t\\t%p/\\n' \\\n  -o -type l -printf 'l%m\\t%u\\t%g\\t%s\\t%t\\t%p -> %l\\n' \\\n  -o -printf '%m\\t%u\\t%g\\t%s\\t%t\\t%p\\n' >> archive_file\n```\n\n16. **查找只出现在一个文件中的内容**\n\n命令 grep -vf right left 中，-f 选项将参数 right 视为模式文件，从中提取模式（一行一个模式）\n\nuniq -u 能够显示出文件中独有的行\n\nuniq -d 能够显示出同时在两个文件中出现的行\n\n```bash\n$ cat left\nrecord_01\nrecord_02.left only\nrecord_03\nrecord_05.differ\nrecord_06\nrecord_07\nrecord_08\nrecord_09\nrecord_10\n\n$ cat right\nrecord_01\nrecord_02\nrecord_04\nrecord_05\nrecord_06.differ\nrecord_07\nrecord_08\nrecord_09.right only\nrecord_10\n\n# 仅显示出现在文件left中的行\n$ comm -23 left right\nrecord_02.left only\nrecord_03\nrecord_05.differ\nrecord_06\nrecord_09\n\n# 仅显示出现在文件right中的行\n$ comm -13 left right\nrecord_02\nrecord_04\nrecord_05\nrecord_06.differ\nrecord_09.right only\n\n# 仅显示同时出现在两个文件中的行\n$ comm -12 left right\nrecord_01\nrecord_07\nrecord_08\nrecord_10\n```\n\n17. **在目录间快速移动**\n\n- pushd\n- popd\n- dirs\n\n如果对一个新目录使用 pushd，那么它会将前一个目录压入栈中\n\n如果使用 pushd 时没有指定目录，那么它会交换栈顶的两个目录的位置\n\n当使用 popd 时，它会弹出栈顶保存的当前位置，切换到新的栈顶目录\n\n如果不记得目录栈中都有哪些目录，可以使用内建命令 dirs 按照从左到右的顺序显示。加上 -v 选项后，显示形式更形象。\n\npushd +2 会将编号为 2 的目录置为栈顶（并切换到该目录）并将其他目录下压。\n\n要想看到类似于栈的目录列表，但又不希望出现编号，可以使用 -p 选项\n\n18. **历史命令重用**\n\n```bash\n## 重复上一次命令\n!!\n## 重复上一次命令的最后一个参数\n!$\n## 重复上一次命令的第1个参数\n!:1\n## 重复上一次命令的第2个参数，以此类推\n!:2\n\n## 使用脱字符（^）替换机制\n$ /usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon\n...\n$ ^-g -A^-gB^\n/usr/bin/somewhere/someprog -gB -yknot -w /tmp/soforthandsoon\n...\n\n## 进行命令行内容替换时要以 ^ 起始，当你想在命令行最后添加更多文本时，结尾的（第 3 个）^才有必要。\n$ /usr/bin/somewhere/someprog -g -A -yknot\n...\n$ ^-g -A^-gB^ /tmp^\n/usr/bin/somewhere/someprog -gB -yknot /tmp\n...\n\n## 要想删除部分内容并将其替换为空值，可以像下面这样做。\n$ /usr/bin/somewhere/someprog -g -A -yknot /tmp\n...\n$ ^-g -A^^\n/usr/bin/somewhere/someprog -yknot /tmp\n...\n$ ^knot^\n/usr/bin/somewhere/someprog -gA -y /tmp\n...\n$\n\n## 用:替换\n## 如果想修改命令行中出现的所有实例，则需要在 s 之前加上 g（以表示全局替换）\n$ /usr/bin/somewhere/someprog -g -H -yknot -w /tmp/soforthandsoon\nError: -H not recognized. Did you mean -A?\n$ !!:s/H/A/\n/usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon\n...\n$ !!:gs/s/S/\n/usr/bin/Somewhere/Someprog -g -S -yknotS -w /tmp/SoforthandSoon\n...\n$\n\n## 使用历史命令时，可以加入 :p 修饰符，这会使得 bash 只输出命令\n$ rm !$:p\nrm ?b1.txt\n$\n```\n\nfc 命令可以将最近执行的命令（或者一批命令）保存在临时文件中，调用编辑器，并允许你按照适合的方式修改其中的命令，然后在退出编辑器时自动重新执行编辑过的命令。\n\n如果调用 fc 时不带参数，则只使用最后一行。你也可以用参数指定某一行：fc 1004 会使用命令历史记录中编号为1004 的命令行，而 fc -5 会使用第 5 个最近的命令。也可以指定范围参数，例如，fc 1001 1005 允许编辑编号为 1001 到 1005 的命令行，fc -5 -1 允许编辑最近执行过的 5 个命令。\n\n当你退出 fc 命令所调用的编辑器时，会重新执行临时文件中剩余的所有命令，即使未做任何改动，这时可以删除文件中的所有命令行，保存并退出。","source":"_posts/shell-action-3.md","raw":"---\ntitle: Shell 实用技巧（三）\ndate: 2024-08-15 10:53:19\ntags: linux\n---\n1. **getopts**\n    - `getopts` 是一个内建命令，用于处理命令行选项。\n    - 它可以让脚本在运行时接受命令行参数。\n    - 它的语法是：`getopts optstring variable`。\n    - `optstring` 填入选项字符，如 `abc` 表示选项 a、b 和 c 是合法的选项。\n    - 如果是必填项要在选项后面加冒号，如`a:bc`\n    - 对于接受参数的选项，参数会保存在 shell 变量 `$OPTARG`中\n    - 当选项是不需要输入参数的时候，`$OPTARG`为空\n    - `$OPTIND` 初始值为1，每解析一个选项，`$OPTIND` 会加1\n    \n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：getopts_example\n    #\n    # getopts用法\n    #\n    aflag=\n    bflag=\n    while getopts 'ab:' OPTION\n    do\n        case $OPTION in\n            a) aflag=1\n            ;;\n            b) bflag=1\n            bval=\"$OPTARG\"\n            ;;\n            ?) printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/} >&2\n            exit 2\n            ;;\n        esac\n    done\n\n    shift $(($OPTIND - 1))\n\n    if [ \"$aflag\" ]\n    then\n        printf \"Option -a specified\\n\"\n    fi\n    if [ \"$bflag\" ]\n    then\n        printf 'Option -b \"%s\" specified\\n' \"$bval\"\n    fi\n    printf \"Remaining arguments are: %s\\n\" \"$*\"\n\n    myscript -a -b alt plow harvest reap\n    ## 这里解析完选项后 $OPTIND 为 4, 因此$OPTIND - 1，丢弃解析过的选项，剩余的参数为 plow harvest reap\n    ```\n    - 如果想让脚本输出自己自定义的错误信息，需要在 `getopts` 选项列表前加上`:`, 如`:ab:c` 使`getopts`不输出错误消息\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：getopts_custom\n    #\n    # 解析参数时使用自定义错误消息\n    #\n    aflag=\n    bflag=\n    while getopts :ab: FOUND\n    do\n        case $FOUND in\n            a) aflag=1\n            ;;\n            b) bflag=1\n            bval=\"$OPTARG\"\n                ;;\n            # 缺少参数返回 :\n            \\:) printf \"argument missing from -%s option\\n\" $OPTARG\n                printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/}\n                exit 2\n                ;;\n            # 不支持的选项返回 ?\n            \\?) printf \"unknown option: -%s\\n\" $OPTARG\n                printf \"Usage: %s: [-a] [-b value] args\\n\" ${0##*/}\n                exit 2\n                ;;\n            esac >&2\n        done\n    shift $(($OPTIND - 1))\n    ```\n2. **用read解析文本**\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：parseViaRead\n    #\n    # 用read语句解析ls -l的输出\n    # ls -l的输出类似于以下这样：\n    # -rw-r--r--  1 albing users 126 2006-10-10 22:50 fnsize\n\n    ls -l \"$1\" | { read PERMS LCOUNT OWNER GROUP SIZE CRDATE CRTIME FILE ;\n    echo $FILE has $LCOUNT 'link(s)' and is $SIZE bytes long. ;\n    }\n\n    # read 将各单词读入数组变量\n    read -a MYRAY\n    ```\n\n3. **读取整个文件**\n    > mapfile 和 readarray\n    >\n    > 能够将整个文件读入数组，每个数组元素对应文件中的一行\n\n    ```bash\n    mapfile -t -s 1 -n 1500 -C showprg -c 100 BIGDATA < /tmp/myfile.data\n    # -s 1 跳过第一行输入\n    # -n 1500 读取 1500行\n    # -t 删除每行行尾的换行符\n    # -c 100 每读取 100行调用一次用户自定义函数 showprg, 默认每 5000行调用一次\n    # 结果放进数组 BIGDATA\n    ```\n\n4. **每次提取一个字符**\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：onebyone\n    #\n    # 从输入中一次解析一个字符\n\n    while read ALINE\n    do\n        for ((i=0; i < ${#ALINE}; i++))\n        do\n            ACHAR=${ALINE:i:1}\n            # 在这里执行某些操作，如echo $ACHAR\n            echo $ACHAR\n        done\n    done\n    ```\n5. **提取数据中的特定字段**\n\n    - `cut`\n    - `awk`\n    - `grep -o` 正则提取\n\n    ```bash\n    cut -d: -f1,6,7 /etc/passwd\n    cut -d: -f1-3\n\n    # 默认输出分隔符是空格，通过 OFS变量修改\n    awk 'BEGIN{FS=\":\"; OFS=\"\\t\"} {print $1 $7 $6}' /etc/passwd\n\n    ## ip地址提取\n    ip a | grep -oP '([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])'\n    ```\n\n6. **更新文件中的特定字段**\n\n    ```bash\n    $ grep csh /etc/passwd\n    root:*:0:0:Charlie &:/root:/bin/csh\n\n    $ sed 's;/csh$;/sh;' /etc/passwd | grep '^root'\n    root:*:0:0:Charlie &:/root:/bin/sh\n\n    # 对字段进行运算或修改特定字段中的内容\n    $ cat data_file\n    Line 1 ends\n    Line 2 ends\n    Line 3 ends\n    Line 4 ends\n    Line 5 ends\n\n    $ awk '{print $1, $2+5, $3}' data_file\n    Line 6 ends\n    Line 7 ends\n    Line 8 ends\n    Line 9 ends\n    Line 10 ends\n    # 如果第2个字段中包含'3'，将其修改为'8'并做标记\n    $ awk '{ if ($2 == \"3\") print $1, $2+5, $3, \"Tweaked\" ; else print $0; }' \\\n    data_file\n    Line 1 ends\n    Line 2 ends\n    Line 8 ends Tweaked\n    Line 4 ends\n    Line 5 ends\n    ```\n\n7. **修剪空白字符**\n    - `shopt -s extglob` 开启扩展通配符匹配\n    - 利用 `read`的设计方法\n    - `${##} 或 ${%%}` 变量字符串切割\n\n    ```bash\n    shopt -s extglob\n    ## 开启后可以用 +(), 匹配多个空格符\n    ${line##+([[:space:]])}\n    ${line%%+([[:space:]])}\n\n    shopt -s extglob\n\n    while IFS= read -r line; do\n    echo \"None: $line\" # 保留所有的空白字符\n    echo \"Ld: ${line##+([[:space:]])}\" # 修剪行首空白字符\n    echo \"Tr: ${line%%+([[:space:]])}\" # 修剪行尾空白字符\n    line=\"${line##+([[:space:]])}\" # 修剪行首和……\n    line=\"${line%%+([[:space:]])}\" # ……行尾的空白字符\n    echo \"All: $line\" # 显示修剪后的内容\n    done < whitespace\n    ```\n\n8. **编写安全的shell脚本**\n\n    ```bash\n    #!/usr/bin/env bash\n    # 实例文件：security_template\n\n    # 设置合理的/安全的路径\n    PATH='/usr/local/bin:/bin:/usr/bin'\n    # 确保导出$PATH\n    \\export PATH\n\n    # 清除所有别名。切记：开头的\\用于禁止别名扩展\n    \\unalias -a\n\n    # 清除命令路径散列\n    hash -r\n\n    # 将硬性限制设置为0，关闭核心转储（core dumps）\n    ulimit -H -c 0 --\n\n    # 设置合理的/安全的IFS（注意，这里使用的语法仅适用于bash和ksh93，不具备可移植性！）\n    IFS=$' \\t\\n'\n\n    # 设置并使用合理的/安全的umask变量\n    # 注意，这不会影响已经在命令行上重定向的文件\n    # 022产生0755权限，077产生0700权限……\n    UMASK=022\n    umask $UMASK\n\n    until [ -n \"$temp_dir\" -a ! -d \"$temp_dir\" ]; do\n        temp_dir=\"/tmp/meaningful_prefix.${RANDOM}${RANDOM}${RANDOM}\"\n    done\n    mkdir -p -m 0700 $temp_dir \\\n    || (echo \"FATAL: Failed to create temp dir '$temp_dir': $?\"; exit 100)\n\n    # 尽全力清除临时文件\n    # 注意，一定要先设置好$temp_dir，千万不要修改！\n    cleanup=\"rm -rf $temp_dir\"\n    trap \"$cleanup\" ABRT EXIT HUP INT QUIT\n    ```\n9. **脚本重定向输出**\n\n    exec 通常会使用其参数所指定的命令来替换正在运行的 shell\n\n    ```bash\n    # 保存旧的STDERR\n    exec 3>&2\n\n    # 将所有发往STDERR的输出重定向到错误日志文件\n    exec 2> /path/to/error_log\n\n    # 通过还原STDERR并关闭文件句柄3来停止重定向\n    exec 2>&3-\n    ```\n\n10. **Argument list too long**\n\n    使用 xargs 命令（可能还要配合 find）来拆分参数列表。\n    \n    find -print0 配合 xargs -0。可以使 find 使用空字符（文件名中不会出现这种字符）代替空白字符作为输出记录分隔符，xargs 使用空字符作为输入记录分隔符。这样能正确地解析包含怪异字符的文件名。\n\n    ARG_MAX 限制了 exec* 系列系统调用的总空间需求，内核以此知道它必须分配的最大缓冲区。execve 的 3 个参数是：程序名称、参数向量和环境。\n\n    ```bash\n    ## 查看系统限制值\n    getconf ARG_MAX\n    getconf LINE_MAX\n    ```\n\n11. **自定义提示符**\n\n    提示字符串分别为 $PS0、$PS1、$PS2、$PS3、$PS4\n\n    ```bash\n    # 实例文件：prompts\n\n    # 用户名@短格式主机名、日期和时间，以及当前工作目录（CWD）：\n    export PS1='[\\u@\\h \\d \\A] \\w \\$ '\n\n    # 用户名@长格式主机名、ISO 8601格式的日期和时间、当前工作目录的基本名称（\\W）:\n    export PS1='[\\u@\\H \\D{%Y-%m-%d %H:%M:%S%z}] \\W \\$ '\n\n    # 用户名@短格式主机名、bash版本号，以及当前工作目录（\\w）：\n    export PS1='[\\u@\\h \\V \\w] \\$ '\n\n    # 换行符、用户名@短格式主机名、基本PTY、shell层级、历史编号、换行符，以及完整的工作\n    目录名称（$PWD）：\n    export PS1='\\n[\\u@\\h \\l:$SHLVL:\\!]\\n$PWD\\$ '\n\n    # 用户名@短格式主机名、上一个命令的退出状态，以及当前工作目录：\n    export PS1='[\\u@\\h $? \\w \\$ '\n\n    # 换行符、用户名@短格式主机名，以及后台作业数：\n    export PS1='\\n[\\u@\\h jobs:\\j]\\n$PWD\\$ '\n\n    # 换行符、用户名@短格式主机名、终端、shell层级、历史编号、作业数量、bash版本号，以\n    及完整的工作目录：\n    export PS1='\\n[\\u@\\h t:\\l l:$SHLVL h:\\! j:\\j v:\\V]\\n$PWD\\$ '\n\n    # 换行符、用户名@短格式主机名、代表终端的T、代表shell层级的L、代表命令编号的C，以及\n    ISO 8601格式的日期和时间：\n    export PS1='\\n[\\u@\\h:T\\l:L$SHLVL:C\\!:\\D{%Y-%m-%d_%H:%M:%S_%Z}]\\n$PWD\\$ '\n\n    # 用户名@短格式主机名、浅蓝色的当前工作目录：\n    export PS1='\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] '\n\n    # 在xterm的标题栏和提示符中同时显示用户名@短格式主机名、当前工作目录：\n    export PS1='\\[\\033]0;\\u@\\h:\\w\\007\\][\\u@\\h:\\w]\\$ '\n\n    # 同时更新颜色和xterm：\n    export PS1='\\[\\033]0;\\u@\\h:\\w\\007\\]\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] '\n    ```\n\n12. **设置$CDPATH**\n\n    CDPATH 是一个以冒号为分隔符的目录列表，用作内建命令 cd 的搜索路径​。可以将它看作 cd 的 $PATH。\n    ```bash\n    CDPATH='.:/etc:/usr'\n    ```\n\n13. **在会话间同步shell历史记录**\n\n```bash\n# 将当前历史记录追加到历史文件\nhistory -a \n\n# 将历史记录读入当前shell\nhistory -n\n\nHISTTIMEFORMAT='%Y-%m-%d_%H:%M:%S; '\n\nHISTTIMEFORMAT=': %Y-%m-%d_%H:%M:%S; '\n```\n\n14. **批量解压ZIP文件**\n\n```bash\nunzip '*.zip'\n\nfor x in /path/to/date*/name/*.zip; do unzip \"$x\"; done\n\nfor x in $(ls /path/to/date*/name/*.zip 2>/dev/null); do unzip $x; done\n```\n\n15. **获取文件元数据**\n\n- (-path /proc -o -path...) -prune 用于去除各种无关的目录\n- printf 格式以 d 作为前缀，然后是八进制模式的文件权限、用户名、用户组等。\n- -type l 表示查找符号链接并显示每个链接的指向。\n\n```bash\n#!/usr/bin/env bash\n# 实例文件：archive_meta-data\n\nprintf \"%b\" \"Mode\\tUser\\tGroup\\tBytes\\tModified\\tFileSpec\\n\" > archive_file\nfind / \\( -path /proc -o -path /mnt -o -path /tmp -o -path /var/tmp \\\n  -o -path /var/cache -o -path /var/spool \\) -prune \\\n  -o -type d -printf 'd%m\\t%u\\t%g\\t%s\\t%t\\t%p/\\n' \\\n  -o -type l -printf 'l%m\\t%u\\t%g\\t%s\\t%t\\t%p -> %l\\n' \\\n  -o -printf '%m\\t%u\\t%g\\t%s\\t%t\\t%p\\n' >> archive_file\n```\n\n16. **查找只出现在一个文件中的内容**\n\n命令 grep -vf right left 中，-f 选项将参数 right 视为模式文件，从中提取模式（一行一个模式）\n\nuniq -u 能够显示出文件中独有的行\n\nuniq -d 能够显示出同时在两个文件中出现的行\n\n```bash\n$ cat left\nrecord_01\nrecord_02.left only\nrecord_03\nrecord_05.differ\nrecord_06\nrecord_07\nrecord_08\nrecord_09\nrecord_10\n\n$ cat right\nrecord_01\nrecord_02\nrecord_04\nrecord_05\nrecord_06.differ\nrecord_07\nrecord_08\nrecord_09.right only\nrecord_10\n\n# 仅显示出现在文件left中的行\n$ comm -23 left right\nrecord_02.left only\nrecord_03\nrecord_05.differ\nrecord_06\nrecord_09\n\n# 仅显示出现在文件right中的行\n$ comm -13 left right\nrecord_02\nrecord_04\nrecord_05\nrecord_06.differ\nrecord_09.right only\n\n# 仅显示同时出现在两个文件中的行\n$ comm -12 left right\nrecord_01\nrecord_07\nrecord_08\nrecord_10\n```\n\n17. **在目录间快速移动**\n\n- pushd\n- popd\n- dirs\n\n如果对一个新目录使用 pushd，那么它会将前一个目录压入栈中\n\n如果使用 pushd 时没有指定目录，那么它会交换栈顶的两个目录的位置\n\n当使用 popd 时，它会弹出栈顶保存的当前位置，切换到新的栈顶目录\n\n如果不记得目录栈中都有哪些目录，可以使用内建命令 dirs 按照从左到右的顺序显示。加上 -v 选项后，显示形式更形象。\n\npushd +2 会将编号为 2 的目录置为栈顶（并切换到该目录）并将其他目录下压。\n\n要想看到类似于栈的目录列表，但又不希望出现编号，可以使用 -p 选项\n\n18. **历史命令重用**\n\n```bash\n## 重复上一次命令\n!!\n## 重复上一次命令的最后一个参数\n!$\n## 重复上一次命令的第1个参数\n!:1\n## 重复上一次命令的第2个参数，以此类推\n!:2\n\n## 使用脱字符（^）替换机制\n$ /usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon\n...\n$ ^-g -A^-gB^\n/usr/bin/somewhere/someprog -gB -yknot -w /tmp/soforthandsoon\n...\n\n## 进行命令行内容替换时要以 ^ 起始，当你想在命令行最后添加更多文本时，结尾的（第 3 个）^才有必要。\n$ /usr/bin/somewhere/someprog -g -A -yknot\n...\n$ ^-g -A^-gB^ /tmp^\n/usr/bin/somewhere/someprog -gB -yknot /tmp\n...\n\n## 要想删除部分内容并将其替换为空值，可以像下面这样做。\n$ /usr/bin/somewhere/someprog -g -A -yknot /tmp\n...\n$ ^-g -A^^\n/usr/bin/somewhere/someprog -yknot /tmp\n...\n$ ^knot^\n/usr/bin/somewhere/someprog -gA -y /tmp\n...\n$\n\n## 用:替换\n## 如果想修改命令行中出现的所有实例，则需要在 s 之前加上 g（以表示全局替换）\n$ /usr/bin/somewhere/someprog -g -H -yknot -w /tmp/soforthandsoon\nError: -H not recognized. Did you mean -A?\n$ !!:s/H/A/\n/usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon\n...\n$ !!:gs/s/S/\n/usr/bin/Somewhere/Someprog -g -S -yknotS -w /tmp/SoforthandSoon\n...\n$\n\n## 使用历史命令时，可以加入 :p 修饰符，这会使得 bash 只输出命令\n$ rm !$:p\nrm ?b1.txt\n$\n```\n\nfc 命令可以将最近执行的命令（或者一批命令）保存在临时文件中，调用编辑器，并允许你按照适合的方式修改其中的命令，然后在退出编辑器时自动重新执行编辑过的命令。\n\n如果调用 fc 时不带参数，则只使用最后一行。你也可以用参数指定某一行：fc 1004 会使用命令历史记录中编号为1004 的命令行，而 fc -5 会使用第 5 个最近的命令。也可以指定范围参数，例如，fc 1001 1005 允许编辑编号为 1001 到 1005 的命令行，fc -5 -1 允许编辑最近执行过的 5 个命令。\n\n当你退出 fc 命令所调用的编辑器时，会重新执行临时文件中剩余的所有命令，即使未做任何改动，这时可以删除文件中的所有命令行，保存并退出。","slug":"shell-action-3","published":1,"updated":"2024-08-22T01:51:00.987Z","_id":"clzvzj69i0002d0uq0c5u67qo","comments":1,"layout":"post","photos":[],"content":"<ol>\n<li><p><strong>getopts</strong></p>\n<ul>\n<li><code>getopts</code> 是一个内建命令，用于处理命令行选项。</li>\n<li>它可以让脚本在运行时接受命令行参数。</li>\n<li>它的语法是：<code>getopts optstring variable</code>。</li>\n<li><code>optstring</code> 填入选项字符，如 <code>abc</code> 表示选项 a、b 和 c 是合法的选项。</li>\n<li>如果是必填项要在选项后面加冒号，如<code>a:bc</code></li>\n<li>对于接受参数的选项，参数会保存在 shell 变量 <code>$OPTARG</code>中</li>\n<li>当选项是不需要输入参数的时候，<code>$OPTARG</code>为空</li>\n<li><code>$OPTIND</code> 初始值为1，每解析一个选项，<code>$OPTIND</code> 会加1</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：getopts_example</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># getopts用法</span><br><span class=\"hljs-comment\">#</span><br>aflag=<br>bflag=<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">getopts</span> <span class=\"hljs-string\">&#x27;ab:&#x27;</span> OPTION<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-variable\">$OPTION</span> <span class=\"hljs-keyword\">in</span><br>        a) aflag=1<br>        ;;<br>        b) bflag=1<br>        bval=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$OPTARG</span>&quot;</span><br>        ;;<br>        ?) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span> &gt;&amp;2<br>        <span class=\"hljs-built_in\">exit</span> 2<br>        ;;<br>    <span class=\"hljs-keyword\">esac</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-built_in\">shift</span> $((<span class=\"hljs-variable\">$OPTIND</span> - <span class=\"hljs-number\">1</span>))<br><br><span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$aflag</span>&quot;</span> ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Option -a specified\\n&quot;</span><br><span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$bflag</span>&quot;</span> ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;Option -b &quot;%s&quot; specified\\n&#x27;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$bval</span>&quot;</span><br><span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Remaining arguments are: %s\\n&quot;</span> <span class=\"hljs-string\">&quot;$*&quot;</span><br><br>myscript -a -b alt plow harvest reap<br><span class=\"hljs-comment\">## 这里解析完选项后 $OPTIND 为 4, 因此$OPTIND - 1，丢弃解析过的选项，剩余的参数为 plow harvest reap</span><br></code></pre></td></tr></table></figure>\n<ul>\n<li>如果想让脚本输出自己自定义的错误信息，需要在 <code>getopts</code> 选项列表前加上<code>:</code>, 如<code>:ab:c</code> 使<code>getopts</code>不输出错误消息 <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：getopts_custom</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 解析参数时使用自定义错误消息</span><br><span class=\"hljs-comment\">#</span><br>aflag=<br>bflag=<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">getopts</span> :ab: FOUND<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-variable\">$FOUND</span> <span class=\"hljs-keyword\">in</span><br>        a) aflag=1<br>        ;;<br>        b) bflag=1<br>        bval=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$OPTARG</span>&quot;</span><br>            ;;<br>        <span class=\"hljs-comment\"># 缺少参数返回 :</span><br>        \\:) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;argument missing from -%s option\\n&quot;</span> <span class=\"hljs-variable\">$OPTARG</span><br>            <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span><br>            <span class=\"hljs-built_in\">exit</span> 2<br>            ;;<br>        <span class=\"hljs-comment\"># 不支持的选项返回 ?</span><br>        \\?) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;unknown option: -%s\\n&quot;</span> <span class=\"hljs-variable\">$OPTARG</span><br>            <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span><br>            <span class=\"hljs-built_in\">exit</span> 2<br>            ;;<br>        <span class=\"hljs-keyword\">esac</span> &gt;&amp;2<br>    <span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">shift</span> $((<span class=\"hljs-variable\">$OPTIND</span> - <span class=\"hljs-number\">1</span>))<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>用read解析文本</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：parseViaRead</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 用read语句解析ls -l的输出</span><br><span class=\"hljs-comment\"># ls -l的输出类似于以下这样：</span><br><span class=\"hljs-comment\"># -rw-r--r--  1 albing users 126 2006-10-10 22:50 fnsize</span><br><br><span class=\"hljs-built_in\">ls</span> -l <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$1</span>&quot;</span> | &#123; <span class=\"hljs-built_in\">read</span> PERMS LCOUNT OWNER GROUP SIZE CRDATE CRTIME FILE ;<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$FILE</span> has <span class=\"hljs-variable\">$LCOUNT</span> <span class=\"hljs-string\">&#x27;link(s)&#x27;</span> and is <span class=\"hljs-variable\">$SIZE</span> bytes long. ;<br>&#125;<br><br><span class=\"hljs-comment\"># read 将各单词读入数组变量</span><br><span class=\"hljs-built_in\">read</span> -a MYRAY<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>读取整个文件</strong></p>\n<blockquote>\n<p>mapfile 和 readarray</p>\n<p>能够将整个文件读入数组，每个数组元素对应文件中的一行</p>\n</blockquote>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mapfile</span> -t -s 1 -n 1500 -C showprg -c 100 BIGDATA &lt; /tmp/myfile.data<br><span class=\"hljs-comment\"># -s 1 跳过第一行输入</span><br><span class=\"hljs-comment\"># -n 1500 读取 1500行</span><br><span class=\"hljs-comment\"># -t 删除每行行尾的换行符</span><br><span class=\"hljs-comment\"># -c 100 每读取 100行调用一次用户自定义函数 showprg, 默认每 5000行调用一次</span><br><span class=\"hljs-comment\"># 结果放进数组 BIGDATA</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>每次提取一个字符</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：onebyone</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 从输入中一次解析一个字符</span><br><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> ALINE<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">for</span> ((i=<span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-variable\">$&#123;#ALINE&#125;</span>; i++))<br>    <span class=\"hljs-keyword\">do</span><br>        ACHAR=<span class=\"hljs-variable\">$&#123;ALINE:i:1&#125;</span><br>        <span class=\"hljs-comment\"># 在这里执行某些操作，如echo $ACHAR</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$ACHAR</span><br>    <span class=\"hljs-keyword\">done</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>提取数据中的特定字段</strong></p>\n<ul>\n<li><code>cut</code></li>\n<li><code>awk</code></li>\n<li><code>grep -o</code> 正则提取</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cut</span> -d: -f1,6,7 /etc/passwd<br><span class=\"hljs-built_in\">cut</span> -d: -f1-3<br><br><span class=\"hljs-comment\"># 默认输出分隔符是空格，通过 OFS变量修改</span><br>awk <span class=\"hljs-string\">&#x27;BEGIN&#123;FS=&quot;:&quot;; OFS=&quot;\\t&quot;&#125; &#123;print $1 $7 $6&#125;&#x27;</span> /etc/passwd<br><br><span class=\"hljs-comment\">## ip地址提取</span><br>ip a | grep -oP <span class=\"hljs-string\">&#x27;([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])&#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>更新文件中的特定字段</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ grep csh /etc/passwd<br>root:*:0:0:Charlie &amp;:/root:/bin/csh<br><br>$ sed <span class=\"hljs-string\">&#x27;s;/csh$;/sh;&#x27;</span> /etc/passwd | grep <span class=\"hljs-string\">&#x27;^root&#x27;</span><br>root:*:0:0:Charlie &amp;:/root:/bin/sh<br><br><span class=\"hljs-comment\"># 对字段进行运算或修改特定字段中的内容</span><br>$ <span class=\"hljs-built_in\">cat</span> data_file<br>Line 1 ends<br>Line 2 ends<br>Line 3 ends<br>Line 4 ends<br>Line 5 ends<br><br>$ awk <span class=\"hljs-string\">&#x27;&#123;print $1, $2+5, $3&#125;&#x27;</span> data_file<br>Line 6 ends<br>Line 7 ends<br>Line 8 ends<br>Line 9 ends<br>Line 10 ends<br><span class=\"hljs-comment\"># 如果第2个字段中包含&#x27;3&#x27;，将其修改为&#x27;8&#x27;并做标记</span><br>$ awk <span class=\"hljs-string\">&#x27;&#123; if ($2 == &quot;3&quot;) print $1, $2+5, $3, &quot;Tweaked&quot; ; else print $0; &#125;&#x27;</span> \\<br>data_file<br>Line 1 ends<br>Line 2 ends<br>Line 8 ends Tweaked<br>Line 4 ends<br>Line 5 ends<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>修剪空白字符</strong></p>\n<ul>\n<li><code>shopt -s extglob</code> 开启扩展通配符匹配</li>\n<li>利用 <code>read</code>的设计方法</li>\n<li><code>$&#123;##&#125; 或 $&#123;%%&#125;</code> 变量字符串切割</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">shopt</span> -s extglob<br><span class=\"hljs-comment\">## 开启后可以用 +(), 匹配多个空格符</span><br><span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span><br><span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span><br><br><span class=\"hljs-built_in\">shopt</span> -s extglob<br><br><span class=\"hljs-keyword\">while</span> IFS= <span class=\"hljs-built_in\">read</span> -r line; <span class=\"hljs-keyword\">do</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;None: <span class=\"hljs-variable\">$line</span>&quot;</span> <span class=\"hljs-comment\"># 保留所有的空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Ld: <span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行首空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Tr: <span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行尾空白字符</span><br>line=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行首和……</span><br>line=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># ……行尾的空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;All: <span class=\"hljs-variable\">$line</span>&quot;</span> <span class=\"hljs-comment\"># 显示修剪后的内容</span><br><span class=\"hljs-keyword\">done</span> &lt; whitespace<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>编写安全的shell脚本</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：security_template</span><br><br><span class=\"hljs-comment\"># 设置合理的/安全的路径</span><br>PATH=<span class=\"hljs-string\">&#x27;/usr/local/bin:/bin:/usr/bin&#x27;</span><br><span class=\"hljs-comment\"># 确保导出$PATH</span><br>\\<span class=\"hljs-built_in\">export</span> PATH<br><br><span class=\"hljs-comment\"># 清除所有别名。切记：开头的\\用于禁止别名扩展</span><br>\\<span class=\"hljs-built_in\">unalias</span> -a<br><br><span class=\"hljs-comment\"># 清除命令路径散列</span><br><span class=\"hljs-built_in\">hash</span> -r<br><br><span class=\"hljs-comment\"># 将硬性限制设置为0，关闭核心转储（core dumps）</span><br><span class=\"hljs-built_in\">ulimit</span> -H -c 0 --<br><br><span class=\"hljs-comment\"># 设置合理的/安全的IFS（注意，这里使用的语法仅适用于bash和ksh93，不具备可移植性！）</span><br>IFS=$<span class=\"hljs-string\">&#x27; \\t\\n&#x27;</span><br><br><span class=\"hljs-comment\"># 设置并使用合理的/安全的umask变量</span><br><span class=\"hljs-comment\"># 注意，这不会影响已经在命令行上重定向的文件</span><br><span class=\"hljs-comment\"># 022产生0755权限，077产生0700权限……</span><br>UMASK=022<br><span class=\"hljs-built_in\">umask</span> <span class=\"hljs-variable\">$UMASK</span><br><br><span class=\"hljs-keyword\">until</span> [ -n <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$temp_dir</span>&quot;</span> -a ! -d <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$temp_dir</span>&quot;</span> ]; <span class=\"hljs-keyword\">do</span><br>    temp_dir=<span class=\"hljs-string\">&quot;/tmp/meaningful_prefix.<span class=\"hljs-variable\">$&#123;RANDOM&#125;</span><span class=\"hljs-variable\">$&#123;RANDOM&#125;</span><span class=\"hljs-variable\">$&#123;RANDOM&#125;</span>&quot;</span><br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">mkdir</span> -p -m 0700 <span class=\"hljs-variable\">$temp_dir</span> \\<br>|| (<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;FATAL: Failed to create temp dir &#x27;<span class=\"hljs-variable\">$temp_dir</span>&#x27;: $?&quot;</span>; <span class=\"hljs-built_in\">exit</span> 100)<br><br><span class=\"hljs-comment\"># 尽全力清除临时文件</span><br><span class=\"hljs-comment\"># 注意，一定要先设置好$temp_dir，千万不要修改！</span><br>cleanup=<span class=\"hljs-string\">&quot;rm -rf <span class=\"hljs-variable\">$temp_dir</span>&quot;</span><br><span class=\"hljs-built_in\">trap</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$cleanup</span>&quot;</span> ABRT EXIT HUP INT QUIT<br></code></pre></td></tr></table></figure></li>\n<li><p><strong>脚本重定向输出</strong></p>\n<p> exec 通常会使用其参数所指定的命令来替换正在运行的 shell</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 保存旧的STDERR</span><br><span class=\"hljs-built_in\">exec</span> 3&gt;&amp;2<br><br><span class=\"hljs-comment\"># 将所有发往STDERR的输出重定向到错误日志文件</span><br><span class=\"hljs-built_in\">exec</span> 2&gt; /path/to/error_log<br><br><span class=\"hljs-comment\"># 通过还原STDERR并关闭文件句柄3来停止重定向</span><br><span class=\"hljs-built_in\">exec</span> 2&gt;&amp;3-<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Argument list too long</strong></p>\n<p>使用 xargs 命令（可能还要配合 find）来拆分参数列表。</p>\n<p>find -print0 配合 xargs -0。可以使 find 使用空字符（文件名中不会出现这种字符）代替空白字符作为输出记录分隔符，xargs 使用空字符作为输入记录分隔符。这样能正确地解析包含怪异字符的文件名。</p>\n<p>ARG_MAX 限制了 exec* 系列系统调用的总空间需求，内核以此知道它必须分配的最大缓冲区。execve 的 3 个参数是：程序名称、参数向量和环境。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看系统限制值</span><br>getconf ARG_MAX<br>getconf LINE_MAX<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>自定义提示符</strong></p>\n<p>提示字符串分别为 $PS0、$PS1、$PS2、$PS3、$PS4</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：prompts</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、日期和时间，以及当前工作目录（CWD）：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h \\d \\A] \\w \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@长格式主机名、ISO 8601格式的日期和时间、当前工作目录的基本名称（\\W）:</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\H \\D&#123;%Y-%m-%d %H:%M:%S%z&#125;] \\W \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、bash版本号，以及当前工作目录（\\w）：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h \\V \\w] \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、基本PTY、shell层级、历史编号、换行符，以及完整的工作</span><br>目录名称（<span class=\"hljs-variable\">$PWD</span>）：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h \\l:$SHLVL:\\!]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、上一个命令的退出状态，以及当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h $? \\w \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名，以及后台作业数：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h jobs:\\j]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、终端、shell层级、历史编号、作业数量、bash版本号，以</span><br>及完整的工作目录：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h t:\\l l:$SHLVL h:\\! j:\\j v:\\V]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、代表终端的T、代表shell层级的L、代表命令编号的C，以及</span><br>ISO 8601格式的日期和时间：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h:T\\l:L$SHLVL:C\\!:\\D&#123;%Y-%m-%d_%H:%M:%S_%Z&#125;]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、浅蓝色的当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] &#x27;</span><br><br><span class=\"hljs-comment\"># 在xterm的标题栏和提示符中同时显示用户名@短格式主机名、当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033]0;\\u@\\h:\\w\\007\\][\\u@\\h:\\w]\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 同时更新颜色和xterm：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033]0;\\u@\\h:\\w\\007\\]\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] &#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>设置$CDPATH</strong></p>\n<p>CDPATH 是一个以冒号为分隔符的目录列表，用作内建命令 cd 的搜索路径​。可以将它看作 cd 的 $PATH。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CDPATH=<span class=\"hljs-string\">&#x27;.:/etc:/usr&#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在会话间同步shell历史记录</strong></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将当前历史记录追加到历史文件</span><br><span class=\"hljs-built_in\">history</span> -a <br><br><span class=\"hljs-comment\"># 将历史记录读入当前shell</span><br><span class=\"hljs-built_in\">history</span> -n<br><br>HISTTIMEFORMAT=<span class=\"hljs-string\">&#x27;%Y-%m-%d_%H:%M:%S; &#x27;</span><br><br>HISTTIMEFORMAT=<span class=\"hljs-string\">&#x27;: %Y-%m-%d_%H:%M:%S; &#x27;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"14\">\n<li><strong>批量解压ZIP文件</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">unzip <span class=\"hljs-string\">&#x27;*.zip&#x27;</span><br><br><span class=\"hljs-keyword\">for</span> x <span class=\"hljs-keyword\">in</span> /path/to/date*/name/*.zip; <span class=\"hljs-keyword\">do</span> unzip <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$x</span>&quot;</span>; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-keyword\">for</span> x <span class=\"hljs-keyword\">in</span> $(<span class=\"hljs-built_in\">ls</span> /path/to/date*/name/*.zip 2&gt;/dev/null); <span class=\"hljs-keyword\">do</span> unzip <span class=\"hljs-variable\">$x</span>; <span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"15\">\n<li><strong>获取文件元数据</strong></li>\n</ol>\n<ul>\n<li>(-path &#x2F;proc -o -path…) -prune 用于去除各种无关的目录</li>\n<li>printf 格式以 d 作为前缀，然后是八进制模式的文件权限、用户名、用户组等。</li>\n<li>-type l 表示查找符号链接并显示每个链接的指向。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：archive_meta-data</span><br><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;%b&quot;</span> <span class=\"hljs-string\">&quot;Mode\\tUser\\tGroup\\tBytes\\tModified\\tFileSpec\\n&quot;</span> &gt; archive_file<br>find / \\( -path /proc -o -path /mnt -o -path /tmp -o -path /var/tmp \\<br>  -o -path /var/cache -o -path /var/spool \\) -prune \\<br>  -o -<span class=\"hljs-built_in\">type</span> d -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;d%m\\t%u\\t%g\\t%s\\t%t\\t%p/\\n&#x27;</span> \\<br>  -o -<span class=\"hljs-built_in\">type</span> l -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;l%m\\t%u\\t%g\\t%s\\t%t\\t%p -&gt; %l\\n&#x27;</span> \\<br>  -o -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;%m\\t%u\\t%g\\t%s\\t%t\\t%p\\n&#x27;</span> &gt;&gt; archive_file<br></code></pre></td></tr></table></figure>\n\n<ol start=\"16\">\n<li><strong>查找只出现在一个文件中的内容</strong></li>\n</ol>\n<p>命令 grep -vf right left 中，-f 选项将参数 right 视为模式文件，从中提取模式（一行一个模式）</p>\n<p>uniq -u 能够显示出文件中独有的行</p>\n<p>uniq -d 能够显示出同时在两个文件中出现的行</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> left<br>record_01<br>record_02.left only<br>record_03<br>record_05.differ<br>record_06<br>record_07<br>record_08<br>record_09<br>record_10<br><br>$ <span class=\"hljs-built_in\">cat</span> right<br>record_01<br>record_02<br>record_04<br>record_05<br>record_06.differ<br>record_07<br>record_08<br>record_09.right only<br>record_10<br><br><span class=\"hljs-comment\"># 仅显示出现在文件left中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -23 left right<br>record_02.left only<br>record_03<br>record_05.differ<br>record_06<br>record_09<br><br><span class=\"hljs-comment\"># 仅显示出现在文件right中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -13 left right<br>record_02<br>record_04<br>record_05<br>record_06.differ<br>record_09.right only<br><br><span class=\"hljs-comment\"># 仅显示同时出现在两个文件中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -12 left right<br>record_01<br>record_07<br>record_08<br>record_10<br></code></pre></td></tr></table></figure>\n\n<ol start=\"17\">\n<li><strong>在目录间快速移动</strong></li>\n</ol>\n<ul>\n<li>pushd</li>\n<li>popd</li>\n<li>dirs</li>\n</ul>\n<p>如果对一个新目录使用 pushd，那么它会将前一个目录压入栈中</p>\n<p>如果使用 pushd 时没有指定目录，那么它会交换栈顶的两个目录的位置</p>\n<p>当使用 popd 时，它会弹出栈顶保存的当前位置，切换到新的栈顶目录</p>\n<p>如果不记得目录栈中都有哪些目录，可以使用内建命令 dirs 按照从左到右的顺序显示。加上 -v 选项后，显示形式更形象。</p>\n<p>pushd +2 会将编号为 2 的目录置为栈顶（并切换到该目录）并将其他目录下压。</p>\n<p>要想看到类似于栈的目录列表，但又不希望出现编号，可以使用 -p 选项</p>\n<ol start=\"18\">\n<li><strong>历史命令重用</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 重复上一次命令</span><br>!!<br><span class=\"hljs-comment\">## 重复上一次命令的最后一个参数</span><br>!$<br><span class=\"hljs-comment\">## 重复上一次命令的第1个参数</span><br>!:1<br><span class=\"hljs-comment\">## 重复上一次命令的第2个参数，以此类推</span><br>!:2<br><br><span class=\"hljs-comment\">## 使用脱字符（^）替换机制</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon<br>...<br>$ ^-g -A^-gB^<br>/usr/bin/somewhere/someprog -gB -yknot -w /tmp/soforthandsoon<br>...<br><br><span class=\"hljs-comment\">## 进行命令行内容替换时要以 ^ 起始，当你想在命令行最后添加更多文本时，结尾的（第 3 个）^才有必要。</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot<br>...<br>$ ^-g -A^-gB^ /tmp^<br>/usr/bin/somewhere/someprog -gB -yknot /tmp<br>...<br><br><span class=\"hljs-comment\">## 要想删除部分内容并将其替换为空值，可以像下面这样做。</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot /tmp<br>...<br>$ ^-g -A^^<br>/usr/bin/somewhere/someprog -yknot /tmp<br>...<br>$ ^knot^<br>/usr/bin/somewhere/someprog -gA -y /tmp<br>...<br>$<br><br><span class=\"hljs-comment\">## 用:替换</span><br><span class=\"hljs-comment\">## 如果想修改命令行中出现的所有实例，则需要在 s 之前加上 g（以表示全局替换）</span><br>$ /usr/bin/somewhere/someprog -g -H -yknot -w /tmp/soforthandsoon<br>Error: -H not recognized. Did you mean -A?<br>$ !!:s/H/A/<br>/usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon<br>...<br>$ !!:gs/s/S/<br>/usr/bin/Somewhere/Someprog -g -S -yknotS -w /tmp/SoforthandSoon<br>...<br>$<br><br><span class=\"hljs-comment\">## 使用历史命令时，可以加入 :p 修饰符，这会使得 bash 只输出命令</span><br>$ <span class=\"hljs-built_in\">rm</span> !$:p<br><span class=\"hljs-built_in\">rm</span> ?b1.txt<br>$<br></code></pre></td></tr></table></figure>\n\n<p>fc 命令可以将最近执行的命令（或者一批命令）保存在临时文件中，调用编辑器，并允许你按照适合的方式修改其中的命令，然后在退出编辑器时自动重新执行编辑过的命令。</p>\n<p>如果调用 fc 时不带参数，则只使用最后一行。你也可以用参数指定某一行：fc 1004 会使用命令历史记录中编号为1004 的命令行，而 fc -5 会使用第 5 个最近的命令。也可以指定范围参数，例如，fc 1001 1005 允许编辑编号为 1001 到 1005 的命令行，fc -5 -1 允许编辑最近执行过的 5 个命令。</p>\n<p>当你退出 fc 命令所调用的编辑器时，会重新执行临时文件中剩余的所有命令，即使未做任何改动，这时可以删除文件中的所有命令行，保存并退出。</p>\n","excerpt":"","more":"<ol>\n<li><p><strong>getopts</strong></p>\n<ul>\n<li><code>getopts</code> 是一个内建命令，用于处理命令行选项。</li>\n<li>它可以让脚本在运行时接受命令行参数。</li>\n<li>它的语法是：<code>getopts optstring variable</code>。</li>\n<li><code>optstring</code> 填入选项字符，如 <code>abc</code> 表示选项 a、b 和 c 是合法的选项。</li>\n<li>如果是必填项要在选项后面加冒号，如<code>a:bc</code></li>\n<li>对于接受参数的选项，参数会保存在 shell 变量 <code>$OPTARG</code>中</li>\n<li>当选项是不需要输入参数的时候，<code>$OPTARG</code>为空</li>\n<li><code>$OPTIND</code> 初始值为1，每解析一个选项，<code>$OPTIND</code> 会加1</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：getopts_example</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># getopts用法</span><br><span class=\"hljs-comment\">#</span><br>aflag=<br>bflag=<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">getopts</span> <span class=\"hljs-string\">&#x27;ab:&#x27;</span> OPTION<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-variable\">$OPTION</span> <span class=\"hljs-keyword\">in</span><br>        a) aflag=1<br>        ;;<br>        b) bflag=1<br>        bval=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$OPTARG</span>&quot;</span><br>        ;;<br>        ?) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span> &gt;&amp;2<br>        <span class=\"hljs-built_in\">exit</span> 2<br>        ;;<br>    <span class=\"hljs-keyword\">esac</span><br><span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-built_in\">shift</span> $((<span class=\"hljs-variable\">$OPTIND</span> - <span class=\"hljs-number\">1</span>))<br><br><span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$aflag</span>&quot;</span> ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Option -a specified\\n&quot;</span><br><span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$bflag</span>&quot;</span> ]<br><span class=\"hljs-keyword\">then</span><br>    <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;Option -b &quot;%s&quot; specified\\n&#x27;</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$bval</span>&quot;</span><br><span class=\"hljs-keyword\">fi</span><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Remaining arguments are: %s\\n&quot;</span> <span class=\"hljs-string\">&quot;$*&quot;</span><br><br>myscript -a -b alt plow harvest reap<br><span class=\"hljs-comment\">## 这里解析完选项后 $OPTIND 为 4, 因此$OPTIND - 1，丢弃解析过的选项，剩余的参数为 plow harvest reap</span><br></code></pre></td></tr></table></figure>\n<ul>\n<li>如果想让脚本输出自己自定义的错误信息，需要在 <code>getopts</code> 选项列表前加上<code>:</code>, 如<code>:ab:c</code> 使<code>getopts</code>不输出错误消息 <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：getopts_custom</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 解析参数时使用自定义错误消息</span><br><span class=\"hljs-comment\">#</span><br>aflag=<br>bflag=<br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">getopts</span> :ab: FOUND<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">case</span> <span class=\"hljs-variable\">$FOUND</span> <span class=\"hljs-keyword\">in</span><br>        a) aflag=1<br>        ;;<br>        b) bflag=1<br>        bval=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$OPTARG</span>&quot;</span><br>            ;;<br>        <span class=\"hljs-comment\"># 缺少参数返回 :</span><br>        \\:) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;argument missing from -%s option\\n&quot;</span> <span class=\"hljs-variable\">$OPTARG</span><br>            <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span><br>            <span class=\"hljs-built_in\">exit</span> 2<br>            ;;<br>        <span class=\"hljs-comment\"># 不支持的选项返回 ?</span><br>        \\?) <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;unknown option: -%s\\n&quot;</span> <span class=\"hljs-variable\">$OPTARG</span><br>            <span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;Usage: %s: [-a] [-b value] args\\n&quot;</span> <span class=\"hljs-variable\">$&#123;0##*/&#125;</span><br>            <span class=\"hljs-built_in\">exit</span> 2<br>            ;;<br>        <span class=\"hljs-keyword\">esac</span> &gt;&amp;2<br>    <span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">shift</span> $((<span class=\"hljs-variable\">$OPTIND</span> - <span class=\"hljs-number\">1</span>))<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>用read解析文本</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：parseViaRead</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 用read语句解析ls -l的输出</span><br><span class=\"hljs-comment\"># ls -l的输出类似于以下这样：</span><br><span class=\"hljs-comment\"># -rw-r--r--  1 albing users 126 2006-10-10 22:50 fnsize</span><br><br><span class=\"hljs-built_in\">ls</span> -l <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$1</span>&quot;</span> | &#123; <span class=\"hljs-built_in\">read</span> PERMS LCOUNT OWNER GROUP SIZE CRDATE CRTIME FILE ;<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$FILE</span> has <span class=\"hljs-variable\">$LCOUNT</span> <span class=\"hljs-string\">&#x27;link(s)&#x27;</span> and is <span class=\"hljs-variable\">$SIZE</span> bytes long. ;<br>&#125;<br><br><span class=\"hljs-comment\"># read 将各单词读入数组变量</span><br><span class=\"hljs-built_in\">read</span> -a MYRAY<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>读取整个文件</strong></p>\n<blockquote>\n<p>mapfile 和 readarray</p>\n<p>能够将整个文件读入数组，每个数组元素对应文件中的一行</p>\n</blockquote>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mapfile</span> -t -s 1 -n 1500 -C showprg -c 100 BIGDATA &lt; /tmp/myfile.data<br><span class=\"hljs-comment\"># -s 1 跳过第一行输入</span><br><span class=\"hljs-comment\"># -n 1500 读取 1500行</span><br><span class=\"hljs-comment\"># -t 删除每行行尾的换行符</span><br><span class=\"hljs-comment\"># -c 100 每读取 100行调用一次用户自定义函数 showprg, 默认每 5000行调用一次</span><br><span class=\"hljs-comment\"># 结果放进数组 BIGDATA</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>每次提取一个字符</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：onebyone</span><br><span class=\"hljs-comment\">#</span><br><span class=\"hljs-comment\"># 从输入中一次解析一个字符</span><br><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-built_in\">read</span> ALINE<br><span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-keyword\">for</span> ((i=<span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-variable\">$&#123;#ALINE&#125;</span>; i++))<br>    <span class=\"hljs-keyword\">do</span><br>        ACHAR=<span class=\"hljs-variable\">$&#123;ALINE:i:1&#125;</span><br>        <span class=\"hljs-comment\"># 在这里执行某些操作，如echo $ACHAR</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-variable\">$ACHAR</span><br>    <span class=\"hljs-keyword\">done</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure></li>\n<li><p><strong>提取数据中的特定字段</strong></p>\n<ul>\n<li><code>cut</code></li>\n<li><code>awk</code></li>\n<li><code>grep -o</code> 正则提取</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cut</span> -d: -f1,6,7 /etc/passwd<br><span class=\"hljs-built_in\">cut</span> -d: -f1-3<br><br><span class=\"hljs-comment\"># 默认输出分隔符是空格，通过 OFS变量修改</span><br>awk <span class=\"hljs-string\">&#x27;BEGIN&#123;FS=&quot;:&quot;; OFS=&quot;\\t&quot;&#125; &#123;print $1 $7 $6&#125;&#x27;</span> /etc/passwd<br><br><span class=\"hljs-comment\">## ip地址提取</span><br>ip a | grep -oP <span class=\"hljs-string\">&#x27;([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])&#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>更新文件中的特定字段</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ grep csh /etc/passwd<br>root:*:0:0:Charlie &amp;:/root:/bin/csh<br><br>$ sed <span class=\"hljs-string\">&#x27;s;/csh$;/sh;&#x27;</span> /etc/passwd | grep <span class=\"hljs-string\">&#x27;^root&#x27;</span><br>root:*:0:0:Charlie &amp;:/root:/bin/sh<br><br><span class=\"hljs-comment\"># 对字段进行运算或修改特定字段中的内容</span><br>$ <span class=\"hljs-built_in\">cat</span> data_file<br>Line 1 ends<br>Line 2 ends<br>Line 3 ends<br>Line 4 ends<br>Line 5 ends<br><br>$ awk <span class=\"hljs-string\">&#x27;&#123;print $1, $2+5, $3&#125;&#x27;</span> data_file<br>Line 6 ends<br>Line 7 ends<br>Line 8 ends<br>Line 9 ends<br>Line 10 ends<br><span class=\"hljs-comment\"># 如果第2个字段中包含&#x27;3&#x27;，将其修改为&#x27;8&#x27;并做标记</span><br>$ awk <span class=\"hljs-string\">&#x27;&#123; if ($2 == &quot;3&quot;) print $1, $2+5, $3, &quot;Tweaked&quot; ; else print $0; &#125;&#x27;</span> \\<br>data_file<br>Line 1 ends<br>Line 2 ends<br>Line 8 ends Tweaked<br>Line 4 ends<br>Line 5 ends<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>修剪空白字符</strong></p>\n<ul>\n<li><code>shopt -s extglob</code> 开启扩展通配符匹配</li>\n<li>利用 <code>read</code>的设计方法</li>\n<li><code>$&#123;##&#125; 或 $&#123;%%&#125;</code> 变量字符串切割</li>\n</ul>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">shopt</span> -s extglob<br><span class=\"hljs-comment\">## 开启后可以用 +(), 匹配多个空格符</span><br><span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span><br><span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span><br><br><span class=\"hljs-built_in\">shopt</span> -s extglob<br><br><span class=\"hljs-keyword\">while</span> IFS= <span class=\"hljs-built_in\">read</span> -r line; <span class=\"hljs-keyword\">do</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;None: <span class=\"hljs-variable\">$line</span>&quot;</span> <span class=\"hljs-comment\"># 保留所有的空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Ld: <span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行首空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Tr: <span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行尾空白字符</span><br>line=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;line##+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># 修剪行首和……</span><br>line=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;line%%+([[:space:]])&#125;</span>&quot;</span> <span class=\"hljs-comment\"># ……行尾的空白字符</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;All: <span class=\"hljs-variable\">$line</span>&quot;</span> <span class=\"hljs-comment\"># 显示修剪后的内容</span><br><span class=\"hljs-keyword\">done</span> &lt; whitespace<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>编写安全的shell脚本</strong></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：security_template</span><br><br><span class=\"hljs-comment\"># 设置合理的/安全的路径</span><br>PATH=<span class=\"hljs-string\">&#x27;/usr/local/bin:/bin:/usr/bin&#x27;</span><br><span class=\"hljs-comment\"># 确保导出$PATH</span><br>\\<span class=\"hljs-built_in\">export</span> PATH<br><br><span class=\"hljs-comment\"># 清除所有别名。切记：开头的\\用于禁止别名扩展</span><br>\\<span class=\"hljs-built_in\">unalias</span> -a<br><br><span class=\"hljs-comment\"># 清除命令路径散列</span><br><span class=\"hljs-built_in\">hash</span> -r<br><br><span class=\"hljs-comment\"># 将硬性限制设置为0，关闭核心转储（core dumps）</span><br><span class=\"hljs-built_in\">ulimit</span> -H -c 0 --<br><br><span class=\"hljs-comment\"># 设置合理的/安全的IFS（注意，这里使用的语法仅适用于bash和ksh93，不具备可移植性！）</span><br>IFS=$<span class=\"hljs-string\">&#x27; \\t\\n&#x27;</span><br><br><span class=\"hljs-comment\"># 设置并使用合理的/安全的umask变量</span><br><span class=\"hljs-comment\"># 注意，这不会影响已经在命令行上重定向的文件</span><br><span class=\"hljs-comment\"># 022产生0755权限，077产生0700权限……</span><br>UMASK=022<br><span class=\"hljs-built_in\">umask</span> <span class=\"hljs-variable\">$UMASK</span><br><br><span class=\"hljs-keyword\">until</span> [ -n <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$temp_dir</span>&quot;</span> -a ! -d <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$temp_dir</span>&quot;</span> ]; <span class=\"hljs-keyword\">do</span><br>    temp_dir=<span class=\"hljs-string\">&quot;/tmp/meaningful_prefix.<span class=\"hljs-variable\">$&#123;RANDOM&#125;</span><span class=\"hljs-variable\">$&#123;RANDOM&#125;</span><span class=\"hljs-variable\">$&#123;RANDOM&#125;</span>&quot;</span><br><span class=\"hljs-keyword\">done</span><br><span class=\"hljs-built_in\">mkdir</span> -p -m 0700 <span class=\"hljs-variable\">$temp_dir</span> \\<br>|| (<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;FATAL: Failed to create temp dir &#x27;<span class=\"hljs-variable\">$temp_dir</span>&#x27;: $?&quot;</span>; <span class=\"hljs-built_in\">exit</span> 100)<br><br><span class=\"hljs-comment\"># 尽全力清除临时文件</span><br><span class=\"hljs-comment\"># 注意，一定要先设置好$temp_dir，千万不要修改！</span><br>cleanup=<span class=\"hljs-string\">&quot;rm -rf <span class=\"hljs-variable\">$temp_dir</span>&quot;</span><br><span class=\"hljs-built_in\">trap</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$cleanup</span>&quot;</span> ABRT EXIT HUP INT QUIT<br></code></pre></td></tr></table></figure></li>\n<li><p><strong>脚本重定向输出</strong></p>\n<p> exec 通常会使用其参数所指定的命令来替换正在运行的 shell</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 保存旧的STDERR</span><br><span class=\"hljs-built_in\">exec</span> 3&gt;&amp;2<br><br><span class=\"hljs-comment\"># 将所有发往STDERR的输出重定向到错误日志文件</span><br><span class=\"hljs-built_in\">exec</span> 2&gt; /path/to/error_log<br><br><span class=\"hljs-comment\"># 通过还原STDERR并关闭文件句柄3来停止重定向</span><br><span class=\"hljs-built_in\">exec</span> 2&gt;&amp;3-<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Argument list too long</strong></p>\n<p>使用 xargs 命令（可能还要配合 find）来拆分参数列表。</p>\n<p>find -print0 配合 xargs -0。可以使 find 使用空字符（文件名中不会出现这种字符）代替空白字符作为输出记录分隔符，xargs 使用空字符作为输入记录分隔符。这样能正确地解析包含怪异字符的文件名。</p>\n<p>ARG_MAX 限制了 exec* 系列系统调用的总空间需求，内核以此知道它必须分配的最大缓冲区。execve 的 3 个参数是：程序名称、参数向量和环境。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看系统限制值</span><br>getconf ARG_MAX<br>getconf LINE_MAX<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>自定义提示符</strong></p>\n<p>提示字符串分别为 $PS0、$PS1、$PS2、$PS3、$PS4</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实例文件：prompts</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、日期和时间，以及当前工作目录（CWD）：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h \\d \\A] \\w \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@长格式主机名、ISO 8601格式的日期和时间、当前工作目录的基本名称（\\W）:</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\H \\D&#123;%Y-%m-%d %H:%M:%S%z&#125;] \\W \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、bash版本号，以及当前工作目录（\\w）：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h \\V \\w] \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、基本PTY、shell层级、历史编号、换行符，以及完整的工作</span><br>目录名称（<span class=\"hljs-variable\">$PWD</span>）：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h \\l:$SHLVL:\\!]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、上一个命令的退出状态，以及当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;[\\u@\\h $? \\w \\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名，以及后台作业数：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h jobs:\\j]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、终端、shell层级、历史编号、作业数量、bash版本号，以</span><br>及完整的工作目录：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h t:\\l l:$SHLVL h:\\! j:\\j v:\\V]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 换行符、用户名@短格式主机名、代表终端的T、代表shell层级的L、代表命令编号的C，以及</span><br>ISO 8601格式的日期和时间：<br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\n[\\u@\\h:T\\l:L$SHLVL:C\\!:\\D&#123;%Y-%m-%d_%H:%M:%S_%Z&#125;]\\n$PWD\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 用户名@短格式主机名、浅蓝色的当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] &#x27;</span><br><br><span class=\"hljs-comment\"># 在xterm的标题栏和提示符中同时显示用户名@短格式主机名、当前工作目录：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033]0;\\u@\\h:\\w\\007\\][\\u@\\h:\\w]\\$ &#x27;</span><br><br><span class=\"hljs-comment\"># 同时更新颜色和xterm：</span><br><span class=\"hljs-built_in\">export</span> PS1=<span class=\"hljs-string\">&#x27;\\[\\033]0;\\u@\\h:\\w\\007\\]\\[\\033[1;34m\\][\\u@\\h:\\w]\\$\\[\\033[0m\\] &#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>设置$CDPATH</strong></p>\n<p>CDPATH 是一个以冒号为分隔符的目录列表，用作内建命令 cd 的搜索路径​。可以将它看作 cd 的 $PATH。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">CDPATH=<span class=\"hljs-string\">&#x27;.:/etc:/usr&#x27;</span><br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>在会话间同步shell历史记录</strong></p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将当前历史记录追加到历史文件</span><br><span class=\"hljs-built_in\">history</span> -a <br><br><span class=\"hljs-comment\"># 将历史记录读入当前shell</span><br><span class=\"hljs-built_in\">history</span> -n<br><br>HISTTIMEFORMAT=<span class=\"hljs-string\">&#x27;%Y-%m-%d_%H:%M:%S; &#x27;</span><br><br>HISTTIMEFORMAT=<span class=\"hljs-string\">&#x27;: %Y-%m-%d_%H:%M:%S; &#x27;</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"14\">\n<li><strong>批量解压ZIP文件</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">unzip <span class=\"hljs-string\">&#x27;*.zip&#x27;</span><br><br><span class=\"hljs-keyword\">for</span> x <span class=\"hljs-keyword\">in</span> /path/to/date*/name/*.zip; <span class=\"hljs-keyword\">do</span> unzip <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$x</span>&quot;</span>; <span class=\"hljs-keyword\">done</span><br><br><span class=\"hljs-keyword\">for</span> x <span class=\"hljs-keyword\">in</span> $(<span class=\"hljs-built_in\">ls</span> /path/to/date*/name/*.zip 2&gt;/dev/null); <span class=\"hljs-keyword\">do</span> unzip <span class=\"hljs-variable\">$x</span>; <span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<ol start=\"15\">\n<li><strong>获取文件元数据</strong></li>\n</ol>\n<ul>\n<li>(-path &#x2F;proc -o -path…) -prune 用于去除各种无关的目录</li>\n<li>printf 格式以 d 作为前缀，然后是八进制模式的文件权限、用户名、用户组等。</li>\n<li>-type l 表示查找符号链接并显示每个链接的指向。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/usr/bin/env bash</span><br><span class=\"hljs-comment\"># 实例文件：archive_meta-data</span><br><br><span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&quot;%b&quot;</span> <span class=\"hljs-string\">&quot;Mode\\tUser\\tGroup\\tBytes\\tModified\\tFileSpec\\n&quot;</span> &gt; archive_file<br>find / \\( -path /proc -o -path /mnt -o -path /tmp -o -path /var/tmp \\<br>  -o -path /var/cache -o -path /var/spool \\) -prune \\<br>  -o -<span class=\"hljs-built_in\">type</span> d -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;d%m\\t%u\\t%g\\t%s\\t%t\\t%p/\\n&#x27;</span> \\<br>  -o -<span class=\"hljs-built_in\">type</span> l -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;l%m\\t%u\\t%g\\t%s\\t%t\\t%p -&gt; %l\\n&#x27;</span> \\<br>  -o -<span class=\"hljs-built_in\">printf</span> <span class=\"hljs-string\">&#x27;%m\\t%u\\t%g\\t%s\\t%t\\t%p\\n&#x27;</span> &gt;&gt; archive_file<br></code></pre></td></tr></table></figure>\n\n<ol start=\"16\">\n<li><strong>查找只出现在一个文件中的内容</strong></li>\n</ol>\n<p>命令 grep -vf right left 中，-f 选项将参数 right 视为模式文件，从中提取模式（一行一个模式）</p>\n<p>uniq -u 能够显示出文件中独有的行</p>\n<p>uniq -d 能够显示出同时在两个文件中出现的行</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ <span class=\"hljs-built_in\">cat</span> left<br>record_01<br>record_02.left only<br>record_03<br>record_05.differ<br>record_06<br>record_07<br>record_08<br>record_09<br>record_10<br><br>$ <span class=\"hljs-built_in\">cat</span> right<br>record_01<br>record_02<br>record_04<br>record_05<br>record_06.differ<br>record_07<br>record_08<br>record_09.right only<br>record_10<br><br><span class=\"hljs-comment\"># 仅显示出现在文件left中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -23 left right<br>record_02.left only<br>record_03<br>record_05.differ<br>record_06<br>record_09<br><br><span class=\"hljs-comment\"># 仅显示出现在文件right中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -13 left right<br>record_02<br>record_04<br>record_05<br>record_06.differ<br>record_09.right only<br><br><span class=\"hljs-comment\"># 仅显示同时出现在两个文件中的行</span><br>$ <span class=\"hljs-built_in\">comm</span> -12 left right<br>record_01<br>record_07<br>record_08<br>record_10<br></code></pre></td></tr></table></figure>\n\n<ol start=\"17\">\n<li><strong>在目录间快速移动</strong></li>\n</ol>\n<ul>\n<li>pushd</li>\n<li>popd</li>\n<li>dirs</li>\n</ul>\n<p>如果对一个新目录使用 pushd，那么它会将前一个目录压入栈中</p>\n<p>如果使用 pushd 时没有指定目录，那么它会交换栈顶的两个目录的位置</p>\n<p>当使用 popd 时，它会弹出栈顶保存的当前位置，切换到新的栈顶目录</p>\n<p>如果不记得目录栈中都有哪些目录，可以使用内建命令 dirs 按照从左到右的顺序显示。加上 -v 选项后，显示形式更形象。</p>\n<p>pushd +2 会将编号为 2 的目录置为栈顶（并切换到该目录）并将其他目录下压。</p>\n<p>要想看到类似于栈的目录列表，但又不希望出现编号，可以使用 -p 选项</p>\n<ol start=\"18\">\n<li><strong>历史命令重用</strong></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 重复上一次命令</span><br>!!<br><span class=\"hljs-comment\">## 重复上一次命令的最后一个参数</span><br>!$<br><span class=\"hljs-comment\">## 重复上一次命令的第1个参数</span><br>!:1<br><span class=\"hljs-comment\">## 重复上一次命令的第2个参数，以此类推</span><br>!:2<br><br><span class=\"hljs-comment\">## 使用脱字符（^）替换机制</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon<br>...<br>$ ^-g -A^-gB^<br>/usr/bin/somewhere/someprog -gB -yknot -w /tmp/soforthandsoon<br>...<br><br><span class=\"hljs-comment\">## 进行命令行内容替换时要以 ^ 起始，当你想在命令行最后添加更多文本时，结尾的（第 3 个）^才有必要。</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot<br>...<br>$ ^-g -A^-gB^ /tmp^<br>/usr/bin/somewhere/someprog -gB -yknot /tmp<br>...<br><br><span class=\"hljs-comment\">## 要想删除部分内容并将其替换为空值，可以像下面这样做。</span><br>$ /usr/bin/somewhere/someprog -g -A -yknot /tmp<br>...<br>$ ^-g -A^^<br>/usr/bin/somewhere/someprog -yknot /tmp<br>...<br>$ ^knot^<br>/usr/bin/somewhere/someprog -gA -y /tmp<br>...<br>$<br><br><span class=\"hljs-comment\">## 用:替换</span><br><span class=\"hljs-comment\">## 如果想修改命令行中出现的所有实例，则需要在 s 之前加上 g（以表示全局替换）</span><br>$ /usr/bin/somewhere/someprog -g -H -yknot -w /tmp/soforthandsoon<br>Error: -H not recognized. Did you mean -A?<br>$ !!:s/H/A/<br>/usr/bin/somewhere/someprog -g -A -yknot -w /tmp/soforthandsoon<br>...<br>$ !!:gs/s/S/<br>/usr/bin/Somewhere/Someprog -g -S -yknotS -w /tmp/SoforthandSoon<br>...<br>$<br><br><span class=\"hljs-comment\">## 使用历史命令时，可以加入 :p 修饰符，这会使得 bash 只输出命令</span><br>$ <span class=\"hljs-built_in\">rm</span> !$:p<br><span class=\"hljs-built_in\">rm</span> ?b1.txt<br>$<br></code></pre></td></tr></table></figure>\n\n<p>fc 命令可以将最近执行的命令（或者一批命令）保存在临时文件中，调用编辑器，并允许你按照适合的方式修改其中的命令，然后在退出编辑器时自动重新执行编辑过的命令。</p>\n<p>如果调用 fc 时不带参数，则只使用最后一行。你也可以用参数指定某一行：fc 1004 会使用命令历史记录中编号为1004 的命令行，而 fc -5 会使用第 5 个最近的命令。也可以指定范围参数，例如，fc 1001 1005 允许编辑编号为 1001 到 1005 的命令行，fc -5 -1 允许编辑最近执行过的 5 个命令。</p>\n<p>当你退出 fc 命令所调用的编辑器时，会重新执行临时文件中剩余的所有命令，即使未做任何改动，这时可以删除文件中的所有命令行，保存并退出。</p>\n"},{"title":"K8s 基础操作与配置","date":"2024-08-27T06:42:39.000Z","_content":"\n# K8s 基础\n\n## kubectl cmd\n\n- command 子命令，常用如 create、 delete、 describe、 get、 apply、 exec等。\n\n- TYPE 资源对象类型，区分大小写。 可简写，简写形式可用`kubectl api-resources`查看。\n\n- NAME 资源对象名称，区分大小写。\n\n- flags 子命令行参数。\n\n```bash\n$ kubectl [command] [TYPE] [NAME] [flags]\n\n## 获取多个pod信息\nkubectl get pods name1 name2\n\n## 获取多种对象信息\nkubectl get pod/pod_name rc/rc_name\nkubectl get pod,rc,service\n\n## 同时应用多个YAML文件，以多个-f file参数表示 \nkubectl get pod -f pod1.yaml -f pod2.yaml\nkubectl create -f pod1.yaml -f rc1.yaml -f service1.yaml\n\n## 按名字进行排序\nkubectl get pods --sort-by=.metadata.name\n\n## 查看指定 namespace下的指定标签下的 pod\nkubectl get pod -n ns -l <labelname>=nginx_proxy\n\n## 创建资源对象\n## 根据 yaml配置文件一次性创建 service和 rc\nkubectl create -f my-service.yaml -f my-rc.yaml\n\n## 根据<directory>目录下所有.yaml、.yml、.json文件的定义进行创建\nkubectl create -f <directory>\n\n## 删除所有包含某个label的pod和service\nkubectl delete pods,services -l name=<label-name>\n\n## 删除所有pod\nkubectl delete pods --all\n\n## 指定 Pod中的指定容器执行 date命令\nkubectl exec <pod-name> -c <container-name> date\n\n## 登录容器\nkubectl exec -it <pod-name> -c <container-name> -- /bin/bash\n\n## 跟踪查看容器日志\nkubectl logs -f <pod-name> -c <container-name>\n\n## 创建或更新资源对象\nkubectl apply -f app.yaml\n\n## 在线编辑运行中的资源对象\nkubectl edit deploy nginx\n```\n通常情况下不会去使用pod类型单独控制pod，而是使用Deployment、ReplicaSet、StatefulSet等资源对象来配置pod。\n\n\n## k8s pod config\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: string\n  namespace: string\n  labels:\n    - name: string\n  annotations:\n    - name: string\nspec:\n  containers:\n  - name: string\n    image: string\n    imagePullPolicy: [Always | Never | IfNotPresent]\n    command: [string]\n    args: [string]\n    workingDir: string\n    volumeMounts:\n    - name: string\n      mountPath: string\n      readOnly: boolean\n    ports:\n    - name: string\n      containerPort: int\n      hostPort: int\n      protocol: string\n    env:\n    - name: string\n      value: string\n    resources:\n      limits:\n        cpu: string\n        memory: string\n      requests:\n        cpu: string\n        memory: string\n  volumes:\n    - name: string\n    emptyDir: {}\n    hostPath:\n      path: string\n    secret:\n      secretName: string\n      items:\n        - key: string\n          path: string\n    configMap:\n      name: string\n      items:\n      - key: string\n        path: string\n\n    livenessProbe:\n      exec:\n        command: [string]\n      httpGet:\n        path: string\n        host: string\n        scheme: string\n      httpHeaders:\n      - name: string\n        value: string\n      tcpSocket:\n        port: number\n      initialDelaySeconds: 0\n      timeoutSeconds: 0\n      periodSeconds: 0\n      successThreshold: 0\n      failureThreshold: 0\n    securityContext:\n      privileged: false\n  restartPolicy: [Always | Never | OnFailure]\n  nodeSelector: object\n  imagePullSecrets:\n    - name: string\n  hostNetwork: false   \n```\n\n## Pod共享volume\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: volume-pod\nspec:\n  containers:\n  - name: tomcat\n    image: tomcat\n    ports:\n    - containerPort: 8080\n    volumeMounts:\n    - name: app-logs\n      mountPath: /usr/local/tomcat/logs\n  - name: busybox\n    image: busybox\n    command: [\"sh\", \"-c\", \"tail -f /logs/catalina*.log\"]\n    volumeMounts:\n    - name: app-logs\n      mountPath: /logs\n  # 设置的Volume名为app-logs,类型为emptyDir\n  volumes:\n  - name: app-logs\n    emptyDir: {}\n```\n\n## ConfigMap\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cm-appvars\ndata:\n  apploglevel: info\n  appdatadir: /var/data\n\n```\n\n## DaemonSet\n\n用于管理在集群中每个Node上仅运行一份Pod的副本实例\n使用场景：\n- 在每个node上都运行一个GlusterFS存储或者Ceph存储的Daemon进程\n- 在每个Node上都运行一个日志采集程序\n- 在每个Node上都运行一个性能监控程序，采集该Node的运行性能数据\n\n```yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-cloud-logging\n  namespace: kube-system\n  labels:\n    k8s-app: fluentd-cloud-logging\nspec:\n  template:\n    metadata:\n      namespace: kube-system\n      labels:\n      k8s-app: fluentd-cloud-logging\n    spec:\n      containers:\n      - name: fluentd-cloud-logging\n      image: gcr.io/google_containers/fluentd-elasticsearch:1.17\n      resources:\n        limits:\n          cpu: 100m\n          memory: 200Mi\n      env:\n      - name: FLUENTD_ARGS\n        value: -q\n      volumeMounts:\n      - name: varlog\n        mountPath: /var/log\n        readOnly: false\n      - name: containers\n        mountPath: /var/lib/docker/containers\n        readOnly: false\n      volumes:\n      - name: containers\n      hostPath:\n        path: /var/lib/docker/containers\n      - name: varlog\n      hostPath:\n        path: /var/log\n  updateStrategy:\n    type: RollingUpdate\n```\n> updateStrategy的另外一个值是OnDelete，即只有手工删除了DaemonSet创建的Pod副本，新的Pod副本才会被创建出来\n\n## Job 批处理调度\n\n通过Kubernetes Job资源对象来定义并启动一个批处理任务\n\n批处理可分为：\n- Job Template Expansion模式\n  - 一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job\n- Queue with Pod Per Work Item模式\n  - 采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item\n  - Job会启动N个Pod，每个Pod都对应一个Work item\n- Queue with Variable Pod Count模式\n  - 采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，但与上面的模式不同，Job启动的Pod数量是可变的。\n- Single Job with Static Work Assignment模式\n  - 一个Job产生多个Pod，但它采用程序静态方式分配任务项，而不是采用队列模式进行动态分配\n\nKubernetes将Job分以下三种类型:\n- Non-parallel Jobs\n- Parallel Jobs with a fixed completion count\n- Parallel Jobs with a work queue\n\n```yaml\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: process-item-$ITEM\n  labels:\n    jobgroup: jobexample\nspec:\n  template:\n    metadata:\n      name: jobexample\n      labels:\n        jobgroup: jobexample\n    spec:\n      containers:\n      - name: c\n        image: busybox\n        command: [\"sh\", \"-c\", \"echo Processing item $ITEM&& sleep 5\"]\n      restartPolicy: Never\n```\n\n## Cronjob 定时任务\n\n基本上可参照Linux Cron的表达式\n\n`Minutes Hours DayofMonth Month DayofWeek Year`\n\n```yaml\napiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n```\n\n## Pod 升级回滚\n\n```bash\n# 更新镜像\nkubectl set image deployment/nginx-deployment nginx=nginx:1.9.1\n# 或者edit编辑\nkubectl edit deployment/nginx-deployment\n\n# 查看deployment更新过程\nkubetl rollout status deployment/hello\n\n## 查看历史记录\nkubectl rollout history deployment/hello\n# 查看指定版本\nkubectl rollout history deployment/hello --revision=2\n# 回滚到上一个版本\nkubectl rollout undo deployment/hello\n# 回滚到指定版本\nkubectl rollout undo deployment/hello --to-revision=2\n\n## 暂停deployment更新\nkubectl rollout pause deployment/hello\n# 恢复Deployment部署\nkubectl rollout resume deployment/hello\n# 在恢复暂停的Deployment之前，无法回滚该Deployment\n```","source":"_posts/k8s-base-operation-config.md","raw":"---\ntitle: K8s 基础操作与配置\ndate: 2024-08-27 14:42:39\ntags: k8s\n---\n\n# K8s 基础\n\n## kubectl cmd\n\n- command 子命令，常用如 create、 delete、 describe、 get、 apply、 exec等。\n\n- TYPE 资源对象类型，区分大小写。 可简写，简写形式可用`kubectl api-resources`查看。\n\n- NAME 资源对象名称，区分大小写。\n\n- flags 子命令行参数。\n\n```bash\n$ kubectl [command] [TYPE] [NAME] [flags]\n\n## 获取多个pod信息\nkubectl get pods name1 name2\n\n## 获取多种对象信息\nkubectl get pod/pod_name rc/rc_name\nkubectl get pod,rc,service\n\n## 同时应用多个YAML文件，以多个-f file参数表示 \nkubectl get pod -f pod1.yaml -f pod2.yaml\nkubectl create -f pod1.yaml -f rc1.yaml -f service1.yaml\n\n## 按名字进行排序\nkubectl get pods --sort-by=.metadata.name\n\n## 查看指定 namespace下的指定标签下的 pod\nkubectl get pod -n ns -l <labelname>=nginx_proxy\n\n## 创建资源对象\n## 根据 yaml配置文件一次性创建 service和 rc\nkubectl create -f my-service.yaml -f my-rc.yaml\n\n## 根据<directory>目录下所有.yaml、.yml、.json文件的定义进行创建\nkubectl create -f <directory>\n\n## 删除所有包含某个label的pod和service\nkubectl delete pods,services -l name=<label-name>\n\n## 删除所有pod\nkubectl delete pods --all\n\n## 指定 Pod中的指定容器执行 date命令\nkubectl exec <pod-name> -c <container-name> date\n\n## 登录容器\nkubectl exec -it <pod-name> -c <container-name> -- /bin/bash\n\n## 跟踪查看容器日志\nkubectl logs -f <pod-name> -c <container-name>\n\n## 创建或更新资源对象\nkubectl apply -f app.yaml\n\n## 在线编辑运行中的资源对象\nkubectl edit deploy nginx\n```\n通常情况下不会去使用pod类型单独控制pod，而是使用Deployment、ReplicaSet、StatefulSet等资源对象来配置pod。\n\n\n## k8s pod config\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: string\n  namespace: string\n  labels:\n    - name: string\n  annotations:\n    - name: string\nspec:\n  containers:\n  - name: string\n    image: string\n    imagePullPolicy: [Always | Never | IfNotPresent]\n    command: [string]\n    args: [string]\n    workingDir: string\n    volumeMounts:\n    - name: string\n      mountPath: string\n      readOnly: boolean\n    ports:\n    - name: string\n      containerPort: int\n      hostPort: int\n      protocol: string\n    env:\n    - name: string\n      value: string\n    resources:\n      limits:\n        cpu: string\n        memory: string\n      requests:\n        cpu: string\n        memory: string\n  volumes:\n    - name: string\n    emptyDir: {}\n    hostPath:\n      path: string\n    secret:\n      secretName: string\n      items:\n        - key: string\n          path: string\n    configMap:\n      name: string\n      items:\n      - key: string\n        path: string\n\n    livenessProbe:\n      exec:\n        command: [string]\n      httpGet:\n        path: string\n        host: string\n        scheme: string\n      httpHeaders:\n      - name: string\n        value: string\n      tcpSocket:\n        port: number\n      initialDelaySeconds: 0\n      timeoutSeconds: 0\n      periodSeconds: 0\n      successThreshold: 0\n      failureThreshold: 0\n    securityContext:\n      privileged: false\n  restartPolicy: [Always | Never | OnFailure]\n  nodeSelector: object\n  imagePullSecrets:\n    - name: string\n  hostNetwork: false   \n```\n\n## Pod共享volume\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: volume-pod\nspec:\n  containers:\n  - name: tomcat\n    image: tomcat\n    ports:\n    - containerPort: 8080\n    volumeMounts:\n    - name: app-logs\n      mountPath: /usr/local/tomcat/logs\n  - name: busybox\n    image: busybox\n    command: [\"sh\", \"-c\", \"tail -f /logs/catalina*.log\"]\n    volumeMounts:\n    - name: app-logs\n      mountPath: /logs\n  # 设置的Volume名为app-logs,类型为emptyDir\n  volumes:\n  - name: app-logs\n    emptyDir: {}\n```\n\n## ConfigMap\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cm-appvars\ndata:\n  apploglevel: info\n  appdatadir: /var/data\n\n```\n\n## DaemonSet\n\n用于管理在集群中每个Node上仅运行一份Pod的副本实例\n使用场景：\n- 在每个node上都运行一个GlusterFS存储或者Ceph存储的Daemon进程\n- 在每个Node上都运行一个日志采集程序\n- 在每个Node上都运行一个性能监控程序，采集该Node的运行性能数据\n\n```yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-cloud-logging\n  namespace: kube-system\n  labels:\n    k8s-app: fluentd-cloud-logging\nspec:\n  template:\n    metadata:\n      namespace: kube-system\n      labels:\n      k8s-app: fluentd-cloud-logging\n    spec:\n      containers:\n      - name: fluentd-cloud-logging\n      image: gcr.io/google_containers/fluentd-elasticsearch:1.17\n      resources:\n        limits:\n          cpu: 100m\n          memory: 200Mi\n      env:\n      - name: FLUENTD_ARGS\n        value: -q\n      volumeMounts:\n      - name: varlog\n        mountPath: /var/log\n        readOnly: false\n      - name: containers\n        mountPath: /var/lib/docker/containers\n        readOnly: false\n      volumes:\n      - name: containers\n      hostPath:\n        path: /var/lib/docker/containers\n      - name: varlog\n      hostPath:\n        path: /var/log\n  updateStrategy:\n    type: RollingUpdate\n```\n> updateStrategy的另外一个值是OnDelete，即只有手工删除了DaemonSet创建的Pod副本，新的Pod副本才会被创建出来\n\n## Job 批处理调度\n\n通过Kubernetes Job资源对象来定义并启动一个批处理任务\n\n批处理可分为：\n- Job Template Expansion模式\n  - 一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job\n- Queue with Pod Per Work Item模式\n  - 采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item\n  - Job会启动N个Pod，每个Pod都对应一个Work item\n- Queue with Variable Pod Count模式\n  - 采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，但与上面的模式不同，Job启动的Pod数量是可变的。\n- Single Job with Static Work Assignment模式\n  - 一个Job产生多个Pod，但它采用程序静态方式分配任务项，而不是采用队列模式进行动态分配\n\nKubernetes将Job分以下三种类型:\n- Non-parallel Jobs\n- Parallel Jobs with a fixed completion count\n- Parallel Jobs with a work queue\n\n```yaml\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: process-item-$ITEM\n  labels:\n    jobgroup: jobexample\nspec:\n  template:\n    metadata:\n      name: jobexample\n      labels:\n        jobgroup: jobexample\n    spec:\n      containers:\n      - name: c\n        image: busybox\n        command: [\"sh\", \"-c\", \"echo Processing item $ITEM&& sleep 5\"]\n      restartPolicy: Never\n```\n\n## Cronjob 定时任务\n\n基本上可参照Linux Cron的表达式\n\n`Minutes Hours DayofMonth Month DayofWeek Year`\n\n```yaml\napiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n```\n\n## Pod 升级回滚\n\n```bash\n# 更新镜像\nkubectl set image deployment/nginx-deployment nginx=nginx:1.9.1\n# 或者edit编辑\nkubectl edit deployment/nginx-deployment\n\n# 查看deployment更新过程\nkubetl rollout status deployment/hello\n\n## 查看历史记录\nkubectl rollout history deployment/hello\n# 查看指定版本\nkubectl rollout history deployment/hello --revision=2\n# 回滚到上一个版本\nkubectl rollout undo deployment/hello\n# 回滚到指定版本\nkubectl rollout undo deployment/hello --to-revision=2\n\n## 暂停deployment更新\nkubectl rollout pause deployment/hello\n# 恢复Deployment部署\nkubectl rollout resume deployment/hello\n# 在恢复暂停的Deployment之前，无法回滚该Deployment\n```","slug":"k8s-base-operation-config","published":1,"updated":"2024-09-06T08:10:40.890Z","_id":"cm0d9jddk0000vnuq020s2anv","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"K8s-基础\"><a href=\"#K8s-基础\" class=\"headerlink\" title=\"K8s 基础\"></a>K8s 基础</h1><h2 id=\"kubectl-cmd\"><a href=\"#kubectl-cmd\" class=\"headerlink\" title=\"kubectl cmd\"></a>kubectl cmd</h2><ul>\n<li><p>command 子命令，常用如 create、 delete、 describe、 get、 apply、 exec等。</p>\n</li>\n<li><p>TYPE 资源对象类型，区分大小写。 可简写，简写形式可用<code>kubectl api-resources</code>查看。</p>\n</li>\n<li><p>NAME 资源对象名称，区分大小写。</p>\n</li>\n<li><p>flags 子命令行参数。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ kubectl [<span class=\"hljs-built_in\">command</span>] [TYPE] [NAME] [flags]<br><br><span class=\"hljs-comment\">## 获取多个pod信息</span><br>kubectl get pods name1 name2<br><br><span class=\"hljs-comment\">## 获取多种对象信息</span><br>kubectl get pod/pod_name rc/rc_name<br>kubectl get pod,rc,service<br><br><span class=\"hljs-comment\">## 同时应用多个YAML文件，以多个-f file参数表示 </span><br>kubectl get pod -f pod1.yaml -f pod2.yaml<br>kubectl create -f pod1.yaml -f rc1.yaml -f service1.yaml<br><br><span class=\"hljs-comment\">## 按名字进行排序</span><br>kubectl get pods --sort-by=.metadata.name<br><br><span class=\"hljs-comment\">## 查看指定 namespace下的指定标签下的 pod</span><br>kubectl get pod -n ns -l &lt;labelname&gt;=nginx_proxy<br><br><span class=\"hljs-comment\">## 创建资源对象</span><br><span class=\"hljs-comment\">## 根据 yaml配置文件一次性创建 service和 rc</span><br>kubectl create -f my-service.yaml -f my-rc.yaml<br><br><span class=\"hljs-comment\">## 根据&lt;directory&gt;目录下所有.yaml、.yml、.json文件的定义进行创建</span><br>kubectl create -f &lt;directory&gt;<br><br><span class=\"hljs-comment\">## 删除所有包含某个label的pod和service</span><br>kubectl delete pods,services -l name=&lt;label-name&gt;<br><br><span class=\"hljs-comment\">## 删除所有pod</span><br>kubectl delete pods --all<br><br><span class=\"hljs-comment\">## 指定 Pod中的指定容器执行 date命令</span><br>kubectl <span class=\"hljs-built_in\">exec</span> &lt;pod-name&gt; -c &lt;container-name&gt; <span class=\"hljs-built_in\">date</span><br><br><span class=\"hljs-comment\">## 登录容器</span><br>kubectl <span class=\"hljs-built_in\">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- /bin/bash<br><br><span class=\"hljs-comment\">## 跟踪查看容器日志</span><br>kubectl logs -f &lt;pod-name&gt; -c &lt;container-name&gt;<br><br><span class=\"hljs-comment\">## 创建或更新资源对象</span><br>kubectl apply -f app.yaml<br><br><span class=\"hljs-comment\">## 在线编辑运行中的资源对象</span><br>kubectl edit deploy nginx<br></code></pre></td></tr></table></figure>\n<p>通常情况下不会去使用pod类型单独控制pod，而是使用Deployment、ReplicaSet、StatefulSet等资源对象来配置pod。</p>\n<h2 id=\"k8s-pod-config\"><a href=\"#k8s-pod-config\" class=\"headerlink\" title=\"k8s pod config\"></a>k8s pod config</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">annotations:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">containers:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">imagePullPolicy:</span> [<span class=\"hljs-string\">Always</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">Never</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">IfNotPresent</span>]<br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">string</span>]<br>    <span class=\"hljs-attr\">args:</span> [<span class=\"hljs-string\">string</span>]<br>    <span class=\"hljs-attr\">workingDir:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-string\">boolean</span><br>    <span class=\"hljs-attr\">ports:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-string\">int</span><br>      <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-string\">int</span><br>      <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">env:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">resources:</span><br>      <span class=\"hljs-attr\">limits:</span><br>        <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">requests:</span><br>        <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">volumes:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">emptyDir:</span> &#123;&#125;<br>    <span class=\"hljs-attr\">hostPath:</span><br>      <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">secret:</span><br>      <span class=\"hljs-attr\">secretName:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">items:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">string</span><br>          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">configMap:</span><br>      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">items:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br><br>    <span class=\"hljs-attr\">livenessProbe:</span><br>      <span class=\"hljs-attr\">exec:</span><br>        <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">string</span>]<br>      <span class=\"hljs-attr\">httpGet:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">scheme:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">httpHeaders:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">tcpSocket:</span><br>        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-string\">number</span><br>      <span class=\"hljs-attr\">initialDelaySeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">timeoutSeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">periodSeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">successThreshold:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">failureThreshold:</span> <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">securityContext:</span><br>      <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">false</span><br>  <span class=\"hljs-attr\">restartPolicy:</span> [<span class=\"hljs-string\">Always</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">Never</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">OnFailure</span>]<br>  <span class=\"hljs-attr\">nodeSelector:</span> <span class=\"hljs-string\">object</span><br>  <span class=\"hljs-attr\">imagePullSecrets:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">false</span>   <br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Pod共享volume\"><a href=\"#Pod共享volume\" class=\"headerlink\" title=\"Pod共享volume\"></a>Pod共享volume</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">volume-pod</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">containers:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">tomcat</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">tomcat</span><br>    <span class=\"hljs-attr\">ports:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8080</span><br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/usr/local/tomcat/logs</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">busybox</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;sh&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>, <span class=\"hljs-string\">&quot;tail -f /logs/catalina*.log&quot;</span>]<br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/logs</span><br>  <span class=\"hljs-comment\"># 设置的Volume名为app-logs,类型为emptyDir</span><br>  <span class=\"hljs-attr\">volumes:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>    <span class=\"hljs-attr\">emptyDir:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ConfigMap\"><a href=\"#ConfigMap\" class=\"headerlink\" title=\"ConfigMap\"></a>ConfigMap</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">cm-appvars</span><br><span class=\"hljs-attr\">data:</span><br>  <span class=\"hljs-attr\">apploglevel:</span> <span class=\"hljs-string\">info</span><br>  <span class=\"hljs-attr\">appdatadir:</span> <span class=\"hljs-string\">/var/data</span><br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"DaemonSet\"><a href=\"#DaemonSet\" class=\"headerlink\" title=\"DaemonSet\"></a>DaemonSet</h2><p>用于管理在集群中每个Node上仅运行一份Pod的副本实例<br>使用场景：</p>\n<ul>\n<li>在每个node上都运行一个GlusterFS存储或者Ceph存储的Daemon进程</li>\n<li>在每个Node上都运行一个日志采集程序</li>\n<li>在每个Node上都运行一个性能监控程序，采集该Node的运行性能数据</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">DaemonSet</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-attr\">k8s-app:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">template:</span><br>    <span class=\"hljs-attr\">metadata:</span><br>      <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span><br>      <span class=\"hljs-attr\">labels:</span><br>      <span class=\"hljs-attr\">k8s-app:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">containers:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>      <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">gcr.io/google_containers/fluentd-elasticsearch:1.17</span><br>      <span class=\"hljs-attr\">resources:</span><br>        <span class=\"hljs-attr\">limits:</span><br>          <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">100m</span><br>          <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">200Mi</span><br>      <span class=\"hljs-attr\">env:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">FLUENTD_ARGS</span><br>        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">-q</span><br>      <span class=\"hljs-attr\">volumeMounts:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">varlog</span><br>        <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/var/log</span><br>        <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-literal\">false</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">containers</span><br>        <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/var/lib/docker/containers</span><br>        <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-literal\">false</span><br>      <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">containers</span><br>      <span class=\"hljs-attr\">hostPath:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/var/lib/docker/containers</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">varlog</span><br>      <span class=\"hljs-attr\">hostPath:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/var/log</span><br>  <span class=\"hljs-attr\">updateStrategy:</span><br>    <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">RollingUpdate</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>updateStrategy的另外一个值是OnDelete，即只有手工删除了DaemonSet创建的Pod副本，新的Pod副本才会被创建出来</p>\n</blockquote>\n<h2 id=\"Job-批处理调度\"><a href=\"#Job-批处理调度\" class=\"headerlink\" title=\"Job 批处理调度\"></a>Job 批处理调度</h2><p>通过Kubernetes Job资源对象来定义并启动一个批处理任务</p>\n<p>批处理可分为：</p>\n<ul>\n<li>Job Template Expansion模式<ul>\n<li>一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job</li>\n</ul>\n</li>\n<li>Queue with Pod Per Work Item模式<ul>\n<li>采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item</li>\n<li>Job会启动N个Pod，每个Pod都对应一个Work item</li>\n</ul>\n</li>\n<li>Queue with Variable Pod Count模式<ul>\n<li>采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，但与上面的模式不同，Job启动的Pod数量是可变的。</li>\n</ul>\n</li>\n<li>Single Job with Static Work Assignment模式<ul>\n<li>一个Job产生多个Pod，但它采用程序静态方式分配任务项，而不是采用队列模式进行动态分配</li>\n</ul>\n</li>\n</ul>\n<p>Kubernetes将Job分以下三种类型:</p>\n<ul>\n<li>Non-parallel Jobs</li>\n<li>Parallel Jobs with a fixed completion count</li>\n<li>Parallel Jobs with a work queue</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">batch/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Job</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">process-item-$ITEM</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-attr\">jobgroup:</span> <span class=\"hljs-string\">jobexample</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">template:</span><br>    <span class=\"hljs-attr\">metadata:</span><br>      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">jobexample</span><br>      <span class=\"hljs-attr\">labels:</span><br>        <span class=\"hljs-attr\">jobgroup:</span> <span class=\"hljs-string\">jobexample</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">containers:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">c</span><br>        <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>        <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;sh&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>, <span class=\"hljs-string\">&quot;echo Processing item $ITEM&amp;&amp; sleep 5&quot;</span>]<br>      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Never</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Cronjob-定时任务\"><a href=\"#Cronjob-定时任务\" class=\"headerlink\" title=\"Cronjob 定时任务\"></a>Cronjob 定时任务</h2><p>基本上可参照Linux Cron的表达式</p>\n<p><code>Minutes Hours DayofMonth Month DayofWeek Year</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">batch/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CronJob</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">hello</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">schedule:</span> <span class=\"hljs-string\">&quot;*/1 * * * *&quot;</span><br>  <span class=\"hljs-attr\">jobTemplate:</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">template:</span><br>        <span class=\"hljs-attr\">spec:</span><br>          <span class=\"hljs-attr\">containers:</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">hello</span><br>            <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>            <span class=\"hljs-attr\">args:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/bin/sh</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">-c</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">date;</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">Hello</span> <span class=\"hljs-string\">from</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">Kubernetes</span> <span class=\"hljs-string\">cluster</span><br>          <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">OnFailure</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Pod-升级回滚\"><a href=\"#Pod-升级回滚\" class=\"headerlink\" title=\"Pod 升级回滚\"></a>Pod 升级回滚</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 更新镜像</span><br>kubectl <span class=\"hljs-built_in\">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1<br><span class=\"hljs-comment\"># 或者edit编辑</span><br>kubectl edit deployment/nginx-deployment<br><br><span class=\"hljs-comment\"># 查看deployment更新过程</span><br>kubetl rollout status deployment/hello<br><br><span class=\"hljs-comment\">## 查看历史记录</span><br>kubectl rollout <span class=\"hljs-built_in\">history</span> deployment/hello<br><span class=\"hljs-comment\"># 查看指定版本</span><br>kubectl rollout <span class=\"hljs-built_in\">history</span> deployment/hello --revision=2<br><span class=\"hljs-comment\"># 回滚到上一个版本</span><br>kubectl rollout undo deployment/hello<br><span class=\"hljs-comment\"># 回滚到指定版本</span><br>kubectl rollout undo deployment/hello --to-revision=2<br><br><span class=\"hljs-comment\">## 暂停deployment更新</span><br>kubectl rollout pause deployment/hello<br><span class=\"hljs-comment\"># 恢复Deployment部署</span><br>kubectl rollout resume deployment/hello<br><span class=\"hljs-comment\"># 在恢复暂停的Deployment之前，无法回滚该Deployment</span><br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"K8s-基础\"><a href=\"#K8s-基础\" class=\"headerlink\" title=\"K8s 基础\"></a>K8s 基础</h1><h2 id=\"kubectl-cmd\"><a href=\"#kubectl-cmd\" class=\"headerlink\" title=\"kubectl cmd\"></a>kubectl cmd</h2><ul>\n<li><p>command 子命令，常用如 create、 delete、 describe、 get、 apply、 exec等。</p>\n</li>\n<li><p>TYPE 资源对象类型，区分大小写。 可简写，简写形式可用<code>kubectl api-resources</code>查看。</p>\n</li>\n<li><p>NAME 资源对象名称，区分大小写。</p>\n</li>\n<li><p>flags 子命令行参数。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ kubectl [<span class=\"hljs-built_in\">command</span>] [TYPE] [NAME] [flags]<br><br><span class=\"hljs-comment\">## 获取多个pod信息</span><br>kubectl get pods name1 name2<br><br><span class=\"hljs-comment\">## 获取多种对象信息</span><br>kubectl get pod/pod_name rc/rc_name<br>kubectl get pod,rc,service<br><br><span class=\"hljs-comment\">## 同时应用多个YAML文件，以多个-f file参数表示 </span><br>kubectl get pod -f pod1.yaml -f pod2.yaml<br>kubectl create -f pod1.yaml -f rc1.yaml -f service1.yaml<br><br><span class=\"hljs-comment\">## 按名字进行排序</span><br>kubectl get pods --sort-by=.metadata.name<br><br><span class=\"hljs-comment\">## 查看指定 namespace下的指定标签下的 pod</span><br>kubectl get pod -n ns -l &lt;labelname&gt;=nginx_proxy<br><br><span class=\"hljs-comment\">## 创建资源对象</span><br><span class=\"hljs-comment\">## 根据 yaml配置文件一次性创建 service和 rc</span><br>kubectl create -f my-service.yaml -f my-rc.yaml<br><br><span class=\"hljs-comment\">## 根据&lt;directory&gt;目录下所有.yaml、.yml、.json文件的定义进行创建</span><br>kubectl create -f &lt;directory&gt;<br><br><span class=\"hljs-comment\">## 删除所有包含某个label的pod和service</span><br>kubectl delete pods,services -l name=&lt;label-name&gt;<br><br><span class=\"hljs-comment\">## 删除所有pod</span><br>kubectl delete pods --all<br><br><span class=\"hljs-comment\">## 指定 Pod中的指定容器执行 date命令</span><br>kubectl <span class=\"hljs-built_in\">exec</span> &lt;pod-name&gt; -c &lt;container-name&gt; <span class=\"hljs-built_in\">date</span><br><br><span class=\"hljs-comment\">## 登录容器</span><br>kubectl <span class=\"hljs-built_in\">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- /bin/bash<br><br><span class=\"hljs-comment\">## 跟踪查看容器日志</span><br>kubectl logs -f &lt;pod-name&gt; -c &lt;container-name&gt;<br><br><span class=\"hljs-comment\">## 创建或更新资源对象</span><br>kubectl apply -f app.yaml<br><br><span class=\"hljs-comment\">## 在线编辑运行中的资源对象</span><br>kubectl edit deploy nginx<br></code></pre></td></tr></table></figure>\n<p>通常情况下不会去使用pod类型单独控制pod，而是使用Deployment、ReplicaSet、StatefulSet等资源对象来配置pod。</p>\n<h2 id=\"k8s-pod-config\"><a href=\"#k8s-pod-config\" class=\"headerlink\" title=\"k8s pod config\"></a>k8s pod config</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">annotations:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">containers:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">imagePullPolicy:</span> [<span class=\"hljs-string\">Always</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">Never</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">IfNotPresent</span>]<br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">string</span>]<br>    <span class=\"hljs-attr\">args:</span> [<span class=\"hljs-string\">string</span>]<br>    <span class=\"hljs-attr\">workingDir:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-string\">boolean</span><br>    <span class=\"hljs-attr\">ports:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-string\">int</span><br>      <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-string\">int</span><br>      <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">env:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">resources:</span><br>      <span class=\"hljs-attr\">limits:</span><br>        <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">requests:</span><br>        <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">volumes:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">emptyDir:</span> &#123;&#125;<br>    <span class=\"hljs-attr\">hostPath:</span><br>      <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">secret:</span><br>      <span class=\"hljs-attr\">secretName:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">items:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">string</span><br>          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>    <span class=\"hljs-attr\">configMap:</span><br>      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">items:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br><br>    <span class=\"hljs-attr\">livenessProbe:</span><br>      <span class=\"hljs-attr\">exec:</span><br>        <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">string</span>]<br>      <span class=\"hljs-attr\">httpGet:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">scheme:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">httpHeaders:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">string</span><br>      <span class=\"hljs-attr\">tcpSocket:</span><br>        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-string\">number</span><br>      <span class=\"hljs-attr\">initialDelaySeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">timeoutSeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">periodSeconds:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">successThreshold:</span> <span class=\"hljs-number\">0</span><br>      <span class=\"hljs-attr\">failureThreshold:</span> <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-attr\">securityContext:</span><br>      <span class=\"hljs-attr\">privileged:</span> <span class=\"hljs-literal\">false</span><br>  <span class=\"hljs-attr\">restartPolicy:</span> [<span class=\"hljs-string\">Always</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">Never</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">OnFailure</span>]<br>  <span class=\"hljs-attr\">nodeSelector:</span> <span class=\"hljs-string\">object</span><br>  <span class=\"hljs-attr\">imagePullSecrets:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">string</span><br>  <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">false</span>   <br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Pod共享volume\"><a href=\"#Pod共享volume\" class=\"headerlink\" title=\"Pod共享volume\"></a>Pod共享volume</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">volume-pod</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">containers:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">tomcat</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">tomcat</span><br>    <span class=\"hljs-attr\">ports:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8080</span><br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/usr/local/tomcat/logs</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">busybox</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;sh&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>, <span class=\"hljs-string\">&quot;tail -f /logs/catalina*.log&quot;</span>]<br>    <span class=\"hljs-attr\">volumeMounts:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>      <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/logs</span><br>  <span class=\"hljs-comment\"># 设置的Volume名为app-logs,类型为emptyDir</span><br>  <span class=\"hljs-attr\">volumes:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">app-logs</span><br>    <span class=\"hljs-attr\">emptyDir:</span> &#123;&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"ConfigMap\"><a href=\"#ConfigMap\" class=\"headerlink\" title=\"ConfigMap\"></a>ConfigMap</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">cm-appvars</span><br><span class=\"hljs-attr\">data:</span><br>  <span class=\"hljs-attr\">apploglevel:</span> <span class=\"hljs-string\">info</span><br>  <span class=\"hljs-attr\">appdatadir:</span> <span class=\"hljs-string\">/var/data</span><br><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"DaemonSet\"><a href=\"#DaemonSet\" class=\"headerlink\" title=\"DaemonSet\"></a>DaemonSet</h2><p>用于管理在集群中每个Node上仅运行一份Pod的副本实例<br>使用场景：</p>\n<ul>\n<li>在每个node上都运行一个GlusterFS存储或者Ceph存储的Daemon进程</li>\n<li>在每个Node上都运行一个日志采集程序</li>\n<li>在每个Node上都运行一个性能监控程序，采集该Node的运行性能数据</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">DaemonSet</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-attr\">k8s-app:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">template:</span><br>    <span class=\"hljs-attr\">metadata:</span><br>      <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span><br>      <span class=\"hljs-attr\">labels:</span><br>      <span class=\"hljs-attr\">k8s-app:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">containers:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">fluentd-cloud-logging</span><br>      <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">gcr.io/google_containers/fluentd-elasticsearch:1.17</span><br>      <span class=\"hljs-attr\">resources:</span><br>        <span class=\"hljs-attr\">limits:</span><br>          <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">100m</span><br>          <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">200Mi</span><br>      <span class=\"hljs-attr\">env:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">FLUENTD_ARGS</span><br>        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">-q</span><br>      <span class=\"hljs-attr\">volumeMounts:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">varlog</span><br>        <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/var/log</span><br>        <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-literal\">false</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">containers</span><br>        <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/var/lib/docker/containers</span><br>        <span class=\"hljs-attr\">readOnly:</span> <span class=\"hljs-literal\">false</span><br>      <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">containers</span><br>      <span class=\"hljs-attr\">hostPath:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/var/lib/docker/containers</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">varlog</span><br>      <span class=\"hljs-attr\">hostPath:</span><br>        <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/var/log</span><br>  <span class=\"hljs-attr\">updateStrategy:</span><br>    <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">RollingUpdate</span><br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>updateStrategy的另外一个值是OnDelete，即只有手工删除了DaemonSet创建的Pod副本，新的Pod副本才会被创建出来</p>\n</blockquote>\n<h2 id=\"Job-批处理调度\"><a href=\"#Job-批处理调度\" class=\"headerlink\" title=\"Job 批处理调度\"></a>Job 批处理调度</h2><p>通过Kubernetes Job资源对象来定义并启动一个批处理任务</p>\n<p>批处理可分为：</p>\n<ul>\n<li>Job Template Expansion模式<ul>\n<li>一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job</li>\n</ul>\n</li>\n<li>Queue with Pod Per Work Item模式<ul>\n<li>采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item</li>\n<li>Job会启动N个Pod，每个Pod都对应一个Work item</li>\n</ul>\n</li>\n<li>Queue with Variable Pod Count模式<ul>\n<li>采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，但与上面的模式不同，Job启动的Pod数量是可变的。</li>\n</ul>\n</li>\n<li>Single Job with Static Work Assignment模式<ul>\n<li>一个Job产生多个Pod，但它采用程序静态方式分配任务项，而不是采用队列模式进行动态分配</li>\n</ul>\n</li>\n</ul>\n<p>Kubernetes将Job分以下三种类型:</p>\n<ul>\n<li>Non-parallel Jobs</li>\n<li>Parallel Jobs with a fixed completion count</li>\n<li>Parallel Jobs with a work queue</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">batch/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Job</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">process-item-$ITEM</span><br>  <span class=\"hljs-attr\">labels:</span><br>    <span class=\"hljs-attr\">jobgroup:</span> <span class=\"hljs-string\">jobexample</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">template:</span><br>    <span class=\"hljs-attr\">metadata:</span><br>      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">jobexample</span><br>      <span class=\"hljs-attr\">labels:</span><br>        <span class=\"hljs-attr\">jobgroup:</span> <span class=\"hljs-string\">jobexample</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">containers:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">c</span><br>        <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>        <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;sh&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>, <span class=\"hljs-string\">&quot;echo Processing item $ITEM&amp;&amp; sleep 5&quot;</span>]<br>      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Never</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Cronjob-定时任务\"><a href=\"#Cronjob-定时任务\" class=\"headerlink\" title=\"Cronjob 定时任务\"></a>Cronjob 定时任务</h2><p>基本上可参照Linux Cron的表达式</p>\n<p><code>Minutes Hours DayofMonth Month DayofWeek Year</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">batch/v1</span><br><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CronJob</span><br><span class=\"hljs-attr\">metadata:</span><br>  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">hello</span><br><span class=\"hljs-attr\">spec:</span><br>  <span class=\"hljs-attr\">schedule:</span> <span class=\"hljs-string\">&quot;*/1 * * * *&quot;</span><br>  <span class=\"hljs-attr\">jobTemplate:</span><br>    <span class=\"hljs-attr\">spec:</span><br>      <span class=\"hljs-attr\">template:</span><br>        <span class=\"hljs-attr\">spec:</span><br>          <span class=\"hljs-attr\">containers:</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">hello</span><br>            <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">busybox</span><br>            <span class=\"hljs-attr\">args:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/bin/sh</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">-c</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">date;</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">Hello</span> <span class=\"hljs-string\">from</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">Kubernetes</span> <span class=\"hljs-string\">cluster</span><br>          <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">OnFailure</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Pod-升级回滚\"><a href=\"#Pod-升级回滚\" class=\"headerlink\" title=\"Pod 升级回滚\"></a>Pod 升级回滚</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 更新镜像</span><br>kubectl <span class=\"hljs-built_in\">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1<br><span class=\"hljs-comment\"># 或者edit编辑</span><br>kubectl edit deployment/nginx-deployment<br><br><span class=\"hljs-comment\"># 查看deployment更新过程</span><br>kubetl rollout status deployment/hello<br><br><span class=\"hljs-comment\">## 查看历史记录</span><br>kubectl rollout <span class=\"hljs-built_in\">history</span> deployment/hello<br><span class=\"hljs-comment\"># 查看指定版本</span><br>kubectl rollout <span class=\"hljs-built_in\">history</span> deployment/hello --revision=2<br><span class=\"hljs-comment\"># 回滚到上一个版本</span><br>kubectl rollout undo deployment/hello<br><span class=\"hljs-comment\"># 回滚到指定版本</span><br>kubectl rollout undo deployment/hello --to-revision=2<br><br><span class=\"hljs-comment\">## 暂停deployment更新</span><br>kubectl rollout pause deployment/hello<br><span class=\"hljs-comment\"># 恢复Deployment部署</span><br>kubectl rollout resume deployment/hello<br><span class=\"hljs-comment\"># 在恢复暂停的Deployment之前，无法回滚该Deployment</span><br></code></pre></td></tr></table></figure>"},{"title":"Ansible 批量设置免密登录","date":"2024-08-29T07:07:38.000Z","_content":"\n# Ansible 批量设置免密登录\n\n## 1. 准备 inventory && sshkey\n  \n  首次批量设置免密必然涉及使用带账号密码的inventory文件，\n  在设置完后记得修改或删除inventory文件。\n\n  生成公钥和私钥\n\n  ```bash\n  # 随机生成公私钥对，ssh-keygen是Linux下认证密钥生成、管理和转换工具，详细用法可参考其man文档\n  # 最简单的用法，然后敲回车即可\n  ssh-keygen -t rsa\n  # -N 必须设置为空，否则ssh时依然需要输入-N设置的密码\n  # -C 添加注释\n  ssh-keygen -N \"\" -b 4096 -t rsa -C \"root@localhost.com\" -f /root/.ssh/root.rsa\n  ```\n\n## 2. 编写playbook or 使用ad-hoc\n\n- authorized_key 模块\n  ```bash\n  ## manage_dir 意思是如果/root没有.ssh文件目录就自动创建.ssh文件目录\n  ansible machine -m authorized_key -a  \"user=root  key='{{  lookup('file', '/root/.ssh/id_rsa.pub')  }}'  path=/root/.ssh/authorized_keys  manage_dir=yes\"\n  ```\n- copy && shell 模块\n  ```bash\n  # copy公钥至远程主机/tmp目录下\n  ansible machine -m copy -a \"src=/root/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub\"\n  # 添加公钥\n  ansible machine -m shell -a \"cat /tmp/id_rsa.pub >> /root/.ssh/authorized_keys\"\n  ```\n- 少量主机时可用\n  - 需要自己输入密码\n  - 主机较多时频繁输入密码较麻烦，主机量少时可以使用\n  - 个别新增可用此方法\n  - 也可配合expect实现自动输入密码\n\n```bash\nssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.1\n```\n关于expect用法可查询其他资料，bash脚本可以结合expect使用，从而达到自动批量登录设置免密的效果。\n\n```bash\n# ! /usr/bin/expect\n# 设置要连接的远程主机IP信息\nset IP      [ lindex $argv 0 ]\n# 设置要连接的远程主机登录用户\nset USER    [ lindex $argv 1 ]\n# 设置要连接的远程主机登录用户的密码信息\nset PASSWD [ lindex $argv 2 ]\n# 设置要执行的命令\nset CMD     [ lindex $argv 3 ]\n# spawn是expect内部命令，开启ssh连接\nspawn ssh $USER@$IP $CMD\n# 判断上次执行结果\nexpect {\n    # 如果有yes或no关键字\n    \"(yes/no)? \" {\n        # 则输入yes\n        send \"yes\\r\"\n        # 输入完yes后如果输出结果有：password: 关键字\n        expect \"password:\"\n        # 则输入密码文件\n        send \"$PASSWD\\r\"\n        }\n    # 如果上次输出结果有：password: ，则输入密码\n    \"password:\" {send \"$PASSWD\\r\"}\n    # 如果上次输出结果有：* to host ，则退出\n    \"* to host\" {exit 1}\n    }\nexpect eof\n```\n\n## 3. 验证\n```bash\n# 将 ip host 写入/etc/hosts文件，如\necho \"192.168.1.1 master\" >> /etc/hosts\n## 实现直接输入master登录远程服务器\nssh master \n```","source":"_posts/ansible-set-sshpass.md","raw":"---\ntitle: Ansible 批量设置免密登录\ndate: 2024-08-29 15:07:38\ntags: ansible\n---\n\n# Ansible 批量设置免密登录\n\n## 1. 准备 inventory && sshkey\n  \n  首次批量设置免密必然涉及使用带账号密码的inventory文件，\n  在设置完后记得修改或删除inventory文件。\n\n  生成公钥和私钥\n\n  ```bash\n  # 随机生成公私钥对，ssh-keygen是Linux下认证密钥生成、管理和转换工具，详细用法可参考其man文档\n  # 最简单的用法，然后敲回车即可\n  ssh-keygen -t rsa\n  # -N 必须设置为空，否则ssh时依然需要输入-N设置的密码\n  # -C 添加注释\n  ssh-keygen -N \"\" -b 4096 -t rsa -C \"root@localhost.com\" -f /root/.ssh/root.rsa\n  ```\n\n## 2. 编写playbook or 使用ad-hoc\n\n- authorized_key 模块\n  ```bash\n  ## manage_dir 意思是如果/root没有.ssh文件目录就自动创建.ssh文件目录\n  ansible machine -m authorized_key -a  \"user=root  key='{{  lookup('file', '/root/.ssh/id_rsa.pub')  }}'  path=/root/.ssh/authorized_keys  manage_dir=yes\"\n  ```\n- copy && shell 模块\n  ```bash\n  # copy公钥至远程主机/tmp目录下\n  ansible machine -m copy -a \"src=/root/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub\"\n  # 添加公钥\n  ansible machine -m shell -a \"cat /tmp/id_rsa.pub >> /root/.ssh/authorized_keys\"\n  ```\n- 少量主机时可用\n  - 需要自己输入密码\n  - 主机较多时频繁输入密码较麻烦，主机量少时可以使用\n  - 个别新增可用此方法\n  - 也可配合expect实现自动输入密码\n\n```bash\nssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.1\n```\n关于expect用法可查询其他资料，bash脚本可以结合expect使用，从而达到自动批量登录设置免密的效果。\n\n```bash\n# ! /usr/bin/expect\n# 设置要连接的远程主机IP信息\nset IP      [ lindex $argv 0 ]\n# 设置要连接的远程主机登录用户\nset USER    [ lindex $argv 1 ]\n# 设置要连接的远程主机登录用户的密码信息\nset PASSWD [ lindex $argv 2 ]\n# 设置要执行的命令\nset CMD     [ lindex $argv 3 ]\n# spawn是expect内部命令，开启ssh连接\nspawn ssh $USER@$IP $CMD\n# 判断上次执行结果\nexpect {\n    # 如果有yes或no关键字\n    \"(yes/no)? \" {\n        # 则输入yes\n        send \"yes\\r\"\n        # 输入完yes后如果输出结果有：password: 关键字\n        expect \"password:\"\n        # 则输入密码文件\n        send \"$PASSWD\\r\"\n        }\n    # 如果上次输出结果有：password: ，则输入密码\n    \"password:\" {send \"$PASSWD\\r\"}\n    # 如果上次输出结果有：* to host ，则退出\n    \"* to host\" {exit 1}\n    }\nexpect eof\n```\n\n## 3. 验证\n```bash\n# 将 ip host 写入/etc/hosts文件，如\necho \"192.168.1.1 master\" >> /etc/hosts\n## 实现直接输入master登录远程服务器\nssh master \n```","slug":"ansible-set-sshpass","published":1,"updated":"2024-08-29T09:11:52.428Z","_id":"cm0ey0byn0002vnuqc1i9ey6d","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"Ansible-批量设置免密登录\"><a href=\"#Ansible-批量设置免密登录\" class=\"headerlink\" title=\"Ansible 批量设置免密登录\"></a>Ansible 批量设置免密登录</h1><h2 id=\"1-准备-inventory-sshkey\"><a href=\"#1-准备-inventory-sshkey\" class=\"headerlink\" title=\"1. 准备 inventory &amp;&amp; sshkey\"></a>1. 准备 inventory &amp;&amp; sshkey</h2><p>  首次批量设置免密必然涉及使用带账号密码的inventory文件，<br>  在设置完后记得修改或删除inventory文件。</p>\n<p>  生成公钥和私钥</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 随机生成公私钥对，ssh-keygen是Linux下认证密钥生成、管理和转换工具，详细用法可参考其man文档</span><br><span class=\"hljs-comment\"># 最简单的用法，然后敲回车即可</span><br>ssh-keygen -t rsa<br><span class=\"hljs-comment\"># -N 必须设置为空，否则ssh时依然需要输入-N设置的密码</span><br><span class=\"hljs-comment\"># -C 添加注释</span><br>ssh-keygen -N <span class=\"hljs-string\">&quot;&quot;</span> -b 4096 -t rsa -C <span class=\"hljs-string\">&quot;root@localhost.com&quot;</span> -f /root/.ssh/root.rsa<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"2-编写playbook-or-使用ad-hoc\"><a href=\"#2-编写playbook-or-使用ad-hoc\" class=\"headerlink\" title=\"2. 编写playbook or 使用ad-hoc\"></a>2. 编写playbook or 使用ad-hoc</h2><ul>\n<li>authorized_key 模块<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## manage_dir 意思是如果/root没有.ssh文件目录就自动创建.ssh文件目录</span><br>ansible machine -m authorized_key -a  <span class=\"hljs-string\">&quot;user=root  key=&#x27;&#123;&#123;  lookup(&#x27;file&#x27;, &#x27;/root/.ssh/id_rsa.pub&#x27;)  &#125;&#125;&#x27;  path=/root/.ssh/authorized_keys  manage_dir=yes&quot;</span><br></code></pre></td></tr></table></figure></li>\n<li>copy &amp;&amp; shell 模块<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># copy公钥至远程主机/tmp目录下</span><br>ansible machine -m copy -a <span class=\"hljs-string\">&quot;src=/root/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub&quot;</span><br><span class=\"hljs-comment\"># 添加公钥</span><br>ansible machine -m shell -a <span class=\"hljs-string\">&quot;cat /tmp/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys&quot;</span><br></code></pre></td></tr></table></figure></li>\n<li>少量主机时可用<ul>\n<li>需要自己输入密码</li>\n<li>主机较多时频繁输入密码较麻烦，主机量少时可以使用</li>\n<li>个别新增可用此方法</li>\n<li>也可配合expect实现自动输入密码</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.1<br></code></pre></td></tr></table></figure>\n<p>关于expect用法可查询其他资料，bash脚本可以结合expect使用，从而达到自动批量登录设置免密的效果。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># ! /usr/bin/expect</span><br><span class=\"hljs-comment\"># 设置要连接的远程主机IP信息</span><br><span class=\"hljs-built_in\">set</span> IP      [ lindex <span class=\"hljs-variable\">$argv</span> 0 ]<br><span class=\"hljs-comment\"># 设置要连接的远程主机登录用户</span><br><span class=\"hljs-built_in\">set</span> USER    [ lindex <span class=\"hljs-variable\">$argv</span> 1 ]<br><span class=\"hljs-comment\"># 设置要连接的远程主机登录用户的密码信息</span><br><span class=\"hljs-built_in\">set</span> PASSWD [ lindex <span class=\"hljs-variable\">$argv</span> 2 ]<br><span class=\"hljs-comment\"># 设置要执行的命令</span><br><span class=\"hljs-built_in\">set</span> CMD     [ lindex <span class=\"hljs-variable\">$argv</span> 3 ]<br><span class=\"hljs-comment\"># spawn是expect内部命令，开启ssh连接</span><br>spawn ssh <span class=\"hljs-variable\">$USER</span>@<span class=\"hljs-variable\">$IP</span> <span class=\"hljs-variable\">$CMD</span><br><span class=\"hljs-comment\"># 判断上次执行结果</span><br>expect &#123;<br>    <span class=\"hljs-comment\"># 如果有yes或no关键字</span><br>    <span class=\"hljs-string\">&quot;(yes/no)? &quot;</span> &#123;<br>        <span class=\"hljs-comment\"># 则输入yes</span><br>        send <span class=\"hljs-string\">&quot;yes\\r&quot;</span><br>        <span class=\"hljs-comment\"># 输入完yes后如果输出结果有：password: 关键字</span><br>        expect <span class=\"hljs-string\">&quot;password:&quot;</span><br>        <span class=\"hljs-comment\"># 则输入密码文件</span><br>        send <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PASSWD</span>\\r&quot;</span><br>        &#125;<br>    <span class=\"hljs-comment\"># 如果上次输出结果有：password: ，则输入密码</span><br>    <span class=\"hljs-string\">&quot;password:&quot;</span> &#123;send <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PASSWD</span>\\r&quot;</span>&#125;<br>    <span class=\"hljs-comment\"># 如果上次输出结果有：* to host ，则退出</span><br>    <span class=\"hljs-string\">&quot;* to host&quot;</span> &#123;<span class=\"hljs-built_in\">exit</span> 1&#125;<br>    &#125;<br>expect eof<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"3-验证\"><a href=\"#3-验证\" class=\"headerlink\" title=\"3. 验证\"></a>3. 验证</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将 ip host 写入/etc/hosts文件，如</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;192.168.1.1 master&quot;</span> &gt;&gt; /etc/hosts<br><span class=\"hljs-comment\">## 实现直接输入master登录远程服务器</span><br>ssh master <br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"Ansible-批量设置免密登录\"><a href=\"#Ansible-批量设置免密登录\" class=\"headerlink\" title=\"Ansible 批量设置免密登录\"></a>Ansible 批量设置免密登录</h1><h2 id=\"1-准备-inventory-sshkey\"><a href=\"#1-准备-inventory-sshkey\" class=\"headerlink\" title=\"1. 准备 inventory &amp;&amp; sshkey\"></a>1. 准备 inventory &amp;&amp; sshkey</h2><p>  首次批量设置免密必然涉及使用带账号密码的inventory文件，<br>  在设置完后记得修改或删除inventory文件。</p>\n<p>  生成公钥和私钥</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 随机生成公私钥对，ssh-keygen是Linux下认证密钥生成、管理和转换工具，详细用法可参考其man文档</span><br><span class=\"hljs-comment\"># 最简单的用法，然后敲回车即可</span><br>ssh-keygen -t rsa<br><span class=\"hljs-comment\"># -N 必须设置为空，否则ssh时依然需要输入-N设置的密码</span><br><span class=\"hljs-comment\"># -C 添加注释</span><br>ssh-keygen -N <span class=\"hljs-string\">&quot;&quot;</span> -b 4096 -t rsa -C <span class=\"hljs-string\">&quot;root@localhost.com&quot;</span> -f /root/.ssh/root.rsa<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"2-编写playbook-or-使用ad-hoc\"><a href=\"#2-编写playbook-or-使用ad-hoc\" class=\"headerlink\" title=\"2. 编写playbook or 使用ad-hoc\"></a>2. 编写playbook or 使用ad-hoc</h2><ul>\n<li>authorized_key 模块<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## manage_dir 意思是如果/root没有.ssh文件目录就自动创建.ssh文件目录</span><br>ansible machine -m authorized_key -a  <span class=\"hljs-string\">&quot;user=root  key=&#x27;&#123;&#123;  lookup(&#x27;file&#x27;, &#x27;/root/.ssh/id_rsa.pub&#x27;)  &#125;&#125;&#x27;  path=/root/.ssh/authorized_keys  manage_dir=yes&quot;</span><br></code></pre></td></tr></table></figure></li>\n<li>copy &amp;&amp; shell 模块<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># copy公钥至远程主机/tmp目录下</span><br>ansible machine -m copy -a <span class=\"hljs-string\">&quot;src=/root/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub&quot;</span><br><span class=\"hljs-comment\"># 添加公钥</span><br>ansible machine -m shell -a <span class=\"hljs-string\">&quot;cat /tmp/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys&quot;</span><br></code></pre></td></tr></table></figure></li>\n<li>少量主机时可用<ul>\n<li>需要自己输入密码</li>\n<li>主机较多时频繁输入密码较麻烦，主机量少时可以使用</li>\n<li>个别新增可用此方法</li>\n<li>也可配合expect实现自动输入密码</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.1<br></code></pre></td></tr></table></figure>\n<p>关于expect用法可查询其他资料，bash脚本可以结合expect使用，从而达到自动批量登录设置免密的效果。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># ! /usr/bin/expect</span><br><span class=\"hljs-comment\"># 设置要连接的远程主机IP信息</span><br><span class=\"hljs-built_in\">set</span> IP      [ lindex <span class=\"hljs-variable\">$argv</span> 0 ]<br><span class=\"hljs-comment\"># 设置要连接的远程主机登录用户</span><br><span class=\"hljs-built_in\">set</span> USER    [ lindex <span class=\"hljs-variable\">$argv</span> 1 ]<br><span class=\"hljs-comment\"># 设置要连接的远程主机登录用户的密码信息</span><br><span class=\"hljs-built_in\">set</span> PASSWD [ lindex <span class=\"hljs-variable\">$argv</span> 2 ]<br><span class=\"hljs-comment\"># 设置要执行的命令</span><br><span class=\"hljs-built_in\">set</span> CMD     [ lindex <span class=\"hljs-variable\">$argv</span> 3 ]<br><span class=\"hljs-comment\"># spawn是expect内部命令，开启ssh连接</span><br>spawn ssh <span class=\"hljs-variable\">$USER</span>@<span class=\"hljs-variable\">$IP</span> <span class=\"hljs-variable\">$CMD</span><br><span class=\"hljs-comment\"># 判断上次执行结果</span><br>expect &#123;<br>    <span class=\"hljs-comment\"># 如果有yes或no关键字</span><br>    <span class=\"hljs-string\">&quot;(yes/no)? &quot;</span> &#123;<br>        <span class=\"hljs-comment\"># 则输入yes</span><br>        send <span class=\"hljs-string\">&quot;yes\\r&quot;</span><br>        <span class=\"hljs-comment\"># 输入完yes后如果输出结果有：password: 关键字</span><br>        expect <span class=\"hljs-string\">&quot;password:&quot;</span><br>        <span class=\"hljs-comment\"># 则输入密码文件</span><br>        send <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PASSWD</span>\\r&quot;</span><br>        &#125;<br>    <span class=\"hljs-comment\"># 如果上次输出结果有：password: ，则输入密码</span><br>    <span class=\"hljs-string\">&quot;password:&quot;</span> &#123;send <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$PASSWD</span>\\r&quot;</span>&#125;<br>    <span class=\"hljs-comment\"># 如果上次输出结果有：* to host ，则退出</span><br>    <span class=\"hljs-string\">&quot;* to host&quot;</span> &#123;<span class=\"hljs-built_in\">exit</span> 1&#125;<br>    &#125;<br>expect eof<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"3-验证\"><a href=\"#3-验证\" class=\"headerlink\" title=\"3. 验证\"></a>3. 验证</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 将 ip host 写入/etc/hosts文件，如</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;192.168.1.1 master&quot;</span> &gt;&gt; /etc/hosts<br><span class=\"hljs-comment\">## 实现直接输入master登录远程服务器</span><br>ssh master <br></code></pre></td></tr></table></figure>"},{"title":"Ansible Playbook 规范","date":"2024-09-27T07:01:47.000Z","_content":"# Ansible Playbook 规范\n\n## 目录结构\n\n可以使用ansible-galaxy 来生成role的目录结构\n\n```bash\n## 生成 role\nansible-galaxy init rolename\n\n## 查看生成的 role结构\ntree roles\nroles/\n└── rolename\n    ├── README.md\n    ├── defaults\n    │   └── main.yml\n    ├── files\n    ├── handlers\n    │   └── main.yml\n    ├── meta\n    │   └── main.yml\n    ├── tasks\n    │   └── main.yml\n    ├── templates\n    ├── tests\n    │   ├── inventory\n    │   └── test.yml\n    └── vars\n        └── main.yml\n\n## Ansible Galaxy 网站下载角色\n## 可以下载看看别人的 playbook\nansible-galaxy install username.rolename\n```\n## Playbook 规范\n\n严格缩进，两个空格\n\n```yaml\n---\n- hosts: webservers\n  vars:\n    http_port: 80\n    max_clients: 200\n  remote_user: root\n  tasks:\n  - name: ensure apache is at the latest version\n    yum: pkg=httpd state=latest\n  - name: write the apache config file\n    template: src=/srv/httpd.j2 dest=/etc/httpd.conf\n    notify:\n    - restart apache\n  - name: ensure apache is running\n    service: name=httpd state=started\n  handlers:\n    - name: restart apache\n      service: name=httpd state=restarted\n```\n\n## shell, command 模块返回码处理\n\n使用 command module 和 shell module 时,我们需要关心返回码信息,如果有一条命令成功执行的返回码不是0, 可以这样做:\n\n```yaml\ntasks:\n  - name: run this command and ignore the result\n    shell: /usr/bin/somecommand || /bin/true\n\ntasks:\n  - name: run this command and ignore the result\n    shell: /usr/bin/somecommand\n    ignore_errors: True\n```\n\n对于 command module 和 shell module,重复执行 playbook,实际上是重复运行同样的命令.如果执行的命令类似于 ‘chmod’ 或者 ‘setsebool’ 这种命令,这没有任何问题.也可以使用一个叫做 ‘creates’ 的 flag 使得这两个 module 变得具有”幂等”特性.\n\n## 引用task\n\n如下foo.yaml例子\n\n```yaml\n---\n# possibly saved as tasks/foo.yml\n- name: placeholder foo\n  command: /bin/foo\n\n- name: placeholder bar\n  command: /bin/bar\n```\n\n使用include引用foo.yaml\n\n```yaml\ntasks:\n  - include: tasks/foo.yml\n```\n\n也可以传递变量\n\n```yaml\ntasks:\n  - include: wordpress.yml wp_user=timmy\n  - include: wordpress.yml wp_user=alice\n  - include: wordpress.yml wp_user=bob\n\n## 或者\ntasks:\n  - include: wordpress.yml\n    vars:\n        wp_user: timmy\n        some_list_variable:\n          - alpha\n          - beta\n          - gamma\n```\n## roles 引用\n\n```yaml\n---\n- hosts: webservers\n  roles:\n     - common\n     - webservers\n```\n这个 playbook 为一个角色 common 指定了如下的行为：\n\n- 如果 roles/common/tasks/main.yml 存在, 其中列出的 tasks 将被添加到 play 中\n- 如果 roles/common/handlers/main.yml 存在, 其中列出的 handlers 将被添加到 play 中\n- 如果 roles/common/vars/main.yml 存在, 其中列出的 variables 将被添加到 play 中\n- 如果 roles/common/meta/main.yml 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中 (1.3 and later)\n- 所有 copy tasks 可以引用 roles/common/files/ 中的文件，不需要指明文件的路径。\n- 所有 script tasks 可以引用 roles/common/files/ 中的脚本，不需要指明文件的路径。\n- 所有 template tasks 可以引用 roles/common/templates/ 中的文件，不需要指明文件的路径。\n- 所有 include tasks 可以引用 roles/common/tasks/ 中的文件，不需要指明文件的路径。\n\n为 roles 设置触发条件\n\n```yaml\n---\n- hosts: webservers\n  roles:\n    - { role: some_role, when: \"ansible_os_family == 'RedHat'\" }\n```\n\n如果你希望定义一些 tasks，让它们在 roles 之前以及之后执行\n```yaml\n---\n- hosts: webservers\n  pre_tasks:\n    - shell: echo 'hello'\n  roles:\n    - { role: some_role }\n  tasks:\n    - shell: echo 'still busy'\n  post_tasks:\n    - shell: echo 'goodbye'\n```\n## 角色默认变量\n\n角色默认变量允许你为 included roles 或者 dependent roles设置默认变量。要创建默认变量，只需在 roles 目录下添加 defaults/main.yml 文件。这些变量在所有可用变量中拥有最低优先级，可能被其他地方定义的变量(包括 inventory 中的变量)所覆盖。\n\n## 角色依赖\n\n“角色依赖” 使你可以自动地将其他 roles 拉取到现在使用的 role 中。”角色依赖” 保存在 roles 目录下的 meta/main.yml 文件中。这个文件应包含一列 roles 和 为之指定的参数，下面是在 roles/myapp/meta/main.yml 文件中的示例:\n\n```yaml\n---\ndependencies:\n  - { role: common, some_parameter: 3 }\n  - { role: apache, port: 80 }\n  - { role: postgres, dbname: blarg, other_parameter: 12 }\n```\n\n## 使用变量\n\n### 注册变量\n\n```yaml\n- hosts: web_servers\n  tasks:\n     - shell: /usr/bin/foo\n       register: foo_result\n       ignore_errors: True\n     - shell: /usr/bin/bar\n       when: foo_result.rc == 5\n```\n\n### 使用facts获取的信息\n\n```shell\nansible hostname -m setup\n```\n\n```json\n\"ansible_all_ipv4_addresses\": [\n    \"REDACTED IP ADDRESS\"\n],\n\"ansible_all_ipv6_addresses\": [\n    \"REDACTED IPV6 ADDRESS\"\n],\n\"ansible_architecture\": \"x86_64\",\n\"ansible_bios_date\": \"09/20/2012\",\n\"ansible_bios_version\": \"6.00\",\n\"ansible_cmdline\": {\n    \"BOOT_IMAGE\": \"/boot/vmlinuz-3.5.0-23-generic\",\n    \"quiet\": true,\n    \"ro\": true,\n    \"root\": \"UUID=4195bff4-e157-4e41-8701-e93f0aec9e22\",\n    \"splash\": true\n},\n\"ansible_date_time\": {\n    \"date\": \"2013-10-02\",\n    \"day\": \"02\",\n    \"epoch\": \"1380756810\",\n    \"hour\": \"19\",\n    \"iso8601\": \"2013-10-02T23:33:30Z\",\n    \"iso8601_micro\": \"2013-10-02T23:33:30.036070Z\",\n    \"minute\": \"33\",\n    \"month\": \"10\",\n    \"second\": \"30\",\n    \"time\": \"19:33:30\",\n    \"tz\": \"EDT\",\n    \"year\": \"2013\"\n},\n\"ansible_default_ipv4\": {\n    \"address\": \"REDACTED\",\n    \"alias\": \"eth0\",\n    \"gateway\": \"REDACTED\",\n    \"interface\": \"eth0\",\n    \"macaddress\": \"REDACTED\",\n    \"mtu\": 1500,\n    \"netmask\": \"255.255.255.0\",\n    \"network\": \"REDACTED\",\n    \"type\": \"ether\"\n},\n\"ansible_default_ipv6\": {},\n\"ansible_devices\": {\n    \"fd0\": {\n        \"holders\": [],\n        \"host\": \"\",\n        \"model\": null,\n        \"partitions\": {},\n        \"removable\": \"1\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"0\",\n        \"sectorsize\": \"512\",\n        \"size\": \"0.00 Bytes\",\n        \"support_discard\": \"0\",\n        \"vendor\": null\n    },\n    \"sda\": {\n        \"holders\": [],\n        \"host\": \"SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)\",\n        \"model\": \"VMware Virtual S\",\n        \"partitions\": {\n            \"sda1\": {\n                \"sectors\": \"39843840\",\n                \"sectorsize\": 512,\n                \"size\": \"19.00 GB\",\n                \"start\": \"2048\"\n            },\n            \"sda2\": {\n                \"sectors\": \"2\",\n                \"sectorsize\": 512,\n                \"size\": \"1.00 KB\",\n                \"start\": \"39847934\"\n            },\n            \"sda5\": {\n                \"sectors\": \"2093056\",\n                \"sectorsize\": 512,\n                \"size\": \"1022.00 MB\",\n                \"start\": \"39847936\"\n            }\n        },\n        \"removable\": \"0\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"41943040\",\n        \"sectorsize\": \"512\",\n        \"size\": \"20.00 GB\",\n        \"support_discard\": \"0\",\n        \"vendor\": \"VMware,\"\n    },\n    \"sr0\": {\n        \"holders\": [],\n        \"host\": \"IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)\",\n        \"model\": \"VMware IDE CDR10\",\n        \"partitions\": {},\n        \"removable\": \"1\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"2097151\",\n        \"sectorsize\": \"512\",\n        \"size\": \"1024.00 MB\",\n        \"support_discard\": \"0\",\n        \"vendor\": \"NECVMWar\"\n    }\n},\n\"ansible_distribution\": \"Ubuntu\",\n\"ansible_distribution_release\": \"precise\",\n\"ansible_distribution_version\": \"12.04\",\n\"ansible_domain\": \"\",\n\"ansible_env\": {\n    \"COLORTERM\": \"gnome-terminal\",\n    \"DISPLAY\": \":0\",\n    \"HOME\": \"/home/mdehaan\",\n    \"LANG\": \"C\",\n    \"LESSCLOSE\": \"/usr/bin/lesspipe %s %s\",\n    \"LESSOPEN\": \"| /usr/bin/lesspipe %s\",\n    \"LOGNAME\": \"root\",\n    \"LS_COLORS\": \"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.axa=00;36:*.oga=00;36:*.spx=00;36:*.xspf=00;36:\",\n    \"MAIL\": \"/var/mail/root\",\n    \"OLDPWD\": \"/root/ansible/docsite\",\n    \"PATH\": \"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\",\n    \"PWD\": \"/root/ansible\",\n    \"SHELL\": \"/bin/bash\",\n    \"SHLVL\": \"1\",\n    \"SUDO_COMMAND\": \"/bin/bash\",\n    \"SUDO_GID\": \"1000\",\n    \"SUDO_UID\": \"1000\",\n    \"SUDO_USER\": \"mdehaan\",\n    \"TERM\": \"xterm\",\n    \"USER\": \"root\",\n    \"USERNAME\": \"root\",\n    \"XAUTHORITY\": \"/home/mdehaan/.Xauthority\",\n    \"_\": \"/usr/local/bin/ansible\"\n},\n\"ansible_eth0\": {\n    \"active\": true,\n    \"device\": \"eth0\",\n    \"ipv4\": {\n        \"address\": \"REDACTED\",\n        \"netmask\": \"255.255.255.0\",\n        \"network\": \"REDACTED\"\n    },\n    \"ipv6\": [\n        {\n            \"address\": \"REDACTED\",\n            \"prefix\": \"64\",\n            \"scope\": \"link\"\n        }\n    ],\n    \"macaddress\": \"REDACTED\",\n    \"module\": \"e1000\",\n    \"mtu\": 1500,\n    \"type\": \"ether\"\n},\n\"ansible_form_factor\": \"Other\",\n\"ansible_fqdn\": \"ubuntu2.example.com\",\n\"ansible_hostname\": \"ubuntu2\",\n\"ansible_interfaces\": [\n    \"lo\",\n    \"eth0\"\n],\n\"ansible_kernel\": \"3.5.0-23-generic\",\n\"ansible_lo\": {\n    \"active\": true,\n    \"device\": \"lo\",\n    \"ipv4\": {\n        \"address\": \"127.0.0.1\",\n        \"netmask\": \"255.0.0.0\",\n        \"network\": \"127.0.0.0\"\n    },\n    \"ipv6\": [\n        {\n            \"address\": \"::1\",\n            \"prefix\": \"128\",\n            \"scope\": \"host\"\n        }\n    ],\n    \"mtu\": 16436,\n    \"type\": \"loopback\"\n},\n\"ansible_lsb\": {\n    \"codename\": \"precise\",\n    \"description\": \"Ubuntu 12.04.2 LTS\",\n    \"id\": \"Ubuntu\",\n    \"major_release\": \"12\",\n    \"release\": \"12.04\"\n},\n\"ansible_machine\": \"x86_64\",\n\"ansible_memfree_mb\": 74,\n\"ansible_memtotal_mb\": 991,\n\"ansible_mounts\": [\n    {\n        \"device\": \"/dev/sda1\",\n        \"fstype\": \"ext4\",\n        \"mount\": \"/\",\n        \"options\": \"rw,errors=remount-ro\",\n        \"size_available\": 15032406016,\n        \"size_total\": 20079898624\n    }\n],\n\"ansible_nodename\": \"ubuntu2.example.com\",\n\"ansible_os_family\": \"Debian\",\n\"ansible_pkg_mgr\": \"apt\",\n\"ansible_processor\": [\n    \"Intel(R) Core(TM) i7 CPU         860  @ 2.80GHz\"\n],\n\"ansible_processor_cores\": 1,\n\"ansible_processor_count\": 1,\n\"ansible_processor_threads_per_core\": 1,\n\"ansible_processor_vcpus\": 1,\n\"ansible_product_name\": \"VMware Virtual Platform\",\n\"ansible_product_serial\": \"REDACTED\",\n\"ansible_product_uuid\": \"REDACTED\",\n\"ansible_product_version\": \"None\",\n\"ansible_python_version\": \"2.7.3\",\n\"ansible_selinux\": false,\n\"ansible_ssh_host_key_dsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_ssh_host_key_ecdsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_ssh_host_key_rsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_swapfree_mb\": 665,\n\"ansible_swaptotal_mb\": 1021,\n\"ansible_system\": \"Linux\",\n\"ansible_system_vendor\": \"VMware, Inc.\",\n\"ansible_user_id\": \"root\",\n\"ansible_userspace_architecture\": \"x86_64\",\n\"ansible_userspace_bits\": \"64\",\n\"ansible_virtualization_role\": \"guest\",\n\"ansible_virtualization_type\": \"VMware\"\n```\n### 使用复杂变量\n\n```jinja\n{{ ansible_eth0[\"ipv4\"][\"address\"] }}\n{{ ansible_eth0.ipv4.address }}\n## 访问数组第一个元素\n{{ foo[0] }}\n```\n\n## 条件选择\n\n### when 使用\n\n```yaml\ntasks:\n  - name: \"shutdown Debian flavored systems\"\n    command: /sbin/shutdown -t now\n    when: ansible_os_family == \"Debian\"\n\n## 通过执行结果来判断\ntasks:\n  - command: /bin/false\n    register: result\n    ignore_errors: True\n  - command: /bin/something\n    when: result|failed\n  - command: /bin/something_else\n    when: result|success\n  - command: /bin/still/something_else\n    when: result|skipped\n```\n\n```yaml\nvars:\n  epic: true\n\ntasks:\n    - shell: echo \"This certainly is epic!\"\n      when: epic\n\ntasks:\n    - shell: echo \"This certainly isn't epic!\"\n      when: not epic\n\ntasks:\n    - shell: echo \"I've got '{{ foo }}' and am not afraid to use it!\"\n      when: foo is defined\n    - fail: msg=\"Bailing out. this play requires 'bar'\"\n      when: bar is not defined\n```\n\n### 条件导入\n\n```yaml\n---\n- hosts: all\n  remote_user: root\n  vars_files:\n    - \"vars/common.yml\"\n    - [ \"vars/{{ ansible_os_family }}.yml\", \"vars/os_defaults.yml\" ]\n  tasks:\n  - name: make sure apache is running\n    service: name={{ apache }} state=running\n```\n\n### 基于变量选择文件和模版\n\n```yaml\n- name: template a file\n  template: src={{ item }} dest=/etc/myapp/foo.conf\n  with_first_found:\n    - files:\n      - {{ ansible_distribution }}.conf\n      - default.conf\n      paths:\n      - search_location_one/somedir/\n      - /opt/other_location/somedir/\n```\n\n### 注册变量\n\n```yaml\n- name: test play\n  hosts: all\n  tasks:\n    - shell: cat /etc/motd\n      register: motd_contents\n    - shell: echo \"motd contains the word hi\"\n      when: motd_contents.stdout.find('hi') != -1\n```\n\n## 循环\n\n### 标准循环\n\n```yaml\n- name: add several users\n  user: name={{ item }} state=present groups=wheel\n  with_items:\n     - testuser1\n     - testuser2\n\n- name: add several users\n  user: name={{ item.name }} state=present groups={{ item.groups }}\n  with_items:\n    - { name: 'testuser1', groups: 'wheel' }\n    - { name: 'testuser2', groups: 'root' }\n```\n\n### 嵌套循环\n\n```yaml\n- name: give users access to multiple databases\n  mysql_user: name={{ item[0] }} priv={{ item[1] }}.*:ALL append_privs=yes password=foo\n  with_nested:\n    - [ 'alice', 'bob' ]\n    - [ 'clientdb', 'employeedb', 'providerdb' ]\n```\n\n### 哈希表循环\n\n```yaml\n---\nusers:\n  alice:\n    name: Alice Appleworth\n    telephone: 123-456-7890\n  bob:\n    name: Bob Bananarama\n    telephone: 987-654-3210\n\n---\ntasks:\n  - name: Print phone records\n    debug: msg=\"User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})\"\n    with_dict: \"{{users}}\"\n```\n\n### 文件列表循环\n\n```yaml\n---\n- hosts: all\n  tasks:\n    # first ensure our target directory exists\n    - file: dest=/etc/fooapp state=directory\n    # copy each file over that matches the given pattern\n    - copy: src={{ item }} dest=/etc/fooapp/ owner=root mode=600\n      with_fileglob:\n        - /playbooks/files/fooapp/*\n```","source":"_posts/ansible-action.md","raw":"---\ntitle: Ansible Playbook 规范\ndate: 2024-09-27 15:01:47\ntags: ansible\n---\n# Ansible Playbook 规范\n\n## 目录结构\n\n可以使用ansible-galaxy 来生成role的目录结构\n\n```bash\n## 生成 role\nansible-galaxy init rolename\n\n## 查看生成的 role结构\ntree roles\nroles/\n└── rolename\n    ├── README.md\n    ├── defaults\n    │   └── main.yml\n    ├── files\n    ├── handlers\n    │   └── main.yml\n    ├── meta\n    │   └── main.yml\n    ├── tasks\n    │   └── main.yml\n    ├── templates\n    ├── tests\n    │   ├── inventory\n    │   └── test.yml\n    └── vars\n        └── main.yml\n\n## Ansible Galaxy 网站下载角色\n## 可以下载看看别人的 playbook\nansible-galaxy install username.rolename\n```\n## Playbook 规范\n\n严格缩进，两个空格\n\n```yaml\n---\n- hosts: webservers\n  vars:\n    http_port: 80\n    max_clients: 200\n  remote_user: root\n  tasks:\n  - name: ensure apache is at the latest version\n    yum: pkg=httpd state=latest\n  - name: write the apache config file\n    template: src=/srv/httpd.j2 dest=/etc/httpd.conf\n    notify:\n    - restart apache\n  - name: ensure apache is running\n    service: name=httpd state=started\n  handlers:\n    - name: restart apache\n      service: name=httpd state=restarted\n```\n\n## shell, command 模块返回码处理\n\n使用 command module 和 shell module 时,我们需要关心返回码信息,如果有一条命令成功执行的返回码不是0, 可以这样做:\n\n```yaml\ntasks:\n  - name: run this command and ignore the result\n    shell: /usr/bin/somecommand || /bin/true\n\ntasks:\n  - name: run this command and ignore the result\n    shell: /usr/bin/somecommand\n    ignore_errors: True\n```\n\n对于 command module 和 shell module,重复执行 playbook,实际上是重复运行同样的命令.如果执行的命令类似于 ‘chmod’ 或者 ‘setsebool’ 这种命令,这没有任何问题.也可以使用一个叫做 ‘creates’ 的 flag 使得这两个 module 变得具有”幂等”特性.\n\n## 引用task\n\n如下foo.yaml例子\n\n```yaml\n---\n# possibly saved as tasks/foo.yml\n- name: placeholder foo\n  command: /bin/foo\n\n- name: placeholder bar\n  command: /bin/bar\n```\n\n使用include引用foo.yaml\n\n```yaml\ntasks:\n  - include: tasks/foo.yml\n```\n\n也可以传递变量\n\n```yaml\ntasks:\n  - include: wordpress.yml wp_user=timmy\n  - include: wordpress.yml wp_user=alice\n  - include: wordpress.yml wp_user=bob\n\n## 或者\ntasks:\n  - include: wordpress.yml\n    vars:\n        wp_user: timmy\n        some_list_variable:\n          - alpha\n          - beta\n          - gamma\n```\n## roles 引用\n\n```yaml\n---\n- hosts: webservers\n  roles:\n     - common\n     - webservers\n```\n这个 playbook 为一个角色 common 指定了如下的行为：\n\n- 如果 roles/common/tasks/main.yml 存在, 其中列出的 tasks 将被添加到 play 中\n- 如果 roles/common/handlers/main.yml 存在, 其中列出的 handlers 将被添加到 play 中\n- 如果 roles/common/vars/main.yml 存在, 其中列出的 variables 将被添加到 play 中\n- 如果 roles/common/meta/main.yml 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中 (1.3 and later)\n- 所有 copy tasks 可以引用 roles/common/files/ 中的文件，不需要指明文件的路径。\n- 所有 script tasks 可以引用 roles/common/files/ 中的脚本，不需要指明文件的路径。\n- 所有 template tasks 可以引用 roles/common/templates/ 中的文件，不需要指明文件的路径。\n- 所有 include tasks 可以引用 roles/common/tasks/ 中的文件，不需要指明文件的路径。\n\n为 roles 设置触发条件\n\n```yaml\n---\n- hosts: webservers\n  roles:\n    - { role: some_role, when: \"ansible_os_family == 'RedHat'\" }\n```\n\n如果你希望定义一些 tasks，让它们在 roles 之前以及之后执行\n```yaml\n---\n- hosts: webservers\n  pre_tasks:\n    - shell: echo 'hello'\n  roles:\n    - { role: some_role }\n  tasks:\n    - shell: echo 'still busy'\n  post_tasks:\n    - shell: echo 'goodbye'\n```\n## 角色默认变量\n\n角色默认变量允许你为 included roles 或者 dependent roles设置默认变量。要创建默认变量，只需在 roles 目录下添加 defaults/main.yml 文件。这些变量在所有可用变量中拥有最低优先级，可能被其他地方定义的变量(包括 inventory 中的变量)所覆盖。\n\n## 角色依赖\n\n“角色依赖” 使你可以自动地将其他 roles 拉取到现在使用的 role 中。”角色依赖” 保存在 roles 目录下的 meta/main.yml 文件中。这个文件应包含一列 roles 和 为之指定的参数，下面是在 roles/myapp/meta/main.yml 文件中的示例:\n\n```yaml\n---\ndependencies:\n  - { role: common, some_parameter: 3 }\n  - { role: apache, port: 80 }\n  - { role: postgres, dbname: blarg, other_parameter: 12 }\n```\n\n## 使用变量\n\n### 注册变量\n\n```yaml\n- hosts: web_servers\n  tasks:\n     - shell: /usr/bin/foo\n       register: foo_result\n       ignore_errors: True\n     - shell: /usr/bin/bar\n       when: foo_result.rc == 5\n```\n\n### 使用facts获取的信息\n\n```shell\nansible hostname -m setup\n```\n\n```json\n\"ansible_all_ipv4_addresses\": [\n    \"REDACTED IP ADDRESS\"\n],\n\"ansible_all_ipv6_addresses\": [\n    \"REDACTED IPV6 ADDRESS\"\n],\n\"ansible_architecture\": \"x86_64\",\n\"ansible_bios_date\": \"09/20/2012\",\n\"ansible_bios_version\": \"6.00\",\n\"ansible_cmdline\": {\n    \"BOOT_IMAGE\": \"/boot/vmlinuz-3.5.0-23-generic\",\n    \"quiet\": true,\n    \"ro\": true,\n    \"root\": \"UUID=4195bff4-e157-4e41-8701-e93f0aec9e22\",\n    \"splash\": true\n},\n\"ansible_date_time\": {\n    \"date\": \"2013-10-02\",\n    \"day\": \"02\",\n    \"epoch\": \"1380756810\",\n    \"hour\": \"19\",\n    \"iso8601\": \"2013-10-02T23:33:30Z\",\n    \"iso8601_micro\": \"2013-10-02T23:33:30.036070Z\",\n    \"minute\": \"33\",\n    \"month\": \"10\",\n    \"second\": \"30\",\n    \"time\": \"19:33:30\",\n    \"tz\": \"EDT\",\n    \"year\": \"2013\"\n},\n\"ansible_default_ipv4\": {\n    \"address\": \"REDACTED\",\n    \"alias\": \"eth0\",\n    \"gateway\": \"REDACTED\",\n    \"interface\": \"eth0\",\n    \"macaddress\": \"REDACTED\",\n    \"mtu\": 1500,\n    \"netmask\": \"255.255.255.0\",\n    \"network\": \"REDACTED\",\n    \"type\": \"ether\"\n},\n\"ansible_default_ipv6\": {},\n\"ansible_devices\": {\n    \"fd0\": {\n        \"holders\": [],\n        \"host\": \"\",\n        \"model\": null,\n        \"partitions\": {},\n        \"removable\": \"1\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"0\",\n        \"sectorsize\": \"512\",\n        \"size\": \"0.00 Bytes\",\n        \"support_discard\": \"0\",\n        \"vendor\": null\n    },\n    \"sda\": {\n        \"holders\": [],\n        \"host\": \"SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)\",\n        \"model\": \"VMware Virtual S\",\n        \"partitions\": {\n            \"sda1\": {\n                \"sectors\": \"39843840\",\n                \"sectorsize\": 512,\n                \"size\": \"19.00 GB\",\n                \"start\": \"2048\"\n            },\n            \"sda2\": {\n                \"sectors\": \"2\",\n                \"sectorsize\": 512,\n                \"size\": \"1.00 KB\",\n                \"start\": \"39847934\"\n            },\n            \"sda5\": {\n                \"sectors\": \"2093056\",\n                \"sectorsize\": 512,\n                \"size\": \"1022.00 MB\",\n                \"start\": \"39847936\"\n            }\n        },\n        \"removable\": \"0\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"41943040\",\n        \"sectorsize\": \"512\",\n        \"size\": \"20.00 GB\",\n        \"support_discard\": \"0\",\n        \"vendor\": \"VMware,\"\n    },\n    \"sr0\": {\n        \"holders\": [],\n        \"host\": \"IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)\",\n        \"model\": \"VMware IDE CDR10\",\n        \"partitions\": {},\n        \"removable\": \"1\",\n        \"rotational\": \"1\",\n        \"scheduler_mode\": \"deadline\",\n        \"sectors\": \"2097151\",\n        \"sectorsize\": \"512\",\n        \"size\": \"1024.00 MB\",\n        \"support_discard\": \"0\",\n        \"vendor\": \"NECVMWar\"\n    }\n},\n\"ansible_distribution\": \"Ubuntu\",\n\"ansible_distribution_release\": \"precise\",\n\"ansible_distribution_version\": \"12.04\",\n\"ansible_domain\": \"\",\n\"ansible_env\": {\n    \"COLORTERM\": \"gnome-terminal\",\n    \"DISPLAY\": \":0\",\n    \"HOME\": \"/home/mdehaan\",\n    \"LANG\": \"C\",\n    \"LESSCLOSE\": \"/usr/bin/lesspipe %s %s\",\n    \"LESSOPEN\": \"| /usr/bin/lesspipe %s\",\n    \"LOGNAME\": \"root\",\n    \"LS_COLORS\": \"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.axa=00;36:*.oga=00;36:*.spx=00;36:*.xspf=00;36:\",\n    \"MAIL\": \"/var/mail/root\",\n    \"OLDPWD\": \"/root/ansible/docsite\",\n    \"PATH\": \"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\",\n    \"PWD\": \"/root/ansible\",\n    \"SHELL\": \"/bin/bash\",\n    \"SHLVL\": \"1\",\n    \"SUDO_COMMAND\": \"/bin/bash\",\n    \"SUDO_GID\": \"1000\",\n    \"SUDO_UID\": \"1000\",\n    \"SUDO_USER\": \"mdehaan\",\n    \"TERM\": \"xterm\",\n    \"USER\": \"root\",\n    \"USERNAME\": \"root\",\n    \"XAUTHORITY\": \"/home/mdehaan/.Xauthority\",\n    \"_\": \"/usr/local/bin/ansible\"\n},\n\"ansible_eth0\": {\n    \"active\": true,\n    \"device\": \"eth0\",\n    \"ipv4\": {\n        \"address\": \"REDACTED\",\n        \"netmask\": \"255.255.255.0\",\n        \"network\": \"REDACTED\"\n    },\n    \"ipv6\": [\n        {\n            \"address\": \"REDACTED\",\n            \"prefix\": \"64\",\n            \"scope\": \"link\"\n        }\n    ],\n    \"macaddress\": \"REDACTED\",\n    \"module\": \"e1000\",\n    \"mtu\": 1500,\n    \"type\": \"ether\"\n},\n\"ansible_form_factor\": \"Other\",\n\"ansible_fqdn\": \"ubuntu2.example.com\",\n\"ansible_hostname\": \"ubuntu2\",\n\"ansible_interfaces\": [\n    \"lo\",\n    \"eth0\"\n],\n\"ansible_kernel\": \"3.5.0-23-generic\",\n\"ansible_lo\": {\n    \"active\": true,\n    \"device\": \"lo\",\n    \"ipv4\": {\n        \"address\": \"127.0.0.1\",\n        \"netmask\": \"255.0.0.0\",\n        \"network\": \"127.0.0.0\"\n    },\n    \"ipv6\": [\n        {\n            \"address\": \"::1\",\n            \"prefix\": \"128\",\n            \"scope\": \"host\"\n        }\n    ],\n    \"mtu\": 16436,\n    \"type\": \"loopback\"\n},\n\"ansible_lsb\": {\n    \"codename\": \"precise\",\n    \"description\": \"Ubuntu 12.04.2 LTS\",\n    \"id\": \"Ubuntu\",\n    \"major_release\": \"12\",\n    \"release\": \"12.04\"\n},\n\"ansible_machine\": \"x86_64\",\n\"ansible_memfree_mb\": 74,\n\"ansible_memtotal_mb\": 991,\n\"ansible_mounts\": [\n    {\n        \"device\": \"/dev/sda1\",\n        \"fstype\": \"ext4\",\n        \"mount\": \"/\",\n        \"options\": \"rw,errors=remount-ro\",\n        \"size_available\": 15032406016,\n        \"size_total\": 20079898624\n    }\n],\n\"ansible_nodename\": \"ubuntu2.example.com\",\n\"ansible_os_family\": \"Debian\",\n\"ansible_pkg_mgr\": \"apt\",\n\"ansible_processor\": [\n    \"Intel(R) Core(TM) i7 CPU         860  @ 2.80GHz\"\n],\n\"ansible_processor_cores\": 1,\n\"ansible_processor_count\": 1,\n\"ansible_processor_threads_per_core\": 1,\n\"ansible_processor_vcpus\": 1,\n\"ansible_product_name\": \"VMware Virtual Platform\",\n\"ansible_product_serial\": \"REDACTED\",\n\"ansible_product_uuid\": \"REDACTED\",\n\"ansible_product_version\": \"None\",\n\"ansible_python_version\": \"2.7.3\",\n\"ansible_selinux\": false,\n\"ansible_ssh_host_key_dsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_ssh_host_key_ecdsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_ssh_host_key_rsa_public\": \"REDACTED KEY VALUE\"\n\"ansible_swapfree_mb\": 665,\n\"ansible_swaptotal_mb\": 1021,\n\"ansible_system\": \"Linux\",\n\"ansible_system_vendor\": \"VMware, Inc.\",\n\"ansible_user_id\": \"root\",\n\"ansible_userspace_architecture\": \"x86_64\",\n\"ansible_userspace_bits\": \"64\",\n\"ansible_virtualization_role\": \"guest\",\n\"ansible_virtualization_type\": \"VMware\"\n```\n### 使用复杂变量\n\n```jinja\n{{ ansible_eth0[\"ipv4\"][\"address\"] }}\n{{ ansible_eth0.ipv4.address }}\n## 访问数组第一个元素\n{{ foo[0] }}\n```\n\n## 条件选择\n\n### when 使用\n\n```yaml\ntasks:\n  - name: \"shutdown Debian flavored systems\"\n    command: /sbin/shutdown -t now\n    when: ansible_os_family == \"Debian\"\n\n## 通过执行结果来判断\ntasks:\n  - command: /bin/false\n    register: result\n    ignore_errors: True\n  - command: /bin/something\n    when: result|failed\n  - command: /bin/something_else\n    when: result|success\n  - command: /bin/still/something_else\n    when: result|skipped\n```\n\n```yaml\nvars:\n  epic: true\n\ntasks:\n    - shell: echo \"This certainly is epic!\"\n      when: epic\n\ntasks:\n    - shell: echo \"This certainly isn't epic!\"\n      when: not epic\n\ntasks:\n    - shell: echo \"I've got '{{ foo }}' and am not afraid to use it!\"\n      when: foo is defined\n    - fail: msg=\"Bailing out. this play requires 'bar'\"\n      when: bar is not defined\n```\n\n### 条件导入\n\n```yaml\n---\n- hosts: all\n  remote_user: root\n  vars_files:\n    - \"vars/common.yml\"\n    - [ \"vars/{{ ansible_os_family }}.yml\", \"vars/os_defaults.yml\" ]\n  tasks:\n  - name: make sure apache is running\n    service: name={{ apache }} state=running\n```\n\n### 基于变量选择文件和模版\n\n```yaml\n- name: template a file\n  template: src={{ item }} dest=/etc/myapp/foo.conf\n  with_first_found:\n    - files:\n      - {{ ansible_distribution }}.conf\n      - default.conf\n      paths:\n      - search_location_one/somedir/\n      - /opt/other_location/somedir/\n```\n\n### 注册变量\n\n```yaml\n- name: test play\n  hosts: all\n  tasks:\n    - shell: cat /etc/motd\n      register: motd_contents\n    - shell: echo \"motd contains the word hi\"\n      when: motd_contents.stdout.find('hi') != -1\n```\n\n## 循环\n\n### 标准循环\n\n```yaml\n- name: add several users\n  user: name={{ item }} state=present groups=wheel\n  with_items:\n     - testuser1\n     - testuser2\n\n- name: add several users\n  user: name={{ item.name }} state=present groups={{ item.groups }}\n  with_items:\n    - { name: 'testuser1', groups: 'wheel' }\n    - { name: 'testuser2', groups: 'root' }\n```\n\n### 嵌套循环\n\n```yaml\n- name: give users access to multiple databases\n  mysql_user: name={{ item[0] }} priv={{ item[1] }}.*:ALL append_privs=yes password=foo\n  with_nested:\n    - [ 'alice', 'bob' ]\n    - [ 'clientdb', 'employeedb', 'providerdb' ]\n```\n\n### 哈希表循环\n\n```yaml\n---\nusers:\n  alice:\n    name: Alice Appleworth\n    telephone: 123-456-7890\n  bob:\n    name: Bob Bananarama\n    telephone: 987-654-3210\n\n---\ntasks:\n  - name: Print phone records\n    debug: msg=\"User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})\"\n    with_dict: \"{{users}}\"\n```\n\n### 文件列表循环\n\n```yaml\n---\n- hosts: all\n  tasks:\n    # first ensure our target directory exists\n    - file: dest=/etc/fooapp state=directory\n    # copy each file over that matches the given pattern\n    - copy: src={{ item }} dest=/etc/fooapp/ owner=root mode=600\n      with_fileglob:\n        - /playbooks/files/fooapp/*\n```","slug":"ansible-action","published":1,"updated":"2024-09-27T07:02:44.163Z","comments":1,"layout":"post","photos":[],"_id":"cm1kdm0yb0000n6uqajr5b8qb","content":"<h1 id=\"Ansible-Playbook-规范\"><a href=\"#Ansible-Playbook-规范\" class=\"headerlink\" title=\"Ansible Playbook 规范\"></a>Ansible Playbook 规范</h1><h2 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h2><p>可以使用ansible-galaxy 来生成role的目录结构</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 生成 role</span><br>ansible-galaxy init rolename<br><br><span class=\"hljs-comment\">## 查看生成的 role结构</span><br>tree roles<br>roles/<br>└── rolename<br>    ├── README.md<br>    ├── defaults<br>    │   └── main.yml<br>    ├── files<br>    ├── handlers<br>    │   └── main.yml<br>    ├── meta<br>    │   └── main.yml<br>    ├── tasks<br>    │   └── main.yml<br>    ├── templates<br>    ├── tests<br>    │   ├── inventory<br>    │   └── test.yml<br>    └── vars<br>        └── main.yml<br><br><span class=\"hljs-comment\">## Ansible Galaxy 网站下载角色</span><br><span class=\"hljs-comment\">## 可以下载看看别人的 playbook</span><br>ansible-galaxy install username.rolename<br></code></pre></td></tr></table></figure>\n<h2 id=\"Playbook-规范\"><a href=\"#Playbook-规范\" class=\"headerlink\" title=\"Playbook 规范\"></a>Playbook 规范</h2><p>严格缩进，两个空格</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">vars:</span><br>    <span class=\"hljs-attr\">http_port:</span> <span class=\"hljs-number\">80</span><br>    <span class=\"hljs-attr\">max_clients:</span> <span class=\"hljs-number\">200</span><br>  <span class=\"hljs-attr\">remote_user:</span> <span class=\"hljs-string\">root</span><br>  <span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ensure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">at</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">latest</span> <span class=\"hljs-string\">version</span><br>    <span class=\"hljs-attr\">yum:</span> <span class=\"hljs-string\">pkg=httpd</span> <span class=\"hljs-string\">state=latest</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">write</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">config</span> <span class=\"hljs-string\">file</span><br>    <span class=\"hljs-attr\">template:</span> <span class=\"hljs-string\">src=/srv/httpd.j2</span> <span class=\"hljs-string\">dest=/etc/httpd.conf</span><br>    <span class=\"hljs-attr\">notify:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">restart</span> <span class=\"hljs-string\">apache</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ensure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">running</span><br>    <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=httpd</span> <span class=\"hljs-string\">state=started</span><br>  <span class=\"hljs-attr\">handlers:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">restart</span> <span class=\"hljs-string\">apache</span><br>      <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=httpd</span> <span class=\"hljs-string\">state=restarted</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"shell-command-模块返回码处理\"><a href=\"#shell-command-模块返回码处理\" class=\"headerlink\" title=\"shell, command 模块返回码处理\"></a>shell, command 模块返回码处理</h2><p>使用 command module 和 shell module 时,我们需要关心返回码信息,如果有一条命令成功执行的返回码不是0, 可以这样做:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">command</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">ignore</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/somecommand</span> <span class=\"hljs-string\">||</span> <span class=\"hljs-string\">/bin/true</span><br><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">command</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">ignore</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/somecommand</span><br>    <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br></code></pre></td></tr></table></figure>\n\n<p>对于 command module 和 shell module,重复执行 playbook,实际上是重复运行同样的命令.如果执行的命令类似于 ‘chmod’ 或者 ‘setsebool’ 这种命令,这没有任何问题.也可以使用一个叫做 ‘creates’ 的 flag 使得这两个 module 变得具有”幂等”特性.</p>\n<h2 id=\"引用task\"><a href=\"#引用task\" class=\"headerlink\" title=\"引用task\"></a>引用task</h2><p>如下foo.yaml例子</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-comment\"># possibly saved as tasks/foo.yml</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">placeholder</span> <span class=\"hljs-string\">foo</span><br>  <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/foo</span><br><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">placeholder</span> <span class=\"hljs-string\">bar</span><br>  <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/bar</span><br></code></pre></td></tr></table></figure>\n\n<p>使用include引用foo.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">tasks/foo.yml</span><br></code></pre></td></tr></table></figure>\n\n<p>也可以传递变量</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=timmy</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=alice</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=bob</span><br><br><span class=\"hljs-comment\">## 或者</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span><br>    <span class=\"hljs-attr\">vars:</span><br>        <span class=\"hljs-attr\">wp_user:</span> <span class=\"hljs-string\">timmy</span><br>        <span class=\"hljs-attr\">some_list_variable:</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">alpha</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">beta</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">gamma</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"roles-引用\"><a href=\"#roles-引用\" class=\"headerlink\" title=\"roles 引用\"></a>roles 引用</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">roles:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">common</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">webservers</span><br></code></pre></td></tr></table></figure>\n<p>这个 playbook 为一个角色 common 指定了如下的行为：</p>\n<ul>\n<li>如果 roles&#x2F;common&#x2F;tasks&#x2F;main.yml 存在, 其中列出的 tasks 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;handlers&#x2F;main.yml 存在, 其中列出的 handlers 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;vars&#x2F;main.yml 存在, 其中列出的 variables 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;meta&#x2F;main.yml 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中 (1.3 and later)</li>\n<li>所有 copy tasks 可以引用 roles&#x2F;common&#x2F;files&#x2F; 中的文件，不需要指明文件的路径。</li>\n<li>所有 script tasks 可以引用 roles&#x2F;common&#x2F;files&#x2F; 中的脚本，不需要指明文件的路径。</li>\n<li>所有 template tasks 可以引用 roles&#x2F;common&#x2F;templates&#x2F; 中的文件，不需要指明文件的路径。</li>\n<li>所有 include tasks 可以引用 roles&#x2F;common&#x2F;tasks&#x2F; 中的文件，不需要指明文件的路径。</li>\n</ul>\n<p>为 roles 设置触发条件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">roles:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">some_role</span>, <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">&quot;ansible_os_family == &#x27;RedHat&#x27;&quot;</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<p>如果你希望定义一些 tasks，让它们在 roles 之前以及之后执行</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">pre_tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;hello&#x27;</span><br>  <span class=\"hljs-attr\">roles:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">some_role</span> &#125;<br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;still busy&#x27;</span><br>  <span class=\"hljs-attr\">post_tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;goodbye&#x27;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"角色默认变量\"><a href=\"#角色默认变量\" class=\"headerlink\" title=\"角色默认变量\"></a>角色默认变量</h2><p>角色默认变量允许你为 included roles 或者 dependent roles设置默认变量。要创建默认变量，只需在 roles 目录下添加 defaults&#x2F;main.yml 文件。这些变量在所有可用变量中拥有最低优先级，可能被其他地方定义的变量(包括 inventory 中的变量)所覆盖。</p>\n<h2 id=\"角色依赖\"><a href=\"#角色依赖\" class=\"headerlink\" title=\"角色依赖\"></a>角色依赖</h2><p>“角色依赖” 使你可以自动地将其他 roles 拉取到现在使用的 role 中。”角色依赖” 保存在 roles 目录下的 meta&#x2F;main.yml 文件中。这个文件应包含一列 roles 和 为之指定的参数，下面是在 roles&#x2F;myapp&#x2F;meta&#x2F;main.yml 文件中的示例:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">dependencies:</span><br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">common</span>, <span class=\"hljs-attr\">some_parameter:</span> <span class=\"hljs-number\">3</span> &#125;<br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">apache</span>, <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">80</span> &#125;<br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">postgres</span>, <span class=\"hljs-attr\">dbname:</span> <span class=\"hljs-string\">blarg</span>, <span class=\"hljs-attr\">other_parameter:</span> <span class=\"hljs-number\">12</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"使用变量\"><a href=\"#使用变量\" class=\"headerlink\" title=\"使用变量\"></a>使用变量</h2><h3 id=\"注册变量\"><a href=\"#注册变量\" class=\"headerlink\" title=\"注册变量\"></a>注册变量</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">web_servers</span><br>  <span class=\"hljs-attr\">tasks:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/foo</span><br>       <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">foo_result</span><br>       <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/bar</span><br>       <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">foo_result.rc</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">5</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"使用facts获取的信息\"><a href=\"#使用facts获取的信息\" class=\"headerlink\" title=\"使用facts获取的信息\"></a>使用facts获取的信息</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ansible hostname -m setup<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-attr\">&quot;ansible_all_ipv4_addresses&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;REDACTED IP ADDRESS&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_all_ipv6_addresses&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;REDACTED IPV6 ADDRESS&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_architecture&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_bios_date&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;09/20/2012&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_bios_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;6.00&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_cmdline&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;BOOT_IMAGE&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/boot/vmlinuz-3.5.0-23-generic&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;quiet&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ro&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;root&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;UUID=4195bff4-e157-4e41-8701-e93f0aec9e22&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;splash&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_date_time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;date&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;day&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;02&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;epoch&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1380756810&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;hour&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;iso8601&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02T23:33:30Z&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;iso8601_micro&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02T23:33:30.036070Z&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;minute&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;33&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;month&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;10&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;second&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;30&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19:33:30&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;tz&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;EDT&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;year&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_default_ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;alias&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;gateway&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;interface&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;macaddress&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1500</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.255.255.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ether&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_default_ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_devices&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;fd0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">null</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0.00 Bytes&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">null</span></span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;sda&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware Virtual S&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;sda1&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39843840&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19.00 GB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2048&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;sda2&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1.00 KB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39847934&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;sda5&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2093056&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1022.00 MB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39847936&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;41943040&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;20.00 GB&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware,&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;sr0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware IDE CDR10&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2097151&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1024.00 MB&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;NECVMWar&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution_release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;precise&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12.04&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;COLORTERM&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;gnome-terminal&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;DISPLAY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;:0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;HOME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/home/mdehaan&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LANG&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;C&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LESSCLOSE&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/bin/lesspipe %s %s&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LESSOPEN&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;| /usr/bin/lesspipe %s&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LOGNAME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LS_COLORS&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.axa=00;36:*.oga=00;36:*.spx=00;36:*.xspf=00;36:&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;MAIL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/var/mail/root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;OLDPWD&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/root/ansible/docsite&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;PATH&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;PWD&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/root/ansible&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SHELL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/bin/bash&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SHLVL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_COMMAND&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/bin/bash&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_GID&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_UID&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_USER&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;mdehaan&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;TERM&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;xterm&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;USER&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;USERNAME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;XAUTHORITY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/home/mdehaan/.Xauthority&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;_&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/local/bin/ansible&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_eth0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;active&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.255.255.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>        <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;prefix&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;64&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;scope&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;link&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;macaddress&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;module&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;e1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1500</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ether&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_form_factor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Other&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_fqdn&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2.example.com&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_hostname&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_interfaces&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;lo&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-string\">&quot;eth0&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_kernel&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;3.5.0-23-generic&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_lo&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;active&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;lo&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;127.0.0.1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.0.0.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;127.0.0.0&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>        <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;::1&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;prefix&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;128&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;scope&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;host&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">16436</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;loopback&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_lsb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;codename&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;precise&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;description&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu 12.04.2 LTS&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;id&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;major_release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12.04&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_machine&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_memfree_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">74</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_memtotal_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">991</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_mounts&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/dev/sda1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;fstype&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ext4&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;mount&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;options&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;rw,errors=remount-ro&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size_available&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">15032406016</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size_total&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">20079898624</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_nodename&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2.example.com&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_os_family&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Debian&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_pkg_mgr&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;apt&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;Intel(R) Core(TM) i7 CPU         860  @ 2.80GHz&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_cores&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_count&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_threads_per_core&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_vcpus&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_name&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware Virtual Platform&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_serial&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_uuid&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;None&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_python_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2.7.3&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_selinux&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_dsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_ecdsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_rsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_swapfree_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">665</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_swaptotal_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1021</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_system&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Linux&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_system_vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware, Inc.&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_user_id&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_userspace_architecture&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_userspace_bits&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_virtualization_role&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;guest&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_virtualization_type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware&quot;</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"使用复杂变量\"><a href=\"#使用复杂变量\" class=\"headerlink\" title=\"使用复杂变量\"></a>使用复杂变量</h3><figure class=\"highlight jinja\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jinja\"><span class=\"hljs-template-variable\">&#123;&#123; ansible_eth0[&quot;ipv4&quot;][&quot;address&quot;] &#125;&#125;</span><span class=\"language-xml\"></span><br><span class=\"language-xml\"></span><span class=\"hljs-template-variable\">&#123;&#123; ansible_eth0.ipv4.address &#125;&#125;</span><span class=\"language-xml\"></span><br><span class=\"language-xml\">## 访问数组第一个元素</span><br><span class=\"language-xml\"></span><span class=\"hljs-template-variable\">&#123;&#123; foo[0] &#125;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"条件选择\"><a href=\"#条件选择\" class=\"headerlink\" title=\"条件选择\"></a>条件选择</h2><h3 id=\"when-使用\"><a href=\"#when-使用\" class=\"headerlink\" title=\"when 使用\"></a>when 使用</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&quot;shutdown Debian flavored systems&quot;</span><br>    <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/sbin/shutdown</span> <span class=\"hljs-string\">-t</span> <span class=\"hljs-string\">now</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">ansible_os_family</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">&quot;Debian&quot;</span><br><br><span class=\"hljs-comment\">## 通过执行结果来判断</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/false</span><br>    <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/something</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|failed</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/something_else</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|success</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/still/something_else</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|skipped</span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">vars:</span><br>  <span class=\"hljs-attr\">epic:</span> <span class=\"hljs-literal\">true</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;This certainly is epic!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">epic</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;This certainly isn&#x27;t epic!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">not</span> <span class=\"hljs-string\">epic</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;I&#x27;ve got &#x27;<span class=\"hljs-template-variable\">&#123;&#123; foo &#125;&#125;</span>&#x27; and am not afraid to use it!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">foo</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">defined</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">fail:</span> <span class=\"hljs-string\">msg=&quot;Bailing</span> <span class=\"hljs-string\">out.</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">play</span> <span class=\"hljs-string\">requires</span> <span class=\"hljs-string\">&#x27;bar&#x27;</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">      when: bar is not defined</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"条件导入\"><a href=\"#条件导入\" class=\"headerlink\" title=\"条件导入\"></a>条件导入</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">remote_user:</span> <span class=\"hljs-string\">root</span><br>  <span class=\"hljs-attr\">vars_files:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;vars/common.yml&quot;</span><br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&quot;vars/<span class=\"hljs-template-variable\">&#123;&#123; ansible_os_family &#125;&#125;</span>.yml&quot;</span>, <span class=\"hljs-string\">&quot;vars/os_defaults.yml&quot;</span> ]<br>  <span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">make</span> <span class=\"hljs-string\">sure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">running</span><br>    <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=running</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"基于变量选择文件和模版\"><a href=\"#基于变量选择文件和模版\" class=\"headerlink\" title=\"基于变量选择文件和模版\"></a>基于变量选择文件和模版</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">template</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">file</span><br>  <span class=\"hljs-attr\">template:</span> <span class=\"hljs-string\">src=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">dest=/etc/myapp/foo.conf</span><br>  <span class=\"hljs-attr\">with_first_found:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">files:</span><br>      <span class=\"hljs-bullet\">-</span> &#123;&#123; <span class=\"hljs-string\">ansible_distribution</span> &#125;&#125;<span class=\"hljs-string\">.conf</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default.conf</span><br>      <span class=\"hljs-attr\">paths:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">search_location_one/somedir/</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/opt/other_location/somedir/</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"注册变量-1\"><a href=\"#注册变量-1\" class=\"headerlink\" title=\"注册变量\"></a>注册变量</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test</span> <span class=\"hljs-string\">play</span><br>  <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">cat</span> <span class=\"hljs-string\">/etc/motd</span><br>      <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">motd_contents</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;motd contains the word hi&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">motd_contents.stdout.find(&#x27;hi&#x27;)</span> <span class=\"hljs-type\">!=</span> <span class=\"hljs-number\">-1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"循环\"><a href=\"#循环\" class=\"headerlink\" title=\"循环\"></a>循环</h2><h3 id=\"标准循环\"><a href=\"#标准循环\" class=\"headerlink\" title=\"标准循环\"></a>标准循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">several</span> <span class=\"hljs-string\">users</span><br>  <span class=\"hljs-attr\">user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=present</span> <span class=\"hljs-string\">groups=wheel</span><br>  <span class=\"hljs-attr\">with_items:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">testuser1</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">testuser2</span><br><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">several</span> <span class=\"hljs-string\">users</span><br>  <span class=\"hljs-attr\">user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item.name</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=present</span> <span class=\"hljs-string\">groups=&#123;&#123;</span> <span class=\"hljs-string\">item.groups</span> <span class=\"hljs-string\">&#125;&#125;</span><br>  <span class=\"hljs-attr\">with_items:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&#x27;testuser1&#x27;</span>, <span class=\"hljs-attr\">groups:</span> <span class=\"hljs-string\">&#x27;wheel&#x27;</span> &#125;<br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&#x27;testuser2&#x27;</span>, <span class=\"hljs-attr\">groups:</span> <span class=\"hljs-string\">&#x27;root&#x27;</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"嵌套循环\"><a href=\"#嵌套循环\" class=\"headerlink\" title=\"嵌套循环\"></a>嵌套循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">give</span> <span class=\"hljs-string\">users</span> <span class=\"hljs-string\">access</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">multiple</span> <span class=\"hljs-string\">databases</span><br>  <span class=\"hljs-attr\">mysql_user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item[0]</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">priv=&#123;&#123;</span> <span class=\"hljs-string\">item[1]</span> <span class=\"hljs-string\">&#125;&#125;.*:ALL</span> <span class=\"hljs-string\">append_privs=yes</span> <span class=\"hljs-string\">password=foo</span><br>  <span class=\"hljs-attr\">with_nested:</span><br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&#x27;alice&#x27;</span>, <span class=\"hljs-string\">&#x27;bob&#x27;</span> ]<br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&#x27;clientdb&#x27;</span>, <span class=\"hljs-string\">&#x27;employeedb&#x27;</span>, <span class=\"hljs-string\">&#x27;providerdb&#x27;</span> ]<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"哈希表循环\"><a href=\"#哈希表循环\" class=\"headerlink\" title=\"哈希表循环\"></a>哈希表循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">users:</span><br>  <span class=\"hljs-attr\">alice:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Alice</span> <span class=\"hljs-string\">Appleworth</span><br>    <span class=\"hljs-attr\">telephone:</span> <span class=\"hljs-number\">123</span><span class=\"hljs-number\">-456</span><span class=\"hljs-number\">-7890</span><br>  <span class=\"hljs-attr\">bob:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Bob</span> <span class=\"hljs-string\">Bananarama</span><br>    <span class=\"hljs-attr\">telephone:</span> <span class=\"hljs-number\">987</span><span class=\"hljs-number\">-654</span><span class=\"hljs-number\">-3210</span><br><br><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Print</span> <span class=\"hljs-string\">phone</span> <span class=\"hljs-string\">records</span><br>    <span class=\"hljs-attr\">debug:</span> <span class=\"hljs-string\">msg=&quot;User</span> &#123;&#123; <span class=\"hljs-string\">item.key</span> &#125;&#125; <span class=\"hljs-string\">is</span> &#123;&#123; <span class=\"hljs-string\">item.value.name</span> &#125;&#125; <span class=\"hljs-string\">(&#123;&#123;</span> <span class=\"hljs-string\">item.value.telephone</span> <span class=\"hljs-string\">&#125;&#125;)&quot;</span><br>    <span class=\"hljs-attr\">with_dict:</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-template-variable\">&#123;&#123;users&#125;&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"文件列表循环\"><a href=\"#文件列表循环\" class=\"headerlink\" title=\"文件列表循环\"></a>文件列表循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-comment\"># first ensure our target directory exists</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">file:</span> <span class=\"hljs-string\">dest=/etc/fooapp</span> <span class=\"hljs-string\">state=directory</span><br>    <span class=\"hljs-comment\"># copy each file over that matches the given pattern</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">copy:</span> <span class=\"hljs-string\">src=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">dest=/etc/fooapp/</span> <span class=\"hljs-string\">owner=root</span> <span class=\"hljs-string\">mode=600</span><br>      <span class=\"hljs-attr\">with_fileglob:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/playbooks/files/fooapp/*</span><br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"Ansible-Playbook-规范\"><a href=\"#Ansible-Playbook-规范\" class=\"headerlink\" title=\"Ansible Playbook 规范\"></a>Ansible Playbook 规范</h1><h2 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h2><p>可以使用ansible-galaxy 来生成role的目录结构</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 生成 role</span><br>ansible-galaxy init rolename<br><br><span class=\"hljs-comment\">## 查看生成的 role结构</span><br>tree roles<br>roles/<br>└── rolename<br>    ├── README.md<br>    ├── defaults<br>    │   └── main.yml<br>    ├── files<br>    ├── handlers<br>    │   └── main.yml<br>    ├── meta<br>    │   └── main.yml<br>    ├── tasks<br>    │   └── main.yml<br>    ├── templates<br>    ├── tests<br>    │   ├── inventory<br>    │   └── test.yml<br>    └── vars<br>        └── main.yml<br><br><span class=\"hljs-comment\">## Ansible Galaxy 网站下载角色</span><br><span class=\"hljs-comment\">## 可以下载看看别人的 playbook</span><br>ansible-galaxy install username.rolename<br></code></pre></td></tr></table></figure>\n<h2 id=\"Playbook-规范\"><a href=\"#Playbook-规范\" class=\"headerlink\" title=\"Playbook 规范\"></a>Playbook 规范</h2><p>严格缩进，两个空格</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">vars:</span><br>    <span class=\"hljs-attr\">http_port:</span> <span class=\"hljs-number\">80</span><br>    <span class=\"hljs-attr\">max_clients:</span> <span class=\"hljs-number\">200</span><br>  <span class=\"hljs-attr\">remote_user:</span> <span class=\"hljs-string\">root</span><br>  <span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ensure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">at</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">latest</span> <span class=\"hljs-string\">version</span><br>    <span class=\"hljs-attr\">yum:</span> <span class=\"hljs-string\">pkg=httpd</span> <span class=\"hljs-string\">state=latest</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">write</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">config</span> <span class=\"hljs-string\">file</span><br>    <span class=\"hljs-attr\">template:</span> <span class=\"hljs-string\">src=/srv/httpd.j2</span> <span class=\"hljs-string\">dest=/etc/httpd.conf</span><br>    <span class=\"hljs-attr\">notify:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">restart</span> <span class=\"hljs-string\">apache</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ensure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">running</span><br>    <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=httpd</span> <span class=\"hljs-string\">state=started</span><br>  <span class=\"hljs-attr\">handlers:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">restart</span> <span class=\"hljs-string\">apache</span><br>      <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=httpd</span> <span class=\"hljs-string\">state=restarted</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"shell-command-模块返回码处理\"><a href=\"#shell-command-模块返回码处理\" class=\"headerlink\" title=\"shell, command 模块返回码处理\"></a>shell, command 模块返回码处理</h2><p>使用 command module 和 shell module 时,我们需要关心返回码信息,如果有一条命令成功执行的返回码不是0, 可以这样做:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">command</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">ignore</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/somecommand</span> <span class=\"hljs-string\">||</span> <span class=\"hljs-string\">/bin/true</span><br><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">command</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">ignore</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/somecommand</span><br>    <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br></code></pre></td></tr></table></figure>\n\n<p>对于 command module 和 shell module,重复执行 playbook,实际上是重复运行同样的命令.如果执行的命令类似于 ‘chmod’ 或者 ‘setsebool’ 这种命令,这没有任何问题.也可以使用一个叫做 ‘creates’ 的 flag 使得这两个 module 变得具有”幂等”特性.</p>\n<h2 id=\"引用task\"><a href=\"#引用task\" class=\"headerlink\" title=\"引用task\"></a>引用task</h2><p>如下foo.yaml例子</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-comment\"># possibly saved as tasks/foo.yml</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">placeholder</span> <span class=\"hljs-string\">foo</span><br>  <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/foo</span><br><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">placeholder</span> <span class=\"hljs-string\">bar</span><br>  <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/bar</span><br></code></pre></td></tr></table></figure>\n\n<p>使用include引用foo.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">tasks/foo.yml</span><br></code></pre></td></tr></table></figure>\n\n<p>也可以传递变量</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=timmy</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=alice</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span> <span class=\"hljs-string\">wp_user=bob</span><br><br><span class=\"hljs-comment\">## 或者</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">include:</span> <span class=\"hljs-string\">wordpress.yml</span><br>    <span class=\"hljs-attr\">vars:</span><br>        <span class=\"hljs-attr\">wp_user:</span> <span class=\"hljs-string\">timmy</span><br>        <span class=\"hljs-attr\">some_list_variable:</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">alpha</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">beta</span><br>          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">gamma</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"roles-引用\"><a href=\"#roles-引用\" class=\"headerlink\" title=\"roles 引用\"></a>roles 引用</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">roles:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">common</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">webservers</span><br></code></pre></td></tr></table></figure>\n<p>这个 playbook 为一个角色 common 指定了如下的行为：</p>\n<ul>\n<li>如果 roles&#x2F;common&#x2F;tasks&#x2F;main.yml 存在, 其中列出的 tasks 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;handlers&#x2F;main.yml 存在, 其中列出的 handlers 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;vars&#x2F;main.yml 存在, 其中列出的 variables 将被添加到 play 中</li>\n<li>如果 roles&#x2F;common&#x2F;meta&#x2F;main.yml 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中 (1.3 and later)</li>\n<li>所有 copy tasks 可以引用 roles&#x2F;common&#x2F;files&#x2F; 中的文件，不需要指明文件的路径。</li>\n<li>所有 script tasks 可以引用 roles&#x2F;common&#x2F;files&#x2F; 中的脚本，不需要指明文件的路径。</li>\n<li>所有 template tasks 可以引用 roles&#x2F;common&#x2F;templates&#x2F; 中的文件，不需要指明文件的路径。</li>\n<li>所有 include tasks 可以引用 roles&#x2F;common&#x2F;tasks&#x2F; 中的文件，不需要指明文件的路径。</li>\n</ul>\n<p>为 roles 设置触发条件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">roles:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">some_role</span>, <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">&quot;ansible_os_family == &#x27;RedHat&#x27;&quot;</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<p>如果你希望定义一些 tasks，让它们在 roles 之前以及之后执行</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">webservers</span><br>  <span class=\"hljs-attr\">pre_tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;hello&#x27;</span><br>  <span class=\"hljs-attr\">roles:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">some_role</span> &#125;<br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;still busy&#x27;</span><br>  <span class=\"hljs-attr\">post_tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;goodbye&#x27;</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"角色默认变量\"><a href=\"#角色默认变量\" class=\"headerlink\" title=\"角色默认变量\"></a>角色默认变量</h2><p>角色默认变量允许你为 included roles 或者 dependent roles设置默认变量。要创建默认变量，只需在 roles 目录下添加 defaults&#x2F;main.yml 文件。这些变量在所有可用变量中拥有最低优先级，可能被其他地方定义的变量(包括 inventory 中的变量)所覆盖。</p>\n<h2 id=\"角色依赖\"><a href=\"#角色依赖\" class=\"headerlink\" title=\"角色依赖\"></a>角色依赖</h2><p>“角色依赖” 使你可以自动地将其他 roles 拉取到现在使用的 role 中。”角色依赖” 保存在 roles 目录下的 meta&#x2F;main.yml 文件中。这个文件应包含一列 roles 和 为之指定的参数，下面是在 roles&#x2F;myapp&#x2F;meta&#x2F;main.yml 文件中的示例:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">dependencies:</span><br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">common</span>, <span class=\"hljs-attr\">some_parameter:</span> <span class=\"hljs-number\">3</span> &#125;<br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">apache</span>, <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">80</span> &#125;<br>  <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">role:</span> <span class=\"hljs-string\">postgres</span>, <span class=\"hljs-attr\">dbname:</span> <span class=\"hljs-string\">blarg</span>, <span class=\"hljs-attr\">other_parameter:</span> <span class=\"hljs-number\">12</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"使用变量\"><a href=\"#使用变量\" class=\"headerlink\" title=\"使用变量\"></a>使用变量</h2><h3 id=\"注册变量\"><a href=\"#注册变量\" class=\"headerlink\" title=\"注册变量\"></a>注册变量</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">web_servers</span><br>  <span class=\"hljs-attr\">tasks:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/foo</span><br>       <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">foo_result</span><br>       <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">/usr/bin/bar</span><br>       <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">foo_result.rc</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">5</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"使用facts获取的信息\"><a href=\"#使用facts获取的信息\" class=\"headerlink\" title=\"使用facts获取的信息\"></a>使用facts获取的信息</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ansible hostname -m setup<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-attr\">&quot;ansible_all_ipv4_addresses&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;REDACTED IP ADDRESS&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_all_ipv6_addresses&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;REDACTED IPV6 ADDRESS&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_architecture&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_bios_date&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;09/20/2012&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_bios_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;6.00&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_cmdline&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;BOOT_IMAGE&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/boot/vmlinuz-3.5.0-23-generic&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;quiet&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ro&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;root&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;UUID=4195bff4-e157-4e41-8701-e93f0aec9e22&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;splash&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_date_time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;date&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;day&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;02&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;epoch&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1380756810&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;hour&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;iso8601&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02T23:33:30Z&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;iso8601_micro&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013-10-02T23:33:30.036070Z&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;minute&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;33&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;month&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;10&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;second&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;30&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19:33:30&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;tz&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;EDT&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;year&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2013&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_default_ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;alias&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;gateway&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;interface&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;macaddress&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1500</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.255.255.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ether&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_default_ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_devices&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;fd0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">null</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0.00 Bytes&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">null</span></span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;sda&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware Virtual S&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;sda1&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39843840&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;19.00 GB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2048&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;sda2&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1.00 KB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39847934&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;sda5&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2093056&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">512</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1022.00 MB&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;start&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;39847936&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;41943040&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;20.00 GB&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware,&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;sr0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;holders&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;model&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware IDE CDR10&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;partitions&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;removable&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rotational&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;scheduler_mode&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;deadline&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectors&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2097151&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;sectorsize&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;512&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1024.00 MB&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;support_discard&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;NECVMWar&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution_release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;precise&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_distribution_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12.04&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;COLORTERM&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;gnome-terminal&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;DISPLAY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;:0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;HOME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/home/mdehaan&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LANG&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;C&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LESSCLOSE&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/bin/lesspipe %s %s&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LESSOPEN&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;| /usr/bin/lesspipe %s&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LOGNAME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;LS_COLORS&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.axa=00;36:*.oga=00;36:*.spx=00;36:*.xspf=00;36:&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;MAIL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/var/mail/root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;OLDPWD&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/root/ansible/docsite&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;PATH&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;PWD&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/root/ansible&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SHELL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/bin/bash&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SHLVL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_COMMAND&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/bin/bash&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_GID&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_UID&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;SUDO_USER&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;mdehaan&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;TERM&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;xterm&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;USER&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;USERNAME&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;XAUTHORITY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/home/mdehaan/.Xauthority&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;_&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/usr/local/bin/ansible&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_eth0&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;active&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;eth0&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.255.255.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>        <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;prefix&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;64&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;scope&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;link&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;macaddress&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;module&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;e1000&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1500</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ether&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_form_factor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Other&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_fqdn&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2.example.com&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_hostname&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_interfaces&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;lo&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-string\">&quot;eth0&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_kernel&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;3.5.0-23-generic&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_lo&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;active&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;lo&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv4&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;127.0.0.1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;netmask&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;255.0.0.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;127.0.0.0&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ipv6&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>        <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;::1&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;prefix&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;128&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;scope&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;host&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;mtu&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">16436</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;loopback&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_lsb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;codename&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;precise&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;description&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu 12.04.2 LTS&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;id&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Ubuntu&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;major_release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;release&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;12.04&quot;</span><br><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_machine&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_memfree_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">74</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_memtotal_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">991</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_mounts&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;device&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/dev/sda1&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;fstype&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ext4&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;mount&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;/&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;options&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;rw,errors=remount-ro&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size_available&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">15032406016</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;size_total&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">20079898624</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_nodename&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ubuntu2.example.com&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_os_family&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Debian&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_pkg_mgr&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;apt&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-string\">&quot;Intel(R) Core(TM) i7 CPU         860  @ 2.80GHz&quot;</span><br><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_cores&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_count&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_threads_per_core&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_processor_vcpus&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_name&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware Virtual Platform&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_serial&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_uuid&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_product_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;None&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_python_version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2.7.3&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_selinux&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_dsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_ecdsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_ssh_host_key_rsa_public&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;REDACTED KEY VALUE&quot;</span><br><span class=\"hljs-attr\">&quot;ansible_swapfree_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">665</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_swaptotal_mb&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1021</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_system&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Linux&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_system_vendor&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware, Inc.&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_user_id&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;root&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_userspace_architecture&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;x86_64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_userspace_bits&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;64&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_virtualization_role&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;guest&quot;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-attr\">&quot;ansible_virtualization_type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VMware&quot;</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"使用复杂变量\"><a href=\"#使用复杂变量\" class=\"headerlink\" title=\"使用复杂变量\"></a>使用复杂变量</h3><figure class=\"highlight jinja\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jinja\"><span class=\"hljs-template-variable\">&#123;&#123; ansible_eth0[&quot;ipv4&quot;][&quot;address&quot;] &#125;&#125;</span><span class=\"language-xml\"></span><br><span class=\"language-xml\"></span><span class=\"hljs-template-variable\">&#123;&#123; ansible_eth0.ipv4.address &#125;&#125;</span><span class=\"language-xml\"></span><br><span class=\"language-xml\">## 访问数组第一个元素</span><br><span class=\"language-xml\"></span><span class=\"hljs-template-variable\">&#123;&#123; foo[0] &#125;&#125;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"条件选择\"><a href=\"#条件选择\" class=\"headerlink\" title=\"条件选择\"></a>条件选择</h2><h3 id=\"when-使用\"><a href=\"#when-使用\" class=\"headerlink\" title=\"when 使用\"></a>when 使用</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&quot;shutdown Debian flavored systems&quot;</span><br>    <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/sbin/shutdown</span> <span class=\"hljs-string\">-t</span> <span class=\"hljs-string\">now</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">ansible_os_family</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">&quot;Debian&quot;</span><br><br><span class=\"hljs-comment\">## 通过执行结果来判断</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/false</span><br>    <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">result</span><br>    <span class=\"hljs-attr\">ignore_errors:</span> <span class=\"hljs-literal\">True</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/something</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|failed</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/something_else</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|success</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">/bin/still/something_else</span><br>    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">result|skipped</span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">vars:</span><br>  <span class=\"hljs-attr\">epic:</span> <span class=\"hljs-literal\">true</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;This certainly is epic!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">epic</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;This certainly isn&#x27;t epic!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">not</span> <span class=\"hljs-string\">epic</span><br><br><span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;I&#x27;ve got &#x27;<span class=\"hljs-template-variable\">&#123;&#123; foo &#125;&#125;</span>&#x27; and am not afraid to use it!&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">foo</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">defined</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">fail:</span> <span class=\"hljs-string\">msg=&quot;Bailing</span> <span class=\"hljs-string\">out.</span> <span class=\"hljs-string\">this</span> <span class=\"hljs-string\">play</span> <span class=\"hljs-string\">requires</span> <span class=\"hljs-string\">&#x27;bar&#x27;</span><span class=\"hljs-string\">&quot;</span><br><span class=\"hljs-string\">      when: bar is not defined</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"条件导入\"><a href=\"#条件导入\" class=\"headerlink\" title=\"条件导入\"></a>条件导入</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">remote_user:</span> <span class=\"hljs-string\">root</span><br>  <span class=\"hljs-attr\">vars_files:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;vars/common.yml&quot;</span><br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&quot;vars/<span class=\"hljs-template-variable\">&#123;&#123; ansible_os_family &#125;&#125;</span>.yml&quot;</span>, <span class=\"hljs-string\">&quot;vars/os_defaults.yml&quot;</span> ]<br>  <span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">make</span> <span class=\"hljs-string\">sure</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">is</span> <span class=\"hljs-string\">running</span><br>    <span class=\"hljs-attr\">service:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">apache</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=running</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"基于变量选择文件和模版\"><a href=\"#基于变量选择文件和模版\" class=\"headerlink\" title=\"基于变量选择文件和模版\"></a>基于变量选择文件和模版</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">template</span> <span class=\"hljs-string\">a</span> <span class=\"hljs-string\">file</span><br>  <span class=\"hljs-attr\">template:</span> <span class=\"hljs-string\">src=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">dest=/etc/myapp/foo.conf</span><br>  <span class=\"hljs-attr\">with_first_found:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">files:</span><br>      <span class=\"hljs-bullet\">-</span> &#123;&#123; <span class=\"hljs-string\">ansible_distribution</span> &#125;&#125;<span class=\"hljs-string\">.conf</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default.conf</span><br>      <span class=\"hljs-attr\">paths:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">search_location_one/somedir/</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/opt/other_location/somedir/</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"注册变量-1\"><a href=\"#注册变量-1\" class=\"headerlink\" title=\"注册变量\"></a>注册变量</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test</span> <span class=\"hljs-string\">play</span><br>  <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">cat</span> <span class=\"hljs-string\">/etc/motd</span><br>      <span class=\"hljs-attr\">register:</span> <span class=\"hljs-string\">motd_contents</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">shell:</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;motd contains the word hi&quot;</span><br>      <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">motd_contents.stdout.find(&#x27;hi&#x27;)</span> <span class=\"hljs-type\">!=</span> <span class=\"hljs-number\">-1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"循环\"><a href=\"#循环\" class=\"headerlink\" title=\"循环\"></a>循环</h2><h3 id=\"标准循环\"><a href=\"#标准循环\" class=\"headerlink\" title=\"标准循环\"></a>标准循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">several</span> <span class=\"hljs-string\">users</span><br>  <span class=\"hljs-attr\">user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=present</span> <span class=\"hljs-string\">groups=wheel</span><br>  <span class=\"hljs-attr\">with_items:</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">testuser1</span><br>     <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">testuser2</span><br><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">add</span> <span class=\"hljs-string\">several</span> <span class=\"hljs-string\">users</span><br>  <span class=\"hljs-attr\">user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item.name</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">state=present</span> <span class=\"hljs-string\">groups=&#123;&#123;</span> <span class=\"hljs-string\">item.groups</span> <span class=\"hljs-string\">&#125;&#125;</span><br>  <span class=\"hljs-attr\">with_items:</span><br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&#x27;testuser1&#x27;</span>, <span class=\"hljs-attr\">groups:</span> <span class=\"hljs-string\">&#x27;wheel&#x27;</span> &#125;<br>    <span class=\"hljs-bullet\">-</span> &#123; <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&#x27;testuser2&#x27;</span>, <span class=\"hljs-attr\">groups:</span> <span class=\"hljs-string\">&#x27;root&#x27;</span> &#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"嵌套循环\"><a href=\"#嵌套循环\" class=\"headerlink\" title=\"嵌套循环\"></a>嵌套循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">give</span> <span class=\"hljs-string\">users</span> <span class=\"hljs-string\">access</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">multiple</span> <span class=\"hljs-string\">databases</span><br>  <span class=\"hljs-attr\">mysql_user:</span> <span class=\"hljs-string\">name=&#123;&#123;</span> <span class=\"hljs-string\">item[0]</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">priv=&#123;&#123;</span> <span class=\"hljs-string\">item[1]</span> <span class=\"hljs-string\">&#125;&#125;.*:ALL</span> <span class=\"hljs-string\">append_privs=yes</span> <span class=\"hljs-string\">password=foo</span><br>  <span class=\"hljs-attr\">with_nested:</span><br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&#x27;alice&#x27;</span>, <span class=\"hljs-string\">&#x27;bob&#x27;</span> ]<br>    <span class=\"hljs-bullet\">-</span> [ <span class=\"hljs-string\">&#x27;clientdb&#x27;</span>, <span class=\"hljs-string\">&#x27;employeedb&#x27;</span>, <span class=\"hljs-string\">&#x27;providerdb&#x27;</span> ]<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"哈希表循环\"><a href=\"#哈希表循环\" class=\"headerlink\" title=\"哈希表循环\"></a>哈希表循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">users:</span><br>  <span class=\"hljs-attr\">alice:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Alice</span> <span class=\"hljs-string\">Appleworth</span><br>    <span class=\"hljs-attr\">telephone:</span> <span class=\"hljs-number\">123</span><span class=\"hljs-number\">-456</span><span class=\"hljs-number\">-7890</span><br>  <span class=\"hljs-attr\">bob:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Bob</span> <span class=\"hljs-string\">Bananarama</span><br>    <span class=\"hljs-attr\">telephone:</span> <span class=\"hljs-number\">987</span><span class=\"hljs-number\">-654</span><span class=\"hljs-number\">-3210</span><br><br><span class=\"hljs-meta\">---</span><br><span class=\"hljs-attr\">tasks:</span><br>  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Print</span> <span class=\"hljs-string\">phone</span> <span class=\"hljs-string\">records</span><br>    <span class=\"hljs-attr\">debug:</span> <span class=\"hljs-string\">msg=&quot;User</span> &#123;&#123; <span class=\"hljs-string\">item.key</span> &#125;&#125; <span class=\"hljs-string\">is</span> &#123;&#123; <span class=\"hljs-string\">item.value.name</span> &#125;&#125; <span class=\"hljs-string\">(&#123;&#123;</span> <span class=\"hljs-string\">item.value.telephone</span> <span class=\"hljs-string\">&#125;&#125;)&quot;</span><br>    <span class=\"hljs-attr\">with_dict:</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-template-variable\">&#123;&#123;users&#125;&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"文件列表循环\"><a href=\"#文件列表循环\" class=\"headerlink\" title=\"文件列表循环\"></a>文件列表循环</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-meta\">---</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hosts:</span> <span class=\"hljs-string\">all</span><br>  <span class=\"hljs-attr\">tasks:</span><br>    <span class=\"hljs-comment\"># first ensure our target directory exists</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">file:</span> <span class=\"hljs-string\">dest=/etc/fooapp</span> <span class=\"hljs-string\">state=directory</span><br>    <span class=\"hljs-comment\"># copy each file over that matches the given pattern</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">copy:</span> <span class=\"hljs-string\">src=&#123;&#123;</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">dest=/etc/fooapp/</span> <span class=\"hljs-string\">owner=root</span> <span class=\"hljs-string\">mode=600</span><br>      <span class=\"hljs-attr\">with_fileglob:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/playbooks/files/fooapp/*</span><br></code></pre></td></tr></table></figure>"},{"title":"SVN GitLab 备份与还原","date":"2024-10-15T03:09:29.000Z","_content":"\n# SVN & GitLab 备份与还原\n\n\n## svn\n\n- 热备\n  - 通过svn的hook达到热备效果\n  - svnsync\n- 冷备\n  - 通过 svnadmin dump 导出备份数据\n  - rsync或scp 传输备份数据到其他机器\n\n### svnsync热备\n#### 创建svn 仓库\n```bash\n# 接创建路径\nsvnadmin create /home/svn\n```\n#### 修改svn配置文件\n```\n# svnserver.conf\n# 取消如下配置注释\nanon-access = none\nauth-access = write\npassword-db = passwd\nauthz-db = authz\n```\n#### 添加admin账号权限\n```ini\n# authz\n[groups]\nadmin = <username>\n\n[/]\n@admin = rw\n```\n#### 添加admin账号密码\n```ini\n# passwd\n[users]\nadmin = <password>\n```\n\n#### 启动svn服务\n```bash\nsvnserve -d -r /home/svn\n```\n\n#### svnsync备份\n```bash\n# 在文件第二行加入 exit 0\ncp pre-revprop-change.tmpl pre-revprop-change\n\n# 初始化备份仓库\nsvnsync init svn://<backup_ip> svn://<svn_ip>\n\n# 会提示输入账号密码\nsvnsync sync svn://<backup_ip>\n# 或\nsvnsync sync --non-interactive svn://<backup_ip> --sync-username <username> --sync-password <password> --source-username <username> --source-password <password>\n```\n\n#### 将svnsync写入post-commit hook\n\n钩子脚本的具体写法和shell脚本写法是一样的。钩子脚本就是被某些版本库事件触发的程序。\n\npost-commit 在提交完成成功创建版本之后执行该钩子，提交已经完成，不可更改。\n\npre-commit 提交完成前触发执行该脚本\n\n```bash\n# hooks目录\ncp post-commit.tmpl post-commit\n# 将如下命令写入 post-commit\nsvnsync sync --non-interactive svn://<backup_ip> --sync-username <username> --sync-password <password> --source-username <username> --source-password <password>\n```\n### 冷备\n#### svnadmin dump\n\n```bash\n## 查看版本\nsvnlook youngest /home/svn\n\n## youngest_num填入svnlook查到值\nsvnadmin dump /home/svn -r 0:$youngest_num --incremental > /home/svn_backup/svn.dump\n# 可以尝试写成增量导出脚本，之后用增量文件会比全量快\n## 恢复备份文件\nsvnadmin load /home/svn < /home/svn_backup/svn.dump\n\n## 然后做成 rsync或者 scp传输 dump文件到备份服务器\n```\n\n## gitlab备份\n\n```bash\ngitlab-rake gitlab:backup:create\n# 备份文件在/var/opt/gitlab/backups/目录下\n\n## 修改备份文件权限\nchmod 777 /var/opt/gitlab/backups/*.tar\n## 停止服务\ngitlab-ctl stop unicorn\ngitlab-ctl stop sidekiq\n\n## 恢复\ngitlab-rake gitlab:backup:restore BACKUP=1481434654\n\n## 启动服务\ngitlab-ctl restart\n```","source":"_posts/svn-gitlab-backup.md","raw":"---\ntitle: SVN GitLab 备份与还原\ndate: 2024-10-15 11:09:29\ntags: tools\n---\n\n# SVN & GitLab 备份与还原\n\n\n## svn\n\n- 热备\n  - 通过svn的hook达到热备效果\n  - svnsync\n- 冷备\n  - 通过 svnadmin dump 导出备份数据\n  - rsync或scp 传输备份数据到其他机器\n\n### svnsync热备\n#### 创建svn 仓库\n```bash\n# 接创建路径\nsvnadmin create /home/svn\n```\n#### 修改svn配置文件\n```\n# svnserver.conf\n# 取消如下配置注释\nanon-access = none\nauth-access = write\npassword-db = passwd\nauthz-db = authz\n```\n#### 添加admin账号权限\n```ini\n# authz\n[groups]\nadmin = <username>\n\n[/]\n@admin = rw\n```\n#### 添加admin账号密码\n```ini\n# passwd\n[users]\nadmin = <password>\n```\n\n#### 启动svn服务\n```bash\nsvnserve -d -r /home/svn\n```\n\n#### svnsync备份\n```bash\n# 在文件第二行加入 exit 0\ncp pre-revprop-change.tmpl pre-revprop-change\n\n# 初始化备份仓库\nsvnsync init svn://<backup_ip> svn://<svn_ip>\n\n# 会提示输入账号密码\nsvnsync sync svn://<backup_ip>\n# 或\nsvnsync sync --non-interactive svn://<backup_ip> --sync-username <username> --sync-password <password> --source-username <username> --source-password <password>\n```\n\n#### 将svnsync写入post-commit hook\n\n钩子脚本的具体写法和shell脚本写法是一样的。钩子脚本就是被某些版本库事件触发的程序。\n\npost-commit 在提交完成成功创建版本之后执行该钩子，提交已经完成，不可更改。\n\npre-commit 提交完成前触发执行该脚本\n\n```bash\n# hooks目录\ncp post-commit.tmpl post-commit\n# 将如下命令写入 post-commit\nsvnsync sync --non-interactive svn://<backup_ip> --sync-username <username> --sync-password <password> --source-username <username> --source-password <password>\n```\n### 冷备\n#### svnadmin dump\n\n```bash\n## 查看版本\nsvnlook youngest /home/svn\n\n## youngest_num填入svnlook查到值\nsvnadmin dump /home/svn -r 0:$youngest_num --incremental > /home/svn_backup/svn.dump\n# 可以尝试写成增量导出脚本，之后用增量文件会比全量快\n## 恢复备份文件\nsvnadmin load /home/svn < /home/svn_backup/svn.dump\n\n## 然后做成 rsync或者 scp传输 dump文件到备份服务器\n```\n\n## gitlab备份\n\n```bash\ngitlab-rake gitlab:backup:create\n# 备份文件在/var/opt/gitlab/backups/目录下\n\n## 修改备份文件权限\nchmod 777 /var/opt/gitlab/backups/*.tar\n## 停止服务\ngitlab-ctl stop unicorn\ngitlab-ctl stop sidekiq\n\n## 恢复\ngitlab-rake gitlab:backup:restore BACKUP=1481434654\n\n## 启动服务\ngitlab-ctl restart\n```","slug":"svn-gitlab-backup","published":1,"updated":"2024-10-16T09:46:17.927Z","_id":"cm29v9iww0000z6uq7t8nfst0","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"SVN-GitLab-备份与还原\"><a href=\"#SVN-GitLab-备份与还原\" class=\"headerlink\" title=\"SVN &amp; GitLab 备份与还原\"></a>SVN &amp; GitLab 备份与还原</h1><h2 id=\"svn\"><a href=\"#svn\" class=\"headerlink\" title=\"svn\"></a>svn</h2><ul>\n<li>热备<ul>\n<li>通过svn的hook达到热备效果</li>\n<li>svnsync</li>\n</ul>\n</li>\n<li>冷备<ul>\n<li>通过 svnadmin dump 导出备份数据</li>\n<li>rsync或scp 传输备份数据到其他机器</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"svnsync热备\"><a href=\"#svnsync热备\" class=\"headerlink\" title=\"svnsync热备\"></a>svnsync热备</h3><h4 id=\"创建svn-仓库\"><a href=\"#创建svn-仓库\" class=\"headerlink\" title=\"创建svn 仓库\"></a>创建svn 仓库</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 接创建路径</span><br>svnadmin create /home/svn<br></code></pre></td></tr></table></figure>\n<h4 id=\"修改svn配置文件\"><a href=\"#修改svn配置文件\" class=\"headerlink\" title=\"修改svn配置文件\"></a>修改svn配置文件</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># svnserver.conf</span><br><span class=\"hljs-comment\"># 取消如下配置注释</span><br><span class=\"hljs-attr\">anon-access</span> = none<br><span class=\"hljs-attr\">auth-access</span> = write<br><span class=\"hljs-attr\">password-db</span> = passwd<br><span class=\"hljs-attr\">authz-db</span> = authz<br></code></pre></td></tr></table></figure>\n<h4 id=\"添加admin账号权限\"><a href=\"#添加admin账号权限\" class=\"headerlink\" title=\"添加admin账号权限\"></a>添加admin账号权限</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># authz</span><br><span class=\"hljs-section\">[groups]</span><br><span class=\"hljs-attr\">admin</span> = &lt;username&gt;<br><br><span class=\"hljs-section\">[/]</span><br>@<span class=\"hljs-attr\">admin</span> = rw<br></code></pre></td></tr></table></figure>\n<h4 id=\"添加admin账号密码\"><a href=\"#添加admin账号密码\" class=\"headerlink\" title=\"添加admin账号密码\"></a>添加admin账号密码</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># passwd</span><br><span class=\"hljs-section\">[users]</span><br><span class=\"hljs-attr\">admin</span> = &lt;password&gt;<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"启动svn服务\"><a href=\"#启动svn服务\" class=\"headerlink\" title=\"启动svn服务\"></a>启动svn服务</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">svnserve -d -r /home/svn<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"svnsync备份\"><a href=\"#svnsync备份\" class=\"headerlink\" title=\"svnsync备份\"></a>svnsync备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 在文件第二行加入 exit 0</span><br><span class=\"hljs-built_in\">cp</span> pre-revprop-change.tmpl pre-revprop-change<br><br><span class=\"hljs-comment\"># 初始化备份仓库</span><br>svnsync init svn://&lt;backup_ip&gt; svn://&lt;svn_ip&gt;<br><br><span class=\"hljs-comment\"># 会提示输入账号密码</span><br>svnsync <span class=\"hljs-built_in\">sync</span> svn://&lt;backup_ip&gt;<br><span class=\"hljs-comment\"># 或</span><br>svnsync <span class=\"hljs-built_in\">sync</span> --non-interactive svn://&lt;backup_ip&gt; --sync-username &lt;username&gt; --sync-password &lt;password&gt; --source-username &lt;username&gt; --source-password &lt;password&gt;<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"将svnsync写入post-commit-hook\"><a href=\"#将svnsync写入post-commit-hook\" class=\"headerlink\" title=\"将svnsync写入post-commit hook\"></a>将svnsync写入post-commit hook</h4><p>钩子脚本的具体写法和shell脚本写法是一样的。钩子脚本就是被某些版本库事件触发的程序。</p>\n<p>post-commit 在提交完成成功创建版本之后执行该钩子，提交已经完成，不可更改。</p>\n<p>pre-commit 提交完成前触发执行该脚本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># hooks目录</span><br><span class=\"hljs-built_in\">cp</span> post-commit.tmpl post-commit<br><span class=\"hljs-comment\"># 将如下命令写入 post-commit</span><br>svnsync <span class=\"hljs-built_in\">sync</span> --non-interactive svn://&lt;backup_ip&gt; --sync-username &lt;username&gt; --sync-password &lt;password&gt; --source-username &lt;username&gt; --source-password &lt;password&gt;<br></code></pre></td></tr></table></figure>\n<h3 id=\"冷备\"><a href=\"#冷备\" class=\"headerlink\" title=\"冷备\"></a>冷备</h3><h4 id=\"svnadmin-dump\"><a href=\"#svnadmin-dump\" class=\"headerlink\" title=\"svnadmin dump\"></a>svnadmin dump</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看版本</span><br>svnlook youngest /home/svn<br><br><span class=\"hljs-comment\">## youngest_num填入svnlook查到值</span><br>svnadmin dump /home/svn -r 0:<span class=\"hljs-variable\">$youngest_num</span> --incremental &gt; /home/svn_backup/svn.dump<br><span class=\"hljs-comment\"># 可以尝试写成增量导出脚本，之后用增量文件会比全量快</span><br><span class=\"hljs-comment\">## 恢复备份文件</span><br>svnadmin load /home/svn &lt; /home/svn_backup/svn.dump<br><br><span class=\"hljs-comment\">## 然后做成 rsync或者 scp传输 dump文件到备份服务器</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"gitlab备份\"><a href=\"#gitlab备份\" class=\"headerlink\" title=\"gitlab备份\"></a>gitlab备份</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">gitlab-rake gitlab:backup:create<br><span class=\"hljs-comment\"># 备份文件在/var/opt/gitlab/backups/目录下</span><br><br><span class=\"hljs-comment\">## 修改备份文件权限</span><br><span class=\"hljs-built_in\">chmod</span> 777 /var/opt/gitlab/backups/*.tar<br><span class=\"hljs-comment\">## 停止服务</span><br>gitlab-ctl stop unicorn<br>gitlab-ctl stop sidekiq<br><br><span class=\"hljs-comment\">## 恢复</span><br>gitlab-rake gitlab:backup:restore BACKUP=1481434654<br><br><span class=\"hljs-comment\">## 启动服务</span><br>gitlab-ctl restart<br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"SVN-GitLab-备份与还原\"><a href=\"#SVN-GitLab-备份与还原\" class=\"headerlink\" title=\"SVN &amp; GitLab 备份与还原\"></a>SVN &amp; GitLab 备份与还原</h1><h2 id=\"svn\"><a href=\"#svn\" class=\"headerlink\" title=\"svn\"></a>svn</h2><ul>\n<li>热备<ul>\n<li>通过svn的hook达到热备效果</li>\n<li>svnsync</li>\n</ul>\n</li>\n<li>冷备<ul>\n<li>通过 svnadmin dump 导出备份数据</li>\n<li>rsync或scp 传输备份数据到其他机器</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"svnsync热备\"><a href=\"#svnsync热备\" class=\"headerlink\" title=\"svnsync热备\"></a>svnsync热备</h3><h4 id=\"创建svn-仓库\"><a href=\"#创建svn-仓库\" class=\"headerlink\" title=\"创建svn 仓库\"></a>创建svn 仓库</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 接创建路径</span><br>svnadmin create /home/svn<br></code></pre></td></tr></table></figure>\n<h4 id=\"修改svn配置文件\"><a href=\"#修改svn配置文件\" class=\"headerlink\" title=\"修改svn配置文件\"></a>修改svn配置文件</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># svnserver.conf</span><br><span class=\"hljs-comment\"># 取消如下配置注释</span><br><span class=\"hljs-attr\">anon-access</span> = none<br><span class=\"hljs-attr\">auth-access</span> = write<br><span class=\"hljs-attr\">password-db</span> = passwd<br><span class=\"hljs-attr\">authz-db</span> = authz<br></code></pre></td></tr></table></figure>\n<h4 id=\"添加admin账号权限\"><a href=\"#添加admin账号权限\" class=\"headerlink\" title=\"添加admin账号权限\"></a>添加admin账号权限</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># authz</span><br><span class=\"hljs-section\">[groups]</span><br><span class=\"hljs-attr\">admin</span> = &lt;username&gt;<br><br><span class=\"hljs-section\">[/]</span><br>@<span class=\"hljs-attr\">admin</span> = rw<br></code></pre></td></tr></table></figure>\n<h4 id=\"添加admin账号密码\"><a href=\"#添加admin账号密码\" class=\"headerlink\" title=\"添加admin账号密码\"></a>添加admin账号密码</h4><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-comment\"># passwd</span><br><span class=\"hljs-section\">[users]</span><br><span class=\"hljs-attr\">admin</span> = &lt;password&gt;<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"启动svn服务\"><a href=\"#启动svn服务\" class=\"headerlink\" title=\"启动svn服务\"></a>启动svn服务</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">svnserve -d -r /home/svn<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"svnsync备份\"><a href=\"#svnsync备份\" class=\"headerlink\" title=\"svnsync备份\"></a>svnsync备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 在文件第二行加入 exit 0</span><br><span class=\"hljs-built_in\">cp</span> pre-revprop-change.tmpl pre-revprop-change<br><br><span class=\"hljs-comment\"># 初始化备份仓库</span><br>svnsync init svn://&lt;backup_ip&gt; svn://&lt;svn_ip&gt;<br><br><span class=\"hljs-comment\"># 会提示输入账号密码</span><br>svnsync <span class=\"hljs-built_in\">sync</span> svn://&lt;backup_ip&gt;<br><span class=\"hljs-comment\"># 或</span><br>svnsync <span class=\"hljs-built_in\">sync</span> --non-interactive svn://&lt;backup_ip&gt; --sync-username &lt;username&gt; --sync-password &lt;password&gt; --source-username &lt;username&gt; --source-password &lt;password&gt;<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"将svnsync写入post-commit-hook\"><a href=\"#将svnsync写入post-commit-hook\" class=\"headerlink\" title=\"将svnsync写入post-commit hook\"></a>将svnsync写入post-commit hook</h4><p>钩子脚本的具体写法和shell脚本写法是一样的。钩子脚本就是被某些版本库事件触发的程序。</p>\n<p>post-commit 在提交完成成功创建版本之后执行该钩子，提交已经完成，不可更改。</p>\n<p>pre-commit 提交完成前触发执行该脚本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># hooks目录</span><br><span class=\"hljs-built_in\">cp</span> post-commit.tmpl post-commit<br><span class=\"hljs-comment\"># 将如下命令写入 post-commit</span><br>svnsync <span class=\"hljs-built_in\">sync</span> --non-interactive svn://&lt;backup_ip&gt; --sync-username &lt;username&gt; --sync-password &lt;password&gt; --source-username &lt;username&gt; --source-password &lt;password&gt;<br></code></pre></td></tr></table></figure>\n<h3 id=\"冷备\"><a href=\"#冷备\" class=\"headerlink\" title=\"冷备\"></a>冷备</h3><h4 id=\"svnadmin-dump\"><a href=\"#svnadmin-dump\" class=\"headerlink\" title=\"svnadmin dump\"></a>svnadmin dump</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">## 查看版本</span><br>svnlook youngest /home/svn<br><br><span class=\"hljs-comment\">## youngest_num填入svnlook查到值</span><br>svnadmin dump /home/svn -r 0:<span class=\"hljs-variable\">$youngest_num</span> --incremental &gt; /home/svn_backup/svn.dump<br><span class=\"hljs-comment\"># 可以尝试写成增量导出脚本，之后用增量文件会比全量快</span><br><span class=\"hljs-comment\">## 恢复备份文件</span><br>svnadmin load /home/svn &lt; /home/svn_backup/svn.dump<br><br><span class=\"hljs-comment\">## 然后做成 rsync或者 scp传输 dump文件到备份服务器</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"gitlab备份\"><a href=\"#gitlab备份\" class=\"headerlink\" title=\"gitlab备份\"></a>gitlab备份</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">gitlab-rake gitlab:backup:create<br><span class=\"hljs-comment\"># 备份文件在/var/opt/gitlab/backups/目录下</span><br><br><span class=\"hljs-comment\">## 修改备份文件权限</span><br><span class=\"hljs-built_in\">chmod</span> 777 /var/opt/gitlab/backups/*.tar<br><span class=\"hljs-comment\">## 停止服务</span><br>gitlab-ctl stop unicorn<br>gitlab-ctl stop sidekiq<br><br><span class=\"hljs-comment\">## 恢复</span><br>gitlab-rake gitlab:backup:restore BACKUP=1481434654<br><br><span class=\"hljs-comment\">## 启动服务</span><br>gitlab-ctl restart<br></code></pre></td></tr></table></figure>"},{"title":"WSL 切换存储路径","date":"2024-10-17T09:08:08.000Z","_content":"\n# WSL 切换存储路径\n\n> WSL默认安装在C盘，使用过程中容易撑满C盘\n\n```bash\n# 查看容器信息\nwsl -l -v \n\n# 如果安装了docker则执行\n# 先在任务栏把docker-desktop退出\nwsl --export docker-desktop-data \"D:\\wsl\\docker-desktop-data.tar\"\nwsl --unregister docker-desktop-data\nwsl --import docker-desktop-data \"D:\\wsl\\docker-desktop-data\" \"D:\\wsl\\docker-desktop-data.tar\" --version 2\n\nwsl --export docker-desktop \"D:\\wsl\\docker-desktop.tar\"\nwsl --unregister docker-desktop\nwsl --import docker-desktop \"D:\\wsl\\docker-desktop\" \"D:\\wsl\\docker-desktop.tar\" --version 2\n\nwsl --shutdown\nwsl --export Ubuntu \"D:\\wsl\\ubuntu.tar\"\nwsl --unregister Ubuntu\nwsl --import Ubuntu \"D:\\wsl\\ubuntu\" \"D:\\wsl\\ubuntu.tar\" --version 2\n## 配置默认登陆用户\nubuntu config --default-user guest\n```","source":"_posts/wsl-migrate.md","raw":"---\ntitle: WSL 切换存储路径\ndate: 2024-10-17 17:08:08\ntags: tools\n---\n\n# WSL 切换存储路径\n\n> WSL默认安装在C盘，使用过程中容易撑满C盘\n\n```bash\n# 查看容器信息\nwsl -l -v \n\n# 如果安装了docker则执行\n# 先在任务栏把docker-desktop退出\nwsl --export docker-desktop-data \"D:\\wsl\\docker-desktop-data.tar\"\nwsl --unregister docker-desktop-data\nwsl --import docker-desktop-data \"D:\\wsl\\docker-desktop-data\" \"D:\\wsl\\docker-desktop-data.tar\" --version 2\n\nwsl --export docker-desktop \"D:\\wsl\\docker-desktop.tar\"\nwsl --unregister docker-desktop\nwsl --import docker-desktop \"D:\\wsl\\docker-desktop\" \"D:\\wsl\\docker-desktop.tar\" --version 2\n\nwsl --shutdown\nwsl --export Ubuntu \"D:\\wsl\\ubuntu.tar\"\nwsl --unregister Ubuntu\nwsl --import Ubuntu \"D:\\wsl\\ubuntu\" \"D:\\wsl\\ubuntu.tar\" --version 2\n## 配置默认登陆用户\nubuntu config --default-user guest\n```","slug":"wsl-migrate","published":1,"updated":"2024-10-17T09:24:01.655Z","_id":"cm2d3asti0000wvuq20em6kcb","comments":1,"layout":"post","photos":[],"content":"<h1 id=\"WSL-切换存储路径\"><a href=\"#WSL-切换存储路径\" class=\"headerlink\" title=\"WSL 切换存储路径\"></a>WSL 切换存储路径</h1><blockquote>\n<p>WSL默认安装在C盘，使用过程中容易撑满C盘</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 查看容器信息</span><br>wsl -l -v <br><br><span class=\"hljs-comment\"># 如果安装了docker则执行</span><br><span class=\"hljs-comment\"># 先在任务栏把docker-desktop退出</span><br>wsl --<span class=\"hljs-built_in\">export</span> docker-desktop-data <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data.tar&quot;</span><br>wsl --unregister docker-desktop-data<br>wsl --import docker-desktop-data <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data.tar&quot;</span> --version 2<br><br>wsl --<span class=\"hljs-built_in\">export</span> docker-desktop <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop.tar&quot;</span><br>wsl --unregister docker-desktop<br>wsl --import docker-desktop <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop.tar&quot;</span> --version 2<br><br>wsl --shutdown<br>wsl --<span class=\"hljs-built_in\">export</span> Ubuntu <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu.tar&quot;</span><br>wsl --unregister Ubuntu<br>wsl --import Ubuntu <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu.tar&quot;</span> --version 2<br><span class=\"hljs-comment\">## 配置默认登陆用户</span><br>ubuntu config --default-user guest<br></code></pre></td></tr></table></figure>","excerpt":"","more":"<h1 id=\"WSL-切换存储路径\"><a href=\"#WSL-切换存储路径\" class=\"headerlink\" title=\"WSL 切换存储路径\"></a>WSL 切换存储路径</h1><blockquote>\n<p>WSL默认安装在C盘，使用过程中容易撑满C盘</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 查看容器信息</span><br>wsl -l -v <br><br><span class=\"hljs-comment\"># 如果安装了docker则执行</span><br><span class=\"hljs-comment\"># 先在任务栏把docker-desktop退出</span><br>wsl --<span class=\"hljs-built_in\">export</span> docker-desktop-data <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data.tar&quot;</span><br>wsl --unregister docker-desktop-data<br>wsl --import docker-desktop-data <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop-data.tar&quot;</span> --version 2<br><br>wsl --<span class=\"hljs-built_in\">export</span> docker-desktop <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop.tar&quot;</span><br>wsl --unregister docker-desktop<br>wsl --import docker-desktop <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\docker-desktop.tar&quot;</span> --version 2<br><br>wsl --shutdown<br>wsl --<span class=\"hljs-built_in\">export</span> Ubuntu <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu.tar&quot;</span><br>wsl --unregister Ubuntu<br>wsl --import Ubuntu <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu&quot;</span> <span class=\"hljs-string\">&quot;D:\\wsl\\ubuntu.tar&quot;</span> --version 2<br><span class=\"hljs-comment\">## 配置默认登陆用户</span><br>ubuntu config --default-user guest<br></code></pre></td></tr></table></figure>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"clzkkh3yl0005uhuq90pa0t2k","tag_id":"clzkkh3yj0003uhuqg2yp5q8a","_id":"clzkkh3yn0008uhuq8n8rckht"},{"post_id":"clzkkh3yf0001uhuq1bz6an0s","tag_id":"clzkkh3yj0003uhuqg2yp5q8a","_id":"clzkkh3yo000auhuqhhq40ydj"},{"post_id":"clzkkh3yi0002uhuqdzi3hgca","tag_id":"clzkkh3ym0007uhuq98ee1m3n","_id":"clzkkh3yp000euhuq3il0bae5"},{"post_id":"clzkkh3yk0004uhuq1jzn2om4","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yr000iuhuqbg2k914o"},{"post_id":"clzkkh3yp000fuhuq44wa3q0j","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3ys000kuhuq9hhm3h0j"},{"post_id":"clzkkh3yr000huhuq8amy089o","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yt000nuhuqegoo8wgr"},{"post_id":"clzkkh3ym0006uhuq5bnr3uzz","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yu000ouhuqa3t24u8h"},{"post_id":"clzkkh3ys000juhuqh0ddd01i","tag_id":"clzkkh3ym0007uhuq98ee1m3n","_id":"clzkkh3yu000quhuqd03vf20i"},{"post_id":"clzkkh3yt000muhuq0xot89y9","tag_id":"clzkkh3ym0007uhuq98ee1m3n","_id":"clzkkh3yu000ruhuq59g16pgu"},{"post_id":"clzkkh3yn0009uhuqhvkdb9ko","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yu000tuhuq2hng1zbj"},{"post_id":"clzkkh3yo000buhuqdk7f4xf9","tag_id":"clzkkh3yu000puhuq7q2z2wti","_id":"clzkkh3yu000uuhuq72csas0r"},{"post_id":"clzkkh3yp000duhuq7c9m7yio","tag_id":"clzkkh3yu000puhuq7q2z2wti","_id":"clzkkh3yu000vuhuqhao6bhyq"},{"post_id":"clzkkh3yw000wuhuq8krd0in4","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yx000yuhuq41rw413v"},{"post_id":"clzkkh3yx000xuhuq2o058jx3","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"clzkkh3yx000zuhuqbc7g04u9"},{"post_id":"clzpbf3wl0000ucuq78o31wqf","tag_id":"clzpe1eno0002ucuq2fae9is7","_id":"clzpe1enr0003ucuq3vq1f7qt"},{"post_id":"clzvzj69d0000d0uqa9gd1zu4","tag_id":"clzkkh3ym0007uhuq98ee1m3n","_id":"clzvzj69i0001d0uqgpwt1q20"},{"post_id":"clzvzj69i0002d0uq0c5u67qo","tag_id":"clzkkh3ym0007uhuq98ee1m3n","_id":"clzvzj69j0003d0uqaguthasd"},{"post_id":"cm0d9jddk0000vnuq020s2anv","tag_id":"clzkkh3yu000puhuq7q2z2wti","_id":"cm0d9jddp0001vnuqcfxkfa1j"},{"post_id":"cm0ey0byn0002vnuqc1i9ey6d","tag_id":"clzkkh3yj0003uhuqg2yp5q8a","_id":"cm0ey10o80003vnuqdlhjavhh"},{"post_id":"cm1kdm0yb0000n6uqajr5b8qb","tag_id":"clzkkh3yj0003uhuqg2yp5q8a","_id":"cm1kdm0yf0001n6uq0hsh4wvq"},{"post_id":"cm29v9iww0000z6uq7t8nfst0","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"cm29v9ix40001z6uq8lrhejuc"},{"post_id":"cm2d3asti0000wvuq20em6kcb","tag_id":"clzkkh3yo000cuhuq3e4c64au","_id":"cm2d3astm0001wvuqeyvkcy3l"}],"Tag":[{"name":"ansible","_id":"clzkkh3yj0003uhuqg2yp5q8a"},{"name":"linux","_id":"clzkkh3ym0007uhuq98ee1m3n"},{"name":"tools","_id":"clzkkh3yo000cuhuq3e4c64au"},{"name":"k8s","_id":"clzkkh3yu000puhuq7q2z2wti"},{"name":"docker","_id":"clzpe1eno0002ucuq2fae9is7"}]}}